
<!DOCTYPE html>
<html lang="pt-BR">
<head>
    
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css" />
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Teddy</title>


    <!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-H7B8XML4VF"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-H7B8XML4VF');
</script>

    <link rel="icon" type="image/x-icon" href="assets/TeddyApp.ico">
    
    <meta name="theme-color" content="#ed8432">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    
    <style>
        /* PERMITE REDIMENSIONAR O EDITOR */
#editor-container {
    resize: vertical; /* Permite puxar para baixo/cima */
    overflow: auto;   /* Necessário para o resize funcionar */
    min-height: 200px; /* Altura mínima para não sumir */
    max-height: 800px; /* (Opcional) Altura máxima */
}
        /* Aumenta a fonte padrão do editor Quill */
#editor-container .ql-editor {
    font-size: 18px; /* O padrão costuma ser 13px ou 14px */
    line-height: 1.6; /* Melhora a leitura também */
}
        :root {
            /* CORES ORIGINAIS */
            --primary: #ed8432;
            --primary-hover: #d9772b;
            --primary-light: #fff7ed;
            --primary-dim: #ffedd5;
            --primary-dark: #c2410c;
            --secondary: #fb923c;
            
            --success: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --info: #3b82f6;
            
            --bg-body: #f1f5f9;
            --bg-card: #ffffff;
            --bg-nav: #ffffff;
            --text-main: #1e293b;
            --text-muted: #64748b;
            --border: #e2e8f0;
            --input-bg: #ffffff;
            
            --radius-lg: 20px;
            --radius-md: 12px;
            --radius-sm: 8px;
            
            --shadow-sm: 0 1px 2px rgba(0,0,0,0.05);
            --shadow-md: 0 4px 6px -1px rgba(0,0,0,0.1);
            --shadow-lg: 0 10px 15px -3px rgba(0,0,0,0.1);
            --nav-height: 65px;
            --sidebar-width: 80px; /* Fixed width for collapsed state */
        }

        /* DARK MODE */
        body.dark-mode {
            --bg-body: #0f172a;
            --bg-card: #1e293b;
            --bg-nav: #1e293b;
            --text-main: #f1f5f9;
            --text-muted: #94a3b8;
            --border: #334155;
            --primary-light: #331f14; 
            --primary-dim: #431407;
            --input-bg: #0f172a;
            --shadow-sm: 0 1px 2px rgba(0,0,0,0.3);
            --shadow-md: 0 4px 6px -1px rgba(0,0,0,0.3);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-body);
            color: var(--text-main);
            height: 100vh;
            display: flex;
            overflow: hidden;
            font-size: 16px; 
            transition: background 0.3s, color 0.3s;
        }

        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        .dark-mode ::-webkit-scrollbar-thumb { background: #475569; }

        /* SIDEBAR APRIMORADA - ALWAYS COLLAPSED */
        .sidebar {
            width: var(--sidebar-width);
            background: var(--bg-nav);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            padding: 24px 12px; 
            z-index: 100;
            padding-top: 40px;
            transition: background 0.3s;
            position: relative;
        }

        .nav-links { display: flex; flex-direction: column; gap: 8px; flex: 1; margin-top: 20px; overflow: hidden; }

        .nav-item {
            display: flex; align-items: center; justify-content: center; /* Centered for icons */
            gap: 12px; padding: 14px 0;
            border-radius: var(--radius-sm); color: var(--text-muted);
            font-weight: 600; cursor: pointer; transition: all 0.2s;
            border: none; background: none; width: 100%; 
            font-size: 0.95rem; white-space: nowrap; 
            position: relative;
        }

        .nav-item:hover { background: var(--primary-light); color: var(--primary); }
        .nav-item.active { background: var(--primary); color: white; box-shadow: var(--shadow-sm); }
        
        .nav-item i { 
            min-width: 24px; 
            text-align: center; 
            font-size: 1.1rem; 
            margin: 0;
        }
        
        /* Tooltip style for Sidebar Legend */
        .nav-item span { 
            position: absolute;
            left: 70px;
            background: var(--text-main);
            color: var(--bg-card);
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 0.85rem;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s ease-in-out;
            box-shadow: var(--shadow-md);
            z-index: 200;
            white-space: nowrap;
        }

        .nav-item:hover span { opacity: 1; }

        /* BOTTOM NAV */
        .bottom-nav {
            display: none; position: fixed; bottom: 0; left: 0; width: 100%;
            background: var(--bg-nav); height: var(--nav-height); border-top: 1px solid var(--border);
            z-index: 1000; justify-content: space-around; align-items: center;
            padding-bottom: env(safe-area-inset-bottom);
            transition: background 0.3s;
        }

        .bottom-nav-item {
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            color: var(--text-muted); font-size: 0.75rem; font-weight: 600; gap: 4px;
            background: none; border: none; width: 100%; height: 100%;
        }
        .bottom-nav-item.active { color: var(--primary); }
        .bottom-nav-item i { font-size: 1.4rem; margin-bottom: 2px; }

        /* MAIN AREA */
        .main-content {
            flex: 1; height: 100%; overflow-y: auto; overflow-x: hidden;
            padding: 24px 32px; position: relative;
        }

        .page-header { margin-bottom: 24px; display: flex; align-items: center; justify-content: space-between; }
        #page-title-display { font-weight: 800; font-size: 1.5rem; color: var(--text-main); letter-spacing: -0.5px; }

        .header-actions { display: flex; gap: 12px; align-items: center; }

        .header-btn-icon {
            width: 40px; height: 40px; border-radius: 50%; border: 1px solid var(--border);
            background: var(--bg-card); color: var(--text-main); display: flex; align-items: center;
            justify-content: center; cursor: pointer; font-size: 1.1rem;
            transition: all 0.2s;
        }
        .header-btn-icon:hover {
            border-color: var(--primary);
            color: var(--primary);
            background: var(--primary-light);
        }

        .view-section { max-width: 1000px; margin: 0 auto; padding-bottom: 100px; animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .hidden { display: none !important; }

        .card-box {
            background: var(--bg-card); border-radius: var(--radius-lg);
            padding: 24px; box-shadow: var(--shadow-sm); border: 1px solid var(--border);
            margin-bottom: 20px; transition: background 0.3s, border 0.3s;
        }

        /* Fix spacing inside grids */
        .dashboard-grid .card-box { margin-bottom: 0; height: 100%; }

        h3 { font-size: 1.15rem; font-weight: 700; color: var(--text-main); margin-bottom: 16px; }

        /* BUTTONS & INPUTS */
        .action-btn {
            background: var(--primary); color: white; border: none; padding: 14px 24px;
            border-radius: var(--radius-md); font-weight: 600; font-size: 1rem;
            cursor: pointer; display: inline-flex; align-items: center; justify-content: center;
            gap: 8px; width: 100%; transition: background 0.2s;
        }
        .action-btn:hover { background: var(--primary-hover); }
        .action-btn:active { transform: scale(0.98); }
        .action-btn:disabled { opacity: 0.6; cursor: not-allowed; transform: none; }
        
        .btn-outline { background: var(--bg-card); border: 1px solid var(--border); color: var(--text-main); cursor: pointer; border-radius: var(--radius-md); padding: 12px 20px; font-weight: 600; font-size: 0.95rem; }
        .btn-outline:hover { background: var(--bg-body); border-color: var(--text-muted); }
        .btn-danger { background: var(--danger); color: white; border: none;}
        .btn-sm { padding: 8px 16px; font-size: 0.85rem; width: auto; border-radius: 8px; }
        .btn-icon { width: 38px; height: 38px; border-radius: 50%; padding: 0; display: flex; align-items: center; justify-content: center; border: 1px solid var(--border); background: var(--bg-card); cursor: pointer; color: var(--text-muted); font-size: 1.1rem; }
        .btn-icon:hover { color: var(--primary); border-color: var(--primary); background: var(--primary-light); }
        .btn-back { border: none; padding: 10px 0; margin-bottom: 16px; color: var(--text-muted); font-size: 1.1rem; display: flex; align-items: center; gap: 8px; background: transparent; cursor: pointer; }
        .btn-back:hover { color: var(--primary); }

        input, select, textarea {
            width: 100%; padding: 14px; border-radius: var(--radius-md);
            border: 1px solid var(--border); background: var(--input-bg);
            font-family: inherit; font-size: 1.05rem; margin-bottom: 16px; color: var(--text-main);
        }
        
        /* Remove default focus outline and add custom style */
        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px var(--primary-light);
        }

        .editor-toolbar { display: flex; gap: 8px; margin-bottom: 12px; padding: 4px; background: var(--bg-body); border-radius: 8px; border: 1px solid var(--border); width: fit-content; }
        
        /* --- SEARCH DROPDOWN STYLES --- */
        .search-container { position: relative; width: 100%; margin-bottom: 12px; }
        .search-results-list {
            position: absolute;
            top: 100%;
            left: 0;
            width: 100%;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
            max-height: 200px;
            overflow-y: auto;
            z-index: 2500;
            box-shadow: var(--shadow-lg);
            display: none;
        }
        .search-result-item {
            padding: 10px 14px;
            border-bottom: 1px solid var(--bg-body);
            cursor: pointer;
            transition: background 0.2s;
            font-size: 0.9rem;
            color: var(--text-main);
        }
        .search-result-item:last-child { border-bottom: none; }
        .search-result-item:hover { background: var(--bg-body); color: var(--primary); }
        .search-result-item strong { display: block; font-size: 0.95rem; }
        .search-result-item span { font-size: 0.8rem; color: var(--text-muted); }

        /* --- HERO HEADER STYLES --- */
        .hero-header-card {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            border: none;
            overflow: hidden;
            position: relative;
            margin-bottom: 24px;
            padding: 24px;
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-md);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .hero-bg-icon {
            position: absolute; right: -20px; bottom: -30px; font-size: 10rem; opacity: 0.1; pointer-events: none;
        }
        .hero-content {
            position: relative; z-index: 2; width: 100%; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 16px;
        }
        .hero-title {
            color: white; margin: 0; font-size: 1.3rem; font-weight: 800;
        }
        .hero-subtitle {
            opacity: 0.9; margin-top: 4px; font-size: 0.9rem; font-weight: 500;
        }
        .hero-actions {
            display: flex;
            background: rgba(255,255,255,0.2);
            padding: 4px;
            border-radius: 12px;
            gap: 4px;
        }
        .banner-period-btn {
            background: transparent;
            border: none;
            color: rgba(255,255,255,0.8);
            padding: 8px 16px;
            border-radius: 8px;
            font-weight: 600;
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.2s;
        }
        .banner-period-btn:hover {
            background: rgba(255,255,255,0.1);
            color: white;
        }
        .banner-period-btn.active {
            background: white;
            color: var(--primary);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        /* --- STYLES FOR UNIFIED STUDY VIEW --- */
        .study-nav-container {
            display: flex;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: var(--radius-lg);
            padding: 6px;
            margin-bottom: 24px;
            gap: 6px;
        }

        .study-nav-btn {
            flex: 1;
            padding: 12px;
            border: none;
            background: transparent;
            color: var(--text-muted);
            border-radius: var(--radius-md);
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .study-nav-btn:hover {
            background: var(--bg-body);
            color: var(--text-main);
        }

        .study-nav-btn.active {
            background: var(--primary);
            color: white;
            box-shadow: var(--shadow-sm);
        }

        /* --- POMODORO STYLES --- */
        .pomodoro-layout { display: grid; grid-template-columns: 1fr 1fr; gap: 24px; }
        .timer-card { text-align: center; display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 400px; }
        .pomo-tabs { display: flex; background: var(--bg-body); padding: 4px; border-radius: 30px; margin-bottom: 30px; width: fit-content; border: 1px solid var(--border); }
        .pomo-tab { padding: 8px 20px; border-radius: 25px; cursor: pointer; border: none; background: transparent; color: var(--text-muted); font-weight: 600; transition: all 0.3s; }
        .pomo-tab.active { background: var(--bg-card); color: var(--primary); box-shadow: var(--shadow-sm); }
        
        .timer-display { font-size: 5rem; font-weight: 800; font-feature-settings: "tnum"; font-variant-numeric: tabular-nums; color: var(--text-main); margin: 20px 0; line-height: 1; }
        
        .timer-controls { display: flex; gap: 16px; align-items: center; margin-bottom: 30px; }
        .btn-pomo-main { width: 70px; height: 70px; border-radius: 50%; font-size: 1.5rem; display: flex; align-items: center; justify-content: center; background: var(--primary); color: white; border: none; cursor: pointer; transition: transform 0.2s, background 0.2s; box-shadow: var(--shadow-md); }
        .btn-pomo-main:hover { transform: scale(1.1); background: var(--primary-hover); }
        .btn-pomo-sec { width: 50px; height: 50px; border-radius: 50%; background: var(--bg-body); color: var(--text-muted); border: 1px solid var(--border); display: flex; align-items: center; justify-content: center; font-size: 1rem; cursor: pointer; transition: all 0.2s; }
        .btn-pomo-sec:hover { background: var(--bg-card); color: var(--primary); border-color: var(--primary); }

        .pomo-history-list { display: flex; flex-direction: column; gap: 10px; max-height: 400px; overflow-y: auto; }
        .pomo-item { display: flex; align-items: center; justify-content: space-between; padding: 14px 16px; background: var(--bg-card); border: 1px solid var(--border); border-radius: var(--radius-md); transition: all 0.2s; }
        .pomo-item:hover { border-color: var(--primary); transform: translateX(2px); }
        .pomo-info h4 { margin: 0; font-size: 0.95rem; color: var(--text-main); }
        .pomo-info span { font-size: 0.8rem; color: var(--text-muted); display: block; margin-top: 2px; }
        .pomo-actions { display: flex; gap: 8px; }
        .tag-pomo { background: var(--primary-light); color: var(--primary); }
        .tag-short { background: #dbeafe; color: var(--info); }
        .tag-long { background: #d1fae5; color: var(--success); }

        /* FLOATING TIMER WIDGET - Updated Position and Layout */
        .floating-timer {
            position: fixed;
            bottom: 77px; /* Align vertical center with FAB (bottom ~70px + ~1/2 height) */
            right: 105px; /* Position to the left of FAB */
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: 10px 20px;
            border-radius: 30px;
            box-shadow: var(--shadow-lg);
            display: flex;
            flex-direction: row; 
            align-items: center;
            justify-content: center;
            border: 1px solid var(--border);
            z-index: 1900;
            transform: translateX(200%);
            transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            pointer-events: none; /* Read only */
        }
        .dark-mode .floating-timer { background: rgba(30, 41, 59, 0.95); }
        .floating-timer.visible { transform: translateX(0); }
        
        .float-time { font-weight: 800; font-variant-numeric: tabular-nums; color: var(--primary); font-size: 1.5rem; line-height: 1; }

        /* --- NEW CREATE CARD STYLES REFINED --- */
        .create-container {
            display: flex;
            flex-direction: column;
            gap: 24px;
        }

        .create-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .create-label {
            font-size: 0.75rem;
            font-weight: 700;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
            display: block;
        }

        .rich-editor {
            min-height: 120px;
            padding: 20px;
            background: var(--input-bg);
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
            font-size: 1.1rem;
            line-height: 1.5;
            transition: all 0.2s;
            color: var(--text-main);
        }

        .rich-editor:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px var(--primary-light);
        }

        .answer-group {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .answer-block {
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
            padding: 12px 16px;
            background: var(--bg-card);
            position: relative;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .answer-block:focus-within {
            border-color: var(--primary);
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
            transform: translateY(-1px);
        }

        .answer-block input {
            border: none;
            background: transparent;
            padding: 8px 0;
            margin: 0;
            font-size: 1rem;
            width: 100%;
            color: var(--text-main);
            box-shadow: none !important; /* Force remove default focus shadow on inner input */
        }
        
        .answer-block input:focus {
             outline: none;
             box-shadow: none;
             border: none;
        }

        .answer-block.correct-answer {
            background: linear-gradient(to right, rgba(16, 185, 129, 0.05), transparent);
            border-left: 4px solid var(--success);
        }
        
        .answer-block.correct-answer:focus-within {
            border-color: var(--success);
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.1);
        }

        .answer-block.wrong-answer {
            border-left: 4px solid var(--border);
        }
        
        .answer-block.wrong-answer:focus-within {
            border-left-color: var(--danger);
            border-color: var(--text-muted);
        }

        .answer-icon {
            font-size: 1.1rem;
            color: var(--text-muted);
            opacity: 0.5;
            flex-shrink: 0;
        }
        
        .correct-answer .answer-icon { color: var(--success); opacity: 1; }

        /* --- FLASHCARDS & STUDY --- */
        .flashcard-display {
            background: var(--bg-card); border-radius: var(--radius-lg); padding: 40px 24px;
            text-align: left; box-shadow: var(--shadow-lg); border: 1px solid var(--border);
            position: relative; overflow: hidden;
        }
        .question-text {
            font-size: 1.25rem; font-weight: 600; color: var(--text-main);
            margin: 16px 0 24px; line-height: 1.6; text-align: left;
        }
        .option-btn {
            background: var(--bg-card); border: 2px solid var(--border); padding: 18px;
            border-radius: var(--radius-md); font-size: 1.05rem; color: var(--text-main);
            font-weight: 500; text-align: left; cursor: pointer; transition: all 0.2s;
            margin-bottom: 12px; width: 100%;
            display: flex; gap: 8px; align-items: flex-start;
        }
        .option-btn:hover { border-color: var(--primary); transform: translateX(4px); }
        .option-btn:disabled { cursor: default; transform: none !important; }
        .option-btn strong { color: var(--primary); margin-right: 4px; }
        
        .option-btn.selected { 
            background: var(--bg-body); 
            border-color: var(--info); 
            box-shadow: 0 0 0 1px var(--info);
        }

        .option-btn.correct { background: rgba(16, 185, 129, 0.1); border-color: var(--success); color: var(--success); }
        .option-btn.wrong { background: rgba(239, 68, 68, 0.1); border-color: var(--danger); color: var(--danger); }
        
        /* List Styles */
        .card-list-item {
            background: var(--bg-card); border-radius: var(--radius-md); padding: 20px;
            border: 1px solid var(--border); box-shadow: var(--shadow-sm);
            margin-bottom: 16px; transition: transform 0.2s, box-shadow 0.2s;
            display: flex; flex-direction: column; gap: 12px;
        }
        .card-list-item:hover { transform: translateY(-2px); box-shadow: var(--shadow-md); border-color: var(--primary); }
        .card-meta { display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 8px; }
        .card-badge {
            font-size: 0.8rem; font-weight: 800; color: var(--primary);
            background: var(--primary-light); padding: 4px 10px; border-radius: 12px; text-transform: uppercase;
        }
        .next-review-badge { font-size: 0.8rem; font-weight: 600; color: var(--text-muted); display: flex; align-items: center; gap: 4px; }

        /* ID Badge Style */
        .id-badge {
            font-family: monospace; font-size: 0.75rem; background: var(--bg-body); 
            padding: 2px 6px; border-radius: 4px; color: var(--text-muted); border: 1px solid var(--border);
        }

        /* --- SYLLABUS, PERFORMANCE, NOTES, SCHEDULE (Kept same) --- */
        .syllabus-item { background: var(--bg-card); border: 1px solid var(--border); border-radius: var(--radius-md); padding: 20px; margin-bottom: 16px; cursor: pointer; transition: all 0.2s; display: flex; justify-content: space-between; align-items: center; }
        .syllabus-item:hover { transform: translateY(-2px); box-shadow: var(--shadow-md); border-color: var(--primary); }
        
        /* Refined Subject/Topic Styling */
        .subject-container { 
            background: var(--bg-card); 
            border: 1px solid var(--border);
            border-left: 4px solid var(--primary);
            border-radius: var(--radius-md); 
            margin-bottom: 20px; 
            overflow: hidden; 
            box-shadow: var(--shadow-sm);
            transition: box-shadow 0.2s;
        }
        .subject-container:hover {
            box-shadow: var(--shadow-md);
        }
        .subject-header { 
            padding: 18px 24px; 
            background: var(--bg-card); 
            border-bottom: 1px solid var(--bg-body); 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            cursor: pointer; 
            user-select: none; 
            transition: background 0.2s;
        }
        .subject-header:hover { background: var(--bg-body); }
        .subject-title { font-weight: 700; color: var(--text-main); font-size: 1rem; display: flex; align-items: center; gap: 10px; }
        
        .subject-progress { width: 100px; height: 8px; background: #e2e8f0; border-radius: 4px; overflow: hidden; margin-left: auto; margin-right: 16px; }
        .subject-progress-bar { height: 100%; background: var(--success); width: 0%; transition: width 0.5s ease; }
        
        .topic-list { padding: 0; background: var(--bg-card); }
        .topic-row { 
            display: flex; 
            align-items: center; 
            padding: 16px 24px; 
            border-bottom: 1px solid var(--bg-body); 
            transition: background 0.2s; 
        }
        .topic-row:last-child { border-bottom: none; }
        .topic-row:hover { background: var(--bg-body); }
        
        .topic-check { 
            width: 24px; height: 24px; 
            border: 2px solid var(--text-muted); 
            border-radius: 50%; /* Rounded checkbox */
            margin-right: 16px; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            cursor: pointer; 
            flex-shrink: 0; 
            color: white; 
            transition: all 0.2s; 
            font-size: 0.8rem;
        }
        .topic-row.done .topic-check { background: var(--success); border-color: var(--success); }
        .topic-row.done span { text-decoration: line-through; color: var(--text-muted); }
        
        .category-stat-item { display: flex; align-items: center; justify-content: space-between; padding: 16px 20px; border-bottom: 1px solid var(--bg-body); background: var(--bg-card); transition:background 0.2s; }
        .category-stat-item:last-child { border-bottom: none; }
        .category-stat-item:hover { background: var(--bg-body); }
        
        .cat-name { font-weight: 600; font-size: 1rem; color: var(--text-main); margin-bottom: 4px; }
        .cat-bar-bg { width: 100%; height: 8px; background: var(--bg-body); border-radius: 4px; overflow: hidden; }
        .cat-bar-fill { height: 100%; border-radius: 4px; transition: width 0.5s ease; }
        .cat-percent { font-weight: 700; font-size: 0.9rem; color: var(--text-main); min-width: 45px; text-align: right; margin-left: 10px; }
        .stats-summary-box { display: flex; justify-content: space-around; align-items: center; text-align: center; padding: 32px 16px; }
        .stat-big-item { flex: 1; }
        .stat-big-item .label { font-size: 0.9rem; opacity:0.8; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 8px; color:white; }
        .stat-big-item .value { font-size: 2.8rem; font-weight: 800; color: white; line-height: 1; }
        .stat-divider { width: 1px; height: 50px; background: rgba(255,255,255,0.3); margin: 0 10px; }
        
        .schedule-layout { display: flex; flex-direction: column; gap: 24px; }
        .task-section, .calendar-wrapper { background: var(--bg-card); border-radius: var(--radius-lg); padding: 24px; box-shadow: var(--shadow-sm); border: 1px solid var(--border); }
        
        /* UPDATED TASK LIST STYLES */
        .task-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 20px; }
        .task-list { display: flex; flex-direction: column; gap: 10px; min-height: 20px; /* Reduced min-height to fix whitespace */ }
        .task-item { 
            background: var(--bg-card); 
            border: 1px solid var(--border); 
            color: var(--text-main); 
            padding: 16px 20px; 
            border-radius: var(--radius-md); 
            display: flex; 
            align-items: center; 
            gap: 16px; 
            transition: all 0.2s;
            box-shadow: var(--shadow-sm);
        }
        .task-item:hover { border-color: var(--primary); transform: translateY(-2px); box-shadow: var(--shadow-md); }
        .task-check { 
            width: 24px; height: 24px; 
            border: 2px solid var(--text-muted); 
            border-radius: 50%; 
            display: flex; align-items: center; justify-content: center; 
            cursor: pointer; color: white; flex-shrink: 0;
            transition: all 0.2s;
        }
        .task-item.completed .task-check { background: var(--success); border-color: var(--success); }
        .task-item.completed span { text-decoration: line-through; color: var(--text-muted); }
        
        .schedule-grid-container { overflow-x: auto; position: relative; max-height: 600px; padding-bottom: 20px; }
        .modern-table { width: 100%; border-collapse: separate; border-spacing: 0; min-width: 900px; table-layout: fixed; border-radius: var(--radius-md); overflow: hidden; border: 1px solid var(--border); }
        .modern-table th { background: var(--bg-body); color: var(--text-muted); border-bottom: 1px solid var(--border); padding: 16px; position: sticky; top: 0; z-index: 20; font-weight: 700; text-transform: uppercase; font-size: 0.8rem; }
        .modern-table td { border-right: 1px solid var(--border); border-bottom: 1px solid var(--border); height: 70px; vertical-align: middle; padding: 4px; position: relative; background: var(--bg-card); transition: background 0.2s; }
        .modern-table td:hover { background: var(--bg-body); }
        .modern-table td.time-label { background: var(--bg-body); color: var(--text-muted); border-right: 1px solid var(--border); width: 80px; text-align: center; position: sticky; left: 0; z-index: 10; font-size: 0.8rem; font-weight: bold; }
        
        .event-block { height: 100%; width: 100%; border-radius: 6px; padding: 4px 8px; font-size: 0.75rem; font-weight: 600; color: white; box-shadow: 0 2px 4px rgba(0,0,0,0.05); cursor: pointer; display: flex; align-items: center; gap: 6px; overflow: hidden; white-space: nowrap; text-overflow: ellipsis; transition: transform 0.2s; }
        .event-block:hover { transform: scale(1.02); }
        .empty-cell-btn { position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; opacity: 0; color: var(--primary); font-size: 1.4rem; cursor: pointer; transition: opacity 0.2s; }
        td:hover .empty-cell-btn { opacity: 0.6; background: rgba(0,0,0,0.02); }
        
        .notes-breadcrumb { display: flex; align-items: center; gap: 8px; padding: 16px 20px; background: var(--bg-card); border: 1px solid var(--border); border-radius: var(--radius-md); margin-bottom: 24px; overflow-x: auto; white-space: nowrap; box-shadow: var(--shadow-sm); }
        .breadcrumb-item { color: var(--text-muted); font-size: 0.95rem; cursor: pointer; display: flex; align-items: center; gap: 8px; font-weight: 500; transition: color 0.2s; }
        .breadcrumb-item:hover { color: var(--primary); }
        .breadcrumb-item.active { color: var(--text-main); font-weight: 700; pointer-events: none; }
        
        .file-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: 20px; }
        .file-item { 
            background: var(--bg-card); 
            border: none; 
            border-radius: var(--radius-lg); 
            padding: 24px 16px; 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            text-align: center; 
            cursor: pointer; 
            position: relative; 
            transition: all 0.2s; 
            box-shadow: var(--shadow-sm); 
            aspect-ratio: 1/1; 
            justify-content: center; 
            border: 1px solid var(--border);
        }
        .file-item:hover { transform: translateY(-4px); box-shadow: var(--shadow-lg); border-color: var(--primary); }
        .file-icon { font-size: 3.5rem; margin-bottom: 16px; transition: transform 0.2s; }
        .file-item:hover .file-icon { transform: scale(1.1); }
        .file-name { font-size: 1rem; font-weight: 600; line-height: 1.3; overflow: hidden; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; color: var(--text-main); }
        .file-actions { position: absolute; top: 12px; right: 12px; display: flex; gap: 6px; opacity: 0; transition: opacity 0.2s; }
        .file-item:hover .file-actions { opacity: 1; }
        
        /* NEW: Study Control Bar (Buttons) */
        .study-controls-container {
            display: flex;
            flex-direction: column;
            gap: 16px;
            margin-top: 24px;
            padding-top: 20px;
            border-top: 1px solid var(--border);
        }
        
        .nav-buttons-row {
            display: flex;
            gap: 12px;
            justify-content: center;
        }

        .btn-study-rect {
            background: var(--bg-card);
            border: 1px solid var(--border);
            color: var(--text-muted);
            border-radius: 12px;
            padding: 12px 24px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.2s;
            flex: 1;
            justify-content: center;
            box-shadow: var(--shadow-sm);
        }
        
        .btn-study-rect:hover {
            border-color: var(--primary);
            color: var(--primary);
            background: var(--bg-body);
        }
        
        .btn-study-rect:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none !important;
        }

        .btn-study-confirm {
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 12px;
            padding: 16px 32px;
            font-size: 1.1rem;
            font-weight: 700;
            width: 100%;
            cursor: pointer;
            box-shadow: var(--shadow-md);
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        
        .btn-study-confirm:hover {
            background: var(--primary-hover);
            transform: translateY(-2px);
        }

        .sim-result-card {
            background: var(--bg-card);
            border-radius: var(--radius-lg);
            border: 1px solid var(--border);
            overflow: hidden;
            box-shadow: var(--shadow-md);
            margin-bottom: 24px;
        }

        .sim-result-header {
            padding: 30px;
            text-align: center;
            background: linear-gradient(135deg, var(--bg-body), var(--bg-card));
            border-bottom: 1px solid var(--border);
        }

        .sim-score-big {
            font-size: 4rem;
            font-weight: 800;
            color: var(--text-main);
            line-height: 1;
            margin-bottom: 4px;
        }

        .sim-score-label {
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--text-muted);
            font-weight: 600;
        }

        .sim-stats-row {
            display: flex;
            border-bottom: 1px solid var(--border);
        }

        .sim-stat-box {
            flex: 1;
            padding: 20px;
            text-align: center;
            border-right: 1px solid var(--border);
        }
        .sim-stat-box:last-child { border-right: none; }

        .sim-stat-val {
            font-size: 1.4rem;
            font-weight: 800;
            margin-bottom: 4px;
        }

        .sim-log-container {
            padding: 20px;
            background: var(--bg-body);
            max-height: 400px;
            overflow-y: auto;
        }

        .sim-log-item {
            background: var(--bg-card);
            padding: 16px;
            border-radius: var(--radius-md);
            margin-bottom: 12px;
            border: 1px solid var(--border);
            border-left: 4px solid var(--border);
            box-shadow: var(--shadow-sm);
        }

        .sim-log-item.correct { border-left-color: var(--success); }
        .sim-log-item.wrong { border-left-color: var(--danger); }
        
        /* NEW: Sim History Card List Style */
        .sim-history-card {
            display: flex;
            align-items: center;
            background: var(--bg-card);
            padding: 16px 20px;
            border-radius: var(--radius-md);
            border: 1px solid var(--border);
            margin-bottom: 12px;
            transition: all 0.2s;
            cursor: pointer;
        }
        .sim-history-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
            border-color: var(--primary);
        }
        
        .sim-hist-date {
            display: flex;
            flex-direction: column;
            margin-right: 20px;
        }
        .sim-hist-day { font-weight: 700; font-size: 1.1rem; color: var(--text-main); }
        .sim-hist-time { font-size: 0.8rem; color: var(--text-muted); }
        
        .sim-hist-score {
            font-size: 1.5rem;
            font-weight: 800;
            margin-left: auto;
            color: var(--text-main);
        }
        
        .sim-hist-pct {
            font-size: 0.85rem;
            font-weight: 700;
            padding: 4px 8px;
            border-radius: 6px;
            margin-left: 16px;
        }
        .bg-success-light { background: #dcfce7; color: var(--success); }
        .bg-warning-light { background: #fef3c7; color: var(--warning); }
        .bg-danger-light { background: #fee2e2; color: var(--danger); }

        .sim-config-item { display: flex; justify-content: space-between; align-items: center; padding: 12px; border: 1px solid var(--border); border-radius: var(--radius-md); margin-bottom: 10px; background: var(--bg-body); }
        .sim-config-item label { margin: 0; font-weight: 600; flex: 1; color: var(--text-main); font-size: 0.95rem; }
        .sim-config-item input[type="number"] { width: 70px; margin-bottom: 0; padding: 8px; font-size: 0.9rem; text-align: center; }
        .subject-controls { display: flex; gap: 6px; align-items: center; }
        .subject-controls .btn-icon { width: 30px; height: 30px; font-size: 0.8rem; border: none; background: transparent; color: var(--text-muted); }
        .subject-controls .btn-icon:hover { background: var(--bg-body); }
        .topic-controls { display: flex; gap: 4px; align-items: center; }
        .topic-controls .btn-icon { width: 26px; height: 26px; font-size: 0.7rem; border: none; background: transparent; color: var(--text-muted); }
        .topic-controls .btn-icon:hover { background: var(--bg-body); }
        .draggable-item { cursor: move; padding: 12px; background: var(--bg-card); border: 1px solid var(--border); border-radius: var(--radius-sm); margin-bottom: 8px; display: flex; align-items: center; gap: 12px; transition: all 0.2s; }
        .draggable-item:hover { background: var(--bg-body); border-color: var(--primary); }
        .draggable-item.dragging { opacity: 0.5; background: var(--primary-light); }
        .drag-handle { color: var(--text-muted); cursor: move; padding: 4px; }
        .drag-handle:hover { color: var(--primary); }
        .topic-card-count { margin-right: 8px; font-size: 0.75rem; background: var(--primary); color: white; border: none; border-radius: 4px; padding: 2px 8px; cursor: pointer; transition: all 0.2s; }
        .topic-card-count:hover { background: var(--primary-hover); transform: scale(1.05); }
        #link-topic-unlink-btn { background: var(--danger); color: white; border: none; }
        #link-topic-unlink-btn:hover { background: #dc2626; }
        .dashboard-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; margin-bottom: 12px; }
        .welcome-card { background: linear-gradient(135deg, var(--primary), var(--secondary)); color: white; border: none; grid-column: 1 / -1; display: flex; flex-direction: column; justify-content: center; min-height: 160px; }
        .welcome-card h2 { font-size: 1.8rem; margin-bottom: 8px; }
        .stat-widget { display: flex; align-items: center; gap: 16px; }
        .stat-icon { width: 50px; height: 50px; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; flex-shrink: 0; }
        .stat-info strong { font-size: 1.5rem; color: var(--text-main); font-weight: 800; }
        #dash-mini-chart { display: flex; justify-content: space-between; align-items: flex-end; height: 160px; padding-top: 20px; width: 100%; }
        .chart-col { display: flex; flex-direction: column; align-items: center; gap: 8px; flex: 1; }
        .chart-bar-container { flex: 1; display: flex; align-items: flex-end; justify-content: center; width: 100%; }
        .chart-bar { width: 12px; border-radius: 6px; transition: height 0.5s ease; min-height: 4px; }
        .chart-label { font-size: 0.75rem; color: var(--text-muted); font-weight: 600; }

        /* Specific Grid for Main Dashboard Row */
       /* GRID CORRIGIDO PARA TELA VERTICAL */
#dash-main-row {
    display: grid;
    /* Define colunas flexíveis: cria quantas colunas de no mínimo 300px couberem na tela */
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    grid-auto-flow: dense; /* Isso preenche os buracos brancos automaticamente */
    gap: 20px;
}

/* Força o widget "Novo Card" (o laranja grande) a ocupar espaço de forma inteligente */
/* Se a tela for larga, ele pode ocupar 2 espaços de altura se necessário */
.dashboard-grid > .card-box:nth-child(4) { 
    grid-row: span 2; 
}


        /* PERFORMANCE VIEW UPDATED STYLES (Horizontal & Larger) */
        .performance-layout {
            display: flex;
            flex-direction: column;
            gap: 20px;
            margin-bottom: 20px;
        }

        .performance-card {
            background: var(--bg-card);
            border-radius: var(--radius-lg);
            padding: 24px;
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--border);
            transition: all 0.3s ease;
            width: 100%; /* Force full width */
        }

        .performance-card:hover {
            box-shadow: var(--shadow-md);
            transform: translateY(-2px);
        }

        /* Metrics Horizontal Row */
        .performance-metrics {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); /* Larger minimum width */
            gap: 16px;
            margin-bottom: 24px;
        }

        .metric-box {
            background: var(--bg-body);
            border-radius: var(--radius-md);
            padding: 20px;
            text-align: center;
            border: 1px solid var(--border);
            transition: all 0.2s ease;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        .metric-box:hover {
            border-color: var(--primary);
            transform: translateY(-2px);
        }

        .metric-value {
            font-size: 2.2rem; /* Larger font */
            font-weight: 800;
            color: var(--primary);
            line-height: 1.1;
            margin-bottom: 8px;
        }

        .metric-label {
            font-size: 0.9rem;
            color: var(--text-muted);
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .category-progress-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); /* Bigger Cards */
            gap: 16px;
            margin-top: 16px;
        }

        .category-progress-item {
            background: var(--bg-body);
            border-radius: var(--radius-md);
            padding: 16px;
            border-left: 5px solid var(--primary);
        }

        /* FAB STYLES - MODIFIED TO EXPAND UPWARDS */
        .fab-container {
            position: fixed;
            bottom: 70px; /* Aumentado do original 50px */
            right: 30px;  /* Movido mais para a direita */
            z-index: 2000;
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 12px;
        }
        
        .fab-button {
            width: 60px;
            height: 60px;
            background: var(--primary);
            color: white;
            border-radius: 50%;
            border: none;
            box-shadow: var(--shadow-lg);
            font-size: 1.5rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: transform 0.3s, background 0.3s;
        }
        
        .fab-button:hover { transform: scale(1.1); background: var(--primary-hover); }
        .fab-button.active { transform: rotate(45deg); background: var(--danger); }
        
        .fab-menu {
            display: flex;
            flex-direction: column;
            gap: 12px;
            align-items: flex-end;
            margin-bottom: 12px;
            opacity: 0;
            pointer-events: none;
            transform: translateY(20px);
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        
        .fab-container.open .fab-menu {
            opacity: 1;
            pointer-events: all;
            transform: translateY(0);
        }
        
        .fab-item {
            display: flex;
            align-items: center;
            gap: 12px;
            background: transparent;
            border: none;
            cursor: pointer;
        }
        
        .fab-icon {
            width: 48px;
            height: 48px;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-muted);
            box-shadow: var(--shadow-md);
            transition: all 0.2s;
            font-size: 1.2rem;
        }
        
        .fab-item:hover .fab-icon {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }
        
        .fab-label {
            background: var(--text-main);
            color: var(--bg-card);
            padding: 4px 10px;
            border-radius: 4px;
            font-size: 0.8rem;
            font-weight: 600;
            opacity: 0;
            transition: opacity 0.2s;
            pointer-events: none;
            box-shadow: var(--shadow-sm);
        }
        
        .fab-container.open .fab-label { opacity: 1; }

        /* Sim History Table Styles */
        .sim-table-row {
            display: grid;
            grid-template-columns: 1.5fr 1fr 1fr 0.5fr;
            padding: 14px 10px;
            border-bottom: 1px solid var(--border);
            align-items: center;
            cursor: pointer;
            transition: background 0.2s;
        }
        .sim-table-row:hover { background: var(--bg-body); }
        .sim-table-header { font-weight: 700; color: var(--text-muted); font-size: 0.85rem; text-transform: uppercase; background: var(--bg-body); border-radius: 8px 8px 0 0; }
        
        /* Progress Indicator in Card */
        .card-progress-counter {
            position: absolute;
            top: 20px;
            right: 20px;
            background: var(--bg-body);
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 700;
            color: var(--text-muted);
            border: 1px solid var(--border);
        }

        /* --- NEW STYLES FOR TEMPLATES --- */
        .template-actions { display: flex; gap: 8px; margin-top: 8px; }
        .btn-template { 
            font-size: 0.8rem; padding: 6px 12px; border-radius: 6px; border: none; 
            cursor: pointer; display: flex; align-items: center; gap: 6px; 
            transition: transform 0.2s; color: white; font-weight: 600;
        }
        .btn-save-tmpl { background: var(--info); }
        .btn-load-tmpl { background: var(--success); }
        .btn-template:hover { transform: translateY(-2px); opacity: 0.9; }
        
        .template-item { 
            display: flex; justify-content: space-between; align-items: center; 
            padding: 12px; border: 1px solid var(--border); border-radius: 8px; 
            margin-bottom: 8px; background: var(--bg-card); cursor: pointer;
            transition: background 0.2s;
        }
        .template-item:hover { border-color: var(--primary); background: var(--bg-body); }
        .template-list { max-height: 300px; overflow-y: auto; margin-top: 10px; }

        @media (max-width: 900px) {
    /* Ajuste INTELIGENTE: Só cria 2 colunas se realmente couberem */
    #dash-main-row { 
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); 
    }
    
    .performance-metrics { grid-template-columns: repeat(2, 1fr); }
    .pomodoro-layout { grid-template-columns: 1fr; }
}

        @media (max-width: 768px) {
            .sidebar { display: none; }
            .bottom-nav { display: flex; }
            .main-content { padding: 20px 16px; margin-bottom: 80px; }
            .card-box { padding: 24px; }
            .file-actions { opacity: 1; }
            .topic-card-count { font-size: 0.7rem; padding: 1px 6px; }
            .create-grid { grid-template-columns: 1fr; }
            #dash-main-row { grid-template-columns: 1fr; }
            .performance-metrics { grid-template-columns: 1fr; }
            .category-progress-grid { grid-template-columns: 1fr; }
            /* FAB Mobile Adjustment */
            .fab-container { bottom: 85px; right: 20px; }
            .hero-header-card { flex-direction: column; align-items: flex-start; }
            .hero-actions { width: 100%; justify-content: space-between; margin-top: 12px; }
            .banner-period-btn { flex: 1; text-align: center; }
            .pomodoro-layout { grid-template-columns: 1fr; }
            .floating-timer { bottom: 92px; right: 90px; }
            .sim-table-row { grid-template-columns: 1fr 1fr 0.5fr; } /* Hide score details on small mobile maybe */
        }
    
/* --- LOGIN NOVO (ISOLADO, ESTILIZADO E CORRIGIDO) --- */

/* Wrapper principal */
#auth-wrapper {
    position: fixed;
    top: 0; left: 0;
    width: 100vw;
    height: 100vh;
    background: #fff;
    z-index: 99999;
    padding: 0;
    margin: 0;
    display: block;
    font-family: 'Inter', sans-serif;
}

#auth-wrapper.hidden {
    display: none !important;
}

.auth-split {
    display: flex;
    width: 100%;
    height: 100%;
}

/* Lado Esquerdo (Formulário) */
.auth-left {
    flex: 1;
    background: #ffffff;
    display: flex;
    flex-direction: column;
    justify-content: center;
    padding: 60px;
    height: 100%;
}

.auth-card--left {
    width: 100%;
    max-width: 420px;
    margin: 0 auto;
}

/* Estilos Visuais */
.auth-header-new { text-align: left; margin-bottom: 30px; }
.auth-logo-new { font-size: 2.5rem; color: var(--primary); margin-bottom: 20px; }
.auth-title { font-size: 2.2rem; font-weight: 800; color: #1e293b; margin: 0 0 10px 0; letter-spacing: -1px; line-height: 1.2; }
.auth-subtitle { font-size: 1.1rem; color: #64748b; font-weight: 500; margin: 0; }

/* Mensagem de Erro (NOVO) */
.error-message {
    background-color: #fef2f2;
    border: 1px solid #fee2e2;
    color: #b91c1c;
    padding: 14px 16px;
    border-radius: 8px;
    font-size: 0.95rem;
    font-weight: 600;
    margin-bottom: 24px;
    display: none;
    align-items: center;
    gap: 10px;
    box-shadow: 0 2px 4px rgba(239, 68, 68, 0.1);
}
.error-message i { font-size: 1.1rem; }
.error-message:not(:empty) { display: flex; animation: fadeIn 0.3s ease-out; }

/* Inputs */
.input-group { margin-bottom: 24px; text-align: left; }
.input-group label { display: block; font-size: 0.9rem; font-weight: 700; color: #334155; margin-bottom: 8px; }
.input-group input {
    width: 100%; padding: 16px; font-size: 1rem; background: #f8fafc;
    border: 2px solid #e2e8f0; border-radius: 12px; transition: all 0.3s ease;
    color: #334155; box-sizing: border-box;
}
.input-group input:focus { background: #fff; border-color: var(--primary); box-shadow: 0 0 0 4px var(--primary-light); outline: none; }

/* Botão */
.btn-full {
    width: 100%; padding: 16px; font-size: 1.1rem; font-weight: 700; border-radius: 12px;
    margin-top: 10px; background: var(--primary); color: white; border: none; cursor: pointer;
    transition: transform 0.2s, background 0.2s; box-shadow: 0 4px 12px rgba(237, 132, 50, 0.25);
}
.btn-full:hover { background: var(--primary-hover); transform: translateY(-2px); }

/* Links */
.form-actions { display: flex; justify-content: flex-end; margin-bottom: 20px; }
.auth-link-sm { font-size: 0.9rem; color: var(--primary); font-weight: 600; cursor: pointer; }
.auth-footer-box { margin-top: 40px; text-align: center; color: #94a3b8; font-size: 0.95rem; }
.auth-link-bold { color: var(--primary); font-weight: 700; cursor: pointer; }

/* Lado Direito (Imagem) */
/* =========================
   LOGIN - LADO DIREITO (SHOWCASE)
   ========================= */

.auth-right{
  flex: 1.3;
  position: relative;
  height: 100%;
  overflow: hidden;

  /* Fundo suave e moderno */
  background:
    radial-gradient(1200px 700px at 18% 20%, rgba(237, 132, 50, 0.16), transparent 55%),
    radial-gradient(900px 600px at 82% 30%, rgba(59, 130, 246, 0.16), transparent 55%),
    linear-gradient(135deg, #f8fafc 0%, #eff6ff 55%, #f1f5f9 100%);

  display: flex;
  align-items: center;
  justify-content: center;
}

/* Remove a “foto” antiga que era aplicada via pseudo-elemento */
.auth-right:before{
  content: none !important;
}

/* Container geral do showcase (Compactado) */
.auth-showcase {
  position: relative;
  width: 100%;
  max-width: 760px;
  padding: 20px; /* Padding menor */
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center; /* Centraliza ao invés de space-between para juntar */
  gap: 10px; /* Gap pequeno para aproximar os blocos */
  height: 100%;
}

/* Cabeçalho */
.auth-showcase-header {
  position: relative;
  z-index: 5;
  text-align: center;
  max-width: 700px;
  margin-top: 0;
  margin-bottom: 5px; /* Margem mínima */
}

.auth-showcase-title {
  font-size: 2.8rem; /* Aumentado para destaque (era 2.2rem) */
  font-weight: 900;
  color: #0f172a;
  letter-spacing: -1.5px;
  margin-bottom: 8px;
  line-height: 1.1;
}

.auth-showcase-subtitle {
  font-size: 1.1rem;
  color: #64748b;
  font-weight: 600;
  max-width: 500px;
  margin: 0 auto;
  line-height: 1.4;
}

/* Canvas dos Cards (Altura reduzida para puxar o footer) */
.auth-showcase-canvas {
  position: relative;
  width: 100%;
  max-width: 700px;
  height: 480px; /* Reduzi de 500px para 420px para juntar as pontas */
  z-index: 2;
  margin: 10px 0; /* Espaçamento controlado */
}

/* Rodapé */
.auth-showcase-footer {
  position: relative;
  z-index: 10;
  width: 100%;
  max-width: 620px;
  background: rgba(255, 255, 255, 0.65);
  border: 1px solid rgba(255, 255, 255, 0.6);
  backdrop-filter: blur(12px);
  border-radius: 14px;
  padding: 10px 20px;
  display: flex;
  align-items: center;
  justify-content: space-between;
  box-shadow: 0 4px 24px rgba(0, 0, 0, 0.04);
  margin-bottom: 0; /* Sem margem extra no fundo */
}


.footer-info {
  display: flex;
  align-items: center;
  gap: 12px;
}

.info-badge {
  background: #f59e0b;
  color: white;
  font-size: 0.7rem;
  font-weight: 800;
  padding: 4px 8px;
  border-radius: 6px;
  letter-spacing: 0.5px;
  text-transform: uppercase;
}

.info-text {
  font-size: 0.85rem;
  color: #475569;
  font-weight: 600;
}

.footer-actions {
  display: flex;
  align-items: center;
  gap: 16px;
}

.btn-download-win {
  display: flex;
  align-items: center;
  gap: 8px;
  background: #1e293b;
  color: white;
  text-decoration: none;
  font-size: 0.85rem;
  font-weight: 700;
  padding: 8px 16px;
  border-radius: 8px;
  transition: all 0.2s ease;
}

.btn-download-win:hover {
  background: var(--primary);
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(237, 132, 50, 0.3);
  color: white;
}

.coming-soon {
  display: flex;
  align-items: center;
  gap: 8px;
  font-size: 0.8rem;
  color: #94a3b8;
  font-weight: 600;
}


/* Card base */
.feature-card{
  position: absolute;
  width: 290px;
  border-radius: 20px;
  background: rgba(255,255,255,0.82);
  border: 1px solid rgba(255,255,255,0.60);
  box-shadow: 0 22px 55px -16px rgba(15, 23, 42, 0.18);
  backdrop-filter: blur(12px);
  padding: 20px;
  transition: transform 0.28s cubic-bezier(0.34, 1.56, 0.64, 1), box-shadow 0.28s ease, border-color 0.28s ease;
}

.feature-card:hover{
  transform: translateY(-6px) scale(1.03) !important;
  z-index: 10;
  border-color: rgba(237, 132, 50, 0.35);
  box-shadow: 0 26px 70px -18px rgba(15, 23, 42, 0.22);
}

/* Topo do card */
.fc-top{
  display: flex;
  align-items: center;
  gap: 12px;
  margin-bottom: 16px;
}

.fc-icon{
  width: 42px;
  height: 42px;
  border-radius: 14px;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  background: rgba(255,255,255,0.85);
  border: 1px solid rgba(148,163,184,0.35);
  box-shadow: 0 6px 16px rgba(15, 23, 42, 0.06);
  font-size: 1.25rem;
}

.fc-title{
  font-size: 1.06rem;
  font-weight: 900;
  color: #0f172a;
  letter-spacing: -0.3px;
}

/* Linhas “skeleton” */
.fc-line{
  height: 10px;
  border-radius: 999px;
  background: rgba(148,163,184,0.35);
  margin-bottom: 10px;
}
.fc-line.w-90{ width: 90%; }
.fc-line.w-85{ width: 85%; }
.fc-line.w-75{ width: 75%; }
.fc-line.w-70{ width: 70%; }
.fc-line.w-60{ width: 60%; }
.fc-line.w-55{ width: 55%; }

/* Chip */
.fc-chip{
  display: inline-block;
  margin-top: 8px;
  padding: 6px 10px;
  border-radius: 999px;
  font-size: 0.8rem;
  font-weight: 900;
  color: #0f172a;
  background: rgba(16,185,129,0.12);
  border: 1px solid rgba(16,185,129,0.22);
}
.fc-chip.alt{
  background: rgba(59,130,246,0.12);
  border: 1px solid rgba(59,130,246,0.22);
}

/* Pomodoro ring */
.pomo-ring{
  width: 132px;
  height: 132px;
  border-radius: 50%;
  margin: 10px auto 14px;
  background: conic-gradient(var(--primary) 0 72%, rgba(148,163,184,0.35) 72% 100%);
  display: grid;
  place-items: center;
  animation: ringPulse 2.8s ease-in-out infinite;
}
@keyframes ringPulse{
  0%, 100% { transform: scale(1); filter: saturate(1); }
  50% { transform: scale(1.03); filter: saturate(1.12); }
}
.pomo-ring-inner{
  width: 104px;
  height: 104px;
  border-radius: 50%;
  background: rgba(255,255,255,0.92);
  border: 1px solid rgba(148,163,184,0.35);
  box-shadow: inset 0 2px 12px rgba(15,23,42,0.06);
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
}
.pomo-time{
  font-size: 1.35rem;
  font-weight: 900;
  letter-spacing: 0.4px;
  color: #0f172a;
}
.pomo-label{
  margin-top: 4px;
  font-size: 0.75rem;
  font-weight: 900;
  color: #64748b;
  text-transform: uppercase;
}

/* Agenda (linhas tipo checklist) */
.agenda-rows{
  display: flex;
  flex-direction: column;
  gap: 10px;
  margin: 8px 0 10px;
}
.agenda-row{
  display: flex;
  align-items: center;
  gap: 10px;
}
.agenda-check{
  width: 18px;
  height: 18px;
  border-radius: 50%;
  border: 2px solid rgba(148,163,184,0.55);
  background: transparent;
}
.agenda-check.active{
  background: var(--primary);
  border-color: var(--primary);
}
.agenda-line{
  height: 8px;
  width: 100%;
  border-radius: 999px;
  background: rgba(148,163,184,0.30);
}
.agenda-line.short{ width: 62%; }

/* Performance (barras visíveis) */
.stat-bars{
  height: 90px;
  margin: 10px 0 12px;
  padding: 0 8px;
  display: flex;
  align-items: flex-end;
  justify-content: space-between;
}
.stat-bar{
  width: 14px;
  border-radius: 8px;
  background: rgba(148,163,184,0.45);
  transform-origin: bottom;
  animation: growBar 1.3s ease-out both;
}
@keyframes growBar{
  from { transform: scaleY(0.12); opacity: 0.75; }
  to { transform: scaleY(1); opacity: 1; }
}
.stat-bar.h-40{ height: 40%; }
.stat-bar.h-55{ height: 55%; }
.stat-bar.h-60{ height: 60%; }
.stat-bar.h-70{ height: 70%; }
.stat-bar.h-85{ height: 85%; }
.stat-bar.active{
  background: linear-gradient(to top, var(--primary), #fbbf24);
  box-shadow: 0 10px 22px rgba(237, 132, 50, 0.18);
}

/* Posições dos cards */
.feature-card.fc-1{ top: 10px; left: 10px; transform: rotate(-3deg); animation: floatA 6s ease-in-out infinite; }
.feature-card.fc-2{ top: 35px; right: 10px; transform: rotate(2deg);  animation: floatB 7.2s ease-in-out infinite; z-index: 3; }
.feature-card.fc-3{ bottom: 45px; left: 35px; transform: rotate(2deg); animation: floatB 7.8s ease-in-out infinite reverse; }
.feature-card.fc-4{ bottom: 15px; right: 5px; transform: rotate(-2deg); animation: floatA 6.6s ease-in-out infinite reverse; z-index: 4; }

@keyframes floatA{
  0%, 100% { transform: translateY(0) rotate(-3deg); }
  50% { transform: translateY(-12px) rotate(-2deg); }
}
@keyframes floatB{
  0%, 100% { transform: translateY(0) rotate(2deg); }
  50% { transform: translateY(-14px) rotate(3deg); }
}

/* Orbs de brilho */
.glow-orb{
  position: absolute;
  border-radius: 50%;
  filter: blur(46px);
  opacity: 0.7;
  z-index: 1;
  pointer-events: none;
}
.glow-orb.o1{
  width: 320px;
  height: 320px;
  left: -70px;
  top: 160px;
  background: rgba(237, 132, 50, 0.26);
  animation: orbMove 7.6s ease-in-out infinite;
}
.glow-orb.o2{
  width: 360px;
  height: 360px;
  right: -120px;
  top: 30px;
  background: rgba(59, 130, 246, 0.24);
  animation: orbMove 9s ease-in-out infinite reverse;
}
@keyframes orbMove{
  0%, 100% { transform: translate(0, 0); }
  50% { transform: translate(18px, -14px); }
}

/* Mantém o comportamento mobile do seu arquivo (imagem some) */
@media (max-width: 900px){
  .auth-right{ display: none !important; }
}


/* RESPONSIVIDADE (Mobile) - Imagem some, form ocupa tudo */
@media (max-width: 900px) {
    .auth-split { display: block; }
    .auth-right { display: none !important; } /* AQUI ESCONDE A IMAGEM */
    .auth-left { width: 100%; height: 100vh; padding: 24px; align-items: center; }
    .auth-card--left { max-width: 100%; margin: 0; }
    .auth-title { font-size: 2rem; }
}

/* CORREÇÕES GLOBAIS DO APP */
body { margin: 0; padding: 0; overflow-x: hidden; }
#app-content { display: flex; width: 100%; height: 100vh; overflow: hidden; }
.sidebar { height: 100vh; position: relative; z-index: 100; flex-shrink: 0; }
.main-content { flex: 1; height: 100vh; overflow-y: auto; position: relative; padding: 24px 32px; }




        /* SCROLLBAR & REST OF STYLES */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        .dark-mode ::-webkit-scrollbar-thumb { background: #475569; }

        /* SIDEBAR APRIMORADA - ALWAYS COLLAPSED */
        .sidebar {
            width: var(--sidebar-width);
            background: var(--bg-nav);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            padding: 24px 12px; 
            z-index: 100;
            padding-top: 40px;
            transition: background 0.3s;
            position: relative;
        }

        .nav-links { display: flex; flex-direction: column; gap: 8px; flex: 1; margin-top: 20px; overflow: hidden; }

        .nav-item {
            display: flex; align-items: center; justify-content: center; /* Centered for icons */
            gap: 12px; padding: 14px 0;
            border-radius: var(--radius-sm); color: var(--text-muted);
            font-weight: 600; cursor: pointer; transition: all 0.2s;
            border: none; background: none; width: 100%; 
            font-size: 0.95rem; white-space: nowrap; 
            position: relative;
        }

        .nav-item:hover { background: var(--primary-light); color: var(--primary); }
        .nav-item.active { background: var(--primary); color: white; box-shadow: var(--shadow-sm); }
        
        .nav-item i { 
            min-width: 24px; 
            text-align: center; 
            font-size: 1.1rem; 
            margin: 0;
        }
        
        /* Tooltip style for Sidebar Legend */
        .nav-item span { 
            position: absolute;
            left: 70px;
            background: var(--text-main);
            color: var(--bg-card);
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 0.85rem;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s ease-in-out;
            box-shadow: var(--shadow-md);
            z-index: 200;
            white-space: nowrap;
        }

        .nav-item:hover span { opacity: 1; }

        /* BOTTOM NAV */
        .bottom-nav {
            display: none; position: fixed; bottom: 0; left: 0; width: 100%;
            background: var(--bg-nav); height: var(--nav-height); border-top: 1px solid var(--border);
            z-index: 1000; justify-content: space-around; align-items: center;
            padding-bottom: env(safe-area-inset-bottom);
            transition: background 0.3s;
        }

        .bottom-nav-item {
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            color: var(--text-muted); font-size: 0.75rem; font-weight: 600; gap: 4px;
            background: none; border: none; width: 100%; height: 100%;
        }
        .bottom-nav-item.active { color: var(--primary); }
        .bottom-nav-item i { font-size: 1.4rem; margin-bottom: 2px; }

        /* MAIN AREA */
        .main-content {
            flex: 1; height: 100%; overflow-y: auto; overflow-x: hidden;
            padding: 24px 32px; position: relative;
        }

        .page-header { margin-bottom: 24px; display: flex; align-items: center; justify-content: space-between; }
        #page-title-display { font-weight: 800; font-size: 1.5rem; color: var(--text-main); letter-spacing: -0.5px; }

        .header-actions { display: flex; gap: 12px; align-items: center; }

        .header-btn-icon {
            width: 40px; height: 40px; border-radius: 50%; border: 1px solid var(--border);
            background: var(--bg-card); color: var(--text-main); display: flex; align-items: center;
            justify-content: center; cursor: pointer; font-size: 1.1rem;
            transition: all 0.2s;
        }
        .header-btn-icon:hover {
            border-color: var(--primary);
            color: var(--primary);
            background: var(--primary-light);
        }

        .view-section { max-width: 1000px; margin: 0 auto; padding-bottom: 100px; animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }


        .card-box {
            background: var(--bg-card); border-radius: var(--radius-lg);
            padding: 24px; box-shadow: var(--shadow-sm); border: 1px solid var(--border);
            margin-bottom: 20px; transition: background 0.3s, border 0.3s;
        }

        /* Fix spacing inside grids */
        .dashboard-grid .card-box { margin-bottom: 0; height: 100%; }

        h3 { font-size: 1.15rem; font-weight: 700; color: var(--text-main); margin-bottom: 16px; }

        /* BUTTONS & INPUTS */
        .action-btn {
            background: var(--primary); color: white; border: none; padding: 14px 24px;
            border-radius: var(--radius-md); font-weight: 600; font-size: 1rem;
            cursor: pointer; display: inline-flex; align-items: center; justify-content: center;
            gap: 8px; width: 100%; transition: background 0.2s;
        }
        .action-btn:hover { background: var(--primary-hover); }
        .action-btn:active { transform: scale(0.98); }
        .action-btn:disabled { opacity: 0.6; cursor: not-allowed; transform: none; }
        
        .btn-outline { background: var(--bg-card); border: 1px solid var(--border); color: var(--text-main); cursor: pointer; border-radius: var(--radius-md); padding: 12px 20px; font-weight: 600; font-size: 0.95rem; }
        .btn-outline:hover { background: var(--bg-body); border-color: var(--text-muted); }
        .btn-danger { background: var(--danger); color: white; border: none;}
        .btn-sm { padding: 8px 16px; font-size: 0.85rem; width: auto; border-radius: 8px; }
        .btn-icon { width: 38px; height: 38px; border-radius: 50%; padding: 0; display: flex; align-items: center; justify-content: center; border: 1px solid var(--border); background: var(--bg-card); cursor: pointer; color: var(--text-muted); font-size: 1.1rem; }
        .btn-icon:hover { color: var(--primary); border-color: var(--primary); background: var(--primary-light); }
        .btn-back { border: none; padding: 10px 0; margin-bottom: 16px; color: var(--text-muted); font-size: 1.1rem; display: flex; align-items: center; gap: 8px; background: transparent; cursor: pointer; }
        .btn-back:hover { color: var(--primary); }

        input, select, textarea {
            width: 100%; padding: 14px; border-radius: var(--radius-md);
            border: 1px solid var(--border); background: var(--input-bg);
            font-family: inherit; font-size: 1.05rem; margin-bottom: 16px; color: var(--text-main);
        }
        
        /* Remove default focus outline and add custom style */
        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px var(--primary-light);
        }

        .editor-toolbar { display: flex; gap: 8px; margin-bottom: 12px; padding: 4px; background: var(--bg-body); border-radius: 8px; border: 1px solid var(--border); width: fit-content; }
        
        /* --- SEARCH DROPDOWN STYLES --- */
        .search-container { position: relative; width: 100%; margin-bottom: 12px; }
        .search-results-list {
            position: absolute;
            top: 100%;
            left: 0;
            width: 100%;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
            max-height: 200px;
            overflow-y: auto;
            z-index: 2500;
            box-shadow: var(--shadow-lg);
            display: none;
        }
        .search-result-item {
            padding: 10px 14px;
            border-bottom: 1px solid var(--bg-body);
            cursor: pointer;
            transition: background 0.2s;
            font-size: 0.9rem;
            color: var(--text-main);
        }
        .search-result-item:last-child { border-bottom: none; }
        .search-result-item:hover { background: var(--bg-body); color: var(--primary); }
        .search-result-item strong { display: block; font-size: 0.95rem; }
        .search-result-item span { font-size: 0.8rem; color: var(--text-muted); }

        /* --- HERO HEADER STYLES --- */
        .hero-header-card {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            border: none;
            overflow: hidden;
            position: relative;
            margin-bottom: 24px;
            padding: 24px;
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-md);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .hero-bg-icon {
            position: absolute; right: -20px; bottom: -30px; font-size: 10rem; opacity: 0.1; pointer-events: none;
        }
        .hero-content {
            position: relative; z-index: 2; width: 100%; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 16px;
        }
        .hero-title {
            color: white; margin: 0; font-size: 1.3rem; font-weight: 800;
        }
        .hero-subtitle {
            opacity: 0.9; margin-top: 4px; font-size: 0.9rem; font-weight: 500;
        }
        .hero-actions {
            display: flex;
            background: rgba(255,255,255,0.2);
            padding: 4px;
            border-radius: 12px;
            gap: 4px;
        }
        .banner-period-btn {
            background: transparent;
            border: none;
            color: rgba(255,255,255,0.8);
            padding: 8px 16px;
            border-radius: 8px;
            font-weight: 600;
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.2s;
        }
        .banner-period-btn:hover {
            background: rgba(255,255,255,0.1);
            color: white;
        }
        .banner-period-btn.active {
            background: white;
            color: var(--primary);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        /* --- STYLES FOR UNIFIED STUDY VIEW --- */
        .study-nav-container {
            display: flex;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: var(--radius-lg);
            padding: 6px;
            margin-bottom: 24px;
            gap: 6px;
        }

        .study-nav-btn {
            flex: 1;
            padding: 12px;
            border: none;
            background: transparent;
            color: var(--text-muted);
            border-radius: var(--radius-md);
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .study-nav-btn:hover {
            background: var(--bg-body);
            color: var(--text-main);
        }

        .study-nav-btn.active {
            background: var(--primary);
            color: white;
            box-shadow: var(--shadow-sm);
        }

        /* --- POMODORO STYLES --- */
        .pomodoro-layout { display: grid; grid-template-columns: 1fr 1fr; gap: 24px; }
        .timer-card { text-align: center; display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 400px; }
        .pomo-tabs { display: flex; background: var(--bg-body); padding: 4px; border-radius: 30px; margin-bottom: 30px; width: fit-content; border: 1px solid var(--border); }
        .pomo-tab { padding: 8px 20px; border-radius: 25px; cursor: pointer; border: none; background: transparent; color: var(--text-muted); font-weight: 600; transition: all 0.3s; }
        .pomo-tab.active { background: var(--bg-card); color: var(--primary); box-shadow: var(--shadow-sm); }
        
        .timer-display { font-size: 5rem; font-weight: 800; font-feature-settings: "tnum"; font-variant-numeric: tabular-nums; color: var(--text-main); margin: 20px 0; line-height: 1; }
        
        .timer-controls { display: flex; gap: 16px; align-items: center; margin-bottom: 30px; }
        .btn-pomo-main { width: 70px; height: 70px; border-radius: 50%; font-size: 1.5rem; display: flex; align-items: center; justify-content: center; background: var(--primary); color: white; border: none; cursor: pointer; transition: transform 0.2s, background 0.2s; box-shadow: var(--shadow-md); }
        .btn-pomo-main:hover { transform: scale(1.1); background: var(--primary-hover); }
        .btn-pomo-sec { width: 50px; height: 50px; border-radius: 50%; background: var(--bg-body); color: var(--text-muted); border: 1px solid var(--border); display: flex; align-items: center; justify-content: center; font-size: 1rem; cursor: pointer; transition: all 0.2s; }
        .btn-pomo-sec:hover { background: var(--bg-card); color: var(--primary); border-color: var(--primary); }

        .pomo-history-list { display: flex; flex-direction: column; gap: 10px; max-height: 400px; overflow-y: auto; }
        .pomo-item { display: flex; align-items: center; justify-content: space-between; padding: 14px 16px; background: var(--bg-card); border: 1px solid var(--border); border-radius: var(--radius-md); transition: all 0.2s; }
        .pomo-item:hover { border-color: var(--primary); transform: translateX(2px); }
        .pomo-info h4 { margin: 0; font-size: 0.95rem; color: var(--text-main); }
        .pomo-info span { font-size: 0.8rem; color: var(--text-muted); display: block; margin-top: 2px; }
        .pomo-actions { display: flex; gap: 8px; }
        .tag-pomo { background: var(--primary-light); color: var(--primary); }
        .tag-short { background: #dbeafe; color: var(--info); }
        .tag-long { background: #d1fae5; color: var(--success); }

        /* FLOATING TIMER WIDGET - Updated Position and Layout */
        .floating-timer {
            position: fixed;
            bottom: 77px; /* Align vertical center with FAB (bottom ~70px + ~1/2 height) */
            right: 105px; /* Position to the left of FAB */
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: 10px 20px;
            border-radius: 30px;
            box-shadow: var(--shadow-lg);
            display: flex;
            flex-direction: row; 
            align-items: center;
            justify-content: center;
            border: 1px solid var(--border);
            z-index: 1900;
            transform: translateX(200%);
            transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            pointer-events: none; /* Read only */
        }
        .dark-mode .floating-timer { background: rgba(30, 41, 59, 0.95); }
        .floating-timer.visible { transform: translateX(0); }
        
        .float-time { font-weight: 800; font-variant-numeric: tabular-nums; color: var(--primary); font-size: 1.5rem; line-height: 1; }

        /* --- NEW CREATE CARD STYLES REFINED --- */
        .create-container {
            display: flex;
            flex-direction: column;
            gap: 24px;
        }

        .create-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .create-label {
            font-size: 0.75rem;
            font-weight: 700;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
            display: block;
        }

        .rich-editor {
            min-height: 120px;
            padding: 20px;
            background: var(--input-bg);
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
            font-size: 1.1rem;
            line-height: 1.5;
            transition: all 0.2s;
            color: var(--text-main);
        }

        .rich-editor:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px var(--primary-light);
        }

        .answer-group {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .answer-block {
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
            padding: 12px 16px;
            background: var(--bg-card);
            position: relative;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .answer-block:focus-within {
            border-color: var(--primary);
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
            transform: translateY(-1px);
        }

        .answer-block input {
            border: none;
            background: transparent;
            padding: 8px 0;
            margin: 0;
            font-size: 1rem;
            width: 100%;
            color: var(--text-main);
            box-shadow: none !important; /* Force remove default focus shadow on inner input */
        }
        
        .answer-block input:focus {
             outline: none;
             box-shadow: none;
             border: none;
        }

        .answer-block.correct-answer {
            background: linear-gradient(to right, rgba(16, 185, 129, 0.05), transparent);
            border-left: 4px solid var(--success);
        }
        
        .answer-block.correct-answer:focus-within {
            border-color: var(--success);
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.1);
        }

        .answer-block.wrong-answer {
            border-left: 4px solid var(--border);
        }
        
        .answer-block.wrong-answer:focus-within {
            border-left-color: var(--danger);
            border-color: var(--text-muted);
        }

        .answer-icon {
            font-size: 1.1rem;
            color: var(--text-muted);
            opacity: 0.5;
            flex-shrink: 0;
        }
        
        .correct-answer .answer-icon { color: var(--success); opacity: 1; }

        /* --- FLASHCARDS & STUDY --- */
        .flashcard-display {
            background: var(--bg-card); border-radius: var(--radius-lg); padding: 40px 24px;
            text-align: left; box-shadow: var(--shadow-lg); border: 1px solid var(--border);
            position: relative; overflow: hidden;
        }
        .question-text {
            font-size: 1.25rem; font-weight: 600; color: var(--text-main);
            margin: 16px 0 24px; line-height: 1.6; text-align: left;
        }
        .option-btn {
            background: var(--bg-card); border: 2px solid var(--border); padding: 18px;
            border-radius: var(--radius-md); font-size: 1.05rem; color: var(--text-main);
            font-weight: 500; text-align: left; cursor: pointer; transition: all 0.2s;
            margin-bottom: 12px; width: 100%;
            display: flex; gap: 8px; align-items: flex-start;
        }
        .option-btn:hover { border-color: var(--primary); transform: translateX(4px); }
        .option-btn:disabled { cursor: default; transform: none !important; }
        .option-btn strong { color: var(--primary); margin-right: 4px; }
        
        .option-btn.selected { 
            background: var(--bg-body); 
            border-color: var(--info); 
            box-shadow: 0 0 0 1px var(--info);
        }

        .option-btn.correct { background: rgba(16, 185, 129, 0.1); border-color: var(--success); color: var(--success); }
        .option-btn.wrong { background: rgba(239, 68, 68, 0.1); border-color: var(--danger); color: var(--danger); }
        
        /* List Styles */
        .card-list-item {
            background: var(--bg-card); border-radius: var(--radius-md); padding: 20px;
            border: 1px solid var(--border); box-shadow: var(--shadow-sm);
            margin-bottom: 16px; transition: transform 0.2s, box-shadow 0.2s;
            display: flex; flex-direction: column; gap: 12px;
        }
        .card-list-item:hover { transform: translateY(-2px); box-shadow: var(--shadow-md); border-color: var(--primary); }
        .card-meta { display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 8px; }
        .card-badge {
            font-size: 0.8rem; font-weight: 800; color: var(--primary);
            background: var(--primary-light); padding: 4px 10px; border-radius: 12px; text-transform: uppercase;
        }
        .next-review-badge { font-size: 0.8rem; font-weight: 600; color: var(--text-muted); display: flex; align-items: center; gap: 4px; }

        /* ID Badge Style */
        .id-badge {
            font-family: monospace; font-size: 0.75rem; background: var(--bg-body); 
            padding: 2px 6px; border-radius: 4px; color: var(--text-muted); border: 1px solid var(--border);
        }

        /* --- SYLLABUS, PERFORMANCE, NOTES, SCHEDULE (Kept same) --- */
        .syllabus-item { background: var(--bg-card); border: 1px solid var(--border); border-radius: var(--radius-md); padding: 20px; margin-bottom: 16px; cursor: pointer; transition: all 0.2s; display: flex; justify-content: space-between; align-items: center; }
        .syllabus-item:hover { transform: translateY(-2px); box-shadow: var(--shadow-md); border-color: var(--primary); }
        
        /* Refined Subject/Topic Styling */
        .subject-container { 
            background: var(--bg-card); 
            border: 1px solid var(--border);
            border-left: 4px solid var(--primary);
            border-radius: var(--radius-md); 
            margin-bottom: 20px; 
            overflow: hidden; 
            box-shadow: var(--shadow-sm);
            transition: box-shadow 0.2s;
        }
        .subject-container:hover {
            box-shadow: var(--shadow-md);
        }
        .subject-header { 
            padding: 18px 24px; 
            background: var(--bg-card); 
            border-bottom: 1px solid var(--bg-body); 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            cursor: pointer; 
            user-select: none; 
            transition: background 0.2s;
        }
        .subject-header:hover { background: var(--bg-body); }
        .subject-title { font-weight: 700; color: var(--text-main); font-size: 1rem; display: flex; align-items: center; gap: 10px; }
        
        .subject-progress { width: 100px; height: 8px; background: #e2e8f0; border-radius: 4px; overflow: hidden; margin-left: auto; margin-right: 16px; }
        .subject-progress-bar { height: 100%; background: var(--success); width: 0%; transition: width 0.5s ease; }
        
        .topic-list { padding: 0; background: var(--bg-card); }
        .topic-row { 
            display: flex; 
            align-items: center; 
            padding: 16px 24px; 
            border-bottom: 1px solid var(--bg-body); 
            transition: background 0.2s; 
        }
        .topic-row:last-child { border-bottom: none; }
        .topic-row:hover { background: var(--bg-body); }
        
        .topic-check { 
            width: 24px; height: 24px; 
            border: 2px solid var(--text-muted); 
            border-radius: 50%; /* Rounded checkbox */
            margin-right: 16px; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            cursor: pointer; 
            flex-shrink: 0; 
            color: white; 
            transition: all 0.2s; 
            font-size: 0.8rem;
        }
        .topic-row.done .topic-check { background: var(--success); border-color: var(--success); }
        .topic-row.done span { text-decoration: line-through; color: var(--text-muted); }
        
        .category-stat-item { display: flex; align-items: center; justify-content: space-between; padding: 16px 20px; border-bottom: 1px solid var(--bg-body); background: var(--bg-card); transition:background 0.2s; }
        .category-stat-item:last-child { border-bottom: none; }
        .category-stat-item:hover { background: var(--bg-body); }
        
        .cat-name { font-weight: 600; font-size: 1rem; color: var(--text-main); margin-bottom: 4px; }
        .cat-bar-bg { width: 100%; height: 8px; background: var(--bg-body); border-radius: 4px; overflow: hidden; }
        .cat-bar-fill { height: 100%; border-radius: 4px; transition: width 0.5s ease; }
        .cat-percent { font-weight: 700; font-size: 0.9rem; color: var(--text-main); min-width: 45px; text-align: right; margin-left: 10px; }
        .stats-summary-box { display: flex; justify-content: space-around; align-items: center; text-align: center; padding: 32px 16px; }
        .stat-big-item { flex: 1; }
        .stat-big-item .label { font-size: 0.9rem; opacity:0.8; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 8px; color:white; }
        .stat-big-item .value { font-size: 2.8rem; font-weight: 800; color: white; line-height: 1; }
        .stat-divider { width: 1px; height: 50px; background: rgba(255,255,255,0.3); margin: 0 10px; }
        
        .schedule-layout { display: flex; flex-direction: column; gap: 24px; }
        .task-section, .calendar-wrapper { background: var(--bg-card); border-radius: var(--radius-lg); padding: 24px; box-shadow: var(--shadow-sm); border: 1px solid var(--border); }
        
        /* UPDATED TASK LIST STYLES */
        .task-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 20px; }
        .task-list { display: flex; flex-direction: column; gap: 10px; min-height: 20px; /* Reduced min-height to fix whitespace */ }
        .task-item { 
            background: var(--bg-card); 
            border: 1px solid var(--border); 
            color: var(--text-main); 
            padding: 16px 20px; 
            border-radius: var(--radius-md); 
            display: flex; 
            align-items: center; 
            gap: 16px; 
            transition: all 0.2s;
            box-shadow: var(--shadow-sm);
        }
        .task-item:hover { border-color: var(--primary); transform: translateY(-2px); box-shadow: var(--shadow-md); }
        .task-check { 
            width: 24px; height: 24px; 
            border: 2px solid var(--text-muted); 
            border-radius: 50%; 
            display: flex; align-items: center; justify-content: center; 
            cursor: pointer; color: white; flex-shrink: 0;
            transition: all 0.2s;
        }
        .task-item.completed .task-check { background: var(--success); border-color: var(--success); }
        .task-item.completed span { text-decoration: line-through; color: var(--text-muted); }
        
        .schedule-grid-container { overflow-x: auto; position: relative; max-height: 600px; padding-bottom: 20px; }
        .modern-table { width: 100%; border-collapse: separate; border-spacing: 0; min-width: 900px; table-layout: fixed; border-radius: var(--radius-md); overflow: hidden; border: 1px solid var(--border); }
        .modern-table th { background: var(--bg-body); color: var(--text-muted); border-bottom: 1px solid var(--border); padding: 16px; position: sticky; top: 0; z-index: 20; font-weight: 700; text-transform: uppercase; font-size: 0.8rem; }
        .modern-table td { border-right: 1px solid var(--border); border-bottom: 1px solid var(--border); height: 70px; vertical-align: middle; padding: 4px; position: relative; background: var(--bg-card); transition: background 0.2s; }
        .modern-table td:hover { background: var(--bg-body); }
        .modern-table td.time-label { background: var(--bg-body); color: var(--text-muted); border-right: 1px solid var(--border); width: 80px; text-align: center; position: sticky; left: 0; z-index: 10; font-size: 0.8rem; font-weight: bold; }
        
        .event-block { height: 100%; width: 100%; border-radius: 6px; padding: 4px 8px; font-size: 0.75rem; font-weight: 600; color: white; box-shadow: 0 2px 4px rgba(0,0,0,0.05); cursor: pointer; display: flex; align-items: center; gap: 6px; overflow: hidden; white-space: nowrap; text-overflow: ellipsis; transition: transform 0.2s; }
        .event-block:hover { transform: scale(1.02); }
        .empty-cell-btn { position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; opacity: 0; color: var(--primary); font-size: 1.4rem; cursor: pointer; transition: opacity 0.2s; }
        td:hover .empty-cell-btn { opacity: 0.6; background: rgba(0,0,0,0.02); }
        
        .notes-breadcrumb { display: flex; align-items: center; gap: 8px; padding: 16px 20px; background: var(--bg-card); border: 1px solid var(--border); border-radius: var(--radius-md); margin-bottom: 24px; overflow-x: auto; white-space: nowrap; box-shadow: var(--shadow-sm); }
        .breadcrumb-item { color: var(--text-muted); font-size: 0.95rem; cursor: pointer; display: flex; align-items: center; gap: 8px; font-weight: 500; transition: color 0.2s; }
        .breadcrumb-item:hover { color: var(--primary); }
        .breadcrumb-item.active { color: var(--text-main); font-weight: 700; pointer-events: none; }
        
        .file-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: 20px; }
        .file-item { 
            background: var(--bg-card); 
            border: none; 
            border-radius: var(--radius-lg); 
            padding: 24px 16px; 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            text-align: center; 
            cursor: pointer; 
            position: relative; 
            transition: all 0.2s; 
            box-shadow: var(--shadow-sm); 
            aspect-ratio: 1/1; 
            justify-content: center; 
            border: 1px solid var(--border);
        }
        .file-item:hover { transform: translateY(-4px); box-shadow: var(--shadow-lg); border-color: var(--primary); }
        .file-icon { font-size: 3.5rem; margin-bottom: 16px; transition: transform 0.2s; }
        .file-item:hover .file-icon { transform: scale(1.1); }
        .file-name { font-size: 1rem; font-weight: 600; line-height: 1.3; overflow: hidden; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; color: var(--text-main); }
        .file-actions { position: absolute; top: 12px; right: 12px; display: flex; gap: 6px; opacity: 0; transition: opacity 0.2s; }
        .file-item:hover .file-actions { opacity: 1; }
        
        /* NEW: Study Control Bar (Buttons) */
        .study-controls-container {
            display: flex;
            flex-direction: column;
            gap: 16px;
            margin-top: 24px;
            padding-top: 20px;
            border-top: 1px solid var(--border);
        }
        
        .nav-buttons-row {
            display: flex;
            gap: 12px;
            justify-content: center;
        }

        .btn-study-rect {
            background: var(--bg-card);
            border: 1px solid var(--border);
            color: var(--text-muted);
            border-radius: 12px;
            padding: 12px 24px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.2s;
            flex: 1;
            justify-content: center;
            box-shadow: var(--shadow-sm);
        }
        
        .btn-study-rect:hover {
            border-color: var(--primary);
            color: var(--primary);
            background: var(--bg-body);
        }
        
        .btn-study-rect:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none !important;
        }

        .btn-study-confirm {
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 12px;
            padding: 16px 32px;
            font-size: 1.1rem;
            font-weight: 700;
            width: 100%;
            cursor: pointer;
            box-shadow: var(--shadow-md);
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        
        .btn-study-confirm:hover {
            background: var(--primary-hover);
            transform: translateY(-2px);
        }

        .sim-result-card {
            background: var(--bg-card);
            border-radius: var(--radius-lg);
            border: 1px solid var(--border);
            overflow: hidden;
            box-shadow: var(--shadow-md);
            margin-bottom: 24px;
        }

        .sim-result-header {
            padding: 30px;
            text-align: center;
            background: linear-gradient(135deg, var(--bg-body), var(--bg-card));
            border-bottom: 1px solid var(--border);
        }

        .sim-score-big {
            font-size: 4rem;
            font-weight: 800;
            color: var(--text-main);
            line-height: 1;
            margin-bottom: 4px;
        }

        .sim-score-label {
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--text-muted);
            font-weight: 600;
        }

        .sim-stats-row {
            display: flex;
            border-bottom: 1px solid var(--border);
        }

        .sim-stat-box {
            flex: 1;
            padding: 20px;
            text-align: center;
            border-right: 1px solid var(--border);
        }
        .sim-stat-box:last-child { border-right: none; }

        .sim-stat-val {
            font-size: 1.4rem;
            font-weight: 800;
            margin-bottom: 4px;
        }

        .sim-log-container {
            padding: 20px;
            background: var(--bg-body);
            max-height: 400px;
            overflow-y: auto;
        }

        .sim-log-item {
            background: var(--bg-card);
            padding: 16px;
            border-radius: var(--radius-md);
            margin-bottom: 12px;
            border: 1px solid var(--border);
            border-left: 4px solid var(--border);
            box-shadow: var(--shadow-sm);
        }

        .sim-log-item.correct { border-left-color: var(--success); }
        .sim-log-item.wrong { border-left-color: var(--danger); }
        
        /* NEW: Sim History Card List Style */
        .sim-history-card {
            display: flex;
            align-items: center;
            background: var(--bg-card);
            padding: 16px 20px;
            border-radius: var(--radius-md);
            border: 1px solid var(--border);
            margin-bottom: 12px;
            transition: all 0.2s;
            cursor: pointer;
        }
        .sim-history-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
            border-color: var(--primary);
        }
        
        .sim-hist-date {
            display: flex;
            flex-direction: column;
            margin-right: 20px;
        }
        .sim-hist-day { font-weight: 700; font-size: 1.1rem; color: var(--text-main); }
        .sim-hist-time { font-size: 0.8rem; color: var(--text-muted); }
        
        .sim-hist-score {
            font-size: 1.5rem;
            font-weight: 800;
            margin-left: auto;
            color: var(--text-main);
        }
        
        .sim-hist-pct {
            font-size: 0.85rem;
            font-weight: 700;
            padding: 4px 8px;
            border-radius: 6px;
            margin-left: 16px;
        }
        .bg-success-light { background: #dcfce7; color: var(--success); }
        .bg-warning-light { background: #fef3c7; color: var(--warning); }
        .bg-danger-light { background: #fee2e2; color: var(--danger); }

        .sim-config-item { display: flex; justify-content: space-between; align-items: center; padding: 12px; border: 1px solid var(--border); border-radius: var(--radius-md); margin-bottom: 10px; background: var(--bg-body); }
        .sim-config-item label { margin: 0; font-weight: 600; flex: 1; color: var(--text-main); font-size: 0.95rem; }
        .sim-config-item input[type="number"] { width: 70px; margin-bottom: 0; padding: 8px; font-size: 0.9rem; text-align: center; }
        .subject-controls { display: flex; gap: 6px; align-items: center; }
        .subject-controls .btn-icon { width: 30px; height: 30px; font-size: 0.8rem; border: none; background: transparent; color: var(--text-muted); }
        .subject-controls .btn-icon:hover { background: var(--bg-body); }
        .topic-controls { display: flex; gap: 4px; align-items: center; }
        .topic-controls .btn-icon { width: 26px; height: 26px; font-size: 0.7rem; border: none; background: transparent; color: var(--text-muted); }
        .topic-controls .btn-icon:hover { background: var(--bg-body); }
        .draggable-item { cursor: move; padding: 12px; background: var(--bg-card); border: 1px solid var(--border); border-radius: var(--radius-sm); margin-bottom: 8px; display: flex; align-items: center; gap: 12px; transition: all 0.2s; }
        .draggable-item:hover { background: var(--bg-body); border-color: var(--primary); }
        .draggable-item.dragging { opacity: 0.5; background: var(--primary-light); }
        .drag-handle { color: var(--text-muted); cursor: move; padding: 4px; }
        .drag-handle:hover { color: var(--primary); }
        .topic-card-count { margin-right: 8px; font-size: 0.75rem; background: var(--primary); color: white; border: none; border-radius: 4px; padding: 2px 8px; cursor: pointer; transition: all 0.2s; }
        .topic-card-count:hover { background: var(--primary-hover); transform: scale(1.05); }
        #link-topic-unlink-btn { background: var(--danger); color: white; border: none; }
        #link-topic-unlink-btn:hover { background: #dc2626; }
        .dashboard-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; margin-bottom: 12px; }
        .welcome-card { background: linear-gradient(135deg, var(--primary), var(--secondary)); color: white; border: none; grid-column: 1 / -1; display: flex; flex-direction: column; justify-content: center; min-height: 160px; }
        .welcome-card h2 { font-size: 1.8rem; margin-bottom: 8px; }
        .stat-widget { display: flex; align-items: center; gap: 16px; }
        .stat-icon { width: 50px; height: 50px; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; flex-shrink: 0; }
        .stat-info strong { font-size: 1.5rem; color: var(--text-main); font-weight: 800; }
        #dash-mini-chart { display: flex; justify-content: space-between; align-items: flex-end; height: 160px; padding-top: 20px; width: 100%; }
        .chart-col { display: flex; flex-direction: column; align-items: center; gap: 8px; flex: 1; }
        .chart-bar-container { flex: 1; display: flex; align-items: flex-end; justify-content: center; width: 100%; }
        .chart-bar { width: 12px; border-radius: 6px; transition: height 0.5s ease; min-height: 4px; }
        .chart-label { font-size: 0.75rem; color: var(--text-muted); font-weight: 600; }

        /* Specific Grid for Main Dashboard Row */
        #dash-main-row {
            grid-template-columns: 1.5fr 0.8fr 1fr;
        }

        /* PERFORMANCE VIEW UPDATED STYLES (Horizontal & Larger) */
        .performance-layout {
            display: flex;
            flex-direction: column;
            gap: 20px;
            margin-bottom: 20px;
        }

        .performance-card {
            background: var(--bg-card);
            border-radius: var(--radius-lg);
            padding: 24px;
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--border);
            transition: all 0.3s ease;
            width: 100%; /* Force full width */
        }

        .performance-card:hover {
            box-shadow: var(--shadow-md);
            transform: translateY(-2px);
        }

        /* Metrics Horizontal Row */
        .performance-metrics {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); /* Larger minimum width */
            gap: 16px;
            margin-bottom: 24px;
        }

        .metric-box {
            background: var(--bg-body);
            border-radius: var(--radius-md);
            padding: 20px;
            text-align: center;
            border: 1px solid var(--border);
            transition: all 0.2s ease;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        .metric-box:hover {
            border-color: var(--primary);
            transform: translateY(-2px);
        }

        .metric-value {
            font-size: 2.2rem; /* Larger font */
            font-weight: 800;
            color: var(--primary);
            line-height: 1.1;
            margin-bottom: 8px;
        }

        .metric-label {
            font-size: 0.9rem;
            color: var(--text-muted);
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .category-progress-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); /* Bigger Cards */
            gap: 16px;
            margin-top: 16px;
        }

        .category-progress-item {
            background: var(--bg-body);
            border-radius: var(--radius-md);
            padding: 16px;
            border-left: 5px solid var(--primary);
        }

        /* FAB STYLES - MODIFIED TO EXPAND UPWARDS */
        .fab-container {
            position: fixed;
            bottom: 70px; /* Aumentado do original 50px */
            right: 30px;  /* Movido mais para a direita */
            z-index: 2000;
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 12px;
        }
        
        .fab-button {
            width: 60px;
            height: 60px;
            background: var(--primary);
            color: white;
            border-radius: 50%;
            border: none;
            box-shadow: var(--shadow-lg);
            font-size: 1.5rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: transform 0.3s, background 0.3s;
        }
        
        .fab-button:hover { transform: scale(1.1); background: var(--primary-hover); }
        .fab-button.active { transform: rotate(45deg); background: var(--danger); }
        
        .fab-menu {
            display: flex;
            flex-direction: column;
            gap: 12px;
            align-items: flex-end;
            margin-bottom: 12px;
            opacity: 0;
            pointer-events: none;
            transform: translateY(20px);
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        
        .fab-container.open .fab-menu {
            opacity: 1;
            pointer-events: all;
            transform: translateY(0);
        }
        
        .fab-item {
            display: flex;
            align-items: center;
            gap: 12px;
            background: transparent;
            border: none;
            cursor: pointer;
        }
        
        .fab-icon {
            width: 48px;
            height: 48px;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-muted);
            box-shadow: var(--shadow-md);
            transition: all 0.2s;
            font-size: 1.2rem;
        }
        
        .fab-item:hover .fab-icon {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }
        
        .fab-label {
            background: var(--text-main);
            color: var(--bg-card);
            padding: 4px 10px;
            border-radius: 4px;
            font-size: 0.8rem;
            font-weight: 600;
            opacity: 0;
            transition: opacity 0.2s;
            pointer-events: none;
            box-shadow: var(--shadow-sm);
        }
        
        .fab-container.open .fab-label { opacity: 1; }

        /* Sim History Table Styles */
        .sim-table-row {
            display: grid;
            grid-template-columns: 1.5fr 1fr 1fr 0.5fr;
            padding: 14px 10px;
            border-bottom: 1px solid var(--border);
            align-items: center;
            cursor: pointer;
            transition: background 0.2s;
        }
        .sim-table-row:hover { background: var(--bg-body); }
        .sim-table-header { font-weight: 700; color: var(--text-muted); font-size: 0.85rem; text-transform: uppercase; background: var(--bg-body); border-radius: 8px 8px 0 0; }
        
        /* Progress Indicator in Card */
        .card-progress-counter {
            position: absolute;
            top: 20px;
            right: 20px;
            background: var(--bg-body);
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 700;
            color: var(--text-muted);
            border: 1px solid var(--border);
        }

        /* --- NEW STYLES FOR TEMPLATES --- */
        .template-actions { display: flex; gap: 8px; margin-top: 8px; }
        .btn-template { 
            font-size: 0.8rem; padding: 6px 12px; border-radius: 6px; border: none; 
            cursor: pointer; display: flex; align-items: center; gap: 6px; 
            transition: transform 0.2s; color: white; font-weight: 600;
        }
        .btn-save-tmpl { background: var(--info); }
        .btn-load-tmpl { background: var(--success); }
        .btn-template:hover { transform: translateY(-2px); opacity: 0.9; }
        
        .template-item { 
            display: flex; justify-content: space-between; align-items: center; 
            padding: 12px; border: 1px solid var(--border); border-radius: 8px; 
            margin-bottom: 8px; background: var(--bg-card); cursor: pointer;
            transition: background 0.2s;
        }
        .template-item:hover { border-color: var(--primary); background: var(--bg-body); }
        .template-list { max-height: 300px; overflow-y: auto; margin-top: 10px; }

        @media (max-width: 900px) {
            #dash-main-row { grid-template-columns: 1fr 1fr; }
            .performance-metrics { grid-template-columns: 1fr 1fr; }
            .pomodoro-layout { grid-template-columns: 1fr; }
        }

        @media (max-width: 768px) {
            .sidebar { display: none; }
            .bottom-nav { display: flex; }
            .main-content { padding: 20px 16px; margin-bottom: 80px; }
            .card-box { padding: 24px; }
            .file-actions { opacity: 1; }
            .topic-card-count { font-size: 0.7rem; padding: 1px 6px; }
            .create-grid { grid-template-columns: 1fr; }
            #dash-main-row { grid-template-columns: 1fr; }
            .performance-metrics { grid-template-columns: 1fr; }
            .category-progress-grid { grid-template-columns: 1fr; }
            /* FAB Mobile Adjustment */
            .fab-container { bottom: 85px; right: 20px; }
            .hero-header-card { flex-direction: column; align-items: flex-start; }
            .hero-actions { width: 100%; justify-content: space-between; margin-top: 12px; }
            .banner-period-btn { flex: 1; text-align: center; }
            .pomodoro-layout { grid-template-columns: 1fr; }
            .floating-timer { bottom: 92px; right: 90px; }
            .sim-table-row { grid-template-columns: 1fr 1fr 0.5fr; } /* Hide score details on small mobile maybe */
        }
        /* FORÇA A BARRA DO QUILL A SER VISÍVEL NO MODO DARK */
.ql-toolbar {
    background-color: #f0f0f0 !important; /* Fundo cinza claro */
    border-radius: 8px 8px 0 0; /* Arredonda o topo */
}

/* Se quiser inverter os ícones para branco no modo dark, use este (Opcional) */
/* Mas a solução acima (fundo claro) é mais garantida e simples */
/* --- ESTILOS DO SISTEMA SRS --- */

/* Banner de Revisão na Home */
#srs-review-banner {
    background: linear-gradient(135deg, #2c3e50 0%, #3498db 100%);
    border-radius: 16px;
    padding: 20px;
    margin: 20px 0;
    box-shadow: 0 8px 25px rgba(52, 152, 219, 0.25);
    border: 1px solid rgba(255, 255, 255, 0.1);
    color: white;
}

.srs-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 15px;
}

.srs-item-row {
    background: rgba(255, 255, 255, 0.1);
    backdrop-filter: blur(5px);
    border: 1px solid rgba(255, 255, 255, 0.1);
    padding: 12px 15px;
    border-radius: 10px;
    margin-bottom: 8px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    transition: transform 0.2s, background 0.2s;
    cursor: pointer;
}

.srs-item-row:hover {
    background: rgba(255, 255, 255, 0.2);
    transform: translateX(5px);
}

/* Modal Bonito */
.srs-modal-content {
    background: var(--bg-card); /* Usa a cor do seu tema */
    color: var(--text-main);
    padding: 25px;
    border-radius: 20px;
    width: 90%;
    max-width: 420px;
    box-shadow: 0 10px 40px rgba(0,0,0,0.4);
    border: 1px solid var(--border);
}

/* Switch Toggle (Botão de ativar bonito) */
.switch-container {
    position: relative;
    display: inline-block;
    width: 50px;
    height: 26px;
}

.switch-container input { opacity: 0; width: 0; height: 0; }

.slider {
    position: absolute;
    cursor: pointer;
    top: 0; left: 0; right: 0; bottom: 0;
    background-color: var(--text-muted);
    transition: .4s;
    border-radius: 34px;
}

.slider:before {
    position: absolute;
    content: "";
    height: 18px;
    width: 18px;
    left: 4px;
    bottom: 4px;
    background-color: white;
    transition: .4s;
    border-radius: 50%;
}

input:checked + .slider { background-color: var(--success); }
input:checked + .slider:before { transform: translateX(24px); }

/* Inputs Bonitos */
.modern-input {
    width: 100%;
    padding: 12px;
    border-radius: 8px;
    border: 2px solid var(--border);
    background: var(--bg-main);
    color: var(--text-main);
    font-size: 1rem;
    outline: none;
    transition: border-color 0.3s;
}
.modern-input:focus { border-color: var(--primary); }

/* --- FIX DO EDITOR NO MODO DARK --- */

/* 1. Cores no Modo Claro (Padrão) */
#editor-container {
    background-color: white;
    color: #1e293b;
    border: 1px solid #ccc; /* Borda padrão do Quill */
    border-top: none; /* Remove borda do topo para colar na toolbar */
}

/* 2. Cores no Modo Escuro (Dark Mode) */
body.dark-mode #editor-container {
    background-color: var(--bg-card); /* Usa o fundo dos seus cards */
    color: var(--text-main);          /* Usa a cor do seu texto */
    border-color: var(--border);
}

/* 3. Barra de Ferramentas (Toolbar) no Dark Mode */
body.dark-mode .ql-toolbar {
    background-color: var(--bg-body) !important;
    border-color: var(--border) !important;
}

/* 4. Ícones da Toolbar ficarem brancos no Dark Mode */
body.dark-mode .ql-snow .ql-stroke { stroke: var(--text-main) !important; }
body.dark-mode .ql-snow .ql-fill { fill: var(--text-main) !important; }
body.dark-mode .ql-snow .ql-picker { color: var(--text-main) !important; }

   /* Pop-up de Inatividade */
.inactivity-overlay {
    position: fixed; top: 0; left: 0; right: 0; bottom: 0;
    background: rgba(0,0,0,0.8); z-index: 9999;
    display: flex; align-items: center; justify-content: center;
    backdrop-filter: blur(5px); animation: fadeIn 0.3s;
}
.inactivity-box {
    background: white; padding: 40px; border-radius: 20px;
    text-align: center; max-width: 400px; width: 90%;
    box-shadow: 0 20px 50px rgba(0,0,0,0.5);
    border: 1px solid rgba(255,255,255,0.1);
}
.dark-theme .inactivity-box { background: #1a202c; color: white; }
.resume-toast {
    position: fixed; top: 20px; right: 20px;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white; padding: 15px 25px; border-radius: 50px;
    font-weight: bold; z-index: 10000;
    box-shadow: 0 5px 15px rgba(0,0,0,0.3);
    animation: slideInRight 0.5s;
}
@keyframes slideInRight { from { transform: translateX(100%); } to { transform: translateX(0); } }
 

/* Correção DEFINITIVA para o gráfico Tempo de Estudo */
#studytime-chart {
  display: flex;
  justify-content: space-around;
  align-items: stretch !important; /* <--- ISSO CORRIGE A ALTURA */
  height: 180px;
  width: 100%;
  padding-top: 20px;
  margin-top: 10px;
}

#studytime-chart .chart-col {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: flex-end;
  flex: 1;
  height: 100%; /* Força a coluna a ocupar toda a altura */
}

#studytime-chart .chart-bar-container {
  flex: 1; /* Ocupa todo o espaço vazio acima do texto */
  display: flex;
  align-items: flex-end; /* Faz a barra nascer do chão */
  justify-content: center;
  width: 100%;
  padding-bottom: 8px; /* Espacinho entre a barra e o texto */
}

#studytime-chart .chart-bar {
  width: 14px; /* Um pouco mais grossa para ficar bonito */
  border-radius: 6px;
  min-height: 4px;
  background: var(--primary);
  transition: height 0.8s cubic-bezier(0.4, 0, 0.2, 1);
  position: relative;
}

/* Efeito ao passar o mouse na coluna */
#studytime-chart .chart-col:hover .chart-bar {
  filter: brightness(1.1);
  transform: scaleX(1.1);
}

#studytime-chart .chart-label {
  font-size: 0.75rem;
  color: var(--text-muted);
  font-weight: 700;
  text-align: center;
  line-height: 1.2;
}

/* --- Novo Design da Biblioteca --- */
.library-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
}

.library-filters-container {
    display: grid;
    grid-template-columns: 2fr 1fr 1fr; /* Busca maior que os outros */
    gap: 15px;
    background: var(--bg-card);
    padding: 20px;
    border-radius: 12px;
    box-shadow: 0 4px 6px rgba(0,0,0,0.05);
    margin-bottom: 25px;
    border: 1px solid var(--border);
}

.lib-input-group {
    position: relative;
    display: flex;
    flex-direction: column;
    gap: 8px;
}

.lib-label {
    font-size: 0.85rem;
    font-weight: 600;
    color: var(--text-muted);
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.lib-control {
    width: 100%;
    padding: 14px 16px; /* Mais altura para facilitar o clique */
    font-size: 1rem;    /* Fonte maior */
    border: 2px solid var(--border);
    border-radius: 10px;
    background: var(--bg-main);
    color: var(--text-main);
    transition: all 0.2s ease;
    font-family: inherit;
    appearance: none; /* Remove estilo padrão do navegador */
}

/* Ícone de dropdown customizado */
select.lib-control {
    background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
    background-repeat: no-repeat;
    background-position: right 1rem center;
    background-size: 1em;
    padding-right: 2.5rem;
}

.lib-control:focus {
    border-color: var(--primary);
    box-shadow: 0 0 0 4px rgba(var(--primary-rgb), 0.15); /* Glow suave */
    outline: none;
}

/* Responsividade para celular */
@media (max-width: 768px) {
    .library-filters-container {
        grid-template-columns: 1fr; /* Empilha tudo no mobile */
    }
}

/* --- CORREÇÃO DE BUGS DO MODO ESCURO --- */

/* 1. Força o navegador a renderizar controles nativos (selects, rolagens) em modo dark */
.dark-mode {
    color-scheme: dark; 
}

/* 2. Garante que as opções individuais tenham o fundo correto */
.dark-mode option {
    background-color: #1e293b; /* Mesma cor escura do card */
    color: #f1f5f9;            /* Texto claro */
}

/* 3. Previne que inputs de data fiquem com ícone de calendário preto no fundo escuro */
.dark-mode ::-webkit-calendar-picker-indicator {
    filter: invert(1);
}

/* Wrapper para manter o botão e o painel juntos */
.quick-access-wrapper {
    width: 100%;
}

/* Ajuste do Ícone do Sino */
#btn-quick-notes i {
    filter: drop-shadow(0 0 2px rgba(245, 158, 11, 0.5)); /* Brilho estático suave */
    transition: transform 0.2s;
}

#btn-quick-notes:hover i {
    transform: scale(1.1);
}

/* Painel de Anotações (Popover) */
.quick-notes-panel {
    display: none;
    position: absolute;
    left: 70px; /* Ao lado da sidebar */
    top: 0; /* Alinhado ao topo do botão */
    width: 280px;
    background: var(--bg-card);
    border: 1px solid var(--border);
    border-radius: 12px;
    box-shadow: 0 10px 25px rgba(0,0,0,0.15);
    z-index: 2000;
    overflow: hidden;
    flex-direction: column;
}

.quick-notes-panel.active {
    display: flex;
}

.quick-notes-header {
    background: var(--primary-dim);
    padding: 12px;
    font-weight: bold;
    color: var(--primary-dark);
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-size: 0.9rem;
}

.quick-notes-list {
    max-height: 250px;
    overflow-y: auto;
    padding: 5px;
}

.quick-note-item {
    padding: 10px;
    border-radius: 8px;
    margin-bottom: 5px;
    cursor: pointer;
    border-bottom: 1px solid var(--border);
    display: flex;
    align-items: center;
    gap: 10px;
}

.quick-note-item:last-child { border-bottom: none; }
.quick-note-item:hover { background: var(--bg-body); }

.quick-note-title {
    font-size: 0.9rem;
    color: var(--text-main);
    font-weight: 500;
}

/* Esconde o botão de histórico por padrão */
#btn-quick-notes {
    display: none;
}

/* Classe para mostrar o botão quando tiver conteúdo */
#btn-quick-notes.visible {
    display: flex !important; /* O !important garante que sobrescreva o none */
}




/* Container lado a lado */
.stats-banners-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 20px;
    margin-top: 20px;
    margin-bottom: 20px;
}

/* Card base */
.stat-banner-card {
    background: var(--bg-card);
    border-radius: var(--radius-lg);
    padding: 20px; /* Espaçamento interno */
    box-shadow: var(--shadow-sm);
    border: 1px solid var(--border);
    transition: transform 0.2s, box-shadow 0.2s;
}

.stat-banner-card:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow-md);
}

/* Títulos e Listas */
.stat-content {
    width: 100%;
}

.stat-content h4 {
    margin: 0 0 15px 0;
    font-size: 1rem;
    
    /* MUDANÇA AQUI: Usa a variável do tema */
    color: var(--text-main); 
    
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    border-bottom: 2px solid var(--border);
    padding-bottom: 8px;
}

.stat-list {
    list-style: none;
    padding: 0;
    margin: 0;
}

/* Item da lista */
.stat-list li {
    display: flex;
    justify-content: space-between;
    align-items: center; /* Mantém a bolinha centralizada verticalmente */
    font-size: 0.95rem;
    color: var(--text-main);
    padding: 12px 0; /* AUMENTEI DE 8px PARA 12px para caber melhor a categoria */
    border-bottom: 1px solid var(--border); /* Usei a variável de borda padrão */
}

/* Remove a linha do último item para ficar limpo */
.stat-list li:last-child {
    border-bottom: none;
}

/* Bolinha da contagem */
.stat-list li .sub-count {
    font-weight: bold;
    color: var(--primary);
    background: var(--primary-light);
    padding: 4px 8px;
    border-radius: 6px;
    font-size: 0.85rem;
    min-width: 28px; /* Aumentei levemente para números de 2 dígitos */
    text-align: center;
    flex-shrink: 0; /* Garante que a bolinha não amasse se o texto for longo */
}


/* Responsivo */
@media (max-width: 768px) {
    .stats-banners-grid {
        grid-template-columns: 1fr;
    }
}

/* Container do ícone */
.info-icon-container {
    position: absolute;
    top: 10px;
    right: 10px;
    width: 24px;
    height: 24px;
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 100;
    cursor: help;
    color: #999;
    opacity: 0.6;
    transition: opacity 0.2s;
}

.info-icon-container:hover {
    opacity: 1;
    color: var(--primary); /* Fica colorido ao passar o mouse */
}

/* O Bloco Preto (Texto) */
.custom-tooltip-text {
    visibility: hidden;
    width: 200px;
    background-color: #222; /* Fundo Preto Quase Total */
    color: #fff; /* Texto Branco */
    
    text-align: left; /* CORRIGIDO: Alinhado à esquerda */
    
    border-radius: 6px;
    padding: 10px 12px;
    font-size: 0.85rem;
    line-height: 1.4;
    box-shadow: 0 4px 10px rgba(0,0,0,0.3);
    
    /* Posicionamento */
    position: absolute;
    z-index: 101;
    top: 130%; /* Fica logo abaixo do ícone */
    right: 0;   /* Alinhado à direita */
    
    /* Efeitinho de aparecer suave */
    opacity: 0;
    transition: opacity 0.3s;
}

/* A setinha preta apontando para cima */
.custom-tooltip-text::after {
    content: "";
    position: absolute;
    bottom: 100%; /* No topo do tooltip */
    right: 8px;   /* Alinhado com o ícone */
    margin-left: -5px;
    border-width: 5px;
    border-style: solid;
    border-color: transparent transparent #222 transparent; /* Triângulo preto */
}

/* Mostrar quando passar o mouse */
.info-icon-container:hover .custom-tooltip-text {
    visibility: visible;
    opacity: 1;
}



</style>
</head>
<body>
<!-- NOVA TELA DE LOGIN (SPLIT) -->
<div id="auth-wrapper" class="auth-wrapper">
  <div class="auth-split">
    <!-- Lado Esquerdo: Formulário (Branco) -->
    <div class="auth-left">
      <div class="auth-card auth-card--left">
        <!-- Cabeçalho Novo -->
        <div class="auth-header-new">
          <div class="auth-logo-new">
            <i class="fas fa-paw"></i>
          </div>
          <h2 class="auth-title">Bem-vindo de volta!</h2>
          <p class="auth-subtitle">Entre com seus dados para continuar.</p>
        </div>
        
        <div id="auth-error-msg" class="error-message"></div>

        <!-- FORMULÁRIO DE LOGIN -->
        <form id="login-form" class="auth-form">
          <div class="input-group">
            <label>E-mail</label>
            <input type="email" id="login-email" placeholder="seu@email.com" required>
          </div>
          <div class="input-group">
            <label>Senha</label>
            <input type="password" id="login-password" placeholder="••••••••" required>
          </div>
          
          <div class="form-actions">
            <span class="auth-link-sm" onclick="toggleAuthMode('forgot')">Esqueci a senha</span>
          </div>

          <button type="submit" class="action-btn btn-full">Entrar</button>
        </form>

        <!-- FORMULÁRIO DE CADASTRO (Mantido oculto até clicar) -->
        <form id="register-form" class="auth-form hidden">
          <div class="input-group">
            <label>E-mail</label>
            <input type="email" id="reg-email" placeholder="seu@email.com" required>
          </div>
          <div class="input-group">
            <label>Senha</label>
            <input type="password" id="reg-password" placeholder="Mínimo 6 caracteres" required>
          </div>
          <div class="input-group">
            <label>Confirmar Senha</label>
            <input type="password" id="reg-confirm" placeholder="Repita a senha" required>
          </div>
          <button type="submit" class="action-btn btn-full">Criar Conta</button>
        </form>

        <!-- FORMULÁRIO ESQUECI SENHA -->
        <form id="forgot-form" class="auth-form hidden">
          <p style="font-size:0.9rem; color:var(--text-muted); margin-bottom:15px;">
            Digite seu e-mail para recuperar o acesso.
          </p>
          <div class="input-group">
            <label>E-mail</label>
            <input type="email" id="forgot-email" placeholder="seu@email.com" required>
          </div>
          <button type="submit" class="action-btn btn-full">Enviar Link</button>
        </form>

        <!-- Rodapé dos Forms -->
        <div class="auth-footer-box">
          <div id="login-footer">
            Não tem uma conta? <span class="auth-link-bold" onclick="toggleAuthMode('register')">Cadastre-se</span>
          </div>
          <div id="register-footer" class="hidden">
            Já tem conta? <span class="auth-link-bold" onclick="toggleAuthMode('login')">Fazer Login</span>
          </div>
          <div id="forgot-footer" class="hidden">
            <span class="auth-link-bold" onclick="toggleAuthMode('login')">Voltar para o Login</span>
          </div>
        </div>

      </div>
    </div>

   <!-- Lado Direito (Vitrine) -->
<div class="auth-right">
  <div class="auth-showcase">
    <div class="auth-showcase-header">
      <!-- Título atualizado -->
      <div class="auth-showcase-title">Estude no piloto automático</div>
      <div class="auth-showcase-subtitle" style="max-width: 500px; margin: 0 auto; line-height: 1.5;">
        Você adiciona o material, nós avisamos a hora de revisar.
      </div>
    </div>

    <div class="auth-showcase-canvas">
      <!-- Card 1: Flashcards -->
      <div class="feature-card fc-1">
        <div class="fc-top">
          <span class="fc-icon">🧠</span>
          <span class="fc-title">Flashcards</span>
        </div>
        <div class="fc-line w-90"></div>
        <div class="fc-line w-70"></div>
        <div class="fc-line w-55"></div>
        <div class="fc-chip">Revisão rápida</div>
      </div>

      <!-- Card 2: Pomodoro -->
      <div class="feature-card fc-2">
        <div class="fc-top">
          <span class="fc-icon">⏱️</span>
          <span class="fc-title">Pomodoro</span>
        </div>
        <div class="pomo-ring">
          <div class="pomo-ring-inner">
            <div class="pomo-time">25:00</div>
            <div class="pomo-label">Foco</div>
          </div>
        </div>
        <div class="fc-chip alt">Pausas inteligentes</div>
      </div>

      <!-- Card 3: Agenda -->
      <div class="feature-card fc-3">
        <div class="fc-top">
          <span class="fc-icon">📅</span>
          <span class="fc-title">Agenda</span>
        </div>
        <div class="agenda-rows">
          <div class="agenda-row">
            <div class="agenda-check"></div>
            <div class="agenda-line"></div>
          </div>
          <div class="agenda-row">
            <div class="agenda-check"></div>
            <div class="agenda-line short"></div>
          </div>
          <div class="agenda-row">
            <div class="agenda-check active"></div>
            <div class="agenda-line"></div>
          </div>
        </div>
        <div class="fc-chip">Organização</div>
      </div>

      <!-- Card 4: Performance -->
      <div class="feature-card fc-4">
        <div class="fc-top">
          <span class="fc-icon">📊</span>
          <span class="fc-title">Performance</span>
        </div>
        <div class="stat-bars">
          <div class="stat-bar h-40"></div>
          <div class="stat-bar h-60"></div>
          <div class="stat-bar h-85 active"></div>
          <div class="stat-bar h-55"></div>
          <div class="stat-bar h-70"></div>
        </div>
        <div class="fc-chip alt">Evolução</div>
      </div>

      <!-- Elementos de brilho -->
      <div class="glow-orb o1"></div>
      <div class="glow-orb o2"></div>
    </div>

    <!-- NOVO RODAPÉ INSERIDO AQUI -->
    <div class="auth-showcase-footer">
      <div class="footer-info">
        <span class="info-badge">BETA WEB</span>
        <span class="info-text">Versão online para testes.</span>
      </div>

      <div class="footer-actions">
        <a href="https://github.com/gpamplona235/teddy-app/releases" target="_blank" class="btn-download-win">
          <i class="fab fa-windows"></i> Baixar para Windows
        </a>
        <span class="coming-soon">
          <i class="fab fa-android"></i> <i class="fab fa-linux"></i> Em breve
        </span>
      </div>
    </div>
    
  </div> <!-- Fim auth-showcase -->
</div> <!-- Fim auth-right -->

</div> <!-- Fim auth-split -->
</div> <!-- Fim auth-wrapper -->



    
<div id="app-content" class="hidden">


    <nav class="sidebar collapsed" id="sidebar">
        <!-- Sidebar Toggle Removed -->

        <div class="nav-links">
            <button class="nav-item active" onclick="switchTab('dashboard')" title="Início"><i class="fas fa-home"></i> <span>Início</span></button>
            <button class="nav-item" onclick="switchTab('study')" title="Estudar"><i class="fas fa-book-open"></i> <span>Estudar</span></button>
            <button class="nav-item" onclick="switchTab('syllabus')" title="Editais"><i class="fas fa-clipboard-list"></i> <span>Editais</span></button>
            <button class="nav-item" onclick="switchTab('pomodoro')" title="Pomodoro"><i class="fas fa-stopwatch"></i> <span>Pomodoro</span></button>
            <button class="nav-item" onclick="switchTab('notes')" title="Caderno"><i class="fas fa-sticky-note"></i> <span>Caderno</span></button>
            <button class="nav-item" onclick="switchTab('schedule')" title="Cronograma"><i class="fas fa-calendar-alt"></i> <span>Cronograma</span></button>
            <button class="nav-item" onclick="switchTab('performance')" title="Dados"><i class="fas fa-chart-pie"></i> <span>Dados</span></button>
            <button class="nav-item" onclick="switchTab('settings')" title="Configurações"><i class="fas fa-cog"></i> <span>Configurações</span></button>
           <div class="quick-access-wrapper" style="position: relative;">
                <button class="nav-item" id="btn-quick-notes" onclick="toggleQuickNotes()" title="Histórico Recente">
    <i class="fas fa-history" style="color: var(--warning);"></i> 
    <span>Histórico</span>
</button>


                <div class="quick-notes-panel" id="quick-notes-panel">
                    <div class="quick-notes-header">
                        <span>Historico de Anotações</span>
                        <i class="fas fa-times" onclick="toggleQuickNotes()" style="cursor: pointer;"></i>
                    </div>
                    <div class="quick-notes-list" id="quick-notes-list">
                        <!-- Lista via JS -->
                    </div>
                </div>
            </div>
        </div>

    
                <!-- TAG DE VERSÃO BETA (Retangular - Alinhado à Esquerda) -->
        <div class="version-tag" style="
            position: absolute;
            bottom: 20px;
            left: 0;
            width: 100%;
            background: var(--primary);
            color: white;
            padding: 8px 0 8px 12px; /* Topo, Direita, Base, Esquerda (12px) */
            text-align: left;
            font-size: 0.75rem;
            cursor: default;
            z-index: 10;
            line-height: 1.2;
            box-sizing: border-box;
        ">
            <div style="font-weight: 900; letter-spacing: 1px; font-size: 0.85rem;">BETA</div>
            <div style="font-weight: 400; font-size: 0.7rem; opacity: 0.9;">v0.9.41</div>
        </div>

    </nav>

    <main class="main-content">
        <div class="page-header">
            <div id="page-title-display">INÍCIO</div>
            <div class="header-actions">
    <!-- Botão Configurações -->
    <button class="header-btn-icon" onclick="switchTab('settings')" title="Configurações">
        <i class="fas fa-cog"></i>
    </button>

    <!-- NOVO: Botão Telegram (Adicionado AQUI) -->
    <button class="header-btn-icon" 
            onclick="window.open('https://t.me/teddyaplicativo', '_blank')" 
            title="Canal Telegram">
        <i class="fab fa-telegram-plane"></i>
    </button>

    <!-- Botão Tema -->
    <button class="header-btn-icon theme-toggle" onclick="toggleTheme()" title="Mudar Tema">
        <i class="fas fa-moon" id="theme-icon"></i>
    </button>

    <!-- Botão Sair -->
    <button onclick="logout()" class="header-btn-icon" title="Sair / Logout" style="color: #ef4444;">
        <i class="fas fa-sign-out-alt"></i>
    </button>
</div>

        </div>

        <section id="dashboard-view" class="view-section">
            <div class="card-box welcome-card">
                <h2>Olá! 👋</h2>
                <p id="quote-display">"O sucesso é a soma de pequenos esforços repetidos dia após dia."</p>
                <div style="margin-top: 20px;">
                    <button class="action-btn" onclick="switchTab('study')" style="background: rgba(255,255,255,0.2); width: auto; backdrop-filter: blur(5px);">
                        Começar Agora <i class="fas fa-arrow-right"></i>
                    </button>
                </div>
            </div>
            
            <div class="dashboard-grid">
                <div class="card-box stat-widget" style="cursor: pointer; position: relative;" onclick="goToStudyPractice()">
    
    <!-- Ícone com Tooltip Personalizado -->
    <div class="info-icon-container" onclick="event.stopPropagation();">
        <i class="fas fa-exclamation-circle"></i>
        
        <!-- O Bloco Preto (Tooltip) -->
        <span class="custom-tooltip-text">
            Cards que precisam de revisão.
        </span>
    </div>

    <!-- Conteúdo Original -->
    <div class="stat-icon" style="background: var(--primary-light); color: var(--primary);">
        <i class="fas fa-layer-group"></i>
    </div>
    <div class="stat-info">
        <h4>Cards para Hoje</h4>
        <strong id="dash-due-count">0</strong>
    </div>
</div>






                <div class="card-box stat-widget">
    <div class="stat-icon" style="background: #e0e7ff; color: var(--primary);"><i class="fas fa-layer-group"></i></div>
    <div class="stat-info"><h4>Cards Criados</h4><strong id="dash-total-cards">0</strong></div>
</div>

                <div class="card-box stat-widget">
                    <div class="stat-icon" style="background: #e0f2fe; color: var(--info);"><i class="fas fa-clock"></i></div>
                    <div class="stat-info"><h4>Próxima Atividade</h4><div id="dash-next-task" style="font-weight:700">Nenhuma</div></div>
                </div>
            </div>

            <div id="dash-main-row" class="dashboard-grid">
                <div class="card-box">
                    <h3>Resumo Semanal</h3>
                    <div id="dash-mini-chart"></div>
                </div>

                <!-- MODIFIED: Novo Card box with solid color -->
                <div class="card-box" style="background: var(--primary); color: white; display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center; gap: 12px; border:none;">
                    <div style="background: rgba(255,255,255,0.2); width: 50px; height: 50px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; backdrop-filter: blur(5px);">
                        <i class="fas fa-plus"></i>
                    </div>
                    <h4 style="margin: 0; font-size: 1rem; color:white;">Novo Card</h4>
                    <button class="btn-sm" onclick="switchTab('study'); switchStudyTab('creator')" style="background: white; color: var(--primary); border: none; font-weight: 700; width: 80%; border-radius: 8px; cursor: pointer; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
                        Criar
                    </button>
                </div>
                
                <div class="card-box" style="display:flex; flex-direction:column;">
                    <h3 style="margin-bottom:12px;">Metas do Dia</h3>
                    <div id="dash-tasks-preview" style="flex:1; display:flex; flex-direction:column; gap:8px;">
                        <div style="text-align:center; color:var(--text-muted); font-size:0.9rem; margin-top:10px;">Carregando...</div>
                    </div>
                    <button class="btn-sm btn-outline" onclick="switchTab('schedule')" style="margin-top:12px; width:100%;">Ver Cronograma</button>
                </div>
            </div>

<!-- Banners de Subtópicos da Semana -->
<div class="stats-banners-grid">
    <!-- Banner: Mais Revisados -->
    <div class="stat-banner-card hot" style="position: relative;">
        
        <!-- Ícone de Informação (Mais Revisados) -->
        <div class="info-icon-container">
            <i class="fas fa-exclamation-circle"></i>
            <span class="custom-tooltip-text">
                Esses são os assuntos mais estudados na semana.
            </span>
        </div>

        <div class="stat-content">
            <h4>Mais Revisados (7d)</h4>
            <ul id="list-top-reviewed" class="stat-list">
                <li><span class="sub-name">Carregando...</span> <span class="sub-count">--</span></li>
            </ul>
        </div>
    </div>


    <!-- Banner: Menos Revisados -->
    <div class="stat-banner-card cold" style="position: relative;">
        
        <!-- Ícone de Informação (Menos Revisados) -->
        <div class="info-icon-container">
            <i class="fas fa-exclamation-circle"></i>
            <span class="custom-tooltip-text" style="width: 240px;">
                Esses são os assuntos menos estudados, fundo do poço. Recomenda-se criar novos cards para os respectivos assuntos.
            </span>
        </div>

        <div class="stat-content">
            <h4>Menos Revisados (7d)</h4>
            <ul id="list-least-reviewed" class="stat-list">
                <li><span class="sub-name">Carregando...</span> <span class="sub-count">--</span></li>
            </ul>
        </div>
    </div>
</div>



                        <!-- BANNER DE DOAÇÕES (TELA INICIAL) -->
            <div class="card-box" style="
                margin-top: 20px;
                background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
                color: white;
                border: none;
                display: flex;
                flex-wrap: wrap;
                gap: 24px;
                align-items: center;
                justify-content: space-between;
                position: relative;
                overflow: hidden;
            ">
                <!-- Efeito de brilho sutil no fundo -->
                <div style="position: absolute; top: -50%; left: -10%; width: 200px; height: 200px; background: rgba(255,255,255,0.1); border-radius: 50%;"></div>
                
                <div style="flex: 1; min-width: 250px; z-index: 1;">
                    <h3 style="margin-bottom: 12px; color: white; display: flex; align-items: center; gap: 10px; font-size: 1.3rem;">
                        <i class="fas fa-hand-holding-heart"></i> Apoie o Projeto
                    </h3>
                    <p style="color: rgba(255,255,255,0.95); font-size: 0.95rem; line-height: 1.6; margin-bottom: 0;">
                        Gosta do app? Ajude a manter o desenvolvimento ativo e 100% grátis! <br>
                        Sua doação traz novas atualizações e melhorias.
                    </p>
                </div>

                <div style="text-align: center; margin: 0 auto; z-index: 1;">
                    <div style="
                        background: white; 
                        padding: 8px; 
                        border-radius: var(--radius-md); 
                        box-shadow: 0 4px 15px rgba(0,0,0,0.2);
                        display: inline-block;
                    ">
                        <!-- Imagem do QR Code -->
                        <img src="assets/qrcode.png" alt="Pix QR Code" style="width: 120px; height: 120px; display: block; border-radius: 4px;">
                    </div>
                    <div style="margin-top: 8px; font-size: 0.8rem; font-weight: 600; opacity: 0.9;">
                        <i class="fas fa-qrcode"></i> Escaneie o Pix
                    </div>
                </div>
            </div>

        </section>

        <!-- POMODORO VIEW -->
        <section id="pomodoro-view" class="view-section hidden">
            <div class="hero-header-card">
                <i class="fas fa-stopwatch hero-bg-icon"></i>
                <div class="hero-content">
                    <div>
                        <h2 class="hero-title">Pomodoro</h2>
                        <p class="hero-subtitle">Foque no que importa, com pausas estratégicas.</p>
                    </div>
                </div>
            </div>

            <div class="pomodoro-layout">
                <div class="card-box timer-card">
                    <div class="pomo-tabs">
                        <button class="pomo-tab active" id="pomo-mode-focus" onclick="setPomoMode('focus')">Pomodoro</button>
                        <button class="pomo-tab" id="pomo-mode-short" onclick="setPomoMode('short')">Descanso</button>
                        <button class="pomo-tab" id="pomo-mode-long" onclick="setPomoMode('long')">Longo</button>
                    </div>

                    <div class="timer-display" id="timer-display">25:00</div>
                    
                    <div class="timer-controls">
                         <button class="btn-pomo-sec" onclick="resetTimer()" title="Reiniciar"><i class="fas fa-undo"></i></button>
                         <button class="btn-pomo-main" id="btn-toggle-timer" onclick="toggleTimer()"><i class="fas fa-play" style="margin-left:4px;"></i></button>
                         <button class="btn-pomo-sec" onclick="openPomoSettings()" title="Configurar"><i class="fas fa-cog"></i></button>
                    </div>
                    
                    <button class="btn-sm btn-outline" onclick="finishPomoSession()" style="margin-bottom:20px; color: var(--danger); border-color: var(--danger);">Finalizar Agora</button>

                    <div style="width: 100%; max-width: 300px; height: 6px; background: var(--bg-body); border-radius: 3px; overflow: hidden;">
                        <div id="pomo-progress-bar" style="height: 100%; background: var(--primary); width: 0%; transition: width 1s linear;"></div>
                    </div>
                </div>

                <div class="card-box" style="display:flex; flex-direction:column;">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:16px;">
                        <h3>Histórico de Sessões</h3>
                        <button class="btn-sm btn-outline" onclick="clearPomoHistory()" style="font-size:0.75rem;">Limpar</button>
                    </div>
                    
                    <div id="pomo-history-list" class="pomo-history-list">
                        <!-- History Items go here -->
                    </div>
                    <div id="pomo-empty-msg" style="text-align:center; padding:40px; color:var(--text-muted); font-style:italic;">Nenhuma sessão finalizada.</div>
                </div>
            </div>
        </section>

        <!-- UNIFIED STUDY SECTION -->
        <section id="study-view" class="view-section hidden">
            <!-- Internal Navigation -->
            <div class="study-nav-container">
                <button class="study-nav-btn active" id="sub-nav-practice" onclick="switchStudyTab('practice')">
                    <i class="fas fa-book-reader"></i> Praticar
                </button>
                <button class="study-nav-btn" id="sub-nav-library" onclick="switchStudyTab('library')">
                    <i class="fas fa-list"></i> Biblioteca
                </button>
                <button class="study-nav-btn" id="sub-nav-creator" onclick="switchStudyTab('creator')">
                    <i class="fas fa-plus-circle"></i> Criar
                </button>
            </div>

            <!-- SUB VIEW: PRACTICE (Original Study) -->
            <div id="sub-view-practice">
                <div class="card-box" style="background: linear-gradient(135deg, var(--primary), var(--secondary)); color: white; border: none; overflow: hidden; position: relative; margin-bottom: 24px;">
                    <i class="fas fa-shapes" style="position: absolute; right: -20px; bottom: -20px; font-size: 8rem; opacity: 0.1;"></i>
                    <div style="display: flex; justify-content: space-between; align-items: center; position: relative; z-index: 2; flex-wrap: wrap; gap:16px;">
                        <div>
                            <h3 style="color: white; margin: 0; font-size: 1.2rem;">Sessão de Estudo</h3>
                            <p style="opacity: 0.9; margin-top: 4px; font-size: 0.9rem;">Cards para revisar: <strong id="due-count">0</strong></p>
                        </div>
                        <div style="display: flex; gap: 8px;">
                            <button class="action-btn" onclick="openSimulationModal()" style="background: var(--primary-dark); width: auto; font-size: 0.9rem; border: 1px solid rgba(255,255,255,0.2);">
                                <i class="fas fa-clipboard-list"></i> Novo Simulado
                            </button>
                            <button class="action-btn" onclick="startRandomReview()" style="background: rgba(255,255,255,0.25); width: auto; font-size: 0.9rem; border: 1px solid rgba(255,255,255,0.4);">
                                <i class="fas fa-dice"></i> Aleatório
                            </button>
                        </div>
                    </div>
                </div>

                <div id="study-content">
                    <div class="flashcard-display">
                        <div style="position: absolute; top: 0; left: 0; width: 100%; height: 6px; background: linear-gradient(90deg, var(--primary), var(--secondary));"></div>
                        
                        <!-- Progress Counter -->
                        <div id="study-progress-display" class="card-progress-counter">0 / 0</div>

                       <!-- CABEÇALHO DO CARD (REDESENHADO) -->
<div style="
    display: flex; 
    align-items: center; 
    gap: 12px; 
    margin-bottom: 25px; 
    border-bottom: 1px solid var(--border); 
    padding-bottom: 15px;
    flex-wrap: wrap;
">
    <!-- ID (Primeiro) -->
    <span id="card-id-display" style="
        font-family: monospace; 
        background: var(--bg-main); 
        padding: 4px 8px; 
        border-radius: 6px; 
        font-size: 0.9rem; 
        color: var(--text-muted); 
        font-weight: bold;
    ">#0000</span>

    <!-- Categoria (Maior e em destaque) -->
    <span id="category-display" style="
        color: var(--primary); 
        font-size: 1.1rem; /* Fonte Aumentada */
        font-weight: 800; 
        text-transform: uppercase;
        letter-spacing: 0.5px;
    ">GERAL</span>
    
    <!-- Separador -->
    <span style="color: var(--border); font-size: 1.2rem;">/</span>

    <!-- Subcategoria -->
    <span id="subcategory-display" style="
        color: var(--text-main); 
        font-size: 1rem; /* Fonte Normal/Legível */
        font-weight: 500;
    "></span>

</div>


                        <div id="question-display" class="question-text">Carregando pergunta...</div>
                        <div id="options-display" class="options-grid"></div>
                        
                        <div id="comment-display" class="hidden" style="margin-top: 24px; background: var(--bg-body); padding: 20px; border-radius: 12px; border: 1px solid var(--border); text-align: left;">
                             <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
                                <h4 style="color: var(--primary-dark); font-size: 0.9rem; margin:0; text-transform: uppercase;">Explicação</h4>
                                <button class="btn-sm btn-outline" onclick="enableCommentEdit()"><i class="fas fa-pen"></i> Editar</button>
                            </div>
                            <div id="comment-content-wrapper">
    <p id="comment-text" style="font-size: 0.95rem; color: var(--text-main); line-height: 1.5; margin-bottom: 0;"></p>
    
    <!-- ÁREA DA FONTE ADICIONADA -->
    <div id="source-display-wrapper" class="hidden" style="margin-top: 16px; padding-top: 12px; border-top: 1px dashed var(--border); display: flex; align-items: center; gap: 8px;">
        <i class="fas fa-link" style="color: var(--primary); font-size: 0.8rem;"></i>
        <strong style="font-size: 0.85rem; color: var(--text-muted);">Fonte:</strong>
        <a id="source-link" href="#" target="_blank" style="color: var(--primary); font-size: 0.9rem; text-decoration: none; font-weight: 600; border-bottom: 1px dotted var(--primary);">
            Acessar Referência <i class="fas fa-external-link-alt" style="font-size: 0.7rem; margin-left: 2px;"></i>
        </a>
    </div>
</div>

                           <div id="comment-edit-wrapper" class="hidden">
    <!-- BARRA DE FERRAMENTAS DA EDIÇÃO RÁPIDA -->
    <div style="margin-bottom: 8px; display:flex; justify-content:space-between; align-items:center;">
        <span style="font-size:0.9rem; font-weight:600; color:var(--text-muted)">Editando Explicação</span>
        <div class="editor-toolbar" style="margin-bottom:0">
            <button class="btn-outline btn-sm" onclick="formatCommentEditText('bold')" title="Negrito"><i class="fas fa-bold"></i></button>
            <button class="btn-outline btn-sm" onclick="formatCommentEditText('italic')" title="Itálico"><i class="fas fa-italic"></i></button>
            <button class="btn-outline btn-sm" onclick="formatCommentEditText('underline')" title="Sublinhado"><i class="fas fa-underline"></i></button>
        </div>
    </div>

    <!-- ÁREA EDITÁVEL RICA (DIV em vez de TEXTAREA) -->
    <div id="comment-edit-area" class="rich-editor" contenteditable="true" 
         style="min-height: 120px; max-height: 300px; overflow-y: auto; resize: vertical; width: 100%; margin-bottom: 12px; border: 1px solid var(--border); border-radius: 8px; padding: 12px; background: var(--bg-body);">
    </div>

    <div style="text-align:right;">
        <button class="btn-sm btn-outline" onclick="toggleCommentSection()" style="margin-right:8px">Cancelar</button>
        <button class="btn-sm action-btn" onclick="saveCommentEdit()">Salvar</button>
    </div>
</div>

                        </div>
                        
                        <!-- NEW NAVIGATION AREA -->
                        <div class="study-controls-container">
<div class="nav-buttons-row" style="display: flex; gap: 10px; width: 100%; margin-bottom: 15px;">
    
    <!-- Esquerda: Navegação Principal -->
    <button id="nav-prev-btn" class="btn-study-rect" onclick="prevCard()" style="flex: 1;">
        <i class="fas fa-arrow-left"></i> Anterior
    </button>

    <button id="nav-next-btn" class="btn-study-rect" onclick="nextCard()" style="flex: 1;">
        Próximo <i class="fas fa-arrow-right"></i>
    </button>

    <!-- Direita: Ferramentas -->
    <button onclick="if(currentCard) openCardHistory(currentCard.id)" class="btn-study-rect" title="Ver histórico" style="
        flex: 0 0 auto;
        min-width: 110px;
        color: var(--text-muted);
        font-weight: 500;
    ">
        <i class="fas fa-history"></i> Histórico
    </button>

</div>


                            
                            <button id="confirm-action-btn" class="btn-study-confirm" onclick="confirmAnswer()">
                                Confirmar Resposta
                            </button>
                            
                            <button id="view-comment-btn" class="btn-study-confirm hidden" style="background-color: var(--secondary);" onclick="toggleCommentSection()">
                                <i class="fas fa-comment-alt"></i> Ver Comentário
                            </button>
                        </div>
                        
                        <!-- Finish Button (shown only at end) -->
                        <div style="text-align:center; margin-top:16px;">
                            <!-- Botão sempre visível agora -->
<button id="finish-review-btn" class="action-btn btn-danger" onclick="finishRandomReview()" style="width:auto; margin:0 auto;">
    Encerrar Sessão
</button>

                        </div>
                    </div>
                </div>

                <div id="simulation-result" class="hidden" style="animation: fadeIn 0.4s ease-out;">
                    <div class="sim-result-card">
                         <div class="sim-result-header">
                            <h3 style="margin-bottom:20px;">Relatório de Desempenho</h3>
                            <div class="sim-score-big" id="sim-score-pct">0%</div>
                            <div class="sim-score-label">Aproveitamento</div>
                         </div>
                         <div class="sim-stats-row">
                             <div class="sim-stat-box">
                                 <div class="sim-stat-val" style="color:var(--success)" id="sim-correct-count">0</div>
                                 <div style="font-size:0.8rem; color:var(--text-muted);">Acertos</div>
                             </div>
                             <div class="sim-stat-box">
                                 <div class="sim-stat-val" style="color:var(--danger)" id="sim-wrong-count">0</div>
                                 <div style="font-size:0.8rem; color:var(--text-muted);">Erros</div>
                             </div>
                             <div class="sim-stat-box">
                                 <div class="sim-stat-val" style="color:var(--text-main)" id="sim-total-count">0</div>
                                 <div style="font-size:0.8rem; color:var(--text-muted);">Total</div>
                             </div>
                         </div>
                    </div>

                    <h4 style="margin-left:8px; margin-bottom:12px; color:var(--text-muted); text-transform:uppercase; font-size:0.85rem;">Gabarito Detalhado</h4>
                    <div id="sim-detailed-log" class="sim-log-container"></div>

                    <div style="display:flex; gap:12px; justify-content: center; margin-top:24px;">
                        <button class="action-btn" onclick="saveSimulationResult()"><i class="fas fa-save"></i> Salvar e Sair</button>
                        <button class="btn-outline action-btn" onclick="finishRandomReview()" style="width: auto;">Sair sem Salvar</button>
                    </div>
                </div>

                <div id="no-cards-msg" class="hidden" style="text-align: center; padding: 60px 20px;">
                    <div style="background: var(--primary-light); width: 80px; height: 80px; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 20px;">
                        <i class="fas fa-check-double" style="font-size: 2.5rem; color: var(--primary);"></i>
                    </div>
                    <h3 style="margin-bottom: 8px;">Tudo em dia!</h3>
                    <p style="color: var(--text-muted); margin-bottom: 24px;">Você zerou sua fila de revisões por hoje.</p>
                    <button class="action-btn btn-prominent" onclick="switchStudyTab('creator')" style="width: auto;">Criar Novo Card <i class="fas fa-plus" style="margin-left:8px"></i></button>
                </div>
            </div>

            
            <!-- SUB VIEW: LIBRARY (Redesenhada) -->
<!-- SUB VIEW: LIBRARY (Design Limpo e Formal) -->
<div id="sub-view-library" class="hidden">
    
    <div class="library-header">
        <div id="total-cards-count" style="font-weight: 600; color: var(--primary);">Calculando...</div>
    </div>

    <!-- Filtros -->
    <div class="library-filters-container">
        
        <!-- Busca -->
        <div class="lib-input-group">
            <label class="lib-label">Pesquisar</label>
            <input type="text" id="search-cards" class="lib-control" 
                   placeholder="Digite palavras-chave..." onkeyup="renderManageList()">
        </div>

        <!-- Ordenação -->
        <div class="lib-input-group">
            <label class="lib-label">Ordenar por</label>
            <select id="filter-sort" class="lib-control" onchange="renderManageList()">
                <option value="newest">Mais Recentes</option>
                <option value="oldest">Mais Antigos</option>
                <option value="reviewDateAsc">Próximas Revisões (Cedo)</option>
                <option value="reviewDateDesc">Próximas Revisões (Tarde)</option>
                <option value="az">Ordem Alfabética (A-Z)</option>
            </select>
        </div>

        <!-- Categoria -->
        <div class="lib-input-group">
            <label class="lib-label">Categoria</label>
            <select id="filter-category" class="lib-control" onchange="renderManageList()">
                <option value="all">Todas as Categorias</option>
                <!-- Opções preenchidas automaticamente -->
            </select>
        </div>
    </div>

    <!-- Lista de Cards -->
    <div id="cards-list-container"></div>
    
    <!-- Mensagem de Vazio -->
    <div id="empty-list-msg" class="hidden" style="text-align: center; padding: 60px; color: var(--text-muted);">
        <p style="font-size: 1.1rem;">Nenhum card encontrado com estes filtros.</p>
    </div>

    <!-- Paginação -->
    <div id="library-pagination" style="display: flex; justify-content: center; align-items: center; gap: 20px; margin-top: 30px; padding-bottom: 40px;">
        <button class="btn-sm btn-outline" onclick="changeLibraryPage(-1)">
            Anterior
        </button>
        <span id="page-info" style="font-size: 1rem; font-weight: bold; padding: 5px 15px;">Pág 1</span>
        <button class="btn-sm btn-outline" onclick="changeLibraryPage(1)">
            Próxima
        </button>
    </div>
</div>


            <!-- SUB VIEW: CREATOR (Redesigned) -->
            <div id="sub-view-creator" class="hidden">
                <div class="card-box create-container">
                    
                    <div class="create-grid">
                        <div>
                            <label class="create-label">Matéria / Categoria</label>
                            <input type="text" id="input-category" list="category-list-suggestions" placeholder="Ex: História, Inglês..." onfocus="updateCategoryDropdowns()" oninput="updateSubcategorySuggestions()" style="margin-bottom:0;">
                            <datalist id="category-list-suggestions"></datalist>
                        </div>
                        <div>
                            <label class="create-label">Tópico / Subcategoria</label>
                            <input type="text" id="input-subcategory" list="subcategory-list-suggestions" placeholder="Ex: Verbos, Revolução..." style="margin-bottom:0;">
                            <datalist id="subcategory-list-suggestions"></datalist>
                        </div>
                    </div>

                    <div>
                        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
                            <label class="create-label" style="margin-bottom:0;">Pergunta</label>
                            <div class="editor-toolbar" style="margin-bottom:0;">
                                <button class="btn-outline btn-sm" onclick="formatQuestionText('bold')"><i class="fas fa-bold"></i></button>
                                <button class="btn-outline btn-sm" onclick="formatQuestionText('italic')"><i class="fas fa-italic"></i></button>
                                <button class="btn-outline btn-sm" onclick="formatQuestionText('underline')"><i class="fas fa-underline"></i></button>
                            </div>
                        </div>
                        <div id="input-question" class="rich-editor" contenteditable="true" placeholder="Digite sua pergunta aqui..."></div>
                    </div>

                    <div class="answer-group">
                        <label class="create-label">Alternativas</label>
                        
                        <div class="answer-block correct-answer">
                            <i class="fas fa-check-circle answer-icon"></i>
                            <input type="text" id="input-opt-a" placeholder="Digite a resposta correta aqui">
                        </div>
                        
                        <div class="answer-block wrong-answer">
                            <i class="far fa-circle answer-icon"></i>
                            <input type="text" id="input-opt-b" placeholder="Alternativa incorreta 1">
                        </div>
                        
                        <div class="answer-block wrong-answer">
                            <i class="far fa-circle answer-icon"></i>
                            <input type="text" id="input-opt-c" placeholder="Alternativa incorreta 2">
                        </div>
                        
                        <div class="answer-block wrong-answer">
                            <i class="far fa-circle answer-icon"></i>
                            <input type="text" id="input-opt-d" placeholder="Alternativa incorreta 3">
                        </div>
                        <div class="answer-block wrong-answer">
    <i class="far fa-circle answer-icon"></i>
    <input type="text" id="input-opt-e" placeholder="Alternativa incorreta 4">
</div>

                    </div>

                    <!-- CAMPO FONTE ADICIONADO -->
<div style="margin-bottom: 12px;">
    <label class="create-label">Fonte / Referência (Link)</label>
    <input type="url" id="input-source" placeholder="Ex: https://youtube.com/..." style="margin-bottom:0;">
</div>

<div style="margin-bottom: 20px;">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
        <label class="create-label" style="margin-bottom:0">Explicação / Comentário (Opcional)</label>
        
        <!-- Barra de Ferramentas -->
        <div class="editor-toolbar" style="margin-bottom:0">
            <button class="btn-outline btn-sm" onclick="formatCommentText('bold')" title="Negrito"><i class="fas fa-bold"></i></button>
            <button class="btn-outline btn-sm" onclick="formatCommentText('italic')" title="Itálico"><i class="fas fa-italic"></i></button>
            <button class="btn-outline btn-sm" onclick="formatCommentText('underline')" title="Sublinhado"><i class="fas fa-underline"></i></button>
        </div>
    </div>

    <!-- Área de Edição Rica (substitui o textarea) -->
    <div id="input-comment" class="rich-editor" contenteditable="true" 
         placeholder="Explicação que aparece após responder..." 
         style="min-height: 120px; max-height: 300px; overflow-y: auto; resize: vertical; width: 100%; box-sizing: border-box; border: 1px solid var(--border); border-radius: 8px; padding: 12px; background: var(--bg-body);">
    </div>
</div>



                    <div style="display: flex; gap: 12px; padding-top:16px; border-top:1px solid var(--border);">
                        <button id="save-btn" class="action-btn" onclick="handleSave()" style="flex:1;">
                            <i class="fas fa-save"></i> Salvar Card
                        </button>
                        <button id="cancel-edit-btn" class="action-btn btn-outline hidden" onclick="resetForm()">Cancelar</button>
                    </div>
                </div>
            </div>
        </section>

        <!-- OLD Create & Manage views REMOVED (Merged above) -->

        <section id="syllabus-view" class="view-section hidden">
            <div class="card-box" style="background: linear-gradient(135deg, var(--primary), var(--secondary)); color: white; border: none; overflow: hidden; position: relative; margin-bottom: 24px;">
                <i class="fas fa-clipboard-list" style="position: absolute; right: -20px; bottom: -20px; font-size: 8rem; opacity: 0.1;"></i>
                <div style="display: flex; justify-content: space-between; align-items: center; position: relative; z-index: 2; flex-wrap: wrap; gap:16px;">
                    <div>
                        <h3 style="color: white; margin: 0; font-size: 1.2rem;">Meus Editais</h3>
                        <p style="opacity: 0.9; margin-top: 4px; font-size: 0.9rem;">Crie seus editais e acompanhe seu desenvolvimento...</p>
                    </div>
                    <div>
                        <button class="action-btn" onclick="createNewEdital()" style="background: rgba(255,255,255,0.25); width: auto; font-size: 0.9rem; border: 1px solid rgba(255,255,255,0.4);">
                            <i class="fas fa-plus"></i> Novo Edital
                        </button>
                    </div>
                </div>
            </div>
            <div id="syllabus-list-container"></div>
        </section>

        <section id="syllabus-detail-view" class="view-section hidden">
            <div style="display:flex; align-items:center; gap:10px; margin-bottom: 16px;">
                <button class="btn-icon" onclick="switchTab('syllabus')" style="background:transparent; border:none; color:var(--text-muted); font-size:1.2rem; width:auto; height:auto; padding:0;">
                    <i class="fas fa-arrow-left"></i>
                </button>
                <h3 style="margin:0; font-size:1.1rem; color:var(--text-muted);">Voltar para Editais</h3>
                <div style="margin-left:auto; display:flex; gap:8px;">
                     <button class="btn-icon" onclick="reorderSubjects()" title="Reorganizar">
                        <i class="fas fa-sort"></i>
                    </button>
                    <button class="btn-icon" onclick="deleteCurrentEdital()" style="color:var(--danger); border-color:rgba(239,68,68,0.3); background: rgba(239,68,68,0.1);">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </div>

            <!-- Hero Card -->
            <div class="card-box" style="background: linear-gradient(135deg, var(--primary), var(--secondary)); color: white; border: none; padding: 24px; position:relative; overflow:hidden;">
                <i class="fas fa-chart-bar" style="position: absolute; right: -20px; bottom: -30px; font-size: 10rem; opacity: 0.1;"></i>
                <div style="display:flex; justify-content:space-between; align-items:flex-start; margin-bottom: 20px; position:relative; z-index:2;">
                    <div>
                         <div style="display:flex; align-items:center; gap:10px; margin-bottom: 8px;">
                            <h2 id="current-edital-title" style="margin:0; font-size:1.8rem; font-weight:800; color:white; line-height:1.2;">Título</h2>
                            <button onclick="editEditalTitle()" style="background:rgba(255,255,255,0.2); border:none; color:white; width:30px; height:30px; border-radius:50%; cursor:pointer; display:flex; align-items:center; justify-content:center;"><i class="fas fa-pen" style="font-size:0.8rem"></i></button>
                         </div>
                         <div style="font-size:0.9rem; opacity:0.9; color:white;">Progresso Geral</div>
                    </div>
                    <div id="current-edital-percent" style="font-size:2.2rem; font-weight:800; color:white;">0%</div>
                </div>
                
                <div style="height:8px; background:rgba(255,255,255,0.3); border-radius:4px; overflow:hidden; position:relative; z-index:2;">
                    <div id="current-edital-progress" style="height:100%; background:white; width:0%; transition:width 0.5s;"></div>
                </div>
            </div>

            <!-- Controls -->
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:16px; margin-bottom:24px;">
                <button class="card-box" onclick="addSubjectToEdital()" style="margin:0; padding:16px; display:flex; align-items:center; justify-content:center; gap:10px; cursor:pointer; border:1px dashed var(--primary); color:var(--primary); font-weight:600; transition:all 0.2s;">
                    <div style="background:var(--primary-light); width:32px; height:32px; border-radius:50%; display:flex; align-items:center; justify-content:center;"><i class="fas fa-plus"></i></div>
                    Nova Matéria
                </button>
                <button class="card-box" onclick="importFromNotes()" style="margin:0; padding:16px; display:flex; align-items:center; justify-content:center; gap:10px; cursor:pointer; border:1px dashed var(--text-muted); color:var(--text-muted); font-weight:600;">
                    <div style="background:var(--bg-body); width:32px; height:32px; border-radius:50%; display:flex; align-items:center; justify-content:center;"><i class="fas fa-book"></i></div>
                    Importar
                </button>
            </div>

            <div id="subjects-container"></div>
        </section>

        <section id="schedule-view" class="view-section hidden">
            <div class="hero-header-card">
                <i class="fas fa-calendar-alt hero-bg-icon"></i>
                <div class="hero-content">
                    <div>
                        <h2 class="hero-title">Minha Agenda</h2>
                        <p class="hero-subtitle">Organize seu tempo e cumpra suas metas.</p>
                    </div>
                </div>
            </div>

            <div class="schedule-layout">
                <div class="task-section">
                    <div class="task-header">
                        <div>
                            <h3 style="margin-bottom: 4px; font-size: 1.3rem;">Metas do Dia</h3>
                            <div style="font-size: 0.9rem; color: var(--text-muted);">Foco total hoje!</div>
                            <!-- New Template Buttons for Tasks -->
                            <div class="template-actions">
                                <button class="btn-template btn-save-tmpl" onclick="openTemplateModal('task', 'save')"><i class="fas fa-save"></i> Salvar Modelo</button>
                                <button class="btn-template btn-load-tmpl" onclick="openTemplateModal('task', 'load')"><i class="fas fa-folder-open"></i> Carregar</button>
                            </div>
                        </div>
                        <button class="btn-sm btn-outline" onclick="clearCompletedTasks()" style="color: var(--text-muted);">Limpar Concluídas</button>
                    </div>
                    
                    <div class="task-progress-bar" style="height:8px; background:var(--bg-body); border-radius:4px; overflow:hidden; margin-bottom:24px;">
                        <div id="task-progress-fill" style="height:100%; background:var(--success); width:0%; transition: width 0.3s ease;"></div>
                    </div>
                    
                    <div class="task-input-group" style="display:flex; gap:12px; margin-bottom:20px;">
                        <input type="text" id="new-task-input" placeholder="Adicionar nova meta..." style="margin-bottom: 0; padding: 14px;">
                        <button class="action-btn" onclick="addTask()" style="width: auto; padding: 0 20px;"><i class="fas fa-plus"></i></button>
                    </div>
                    <div id="tasks-container" class="task-list"></div>
                </div>

                <div class="calendar-wrapper">
                    <div class="calendar-header" style="display:flex; justify-content:space-between; align-items:flex-start; margin-bottom: 16px;">
                        <div style="display: flex; gap: 8px;">
                            <button class="btn-icon" onclick="changeWeek(-1)"><i class="fas fa-chevron-left"></i></button>
                            <button class="btn-icon" onclick="changeWeek(1)"><i class="fas fa-chevron-right"></i></button>
                        </div>
                        <div style="text-align: right; display: flex; flex-direction: column; align-items: flex-end;">
                            <span id="current-week-label" style="display: block; font-weight: 800; font-size: 1.1rem; color: var(--primary);">Semana Atual</span>
                            <span id="current-month-label" style="font-size: 0.8rem; color: var(--text-muted); font-weight: 600; margin-bottom: 8px;">...</span>
                             <!-- New Template Buttons for Schedule -->
                            <div class="template-actions">
                                <button class="btn-template btn-save-tmpl" onclick="openTemplateModal('schedule', 'save')"><i class="fas fa-save"></i> Salvar</button>
                                <button class="btn-template btn-load-tmpl" onclick="openTemplateModal('schedule', 'load')"><i class="fas fa-folder-open"></i> Carregar</button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="schedule-grid-container">
                        <table class="modern-table">
                            <thead>
                                <tr>
                                    <th style="width: 80px;">Hora</th>
                                    <th id="th-0">SEG</th><th id="th-1">TER</th><th id="th-2">QUA</th><th id="th-3">QUI</th><th id="th-4">SEX</th><th id="th-5">SÁB</th><th id="th-6">DOM</th>
                                </tr>
                            </thead>
                            <tbody id="schedule-body"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </section>

        <section id="notes-view" class="view-section hidden">
            <div class="hero-header-card">
                <i class="fas fa-book hero-bg-icon"></i>
                <div class="hero-content">
                    <div>
                        <h2 class="hero-title">Caderno Digital</h2>
                        <p class="hero-subtitle">Seus resumos e anotações em um só lugar.</p>
                    </div>
                    <div style="display:flex; gap:10px;">
                        <button class="action-btn" onclick="promptNewFolder()" style="background: rgba(255,255,255,0.2); width:auto; border: 1px solid rgba(255,255,255,0.3); font-size:0.9rem;"><i class="fas fa-folder-plus"></i> Pasta</button>
                        <button class="action-btn" onclick="createNewNote()" style="background: white; color: var(--primary); width:auto; font-size:0.9rem;"><i class="fas fa-file-alt"></i> Nota</button>
                    </div>
                </div>
            </div>
            <!-- ADICIONE ESTE CÓDIGO AQUI -->
<div id="srs-review-banner" style="display:none; background: linear-gradient(135deg, #ff9800 0%, #ed6c02 100%); margin: 15px 0; padding: 15px; border-radius: 12px; color: white; box-shadow: 0 4px 15px rgba(237, 108, 2, 0.3);">
    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 10px;">
        <h3 style="margin:0; font-size: 1.1rem; color: white;">
    Revisões Pendentes
</h3>

        <span id="srs-count-badge" style="background: rgba(255,255,255,0.2); padding: 2px 8px; border-radius: 10px; font-size: 0.8rem;">0</span>
    </div>
    <div id="srs-list" style="max-height: 150px; overflow-y: auto;">
        <!-- Itens serão inseridos via JS -->
    </div>
</div>
<!-- FIM DO CÓDIGO ADICIONADO -->

            <div id="notes-breadcrumbs" class="notes-breadcrumb"></div>
            
            <div style="margin-bottom: 24px; position: relative;">
                <i class="fas fa-search" style="position: absolute; left: 16px; top: 50%; transform: translateY(-50%); color: var(--text-muted);"></i>
                <input type="text" id="search-notes" placeholder="Buscar pastas ou anotações..." onkeyup="renderCurrentFolder()" style="margin-bottom:0; padding-left: 44px;">
            </div>

            <div id="file-explorer" class="file-grid"></div>
            <div id="empty-folder-msg" class="hidden" style="text-align:center; padding:60px 20px; color:var(--text-muted); grid-column:1/-1; display: flex; flex-direction: column; align-items: center; gap: 10px;">
                <i class="far fa-folder-open" style="font-size: 3rem; opacity: 0.3;"></i>
                <span>Pasta vazia.</span>
            </div>
        </section>

        <section id="note-editor-view" class="view-section hidden">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <button class="btn-back" onclick="closeNoteEditor()" style="margin-bottom: 0;">
                    <i class="fas fa-arrow-left"></i> Voltar
                </button>
                <div style="display:flex; gap:12px; align-items:center;">
                    <select id="note-folder-select" style="margin-bottom:0; width:auto; padding:10px;">
                        <option value="null">Início</option>
                    </select>
                    <button class="action-btn" onclick="openSRSSettings()" style="width: auto; margin-right: 5px; background: var(--warning); color: #fff;" title="Configurar Revisão">
    <i class="fas fa-history"></i>
</button>
                    <button class="action-btn" onclick="saveNote()" style="width: auto;">Salvar</button>
                </div>
            </div>
            
            <input type="text" id="note-title" placeholder="Título da Anotação" style="font-size: 1.8rem; font-weight: 800; border: none; background: transparent; padding: 0; margin-bottom: 20px; color: var(--text-main);">
            <!-- O Quill vai nascer aqui dentro -->
          <div id="editor-container" style="min-height: 600px; height: 65vh; max-height: 90vh; resize: vertical; overflow: auto; border-radius: 0 0 8px 8px;"></div>


        </section>

        <section id="card-detail-view" class="view-section hidden">
            <button class="btn-back" onclick="switchTab('study'); switchStudyTab('library');">
                <i class="fas fa-arrow-left"></i> Voltar
            </button>
            <div class="card-box">
                <span id="detail-category" style="background: var(--primary); color: white; padding: 4px 12px; border-radius: 12px; font-size: 0.8rem; font-weight: 700;">GERAL</span>
                <div id="detail-question" class="question-text" style="margin-top: 20px;"></div>
                <div id="detail-options-list" style="display: flex; flex-direction: column; gap: 10px; margin-bottom: 24px;"></div>
                <div id="detail-comment-container" style="background: var(--bg-body); padding: 20px; border-radius: 12px; border-left: 4px solid var(--primary);">
                    <strong style="color: var(--primary); display: block; margin-bottom: 4px;">Explicação:</strong> 
                    <span id="detail-comment-text" style="color: var(--text-main);"></span>
                    <!-- FONTE NOS DETALHES -->
<div id="detail-source-wrapper" class="hidden" style="margin-top: 12px; font-size: 0.9rem;">
    <strong style="color: var(--primary);">Fonte:</strong> 
    <a id="detail-source-link" href="#" target="_blank" style="color: var(--info); text-decoration: underline;">Ver Link</a>
</div>

                </div>
                <div style="display: flex; gap: 12px; margin-top: 32px; border-top: 1px solid var(--border); padding-top: 20px;">
                    <button class="action-btn btn-outline" onclick="editCurrentCard()">Editar</button>
                    <button class="action-btn btn-danger" onclick="deleteCurrentCard()">Excluir</button>
                </div>
            </div>
        </section>

        <!-- MODIFIED: Performance View Reformulated (Horizontal & Banner Buttons) -->
        <section id="performance-view" class="view-section hidden">
            <div class="hero-header-card">
                <i class="fas fa-chart-line hero-bg-icon"></i>
                <div class="hero-content">
                    <div>
                        <h2 class="hero-title">Meu Desempenho</h2>
                        <p class="hero-subtitle">Acompanhe sua evolução e métricas de estudo.</p>
                    </div>
                    <div class="hero-actions">
                        <button id="btn-week" class="banner-period-btn active" onclick="changePeriod('week')">Semana</button>
                        <button id="btn-month" class="banner-period-btn" onclick="changePeriod('month')">Mês</button>
                        <button id="btn-year" class="banner-period-btn" onclick="changePeriod('year')">Ano</button>
                    </div>
                </div>
            </div>

            <!-- Date Display -->
            <div style="text-align: center; margin-bottom: 24px; color: var(--text-main);">
                <div style="display: flex; align-items: center; justify-content: center; gap: 20px;">
                    <button class="btn-outline btn-sm" style="width: 32px; padding: 0;" onclick="prevPeriod()"><i class="fas fa-chevron-left"></i></button>
                    <span id="period-display" style="font-weight: 800; font-size: 1.1rem; min-width: 150px;">...</span>
                    <button class="btn-outline btn-sm" style="width: 32px; padding: 0;" onclick="nextPeriod()"><i class="fas fa-chevron-right"></i></button>
                </div>
            </div>

            <div class="performance-layout">
                <!-- Row 1: Top Metrics (Full Width Stack) -->
                <div class="performance-card">
                    <h3 style="margin-bottom:20px;">Métricas Principais</h3>
                    <div class="performance-metrics">
                        <div class="metric-box">
                            <div class="metric-value" id="total-reviews-count">0</div>
                            <div class="metric-label">Revisões Feitas</div>
                        </div>
                        <div class="metric-box">
                            <div class="metric-value" id="accuracy-rate">0%</div>
                            <div class="metric-label">Taxa de Acertos</div>
                        </div>
                        <div class="metric-box">
                            <div class="metric-value" id="performance-streak">0</div>
                            <div class="metric-label">Dias de Ofensiva</div>
                        </div>
                                                <div class="metric-box">
                            <!-- O ID PRECISA SER reviews-today PARA O APP NÃO QUEBRAR -->
                            <div class="metric-value" id="reviews-today">0</div>
                            <div class="metric-label">Tempo de Estudo</div>
                        </div>


                    </div>
                </div>

                <!-- === NOVO GRÁFICO: ACERTOS vs ERROS (Duas Colunas) === -->
<div class="performance-card">
  <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
    <h3 style="margin:0">Balanço: Acertos vs Erros</h3>
    <div style="display:flex; gap:15px; font-size:0.8rem; font-weight:600;">
         <div style="display:flex; align-items:center; gap:6px;">
             <span style="width:12px; height:12px; background:#10b981; border-radius:2px;"></span> Acertos
         </div>
         <div style="display:flex; align-items:center; gap:6px;">
             <span style="width:12px; height:12px; background:#ef4444; border-radius:2px;"></span> Erros
         </div>
    </div>
  </div>
  
  <!-- GRÁFICO COM ROLAGEM RESPONSIVA -->
<div id="accuracy-vs-error-chart" class="dash-mini-chart" 
     style="
        height: 200px; 
        display: flex; 
        align-items: flex-end; 
        gap: 8px; 
        overflow-x: auto; /* Permite rolagem lateral */
        padding-bottom: 10px; /* Espaço para barra de rolagem não cobrir legendas */">
</div>

</div>


<!-- GRÁFICO DE CARDS CRIADOS (NOVO) -->
<div class="card-box" style="margin-bottom: 24px;">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <h3 style="margin: 0; font-size: 1.1rem; color: var(--text-main);">Evolução: Cards Criados</h3>
        <div style="display: flex; align-items: center; gap: 12px; font-size: 0.85rem;">
            <div style="display: flex; align-items: center; gap: 6px;">
                <div style="width: 10px; height: 10px; background: var(--primary); border-radius: 2px;"></div>
                <span style="color: var(--text-muted);">Novos Cards</span>
            </div>
        </div>
    </div>
    
    <!-- Container do Gráfico (Com rolagem horizontal igual ao anterior) -->
    <div id="cards-created-chart" class="dash-mini-chart" 
         style="
            height: 200px; 
            display: flex; 
            align-items: flex-end; 
            gap: 8px; 
            overflow-x: auto; 
            padding-bottom: 10px;
         ">
         <!-- O JS vai preencher aqui -->
    </div>
</div>



                <!-- Row 1.5 Study Time Chart (NOVO) -->
<div class="performance-card">
  <div style="display:flex; justify-content:space-between; align-items:baseline; gap:12px; flex-wrap:wrap; margin-bottom:20px;">
    <h3 style="margin:0">Tempo de estudo</h3>
    <span id="studytime-chart-subtitle"
          style="font-size:0.85rem; color: var(--text-muted); font-weight:600;"></span>
  </div>

  <div id="studytime-chart" class="dash-mini-chart" style="height:180px;"></div>
</div>


                <!-- Row 2: Evolution Chart (Full Width) -->
                <div class="performance-card">
                    <h3 style="margin-bottom:20px;">Evolução Diária</h3>
                    <div id="performance-chart" style="display: flex; flex-direction: column; gap: 12px; min-height: 200px;"></div>
                </div>

                <!-- Row 3: Breakdown by Subject & Category (Full Width) -->
                <div class="performance-card">
                    <h3 style="margin-bottom:20px;">Desempenho por Matéria</h3>
                    <div id="category-stats-list" style="display: flex; flex-direction: column; gap: 10px;"></div>
                </div>

                <div class="performance-card">
                    <h3 style="margin-bottom:20px;">Progresso por Categoria</h3>
                    <div class="category-progress-grid" id="category-progress-grid"></div>
                </div>
            </div>
        </section>

        <section id="settings-view" class="view-section hidden">
                                    <!-- BANNER DE DOAÇÕES (DESIGN MODERNO ORANGE) -->
            <div class="card-box" style="
                background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
                color: white;
                border: none;
                display: flex;
                flex-wrap: wrap;
                gap: 24px;
                align-items: center;
                justify-content: space-between;
                position: relative;
                overflow: hidden;
            ">
                <!-- Efeito de brilho sutil no fundo para modernidade -->
                <div style="position: absolute; top: -50%; left: -10%; width: 200px; height: 200px; background: rgba(255,255,255,0.1); border-radius: 50%;"></div>
                
                <div style="flex: 1; min-width: 250px; z-index: 1;">
                    <h3 style="margin-bottom: 12px; color: white; display: flex; align-items: center; gap: 10px; font-size: 1.3rem;">
                        <i class="fas fa-hand-holding-heart"></i> Apoie o Projeto
                    </h3>
                    <p style="color: rgba(255,255,255,0.95); font-size: 0.95rem; line-height: 1.6; margin-bottom: 0;">
                        Gosta do app? Ajude a manter o desenvolvimento ativo e 100% grátis! <br>
                        Sua doação traz novas atualizações e melhorias.
                    </p>
                </div>

                <div style="text-align: center; margin: 0 auto; z-index: 1;">
                    <div style="
                        background: white; 
                        padding: 8px; 
                        border-radius: var(--radius-md); 
                        box-shadow: 0 4px 15px rgba(0,0,0,0.2);
                        display: inline-block;
                    ">
                        <!-- Imagem do QR Code -->
                        <img src="assets/qrcode.png" alt="Pix QR Code" style="width: 120px; height: 120px; display: block; border-radius: 4px;">
                    </div>
                    <div style="margin-top: 8px; font-size: 0.8rem; font-weight: 600; opacity: 0.9;">
                        <i class="fas fa-qrcode"></i> Escaneie o Pix
                    </div>
                </div>
            </div>
            <!-- FIM DO BANNER -->


 <!-- === SISTEMA ANTI-DISTRAÇÃO (CORRIGIDO) === -->
<div class="card-box">
    <!-- Título Principal -->
    <h3 style="font-size: 1.1rem; margin-bottom: 5px;">Sistema Anti-Distração (Pomodoro)</h3>
    
    <!-- Texto Base -->
    <p style="color: var(--text-secondary); margin-bottom: 15px; font-size: 0.95rem; line-height: 1.4;">
        Configure o comportamento inteligente do pomodoro para manter seu foco.
    </p>

    <!-- Botão de Ativar/Desativar -->
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 1px solid var(--border);">
        <label style="font-weight: bold; color: var(--text-primary); font-size: 1.1rem;">
            Ativar Sistema
        </label>
        <label class="switch-container">
            <input type="checkbox" id="antiDistractionToggle">
            <span class="slider round"></span>
        </label>
    </div>

    <!-- CONTAINER QUE ESCONDE AS OPÇÕES (Início) -->
    <div id="antiDistractionOptions" style="display: none;">
        
        <!-- ITEM 1: Pausa por Foco -->
        <div style="margin-bottom: 12px; padding-bottom: 12px; border-bottom: 1px solid var(--border);">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px;">
                <label style="font-weight: bold; color: var(--text-primary); font-size: 1.1rem;">
                    Pausa por Foco
                </label>
                <input type="number" id="mouseOutTime" class="input-modern" style="width: 70px; text-align: center;" value="30">
            </div>
            <p style="font-size: 0.95rem; color: var(--text-secondary); margin: 0; line-height: 1.4;">
                Pausa o timer se o mouse sair da janela por mais de <b>segundos</b>.
            </p>
        </div>

        <!-- ITEM 2: Aviso de Inatividade -->
        <div style="margin-bottom: 12px; padding-bottom: 12px; border-bottom: 1px solid var(--border);">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px;">
                <label style="font-weight: bold; color: var(--text-primary); font-size: 1.1rem;">
                    Aviso de Inatividade
                </label>
                <input type="number" id="inactivityTime" class="input-modern" style="width: 70px; text-align: center;" value="5">
            </div>
            <p style="font-size: 0.95rem; color: var(--text-secondary); margin: 0; line-height: 1.4;">
                Pergunta "Você ainda está aí?" após <b>minutos</b> sem mexer no PC.
            </p>
        </div>

        <!-- ITEM 3: Retomada Automática -->
        <div style="margin-bottom: 25px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px;">
                <label style="font-weight: bold; color: var(--text-primary); font-size: 1.1rem;">
                    Retomada Automática
                </label>
                <input type="number" id="resumeCountdown" class="input-modern" style="width: 70px; text-align: center;" value="10">
            </div>
            <p style="font-size: 0.95rem; color: var(--text-secondary); margin: 0; line-height: 1.4;">
                Contagem de <b>segundos</b> para retomar ao voltar a atividade.
            </p>
        </div>

    </div> <!-- FIM DO CONTAINER QUE ESCONDE AS OPÇÕES (Adicionei este fechamento aqui!) -->

    <button onclick="saveAntiDistractionConfig()" class="action-btn" style="width: 100%; justify-content: center; font-size: 1rem; padding: 10px;">
        Salvar Alterações
    </button>
    
    <div id="configStatus" style="text-align: center; margin-top: 8px; height: 15px; font-size: 0.9rem; font-weight: bold;"></div>
</div>







            <!-- NEW: Revision Intensity Settings -->
            <div class="card-box">
                <h3>Intensidade da Revisão</h3>
                <p style="color:var(--text-muted); margin-bottom:12px; font-size:0.95rem;">
                    Defina a frequência com que os cards reaparecerão para revisão.
                </p>
                <div style="margin-bottom: 12px;">
                    <select id="revision-level-select" onchange="changeRevisionLevel(this.value)">
                        <option value="light">Leve (Intervalos Longos)</option>
                        <option value="moderate">Moderada (Padrão)</option>
                        <option value="intense">Intensa (Intervalos Curtos)</option>
                    </select>
                </div>
                <div style="background: var(--bg-body); padding: 12px; border-radius: 8px; border: 1px solid var(--border); font-size: 0.85rem; color: var(--text-muted);">
    <i class="fas fa-info-circle"></i> <strong>Nota:</strong> A nova intensidade será aplicada nas suas próximas revisões.
    <ul style="margin: 12px 0 0 20px; padding: 0; color: var(--text-color);">
        <li style="margin-bottom: 10px;">
            <strong>Leve (x2.2):</strong> Intervalos longos. Menos revisões, ideal para revisão rápida.
        </li>
        <li style="margin-bottom: 10px;">
            <strong>Moderada (x1.8):</strong> Equilibrado. Ritmo constante para fixação segura.
        </li>
        <li style="margin-bottom: 0;">
            <strong>Intensa (x1.4):</strong> Intervalos curtos. Muitas repetições, foco total em não esquecer.
        </li>
    </ul>
</div>

            </div>

            <div class="card-box">
                <h3>Backup e Restauração</h3>
                <p style="color:var(--text-muted); margin-bottom:20px; font-size:0.95rem;">
                    Salve todo o seu progresso (cards, notas, cronograma e metas) em um arquivo ou restaure um backup anterior.
                </p>
                <button class="action-btn" onclick="exportAllData()"><i class="fas fa-download"></i> Baixar Backup Completo</button>
                <button class="btn-outline action-btn" onclick="document.getElementById('import-file').click()" style="margin-top: 10px;"><i class="fas fa-upload"></i> Restaurar Backup</button>
                <input type="file" id="import-file" style="display: none;" onchange="importAllData(this)" accept=".json">
            </div>

            <div class="card-box" style="margin-top:20px;">
                <h3 style="color:var(--danger);">Zona de Perigo</h3>
                <p style="color:var(--text-muted); margin-bottom:20px; font-size:0.95rem;">
                    Esta ação apagará todos os seus dados do navegador. Certifique-se de ter um backup.
                </p>
                <button class="btn-outline action-btn" onclick="clearAllData()" style="color: var(--danger); border-color: var(--danger);"><i class="fas fa-trash"></i> Apagar Tudo</button>
            </div>
        </section>

    </main>

    <nav class="bottom-nav">
        <button class="bottom-nav-item active" onclick="switchTab('dashboard')"><i class="fas fa-home"></i>Início</button>
        <button class="bottom-nav-item" onclick="switchTab('study')"><i class="fas fa-book-open"></i>Estudar</button>
        <button class="bottom-nav-item" onclick="switchTab('pomodoro')"><i class="fas fa-stopwatch"></i>Pomodoro</button> 
        <button class="bottom-nav-item" onclick="switchTab('schedule')"><i class="fas fa-calendar-alt"></i>Agenda</button>
    </nav>

    <!-- MODIFIED: FAB Container with upward expansion -->
    <div class="fab-container" id="fab-container">
        <div class="fab-menu" id="fab-menu">
            <button class="fab-item" onclick="quickCreate('card')" title="Novo Card">
                <span class="fab-label">Novo Card</span>
                <div class="fab-icon"><i class="fas fa-layer-group"></i></div>
            </button>
            <button class="fab-item" onclick="quickCreate('note')" title="Nova Nota">
                <span class="fab-label">Nova Nota</span>
                <div class="fab-icon"><i class="fas fa-sticky-note"></i></div>
            </button>
            <button class="fab-item" onclick="quickCreate('goal')" title="Nova Meta">
                <span class="fab-label">Nova Meta</span>
                <div class="fab-icon"><i class="fas fa-check-circle"></i></div>
            </button>
        </div>
        <button class="fab-button" id="fab-button" onclick="toggleFabMenu()">
            <i class="fas fa-plus"></i>
        </button>
    </div>

    <!-- NEW: Floating Timer Widget - Updated Position & Controls -->
    <div id="floating-timer-widget" class="floating-timer">
        <div class="float-time" id="float-time-display">25:00</div>
    </div>

    <!-- NEW: Custom Alert Modal -->
    <div id="custom-alert-modal" class="hidden" style="position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);z-index:3000;display:flex;align-items:center;justify-content:center; padding: 20px;">
        <div class="card-box" style="width:100%;max-width:350px;margin:0; text-align: center; border-radius: 20px;">
            <div style="width: 60px; height: 60px; background: var(--primary-light); color: var(--primary); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.8rem; margin: 0 auto 16px;">
                <i class="fas fa-bell"></i>
            </div>
            <h3 id="custom-alert-title" style="margin-bottom: 8px;">Atenção</h3>
            <p id="custom-alert-msg" style="color:var(--text-muted); margin-bottom: 24px; font-size:0.95rem;">Mensagem</p>
            <button class="action-btn" onclick="document.getElementById('custom-alert-modal').classList.add('hidden')">Entendido</button>
        </div>
    </div>

    <!-- NEW: Custom Confirmation Modal -->
    <div id="custom-confirm-modal" class="hidden" style="position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);z-index:3000;display:flex;align-items:center;justify-content:center; padding: 20px;">
        <div class="card-box" style="width:100%;max-width:350px;margin:0; text-align: center; border-radius: 20px;">
            <div style="width: 60px; height: 60px; background: #fee2e2; color: var(--danger); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.8rem; margin: 0 auto 16px;">
                <i class="fas fa-exclamation-triangle"></i>
            </div>
            <h3 id="confirm-modal-title" style="margin-bottom: 8px;">Confirmar</h3>
            <p id="confirm-modal-msg" style="color:var(--text-muted); margin-bottom: 24px; font-size:0.95rem;">Tem certeza?</p>
            <div style="display:flex; gap:10px;">
                <button class="action-btn btn-outline" onclick="handleConfirm(false)">Cancelar</button>
                <button class="action-btn btn-danger" onclick="handleConfirm(true)">Sim, confirmar</button>
            </div>
        </div>
    </div>

    <div id="schedule-modal" class="hidden" style="position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);z-index:2000;display:flex;align-items:flex-end;justify-content:center;">
        <div class="card-box" style="width:100%;max-width:500px;margin:0;border-bottom-left-radius:0;border-bottom-right-radius:0;">
            <h3>Agendar</h3>
            <input type="text" id="schedule-block-title" placeholder="Título">
            <div style="display:flex;gap:12px;margin-bottom:20px;">
                <div class="color-chip" onclick="selectColor('var(--primary)',this)" style="background:var(--primary);width:30px;height:30px;border-radius:50%;border:2px solid transparent;"></div>
                <div class="color-chip" onclick="selectColor('var(--success)',this)" style="background:var(--success);width:30px;height:30px;border-radius:50%;border:2px solid transparent;"></div>
                <div class="color-chip" onclick="selectColor('var(--info)',this)" style="background:var(--info);width:30px;height:30px;border-radius:50%;border:2px solid transparent;"></div>
            </div>
            <div style="display:flex;gap:10px;">
                <button class="action-btn" onclick="saveScheduleBlock()">Salvar</button>
                <button class="action-btn btn-danger hidden" id="btn-delete-block" onclick="deleteScheduleBlock()">Excluir</button>
                <button class="btn-outline" onclick="closeScheduleModal()">Cancelar</button>
            </div>
        </div>
    </div>
    
    <div id="simulation-config-modal" class="hidden" style="position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.6);z-index:3000;display:flex;align-items:center;justify-content:center; padding: 20px;">
        <div class="card-box" style="width:100%;max-width:450px;margin:0; text-align: left; max-height: 90vh; display:flex; flex-direction:column;">
            <h3 style="color: var(--primary); margin-bottom: 8px;">Configurar Simulado</h3>
            <p style="color:var(--text-muted); font-size:0.9rem; margin-bottom:16px;">Defina a quantidade de questões por matéria:</p>
            
            <div id="sim-category-list" style="overflow-y: auto; margin-bottom: 20px; padding-right:5px;">
                </div>
            
            <div style="border-top: 1px solid var(--border); padding-top: 12px; margin-bottom: 16px; display:flex; justify-content:space-between; font-weight:700;">
                <span>Total de Questões:</span>
                <span id="sim-total-preview" style="color:var(--primary);">0</span>
            </div>

            <div style="display:flex;gap:10px;">
                <button class="action-btn" onclick="startSimulationFromConfig()">Começar</button>
                <button class="btn-outline" onclick="document.getElementById('simulation-config-modal').classList.add('hidden')">Cancelar</button>
            </div>
        </div>
    </div>

    <!-- Modal genérico para edição -->
    <div id="generic-modal" class="hidden" style="position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);z-index:2000;display:flex;align-items:center;justify-content:center; padding: 20px;">
        <div class="card-box" style="width:100%;max-width:500px;margin:0; text-align: left; max-height: 90vh; display:flex; flex-direction:column;">
            <h3 id="generic-modal-title"></h3>
            <input type="text" id="generic-modal-input" placeholder="Digite aqui..." style="margin-bottom:20px;">
            <div id="generic-modal-textarea-container" style="display:none;">
                <textarea id="generic-modal-textarea" rows="4" placeholder="Digite aqui..." style="margin-bottom:20px;"></textarea>
            </div>
            <div style="display:flex;gap:10px;">
                <button class="action-btn" id="generic-modal-confirm">Salvar</button>
                <button class="btn-outline" onclick="closeGenericModal()">Cancelar</button>
            </div>
        </div>
    </div>

    <!-- Modal para configurações do Pomodoro -->
    <div id="pomo-settings-modal" class="hidden" style="position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);z-index:2000;display:flex;align-items:center;justify-content:center; padding: 20px;">
        <div class="card-box" style="width:100%;max-width:400px;margin:0; text-align: left;">
            <h3>Configurar Pomodoro</h3>
            <div style="margin-bottom: 16px;">
                <label style="font-size:0.9rem; font-weight:600; color:var(--text-muted); display:block; margin-bottom:6px;">Pomodoro (minutos)</label>
                <input type="number" id="pomo-input-focus" value="25" min="1" max="60">
            </div>
            <div style="margin-bottom: 16px;">
                <label style="font-size:0.9rem; font-weight:600; color:var(--text-muted); display:block; margin-bottom:6px;">Descanso Curto (minutos)</label>
                <input type="number" id="pomo-input-short" value="5" min="1" max="60">
            </div>
            <div style="margin-bottom: 20px;">
                <label style="font-size:0.9rem; font-weight:600; color:var(--text-muted); display:block; margin-bottom:6px;">Descanso Longo (minutos)</label>
                <input type="number" id="pomo-input-long" value="15" min="1" max="60">
            </div>
            <div style="display:flex; gap:10px;">
                <button class="action-btn" onclick="savePomoSettings()">Salvar</button>
                <button class="btn-outline" onclick="document.getElementById('pomo-settings-modal').classList.add('hidden')">Cancelar</button>
            </div>
        </div>
    </div>

    <!-- Modal para reordenar itens -->
    <div id="reorder-modal" class="hidden" style="position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);z-index:2000;display:flex;align-items:center;justify-content:center; padding: 20px;">
        <div class="card-box" style="width:100%;max-width:500px;margin:0; text-align: left; max-height: 90vh; display:flex; flex-direction:column;">
            <h3 id="reorder-modal-title">Reorganizar</h3>
            <p style="color:var(--text-muted); margin-bottom:16px;">Arraste os itens para reordenar:</p>
            <div id="reorder-list-container" style="overflow-y: auto; margin-bottom: 20px; border: 1px solid var(--border); border-radius: var(--radius-md); padding: 10px;"></div>
            <div style="display:flex;gap:10px;">
                <button class="action-btn" onclick="saveReordering()">Salvar Ordem</button>
                <button class="btn-outline" onclick="document.getElementById('reorder-modal').classList.add('hidden')">Cancelar</button>
            </div>
        </div>
    </div>
    
    <!-- Modal Details for Saved Simulation -->
    <div id="sim-detail-modal" class="hidden" style="position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);z-index:2500;display:flex;align-items:center;justify-content:center; padding: 20px;">
        <div class="card-box" style="width:100%;max-width:500px;margin:0; text-align: left; max-height: 90vh; display:flex; flex-direction:column;">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px;">
                <h3 id="sim-detail-title" style="margin:0;">Detalhes do Simulado</h3>
                <button class="btn-icon" onclick="document.getElementById('sim-detail-modal').classList.add('hidden')"><i class="fas fa-times"></i></button>
            </div>
            <div id="sim-detail-content" style="overflow-y: auto; margin-bottom: 20px; flex:1;"></div>
            <button class="action-btn" onclick="document.getElementById('sim-detail-modal').classList.add('hidden')">Fechar</button>
        </div>
    </div>

    <!-- Modal para vincular tópico a categoria de cards E anotações -->
    <div id="link-topic-modal" class="hidden" style="position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);z-index:2000;display:flex;align-items:center;justify-content:center; padding: 20px;">
        <div class="card-box" style="width:100%;max-width:500px;margin:0; text-align: left; max-height: 90vh; display:flex; flex-direction:column;">
            <h3>Vincular Conteúdo</h3>
            <p style="color:var(--text-muted); margin-bottom:16px;">Associe este tópico a cards de estudo e/ou uma anotação do caderno.</p>
            
            <div style="margin-bottom:20px; border-bottom:1px solid var(--border); padding-bottom:16px;">
                <label style="font-weight:700; margin-bottom:8px; display:block; color:var(--primary);">1. Vincular Flashcards</label>
                <label style="font-weight:600; margin-bottom:4px; display:block; font-size:0.9rem;">Categoria Principal</label>
                
                <!-- NEW SEARCHABLE DROPDOWN FOR CATEGORIES -->
                <div class="search-container">
                    <input type="text" id="link-category-search" placeholder="Buscar categoria..." onkeyup="filterLinkCategories()" onfocus="filterLinkCategories()" autocomplete="off">
                    <div id="link-category-results" class="search-results-list"></div>
                </div>
                
                <label style="font-weight:600; margin-bottom:4px; display:block; font-size:0.9rem;">Subcategoria (Opcional)</label>
                <select id="link-subcategory-select" style="margin-bottom:12px;">
                    <option value="">Todas as subcategorias</option>
                </select>
                
                <div id="link-preview" style="background:var(--bg-body); padding:10px; border-radius:8px; font-size:0.9rem; display:none;">
                    Cards disponíveis: <span id="link-card-count" style="font-weight:bold; color:var(--primary);">0</span>
                </div>
            </div>

            <div style="margin-bottom:20px;">
                <label style="font-weight:700; margin-bottom:8px; display:block; color:var(--primary);">2. Vincular Anotação</label>
                <!-- NEW SEARCHABLE DROPDOWN FOR NOTES -->
                <div class="search-container">
                    <input type="text" id="link-note-search" placeholder="Buscar anotação..." onkeyup="filterLinkNotes()" onfocus="filterLinkNotes()" autocomplete="off">
                    <div id="link-note-results" class="search-results-list"></div>
                </div>
            </div>
            
            <div style="display:flex;gap:10px;">
                <button class="action-btn" id="link-topic-confirm-btn">Salvar Vínculos</button>
                <button class="btn-outline" onclick="document.getElementById('link-topic-modal').classList.add('hidden')">Cancelar</button>
            </div>
        </div>
    </div>

    <!-- NEW: Template Management Modal -->
    <div id="template-modal" class="hidden" style="position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);z-index:2000;display:flex;align-items:center;justify-content:center; padding: 20px;">
        <div class="card-box" style="width:100%;max-width:450px;margin:0; text-align: left; display:flex; flex-direction:column;">
            <h3 id="template-modal-title">Modelos</h3>
            <p id="template-modal-desc" style="color:var(--text-muted); margin-bottom:16px;">Gerenciar modelos salvos.</p>
            
            <div id="template-list-container" class="template-list">
                <!-- Template items injected here -->
            </div>
            
            <div id="template-empty-msg" class="hidden" style="text-align:center; padding:20px; color:var(--text-muted);">Nenhum modelo salvo.</div>

            <div style="display:flex;gap:10px; margin-top:20px;">
                <button class="btn-outline" style="width:100%" onclick="document.getElementById('template-modal').classList.add('hidden')">Fechar</button>
            </div>
        </div>
    </div>

    
</div><!-- END APP CONTENT -->

<script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, sendPasswordResetEmail, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyClmCSBNN63iHY9F_bFXRP2x7YYNr_2Qm4",
            authDomain: "teddy-c5c03.firebaseapp.com",
            projectId: "teddy-c5c03",
            storageBucket: "teddy-c5c03.firebasestorage.app",
            messagingSenderId: "850197478556",
            appId: "1:850197478556:web:e0ae46c5b158c21a64c159",
            measurementId: "G-HSVGWCDCEF"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);

        // UI References
        const authWrapper = document.getElementById('auth-wrapper');
        const appContent = document.getElementById('app-content');
        const errorMsg = document.getElementById('auth-error-msg');
        
        const loginForm = document.getElementById('login-form');
        const registerForm = document.getElementById('register-form');
        const forgotForm = document.getElementById('forgot-form');

        const loginFooter = document.getElementById('login-footer');
        const registerFooter = document.getElementById('register-footer');
        const forgotFooter = document.getElementById('forgot-footer');

        // Expose toggleAuthMode to global scope for HTML onclick
        window.toggleAuthMode = (mode) => {
            errorMsg.style.display = 'none';
            loginForm.classList.add('hidden');
            registerForm.classList.add('hidden');
            forgotForm.classList.add('hidden');
            
            loginFooter.classList.add('hidden');
            registerFooter.classList.add('hidden');
            forgotFooter.classList.add('hidden');

            if (mode === 'login') {
                loginForm.classList.remove('hidden');
                loginFooter.classList.remove('hidden');
            } else if (mode === 'register') {
                registerForm.classList.remove('hidden');
                registerFooter.classList.remove('hidden');
            } else if (mode === 'forgot') {
                forgotForm.classList.remove('hidden');
                forgotFooter.classList.remove('hidden');
            }
        };

        // Helper: Show Error
        const showError = (message) => {
            errorMsg.innerText = message;
            errorMsg.style.display = 'block';
        };

        // Firebase Error Translation
        const getErrorMessage = (error) => {
            switch (error.code) {
                case 'auth/email-already-in-use': return 'Este e-mail já está em uso.';
                case 'auth/invalid-email': return 'E-mail inválido.';
                case 'auth/weak-password': return 'A senha deve ter pelo menos 6 caracteres.';
                case 'auth/user-not-found': return 'Usuário não encontrado.';
                case 'auth/wrong-password': return 'Senha incorreta.';
                case 'auth/too-many-requests': return 'Muitas tentativas. Tente novamente mais tarde.';
                case 'auth/missing-password': return 'Digite a senha.';
                case 'auth/invalid-credential': return 'Credenciais inválidas.';
                default: return 'Erro: ' + error.message;
            }
        };

        // Login Handler
        loginForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            
            signInWithEmailAndPassword(auth, email, password)
                .catch((error) => showError(getErrorMessage(error)));
        });

        // Register Handler
        registerForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const email = document.getElementById('reg-email').value;
            const password = document.getElementById('reg-password').value;
            const confirm = document.getElementById('reg-confirm').value;

            if (password !== confirm) return showError('As senhas não coincidem.');

            createUserWithEmailAndPassword(auth, email, password)
                .catch((error) => showError(getErrorMessage(error)));
        });

        // Forgot Password Handler
        forgotForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const email = document.getElementById('forgot-email').value;

            sendPasswordResetEmail(auth, email)
                .then(() => {
                    alert('E-mail de redefinição enviado!');
                    window.toggleAuthMode('login');
                })
                .catch((error) => showError(getErrorMessage(error)));
        });

        // Auth State Listener
       // Auth State Listener (Versão de Diagnóstico)
onAuthStateChanged(auth, async (user) => {
    console.log("1. Estado de autenticação mudou. Usuário:", user ? "Logado" : "Deslogado");
    
    if (user) {
        // Logged In
        console.log("2. Escondendo tela de login...");
        authWrapper.style.display = 'none';

        if (typeof cards === 'undefined' || !cards) {
            console.log("3. Banco de dados vazio. Iniciando carga...");
            try {
                await iniciarApp();
                console.log("4. Banco carregado com sucesso!");
            } catch (e) {
                console.error("ERRO CRÍTICO ao carregar banco:", e);
                alert("Erro ao carregar seus dados. Veja o console.");
            }
        } else {
            console.log("3. Banco já estava carregado.");
        }

        console.log("5. Removendo classe hidden do appContent...");
        appContent.classList.remove('hidden');
        
        // Verifica se o elemento está realmente visível no DOM
        console.log("   appContent classes:", appContent.className);
        console.log("   appContent display style:", appContent.style.display);

        if(window.renderDashboard) {
            console.log("6. Chamando renderDashboard()...");
            try {
                window.renderDashboard();
                console.log("7. renderDashboard finalizou sem erros.");
            } catch (renderError) {
                console.error("ERRO ao renderizar dashboard:", renderError);
            }
        } else {
            console.warn("AVISO: Função renderDashboard não encontrada!");
        }
        
    } else {
        // Logged Out
        console.log("Usuário saiu. Mostrando login.");
        authWrapper.style.display = 'flex';
        appContent.classList.add('hidden');
    }
});


        // LOGOUT COM MODAL CUSTOMIZADO
    window.logout = () => {
        const logoutModal = document.getElementById('logout-modal');
        if (logoutModal) logoutModal.classList.remove('hidden');
    };

    window.closeLogoutModal = () => {
        const logoutModal = document.getElementById('logout-modal');
        if (logoutModal) logoutModal.classList.add('hidden');
    };

    window.confirmLogout = () => {
        const logoutModal = document.getElementById('logout-modal');
        if (logoutModal) logoutModal.classList.add('hidden'); // Close immediately

        signOut(auth).then(() => {
            location.reload(); // Reload to return to login screen
        }).catch(e => {
            alert("Erro ao sair: " + e.message);
            // Reopen modal if error
            if (logoutModal) logoutModal.classList.remove('hidden');
        });
    };
    </script>
<script>
        // --- BLOQUEADOR DE ALERTAS E POP-UPS NATIVOS (PARA ELECTRON) ---
    window.alert = function(message) {
        console.log("Alerta Bloqueado: " + message); 
        return true; // Retorna true para simular que o alerta foi "visto"
    };
    window.confirm = function(message) {
        console.log("Confirmação Bloqueada: " + message);
        return true; // Retorna true para ações de exclusão que esperam a confirmação
    };
    window.prompt = function(message) {
        console.log("Prompt Bloqueado: " + message);
        return null; // Retorna nulo para simular que o prompt foi cancelado
    };
    // -----------------------------------------------------------------
                // --- ESTADO GLOBAL (DECLARAÇÃO) ---
        // Agora declaramos tudo vazio ou null primeiro. 

        // --- Adicione estas linhas junto com as outras variáveis globais ---
let currentLibraryPage = 1;
const libraryItemsPerPage = 10; // Quantidade de cards por página

        // Os dados reais virão da função 'iniciarApp' logo abaixo.
        
        let cards = [];
        let folders = [];
        let notes = [];
        let scheduleData = {};
        let tasks = [];
        let performanceData = [];
        let editais = [];
        let simulationHistory = [];
        
        // Templates State
        let taskTemplates = [];
        let scheduleTemplates = [];

        // Updated userData (Valores padrão iniciais)
        let userData = { streak: 0, lastStudyDate: null, theme: 'light', revisionLevel: 'moderate' };
        
        // --- POMODORO STATE (Padrões iniciais) ---
        let pomoSettings = { focus: 25, short: 5, long: 15 };
        let pomoHistory = [];
        let pomoTimer = null;
        let pomoTimeLeft = 25 * 60; // Calculado temporariamente
        let pomoCurrentMode = 'focus'; 
        let pomoIsRunning = false;
        window.pomoTimer = pomoTimer; // Expor para sistema anti-distração
        window.pomoIsRunning = pomoIsRunning; // Expor estado

        // Variáveis de Controle (Estas não precisam salvar no banco)
        let currentFolderId = null;
        let editingNoteId = null;
        let sessionQueue = [];
        let randomReviewQueue = [];
        let currentCard = null;
        let editingId = null; 
        
        let currentCardIndex = 0;
        let sessionAnswers = {}; 

        let currentEditalId = null;
        
        let currentSelectedOption = null;
        let currentSelectedBtn = null;
        
        let studyMode = 'standard'; 
        let simulationQueue = [];
        let simulationResults = { correct: 0, wrong: 0, total: 0 };
        let currentSimulationLog = []; 
        
        let currentSessionTotal = 0;
        let cardsDoneCount = 0;

        let currentWeekOffset = 0;
        let editingScheduleBlock = null;
        let selectedColor = 'var(--primary)';
        let currentPeriod = 'week';
        let currentPeriodIndex = 0;

        let genericModalCallback = null;
        let genericModalIsTextarea = false;
        let reorderingData = null;
        let reorderingType = null; 
        
        let linkingTopicData = null; 
        
        let selectedLinkCategory = null;
        let selectedLinkNoteId = null;

        let confirmCallback = null;

        // --- FUNÇÃO DE INICIALIZAÇÃO (A Nova "Chave de Ignição") ---
        async function iniciarApp() {
            try {
                // Aqui carregamos do banco de dados grande (localForage)
                // O 'await' faz o código esperar o dado chegar antes de continuar
                
                cards = await carregarDados('ted_flashcards', []);
                folders = await carregarDados('ted_folders', []);
                notes = await carregarDados('ted_notes', []);
                scheduleData = await carregarDados('ted_schedule', {});
                tasks = await carregarDados('ted_tasks', []);
                performanceData = await carregarDados('ted_performance', []);
                editais = await carregarDados('ted_editais', []);
                simulationHistory = await carregarDados('ted_simulation_history', []);
                
                taskTemplates = await carregarDados('ted_task_templates', []);
                scheduleTemplates = await carregarDados('ted_schedule_templates', []);
                
                userData = await carregarDados('ted_userdata', { streak: 0, lastStudyDate: null, theme: 'light', revisionLevel: 'moderate' });
                
                pomoSettings = await carregarDados('ted_pomo_settings', { focus: 25, short: 5, long: 15 });
                pomoHistory = await carregarDados('ted_pomo_history', []);
                
                // Recalcula o tempo do Pomodoro com base no que carregou
                pomoTimeLeft = pomoSettings.focus * 60;

                console.log("Banco de dados carregado com sucesso!");
                
                // --- AQUI COMEÇA O RESTO DO SEU APP ---
                // Se você tiver uma função que desenha a tela inicial (ex: renderDashboard ou updateUI),
                // chame ela aqui dentro!
                // Exemplo:
                if (typeof renderDashboard === "function") renderDashboard();
                if (typeof updateTheme === "function") updateTheme(); 
                if (typeof checkDailyStreak === "function") checkDailyStreak();

            } catch (erro) {
                console.error("Erro fatal ao iniciar banco de dados:", erro);
            }
        }

        // --- SUBSTITUIÇÃO DO WINDOW.ONLOAD ---
        // Em vez de window.onload = function() { ... }, use isto:
        
        window.addEventListener('load', function() {
            // Dispara o carregamento do banco assim que a página abre
            iniciarApp();
        });


        window.onload = function() {

            // Carregar Templates da Agenda (Correção)
localforage.getItem('ted_schedule_templates').then(function(savedTemplates) {
    if (savedTemplates) {
        scheduleTemplates = savedTemplates;
        // Se houver alguma função que desenha a lista de templates na tela, chame ela aqui
        // Exemplo: renderTemplateList('schedule'); 
    }
}).catch(console.error);

// Carregar Templates de Tarefas (Aproveitando pra corrigir esse também)
localforage.getItem('ted_task_templates').then(function(savedTasks) {
    if (savedTasks) {
        taskTemplates = savedTasks;
        // Exemplo: renderTemplateList('task');
    }
}).catch(console.error);
            if (userData.theme === 'dark') document.body.classList.add('dark-mode');
            
           if (document.getElementById('revision-level-select')) {
    // Pega o valor salvo OU usa 'moderate' se não tiver nada
    const savedLevel = userData.revisionLevel || 'moderate';
    
    // Força o select visual a marcar a opção certa
    document.getElementById('revision-level-select').value = savedLevel;
    
    console.log("Intensidade carregada:", savedLevel);
}

            checkStreakIntegrity(); 
            checkDataIntegrity(); // Fix ghost folders
            updateCategoryDropdowns();
            renderDashboard();
            
            document.getElementById('generic-modal-confirm').onclick = function() {
                if (genericModalCallback) {
                    const value = genericModalIsTextarea ? 
                        document.getElementById('generic-modal-textarea').value : 
                        document.getElementById('generic-modal-input').value;
                    genericModalCallback(value);
                }
                closeGenericModal();
            };
            
            document.getElementById('link-topic-confirm-btn').onclick = saveTopicLink;
            document.getElementById('link-subcategory-select').addEventListener('change', updateLinkPreview);
            
            document.getElementById('generic-modal').addEventListener('transitionend', function() {
                if (!this.classList.contains('hidden')) {
                    if (genericModalIsTextarea) {
                        document.getElementById('generic-modal-textarea').focus();
                    } else {
                        document.getElementById('generic-modal-input').focus();
                    }
                }
            });

            // Initialize Pomodoro
            setPomoMode('focus');

            // Close FAB when clicking outside
            document.addEventListener('click', (e) => {
                const fab = document.getElementById('fab-container');
                if(fab && fab.classList.contains('open') && !fab.contains(e.target)) {
                    toggleFabMenu();
                }
                
                // Close search dropdowns when clicking outside
                if(!e.target.closest('.search-container')) {
                    document.getElementById('link-category-results').style.display = 'none';
                    document.getElementById('link-note-results').style.display = 'none';
                }
            });
        }
        
        function checkDataIntegrity() {
            // Fix notes pointing to non-existent folders
            let fixedCount = 0;
            notes.forEach(note => {
                if (note.folderId && !folders.find(f => f.id === note.folderId)) {
                    note.folderId = null; // Move to root
                    fixedCount++;
                }
            });
            if (fixedCount > 0) {
                console.log(`Fixed ${fixedCount} ghost notes.`);
                saveNotesData();
            }
        }



function addToQuickHistory(note) {
    if (!note || !note.title) return;

    try {
        let history = JSON.parse(sessionStorage.getItem('ted_quick_history') || '[]');
        
        history = history.filter(h => h.id !== note.id);
        
        history.unshift({
            id: note.id,
            title: note.title,
            folderName: note.folderName || 'Anotações',
            timestamp: Date.now()
        });
        
        if (history.length > 10) history.pop();
        
        sessionStorage.setItem('ted_quick_history', JSON.stringify(history));

        // --- NOVO TRECHO: Atualiza a visibilidade do botão ---
        checkHistoryVisibility(); 
        // ----------------------------------------------------
        
    } catch (e) {
        console.error("Erro ao salvar histórico", e);
    }
}


function checkHistoryVisibility() {
    const history = JSON.parse(sessionStorage.getItem('ted_quick_history') || '[]');
    const btn = document.getElementById('btn-quick-notes');
    
    if (btn) {
        if (history.length > 0) {
            btn.classList.add('visible'); // Mostra se tiver itens
        } else {
            btn.classList.remove('visible'); // Esconde se estiver vazio
        }
    }
}

// Executa a checagem assim que a página carrega
document.addEventListener('DOMContentLoaded', checkHistoryVisibility);



// 2. Interceptor Global (Tenta detectar cliques em notas automaticamente)
document.addEventListener('click', function(e) {
    // Tenta achar o elemento da nota clicado na lista lateral ou cards
    const noteEl = e.target.closest('.note-item, .card-note-link'); 
    if (noteEl) {
        // Pega o título visualmente se não tivermos acesso aos dados brutos
        const title = noteEl.innerText || noteEl.textContent;
        // Salva um histórico provisório visual
        addToQuickHistory({
            id: Date.now(), // ID temporário
            title: title.split('\n')[0], // Pega só a primeira linha
            folderName: 'Aberto Recentemente'
        });
    }
});


// 3. Função de Exibir (Lê do histórico que acabamos de criar)
function toggleQuickNotes() {
    const panel = document.getElementById('quick-notes-panel');
    if (!panel) return;
    
    // Toggle Visual
    if (panel.style.display === 'flex') {
        panel.style.display = 'none';
        return;
    }
    
    // Atualiza Lista
    const list = document.getElementById('quick-notes-list');
    list.innerHTML = '';
    
    const history = JSON.parse(sessionStorage.getItem('ted_quick_history') || '[]');

    
    if (history.length === 0) {
        list.innerHTML = '<div style="padding:15px;text-align:center;color:#888">Nenhuma nota aberta recentemente.</div>';
    } else {
        history.forEach(h => {
            const item = document.createElement('div');
            item.className = 'quick-note-item';
            
            // Limpa título
            let cleanTitle = h.title.replace(/<[^>]*>/g, '').trim() || "Nota sem nome";
            
            item.innerHTML = `
                <div style="flex:1">
                    <div style="font-weight:500;color:var(--text-main)">${cleanTitle}</div>
                    <div style="font-size:10px;color:var(--text-muted)">${new Date(h.timestamp).toLocaleTimeString()}</div>
                </div>
            `;
            
            // --- CORREÇÃO AQUI ---
            item.onclick = () => {
                panel.style.display = 'none'; // Fecha o painel primeiro
                
                // Vai para a aba de listagem de notas
                switchTab('notes');
                
                // Pequeno delay para garantir que a transição de aba ocorreu
                setTimeout(() => {
                    // Tenta encontrar a nota na lista global 'notes' pelo ID
                    // Se não achar em 'notes', procura dentro das pastas 'folders'
                    let targetNote = notes.find(n => n.id === h.id);
                    
                    if (!targetNote && typeof folders !== 'undefined') {
                        // Varre pastas se não achou na raiz
                        for (const f of folders) {
                            if (f.notes) {
                                const found = f.notes.find(n => n.id === h.id);
                                if (found) {
                                    targetNote = found;
                                    break;
                                }
                            }
                        }
                    }

                    if (targetNote && typeof openNoteEditor === 'function') {
                        // Passa APENAS o ID, pois sua função openNoteEditor(id) espera isso
                        openNoteEditor(h.id); 
                    } else {
                        // Se não achar a nota (foi deletada?), remove do histórico para não confundir
                        alert('Esta anotação não foi encontrada (pode ter sido excluída).');
                    
                    }
                }, 50);
            };
            // ---------------------
            
            list.appendChild(item);
        });
    }

    // Posiciona e mostra
    panel.style.display = 'flex';
    const btn = document.getElementById('btn-quick-notes');
    if(btn) {
        const rect = btn.getBoundingClientRect();
        panel.style.position = 'fixed';
        panel.style.left = (rect.right + 10) + 'px';
        panel.style.top = Math.max(10, rect.top - 50) + 'px';
    }
}




       


        function showAlert(title, msg) {
            document.getElementById('custom-alert-title').innerText = title;
            document.getElementById('custom-alert-msg').innerText = msg;
            document.getElementById('custom-alert-modal').classList.remove('hidden');
        }

        function showConfirm(title, msg, callback) {
    document.getElementById('confirm-modal-title').innerText = title;
    document.getElementById('confirm-modal-msg').innerHTML = msg; // <-- Agora usamos INNERHTML
    confirmCallback = callback;
    document.getElementById('custom-confirm-modal').classList.remove('hidden');
}

        function handleConfirm(result) {
            document.getElementById('custom-confirm-modal').classList.add('hidden');
            if(result && confirmCallback) confirmCallback();
            
            // Revert dropdown if canceled during revision level change
            if(!result && document.getElementById('revision-level-select')) {
                 document.getElementById('revision-level-select').value = userData.revisionLevel || 'moderate';
            }
            
            confirmCallback = null;
        }

        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                if (!document.getElementById('generic-modal').classList.contains('hidden')) closeGenericModal();
                if (!document.getElementById('reorder-modal').classList.contains('hidden')) document.getElementById('reorder-modal').classList.add('hidden');
                if (!document.getElementById('link-topic-modal').classList.contains('hidden')) document.getElementById('link-topic-modal').classList.add('hidden');
                if (!document.getElementById('simulation-config-modal').classList.contains('hidden')) document.getElementById('simulation-config-modal').classList.add('hidden');
                if (!document.getElementById('schedule-modal').classList.contains('hidden')) document.getElementById('schedule-modal').classList.add('hidden');
                if (!document.getElementById('pomo-settings-modal').classList.contains('hidden')) document.getElementById('pomo-settings-modal').classList.add('hidden');
                if (!document.getElementById('custom-alert-modal').classList.contains('hidden')) document.getElementById('custom-alert-modal').classList.add('hidden');
                if (!document.getElementById('custom-confirm-modal').classList.contains('hidden')) handleConfirm(false);
                if (!document.getElementById('sim-detail-modal').classList.contains('hidden')) document.getElementById('sim-detail-modal').classList.add('hidden');
                if (!document.getElementById('template-modal').classList.contains('hidden')) document.getElementById('template-modal').classList.add('hidden');
                
                document.getElementById('link-category-results').style.display = 'none';
                document.getElementById('link-note-results').style.display = 'none';
            }
            if (e.key === 'Enter' && !document.getElementById('generic-modal').classList.contains('hidden')) {
                if (document.activeElement.id === 'generic-modal-input' || document.activeElement.id === 'generic-modal-textarea') {
                    document.getElementById('generic-modal-confirm').click();
                }
            }
        });

        // Toggle Sidebar function removed/simplified as it is always collapsed
       function toggleTheme() {
    document.body.classList.toggle('dark-mode');
    userData.theme = document.body.classList.contains('dark-mode') ? 'dark' : 'light';
    
    localforage.setItem('ted_userdata', userData).catch(function(err) {
        console.error('Erro ao salvar tema:', err);
    });
}

        function checkStreakIntegrity() {
    if (!userData.lastStudyDate) return;
    
    const today = new Date();
    today.setHours(0,0,0,0);
    
    const parts = userData.lastStudyDate.split('-');
    const lastStudy = new Date(parts[0], parts[1] - 1, parts[2]); 
    lastStudy.setHours(0,0,0,0);
    
    const diffTime = today.getTime() - lastStudy.getTime();
    const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));

    if (diffDays > 1) {
        userData.streak = 0;
        localforage.setItem('ted_userdata', userData).catch(function(err) {
            console.error('Erro ao salvar ofensiva (streak):', err);
        });
    }
}


        function updateStreakOnStudy() {
    const todayObj = new Date();
    // Formata YYYY-MM-DD usando o horário local, não UTC
    const year = todayObj.getFullYear();
    const month = String(todayObj.getMonth() + 1).padStart(2, '0');
    const day = String(todayObj.getDate()).padStart(2, '0');
    const todayStr = `${year}-${month}-${day}`;
    
    // Se já estudou hoje, não faz nada
    if (userData.lastStudyDate === todayStr) return;

    if (userData.lastStudyDate) {
        // Converte a string salva (YYYY-MM-DD) para data objeto corretamente
        const parts = userData.lastStudyDate.split('-');
        const lastStudy = new Date(parts[0], parts[1] - 1, parts[2]);
        
        // Data de hoje zerada
        const currentToday = new Date(year, month - 1, day);
        
        const diffTime = currentToday.getTime() - lastStudy.getTime();
        const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));

        if (diffDays === 1) {
            // Se foi ontem, aumenta +1
            userData.streak = (userData.streak || 0) + 1;
        } else {
            // Se foi antes de ontem (ou futuro/erro), reseta para 1
            userData.streak = 1;
        }
    } else {
        // Primeiro estudo da vida
        userData.streak = 1;
    }

    userData.lastStudyDate = todayStr;
    localforage.setItem('ted_userdata', userData).catch(function(err) {
    console.error('Erro ao salvar no localForage:', err);
});

    
    // Atualiza visualmente na hora
    updateDashboardStats();
}

        
  function changeRevisionLevel(newLevel) {
    // 1. Salva no objeto global (para uso imediato)
    if(typeof userData !== 'undefined') userData.revisionLevel = newLevel;

    // 2. Salva numa chave EXCLUSIVA e SEGURA
    localforage.setItem('ted_config_intensity', newLevel).then(() => {
        console.log("Intensidade salva na chave segura:", newLevel);
        
        // Feedback visual simples
        const msg = document.createElement('div');
        msg.innerText = "Salvo!";
        msg.style.cssText = "position:fixed; bottom:20px; right:20px; background:green; color:white; padding:10px; z-index:9999; border-radius:5px;";
        document.body.appendChild(msg);
        setTimeout(() => msg.remove(), 2000);
    });
}
        // --- NAVEGAÇÃO ---
        function switchTab(tab) {
          if (tab !== 'note-editor') {
        persistCurrentNote();
    }
            document.querySelectorAll('.view-section').forEach(el => el.classList.add('hidden'));
            const target = document.getElementById(tab + '-view');
            if(target) target.classList.remove('hidden');
            
            const titles = {
                'dashboard': 'INÍCIO', 'study':'ESTUDAR', 
                'notes':'CADERNO', 'schedule':'CRONOGRAMA', 'performance':'DADOS',
                'card-detail': 'DETALHES', 'note-editor': 'EDITOR', 'settings': 'CONFIGURAÇÕES',
                'syllabus': 'EDITAIS', 'syllabus-detail': 'EDITAL',
                'pomodoro': 'POMODORO'
            };
            document.getElementById('page-title-display').innerText = titles[tab] || '';
            
            document.querySelectorAll('.nav-item, .bottom-nav-item').forEach(btn => btn.classList.remove('active'));
            
            let activeTab = tab;
            if(tab === 'syllabus-detail') activeTab = 'syllabus';
            if(tab === 'card-detail') activeTab = 'study';
            if(tab === 'note-editor') activeTab = 'notes';

            document.querySelectorAll(`button[onclick="switchTab('${activeTab}')"]`).forEach(btn => btn.classList.add('active'));

            if (tab === 'notes') {
    renderCurrentFolder();
    renderReviewBanner(); // <--- Adicione esta linha aqui!
}
            if (tab === 'schedule') { renderSchedule(); renderTasks(); }
            if (tab === 'dashboard') {
    renderDashboard();
    renderReviewBanner(); // Faz o banner aparecer na tela inicial também!
}

            if (tab === 'pomodoro') renderPomoHistory();
            if (tab === 'study') {
                 // Default to practice if not set, or maintain state if switching back
                 if(document.querySelector('.study-nav-btn.active').id === 'sub-nav-practice') loadStudyView();
                 if(document.querySelector('.study-nav-btn.active').id === 'sub-nav-library') renderManageList();
            }
            if (tab === 'performance') renderPerformanceView();
            if (tab === 'syllabus') renderSyllabusList();

            // Floating Widget Logic
            const floatWidget = document.getElementById('floating-timer-widget');
            if(tab === 'pomodoro') {
                floatWidget.classList.remove('visible');
            } else {
                // Show if running OR if active but paused (timeLeft < fullTime)
                const fullTime = pomoSettings[pomoCurrentMode] * 60;
                if(pomoIsRunning || pomoTimeLeft < fullTime) {
                    floatWidget.classList.add('visible');
                } else {
                    floatWidget.classList.remove('visible');
                }
            }
        }

        function switchStudyTab(subTab) {
    // Hide all sub-views
    document.getElementById('sub-view-practice').classList.add('hidden');
    document.getElementById('sub-view-library').classList.add('hidden');
    document.getElementById('sub-view-creator').classList.add('hidden');
    
    // Deactivate nav buttons
    document.querySelectorAll('.study-nav-btn').forEach(btn => btn.classList.remove('active'));
    
    // Activate target
    document.getElementById(`sub-nav-${subTab}`).classList.add('active');
    document.getElementById(`sub-view-${subTab}`).classList.remove('hidden');
    
    // Load specific logic
    if (subTab === 'practice') loadStudyView();
    if (subTab === 'library') {
        updateCategoryDropdowns(); // <--- LINHA ADICIONADA: Corrige o bug das categorias vazias
        renderManageList();
    }
    if (subTab === 'creator') {
        if (!editingId) resetForm();
        // Opcional: atualizar aqui também para garantir que as sugestões estejam frescas
        updateCategoryDropdowns(); 
    }
}


        // --- MODIFIED: FAB LOGIC with upward expansion ---
        function toggleFabMenu() {
            document.getElementById('fab-container').classList.toggle('open');
            document.getElementById('fab-button').classList.toggle('active');
        }
        
        function quickCreate(type) {
            toggleFabMenu(); // close menu
            if (type === 'card') {
                switchTab('study');
                switchStudyTab('creator');
            } else if (type === 'note') {
                createNewNote();
            } else if (type === 'goal') {
                // Global Quick Task creation
                openGenericModal('Nova Meta', '', false, (text) => {
                    if(text && text.trim() !== '') {
                        tasks.push({id:Date.now(), text:text.trim(), done:false});
                        saveSchedule();
                        // If we are on dashboard or schedule, update view
                        if(!document.getElementById('dashboard-view').classList.contains('hidden')) renderDashboard();
                        if(!document.getElementById('schedule-view').classList.contains('hidden')) renderTasks();
                        alert('Meta adicionada!');
                    }
                });
            }
        }

        function saveEditais() { salvarDados('ted_editais', editais); }

        function openGenericModal(title, initialValue, isTextarea = false, callback) {
            document.getElementById('generic-modal-title').innerText = title;
            if (isTextarea) {
                document.getElementById('generic-modal-input').style.display = 'none';
                document.getElementById('generic-modal-textarea-container').style.display = 'block';
                document.getElementById('generic-modal-textarea').value = initialValue || '';
            } else {
                document.getElementById('generic-modal-input').style.display = 'block';
                document.getElementById('generic-modal-textarea-container').style.display = 'none';
                document.getElementById('generic-modal-input').value = initialValue || '';
            }
            genericModalIsTextarea = isTextarea;
            genericModalCallback = callback;
            document.getElementById('generic-modal').classList.remove('hidden');
        }

        function closeGenericModal() {
            document.getElementById('generic-modal').classList.add('hidden');
            genericModalCallback = null;
        }

        // --- POMODORO LOGIC START ---
        function setPomoMode(mode) {
            // If timer is running, stop it
            if(pomoIsRunning) toggleTimer();
            
            pomoCurrentMode = mode;
            pomoTimeLeft = pomoSettings[mode] * 60;
            updateTimerDisplay();
            updatePomoTabs();
            // Reset bar
            document.getElementById('pomo-progress-bar').style.width = '0%';
        }

        function updatePomoTabs() {
            document.querySelectorAll('.pomo-tab').forEach(t => t.classList.remove('active'));
            document.getElementById(`pomo-mode-${pomoCurrentMode}`).classList.add('active');
        }

        function updateTimerDisplay() {
            const m = Math.floor(pomoTimeLeft / 60);
            const s = pomoTimeLeft % 60;
            const timeStr = `${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;
            document.getElementById('timer-display').innerText = timeStr;
            document.title = `Teddy`;
            
            // Update Floating Widget
            document.getElementById('float-time-display').innerText = timeStr;
        }

        function toggleTimer() {
            const btn = document.getElementById('btn-toggle-timer');
            // Removed float button icon logic
            
            if (pomoIsRunning) {
                clearInterval(pomoTimer);
                pomoIsRunning = false;
                window.pomoIsRunning = pomoIsRunning; // Atualizar global
                btn.innerHTML = '<i class="fas fa-play" style="margin-left:4px;"></i>';
                btn.style.background = 'var(--primary)';
            } else {
                pomoTimer = setInterval(() => {
                    if (pomoTimeLeft > 0) {
                        pomoTimeLeft--;
                        updateTimerDisplay();
                        
                        // Update Progress Bar
                        const totalTime = pomoSettings[pomoCurrentMode] * 60;
                        const percent = ((totalTime - pomoTimeLeft) / totalTime) * 100;
                        document.getElementById('pomo-progress-bar').style.width = percent + '%';
                    } else {
                        finishPomoSession();
                    }
                }, 1000);
                pomoIsRunning = true;
                window.pomoIsRunning = pomoIsRunning; // Atualizar global
                btn.innerHTML = '<i class="fas fa-pause"></i>';
                btn.style.background = 'var(--warning)';
                
                // If not on pomodoro tab, show widget
                if(document.getElementById('pomodoro-view').classList.contains('hidden')) {
                     document.getElementById('floating-timer-widget').classList.add('visible');
                }
            }
        }

        function resetTimer() {
            if(pomoIsRunning) toggleTimer();
            pomoTimeLeft = pomoSettings[pomoCurrentMode] * 60;
            updateTimerDisplay();
            document.getElementById('pomo-progress-bar').style.width = '0%';
            document.getElementById('floating-timer-widget').classList.remove('visible');
        }

        // Helper to get week number consistently
        function getWeekNumber(d) {
            // Copy date so don't modify original
            d = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
            // Set to nearest Thursday: current date + 4 - current day number
            // Make Sunday's day number 7
            d.setUTCDate(d.getUTCDate() + 4 - (d.getUTCDay() || 7));
            // Get first day of year
            var yearStart = new Date(Date.UTC(d.getUTCFullYear(),0,1));
            // Calculate full weeks to nearest Thursday
            var weekNo = Math.ceil(( ( (d.valueOf() - yearStart.valueOf()) / 86400000) + 1)/7);
            return weekNo;
        }

        function finishPomoSession() {
            if(pomoIsRunning) toggleTimer(); // Stop timer
            const audio = new Audio('https://actions.google.com/sounds/v1/alarms/beep_short.ogg');
            audio.play().catch(e=>console.log(e));
            
            showAlert("Tempo Esgotado!", "Sessão finalizada com sucesso! Seus dados foram salvos.");

            // Save to history automatically as "Pomodoro" if focus
            if (pomoCurrentMode === 'focus') {
                const sessionName = "Pomodoro";
                const now = new Date();
                
                const newItem = {
                    id: Date.now(),
                    name: sessionName,
                    duration: pomoSettings.focus, // Note: This logs the planned duration, or could log elapsed if modified
                    type: 'focus',
                    date: now.toISOString()
                };
                pomoHistory.unshift(newItem);
                savePomoHistory();
                renderPomoHistory();

                // Save to Schedule Grid (Current time slot)
                const currentYear = now.getFullYear();
                const weekNum = getWeekNumber(now); // Use consistent week helper
                const dayIndex = now.getDay() === 0 ? 6 : now.getDay() - 1; // Mon=0 ... Sun=6
                const hour = now.getHours();

                if(hour >= 0 && hour <= 23) {
                    const key = `${currentYear}-${weekNum}-${dayIndex}-${hour}`;
                    // Force save regardless of duration
                    scheduleData[key] = { title: "Pomodoro", color: "var(--primary)" }; 
                    saveSchedule();
                    
                    // If schedule view is open, refresh
                    if(!document.getElementById('schedule-view').classList.contains('hidden')) renderSchedule();
                }
            }
            
            resetTimer();
        }

        function openPomoSettings() {
            document.getElementById('pomo-input-focus').value = pomoSettings.focus;
            document.getElementById('pomo-input-short').value = pomoSettings.short;
            document.getElementById('pomo-input-long').value = pomoSettings.long;
            document.getElementById('pomo-settings-modal').classList.remove('hidden');
        }

        function savePomoSettings() {
            const f = parseInt(document.getElementById('pomo-input-focus').value);
            const s = parseInt(document.getElementById('pomo-input-short').value);
            const l = parseInt(document.getElementById('pomo-input-long').value);
            
            if(f > 0 && s > 0 && l > 0) {
                pomoSettings = { focus: f, short: s, long: l };
                salvarDados('ted_pomo_settings', pomoSettings);
                document.getElementById('pomo-settings-modal').classList.add('hidden');
                // Reset current timer to reflect changes
                resetTimer();
            } else {
                alert("Valores inválidos.");
            }
        }

        function savePomoHistory() {
            salvarDados('ted_pomo_history', pomoHistory);
        }

                function renderPomoHistory() {
            const list = document.getElementById('pomo-history-list');
            list.innerHTML = '';
            
            // Pega o histórico atualizado
            // IMPORTANTE: Garantir que usamos a variável pomoHistory se ela for global, ou ler do localStorage
            let currentHistory = pomoHistory || []; 
            
            // Verifica se tem itens visíveis (não ocultos)
            const visibleItems = currentHistory.filter(item => !item.hidden);

            if (visibleItems.length === 0) {
                // Se tiver o elemento de mensagem vazia, usa ele, senão cria um div
                const emptyMsg = document.getElementById('pomo-empty-msg');
                if (emptyMsg) emptyMsg.classList.remove('hidden');
                else list.innerHTML = '<div style="text-align:center; color:var(--text-muted); padding:20px;">Nenhuma sessão visível.</div>';
                return;
            }
            
            // Esconde msg de vazio se existir
            const emptyMsg = document.getElementById('pomo-empty-msg');
            if(emptyMsg) emptyMsg.classList.add('hidden');

            // Percorre o histórico INVERTIDO para mostrar os mais novos primeiro
            // Mas mantendo a referência correta para edição
            currentHistory.slice().forEach(item => {
                // Se estiver oculto, pula
                if (item.hidden) return;

                const date = new Date(item.date || item.timestamp || item.endTime);
                const dateStr = date.toLocaleDateString('pt-BR') + ' ' + date.toLocaleTimeString('pt-BR', {hour:'2-digit', minute:'2-digit'});
                
                // Layout Original que você tinha
                list.innerHTML += `
                    <div class="pomo-item">
                        <div class="pomo-info">
                            <h4>${item.name || 'Sessão de Estudo'} <span class="card-badge tag-pomo" style="display:inline; padding:2px 6px; font-size:0.7rem;">${item.duration} min</span></h4>
                            <span>${dateStr}</span>
                        </div>
                        <div class="pomo-actions">
                            <!-- Botão Salvar na Agenda (Mantido) -->
                            <button class="btn-sm btn-outline" title="Salvar no Cronograma" onclick="addPomoToSchedule(${item.id})"><i class="fas fa-calendar-plus"></i></button>
        
                            <!-- Botão Editar (Mantido) -->
                            <button class="btn-sm btn-outline" title="Editar" onclick="editPomoItem(${item.id})"><i class="fas fa-pen"></i></button>
                            
                            <!-- Botão Excluir MODIFICADO para usar a função hidePomoSession -->
                            <!-- Note que passamos o ID do item, não o index -->
                            <button class="btn-sm btn-danger" title="Excluir da lista (mantém nos dados)" onclick="hidePomoSessionById(${item.id})"><i class="fas fa-trash"></i></button>
                        </div>
                    </div>
                `;
            });
        }


        function editPomoItem(id) {
            const item = pomoHistory.find(i => i.id === id);
            openGenericModal('Editar Sessão', item.name, false, (newName) => {
                if (newName && newName.trim() !== '') {
                    item.name = newName.trim();
                    savePomoHistory();
                    renderPomoHistory();
                }
            });
        }

        function deletePomoItem(id) {
            showConfirm("Excluir Sessão", "Deseja realmente apagar este registro do histórico?", () => {
                pomoHistory = pomoHistory.filter(i => i.id !== id);
                savePomoHistory();
                renderPomoHistory();
            });
        }
        
        function clearPomoHistory() {
    // Verifica se existe algum item visível para limpar
    const visibleItems = pomoHistory.filter(item => !item.hidden);
    
    if (visibleItems.length === 0) {
        alert("O histórico já está limpo!");
        return;
    }

    showConfirm('Limpar Lista', 'Deseja limpar a lista de sessões? (Seus dados de tempo de estudo serão mantidos nas estatísticas)', () => {
        // Em vez de apagar o array, apenas marcamos todos como ocultos
        pomoHistory.forEach(item => {
            item.hidden = true;
        });
        
        savePomoHistory();   // Salva o estado oculto
        renderPomoHistory(); // Atualiza a tela (vai sumir tudo visualmente)
    });
}

        function addPomoToSchedule(id) {
            const item = pomoHistory.find(i => i.id === id);
            if(item) {
                // Manually add to current slot based on item date
                const date = new Date(item.date); // Use the date stored in history
                const currentYear = date.getFullYear();
                const weekNum = getWeekNumber(date); // Use helper
                const dayIndex = date.getDay() === 0 ? 6 : date.getDay() - 1; 
                const hour = date.getHours();

                if(hour >= 0 && hour <= 23) {
                    const key = `${currentYear}-${weekNum}-${dayIndex}-${hour}`;
                    scheduleData[key] = { title: `Pomo: ${item.name}`, color: "var(--primary)" }; 
                    saveSchedule();
                    showAlert("Sucesso", "Adicionado à grade de horários com sucesso!");
                    if(!document.getElementById('schedule-view').classList.contains('hidden')) renderSchedule();
                } else {
                    showAlert("Erro", "Horário inválido.");
                }
            }
        }
        // --- POMODORO LOGIC END ---

        function openLinkTopicModal(subjectId, topicId) {
            linkingTopicData = { subjectId, topicId };
            const edital = editais.find(e => e.id === currentEditalId);
            const subject = edital.subjects.find(s => s.id === subjectId);
            const topic = subject.topics.find(t => t.id === topicId);
            
            // Setup Categories
            selectedLinkCategory = topic.linkedCategory || null;
            document.getElementById('link-category-search').value = selectedLinkCategory || '';
            updateLinkSubcategories(topic.linkedSubcategory);
            updateLinkPreview();

            // Setup Notes
            selectedLinkNoteId = topic.linkedNoteId || null;
            if (selectedLinkNoteId) {
                const note = notes.find(n => n.id === selectedLinkNoteId);
                document.getElementById('link-note-search').value = note ? note.title : '';
            } else {
                document.getElementById('link-note-search').value = '';
            }

            document.getElementById('link-topic-modal').classList.remove('hidden');
        }

        function filterLinkCategories() {
            const input = document.getElementById('link-category-search');
            const filter = input.value.toLowerCase();
            const results = document.getElementById('link-category-results');
            
            const categories = [...new Set(cards.map(c => c.category || 'Geral'))].sort();
            const filtered = categories.filter(c => c.toLowerCase().includes(filter));
            
            results.innerHTML = '';
            if (filtered.length > 0) {
                filtered.forEach(cat => {
                    results.innerHTML += `<div class="search-result-item" onclick="selectLinkCategory('${cat}')">${cat}</div>`;
                });
                results.style.display = 'block';
            } else {
                results.style.display = 'none';
            }
        }
        
        function selectLinkCategory(cat) {
            selectedLinkCategory = cat;
            document.getElementById('link-category-search').value = cat;
            document.getElementById('link-category-results').style.display = 'none';
            updateLinkSubcategories();
            updateLinkPreview();
        }

        function filterLinkNotes() {
            const input = document.getElementById('link-note-search');
            const filter = input.value.toLowerCase();
            const results = document.getElementById('link-note-results');
            
            const filtered = notes.filter(n => n.title.toLowerCase().includes(filter));
            
            results.innerHTML = '';
            // Add option to clear
            results.innerHTML += `<div class="search-result-item" onclick="selectLinkNote(null, '')" style="color:var(--danger);"><i class="fas fa-times"></i> Nenhuma anotação</div>`;
            
            if (filtered.length > 0) {
                filtered.forEach(n => {
                    const folderName = n.folderId ? (folders.find(f => f.id === n.folderId)?.name || 'Pasta desconhecida') : 'Início';
                    results.innerHTML += `<div class="search-result-item" onclick="selectLinkNote('${n.id}', '${n.title}')"><strong>${n.title}</strong><span>${folderName}</span></div>`;
                });
                results.style.display = 'block';
            } else if (filter === '') {
                // Show recent/all if empty
                 notes.slice(0, 10).forEach(n => {
                    const folderName = n.folderId ? (folders.find(f => f.id === n.folderId)?.name || 'Pasta desconhecida') : 'Início';
                    results.innerHTML += `<div class="search-result-item" onclick="selectLinkNote('${n.id}', '${n.title}')"><strong>${n.title}</strong><span>${folderName}</span></div>`;
                });
                results.style.display = 'block';
            } else {
                results.style.display = 'none';
            }
        }
        
        function selectLinkNote(id, title) {
            selectedLinkNoteId = id;
            document.getElementById('link-note-search').value = title;
            document.getElementById('link-note-results').style.display = 'none';
        }

        function updateLinkSubcategories(selectedSubcategory = '') {
            const subcategorySelect = document.getElementById('link-subcategory-select');
            const category = selectedLinkCategory;
            subcategorySelect.innerHTML = '<option value="">Todas as subcategorias</option>';
            if (category) {
                const subcategories = [...new Set(cards.filter(c => (c.category || 'Geral') === category && c.subcategory).map(c => c.subcategory))].sort();
                subcategories.forEach(sub => {
                    subcategorySelect.innerHTML += `<option value="${sub}" ${selectedSubcategory === sub ? 'selected' : ''}>${sub}</option>`;
                });
            }
            updateLinkPreview();
        }

        function updateLinkPreview() {
            const category = selectedLinkCategory;
            const subcategory = document.getElementById('link-subcategory-select').value;
            const previewDiv = document.getElementById('link-preview');
            const countSpan = document.getElementById('link-card-count');
            
            if (!category) { 
                previewDiv.style.display = 'none'; 
                return; 
            }
            
            let filteredCards = cards.filter(c => (c.category || 'Geral') === category);
            if (subcategory) filteredCards = filteredCards.filter(c => c.subcategory === subcategory);
            
            countSpan.textContent = filteredCards.length;
            previewDiv.style.display = 'block';
        }

        function saveTopicLink() {
            if (!linkingTopicData) return;
            const { subjectId, topicId } = linkingTopicData;
            
            const category = selectedLinkCategory;
            const subcategory = document.getElementById('link-subcategory-select').value || '';
            const noteId = selectedLinkNoteId;

            const edital = editais.find(e => e.id === currentEditalId);
            const subject = edital.subjects.find(s => s.id === subjectId);
            const topic = subject.topics.find(t => t.id === topicId);
            
            // Update Card Links
            topic.linkedCategory = category || null;
            topic.linkedSubcategory = subcategory || null;
            
            // Update Note Link
            topic.linkedNoteId = noteId;

            saveEditais();
            document.getElementById('link-topic-modal').classList.add('hidden');
            renderEditalDetail();
        }

        function openLinkedNote(noteId) {
            openNoteEditor(noteId);
        }

        function startSimulationForTopic(subjectId, topicId) {
            const edital = editais.find(e => e.id === currentEditalId);
            const subject = edital.subjects.find(s => s.id === subjectId);
            const topic = subject.topics.find(t => t.id === topicId);
            if (!topic.linkedCategory) return alert('Este tópico não está vinculado a nenhuma categoria de cards.');
            let filteredCards = cards.filter(c => (c.category || 'Geral') === topic.linkedCategory);
            if (topic.linkedSubcategory) filteredCards = filteredCards.filter(c => c.subcategory === topic.linkedSubcategory);
            if (filteredCards.length === 0) return alert('Nenhum card encontrado para esta associação.');
            simulationQueue = [...filteredCards].sort(() => 0.5 - Math.random());
            simulationResults = { correct: 0, wrong: 0, total: simulationQueue.length };
            currentSimulationLog = [];
            currentSessionTotal = simulationQueue.length;
            currentSessionDone = 0;
            studyMode = 'simulation';
            
            // NEW NAV INIT
            currentCardIndex = 0;
            sessionAnswers = {};
            
            document.getElementById('study-content').classList.remove('hidden');
            document.getElementById('simulation-result').classList.add('hidden');
            document.getElementById('no-cards-msg').classList.add('hidden');
            showCard(simulationQueue[0]);
            switchTab('study');
            switchStudyTab('practice');
            document.getElementById('due-count').innerText = simulationQueue.length;
            document.getElementById('finish-review-btn').classList.remove('hidden'); // Show finish early
        }

        function loadStudyView() {
            if (studyMode === 'simulation' && simulationQueue.length > 0) {
                document.getElementById('simulation-result').classList.add('hidden');
                document.getElementById('study-content').classList.remove('hidden');
                document.getElementById('no-cards-msg').classList.add('hidden');
                showCard(simulationQueue[currentCardIndex]);
            } else if (studyMode === 'standard') {
                loadStudySession();
            }
        }

        function countCardsForTopic(topic) {
            if (!topic.linkedCategory) return 0;
            let filteredCards = cards.filter(c => (c.category || 'Geral') === topic.linkedCategory);
            if (topic.linkedSubcategory) filteredCards = filteredCards.filter(c => c.subcategory === topic.linkedSubcategory);
            return filteredCards.length;
        }

        function editEditalTitle() {
            const edital = editais.find(e => e.id === currentEditalId);
            openGenericModal('Editar Nome do Edital', edital.title, false, (newTitle) => {
                if (newTitle && newTitle.trim() !== '') {
                    edital.title = newTitle.trim();
                    saveEditais();
                    renderEditalDetail();
                }
            });
        }

        function editSubject(subjectId) {
            const edital = editais.find(e => e.id === currentEditalId);
            const subject = edital.subjects.find(s => s.id === subjectId);
            openGenericModal('Editar Matéria', subject.title, false, (newTitle) => {
                if (newTitle && newTitle.trim() !== '') {
                    subject.title = newTitle.trim();
                    saveEditais();
                    renderEditalDetail();
                }
            });
        }

        function editTopic(subjectId, topicId) {
            const edital = editais.find(e => e.id === currentEditalId);
            const subject = edital.subjects.find(s => s.id === subjectId);
            const topic = subject.topics.find(t => t.id === topicId);
            openGenericModal('Editar Tópico', topic.text, false, (newText) => {
                if (newText && newText.trim() !== '') {
                    topic.text = newText.trim();
                    saveEditais();
                    renderEditalDetail();
                }
            });
        }

        function reorderSubjects() {
            const edital = editais.find(e => e.id === currentEditalId);
            reorderingData = edital.subjects;
            reorderingType = 'subjects';
            openReorderModal('Matérias');
        }

        function reorderTopics(subjectId) {
            const edital = editais.find(e => e.id === currentEditalId);
            const subject = edital.subjects.find(s => s.id === subjectId);
            reorderingData = subject.topics;
            reorderingType = 'topics';
            openReorderModal('Tópicos');
        }

        function openReorderModal(title) {
            document.getElementById('reorder-modal-title').innerText = `Reorganizar ${title}`;
            const container = document.getElementById('reorder-list-container');
            container.innerHTML = '';
            reorderingData.forEach((item, index) => {
                const itemDiv = document.createElement('div');
                itemDiv.className = 'draggable-item';
                itemDiv.draggable = true;
                itemDiv.dataset.index = index;
                itemDiv.innerHTML = `<div class="drag-handle"><i class="fas fa-grip-vertical"></i></div><div style="flex:1;">${item.title || item.text}</div><div style="font-size:0.8rem; color:var(--text-muted);">${index + 1}</div>`;
                itemDiv.addEventListener('dragstart', (e) => { e.dataTransfer.setData('text/plain', index); itemDiv.classList.add('dragging'); });
                itemDiv.addEventListener('dragend', () => { document.querySelectorAll('.draggable-item').forEach(el => { el.classList.remove('dragging'); }); });
                container.appendChild(itemDiv);
            });
            container.addEventListener('dragover', (e) => {
                e.preventDefault();
                const dragging = document.querySelector('.dragging');
                const siblings = [...container.querySelectorAll('.draggable-item:not(.dragging)')];
                const nextSibling = siblings.find(sibling => {
                    const box = sibling.getBoundingClientRect();
                    const offset = e.clientY - box.top - box.height / 2;
                    return offset < 0;
                });
                container.insertBefore(dragging, nextSibling);
            });
            document.getElementById('reorder-modal').classList.remove('hidden');
        }

        function saveReordering() {
            const container = document.getElementById('reorder-list-container');
            const newOrder = [...container.querySelectorAll('.draggable-item')].map(item => {
                const index = parseInt(item.dataset.index);
                return reorderingData[index];
            });
            if (reorderingType === 'subjects') {
                const edital = editais.find(e => e.id === currentEditalId);
                edital.subjects = newOrder;
            } else if (reorderingType === 'topics') {
                const edital = editais.find(e => e.id === currentEditalId);
                for (let subject of edital.subjects) {
                    if (subject.topics === reorderingData) { subject.topics = newOrder; break; }
                }
            }
            saveEditais();
            renderEditalDetail();
            document.getElementById('reorder-modal').classList.add('hidden');
        }

        function createNewEdital() {
            openGenericModal('Novo Edital', '', false, (name) => {
                if (name && name.trim() !== '') {
                    editais.push({ id: Date.now(), title: name.trim(), subjects: [] });
                    saveEditais();
                    renderSyllabusList();
                }
            });
        }

        function renderSyllabusList() {
            const container = document.getElementById('syllabus-list-container');
            container.innerHTML = '';
            if(editais.length === 0) { container.innerHTML = `<div style="text-align:center; color:var(--text-muted); margin-top:20px;">Você ainda não criou nenhum edital.</div>`; return; }
            editais.forEach(edital => {
                let totalTopics = 0; let doneTopics = 0; let linkedTopics = 0;
                edital.subjects.forEach(sub => { totalTopics += sub.topics.length; doneTopics += sub.topics.filter(t => t.done).length; linkedTopics += sub.topics.filter(t => t.linkedCategory || t.linkedNoteId).length; });
                const percent = totalTopics === 0 ? 0 : Math.round((doneTopics / totalTopics) * 100);
                container.innerHTML += `<div class="syllabus-item" onclick="openEdital(${edital.id})"><div style="flex:1;"><h4 style="margin-bottom:8px; font-size:1.1rem; color:var(--text-main);">${edital.title}</h4><div style="font-size:0.85rem; color:var(--text-muted);">${edital.subjects.length} Matérias • ${totalTopics} Tópicos • ${linkedTopics} Vinculados</div></div><div style="display:flex; align-items:center; gap:12px;"><strong style="color:var(--primary); font-size:1.1rem;">${percent}%</strong><i class="fas fa-chevron-right" style="color:var(--text-muted);"></i></div></div>`;
            });
        }

        function openEdital(id) { currentEditalId = id; renderEditalDetail(); switchTab('syllabus-detail'); }

        function renderEditalDetail() {
            const edital = editais.find(e => e.id === currentEditalId);
            if(!edital) return switchTab('syllabus');
            document.getElementById('current-edital-title').innerText = edital.title;
            let totalTopics = 0; let doneTopics = 0;
            edital.subjects.forEach(sub => { totalTopics += sub.topics.length; doneTopics += sub.topics.filter(t => t.done).length; });
            const percent = totalTopics === 0 ? 0 : Math.round((doneTopics / totalTopics) * 100);
            document.getElementById('current-edital-percent').innerText = `${percent}%`;
            document.getElementById('current-edital-progress').style.width = `${percent}%`;
            const container = document.getElementById('subjects-container');
            container.innerHTML = '';
            if(edital.subjects.length === 0) { container.innerHTML = `<div style="text-align:center; color:var(--text-muted); padding:40px;">Nenhuma matéria adicionada.</div>`; }
            edital.subjects.forEach((sub, subIndex) => {
                const subTotal = sub.topics.length; const subDone = sub.topics.filter(t => t.done).length; const subPercent = subTotal === 0 ? 0 : Math.round((subDone / subTotal) * 100);
                let topicsHtml = '';
                sub.topics.forEach((topic, topicIndex) => {
                    const topicCount = countCardsForTopic(topic);
                    
                    // Buttons logic
                    let linkButtons = '';
                    if (topic.linkedCategory) {
                         linkButtons += `<button class="topic-card-count" onclick="startSimulationForTopic(${sub.id}, ${topic.id})" title="Simulado: ${topic.linkedCategory}${topic.linkedSubcategory ? ' › ' + topic.linkedSubcategory : ''}"><i class="fas fa-play-circle" style="margin-right: 4px;"></i> ${topicCount} questões</button>`;
                    }
                    if (topic.linkedNoteId) {
                         linkButtons += `<button class="topic-card-count" style="background:var(--info);" onclick="openLinkedNote('${topic.linkedNoteId}')" title="Abrir anotação vinculada"><i class="fas fa-sticky-note" style="margin-right: 4px;"></i> Anotação</button>`;
                    }

                    topicsHtml += `<div class="topic-row ${topic.done ? 'done' : ''}"><div class="topic-check" onclick="toggleTopic(${sub.id}, ${topic.id})">${topic.done ? '<i class="fas fa-check" style="font-size:0.8rem"></i>' : ''}</div><span style="flex:1; font-size:0.95rem;">${topic.text}</span>${linkButtons}<div class="topic-controls"><button class="btn-icon" onclick="openLinkTopicModal(${sub.id}, ${topic.id})" title="Vincular conteúdo"><i class="fas fa-link"></i></button><button class="btn-icon" onclick="editTopic(${sub.id}, ${topic.id})" title="Editar"><i class="fas fa-pen"></i></button><button class="btn-icon" onclick="deleteTopic(${sub.id}, ${topic.id})" title="Excluir" style="color:var(--danger);"><i class="fas fa-trash"></i></button></div></div>`;
                });
                container.innerHTML += `<div class="subject-container ${sub.collapsed ? 'collapsed' : ''}"><div class="subject-header" onclick="toggleSubjectCollapse(${sub.id})"><div class="subject-title"><i class="fas fa-chevron-down chevron-icon"></i>${sub.title}</div><div style="display:flex; align-items:center; gap:16px;"><div class="subject-progress"><div class="subject-progress-bar" style="width:${subPercent}%"></div></div><span style="font-size:0.85rem; font-weight:700; color:var(--text-muted);">${subPercent}%</span><div class="subject-controls"><button class="btn-icon" onclick="reorderTopics(${sub.id})" title="Reorganizar tópicos"><i class="fas fa-sort"></i></button><button class="btn-icon" onclick="editSubject(${sub.id})" title="Editar"><i class="fas fa-pen"></i></button><button class="btn-icon" onclick="deleteSubject(${sub.id})" title="Excluir" style="color:var(--danger);"><i class="fas fa-trash"></i></button></div></div></div><div class="topic-list ${sub.collapsed ? 'hidden' : ''}">${topicsHtml}<div style="padding:10px 16px;"><button class="btn-sm btn-outline" onclick="addTopicToSubject(${sub.id})" style="width:100%; border-style:dashed; font-size:0.85rem;"><i class="fas fa-plus"></i> Adicionar Tópico</button></div></div></div>`;
            });
        }

        function addSubjectToEdital() {
            openGenericModal('Nova Matéria', '', false, (title) => {
                if (title && title.trim() !== '') {
                    const edital = editais.find(e => e.id === currentEditalId);
                    edital.subjects.push({ id: Date.now(), title: title.trim(), collapsed: false, topics: [] });
                    saveEditais();
                    renderEditalDetail();
                }
            });
        }

        function addTopicToSubject(subjectId) {
            openGenericModal('Novo Tópico', '', false, (text) => {
                if (text && text.trim() !== '') {
                    const edital = editais.find(e => e.id === currentEditalId);
                    const sub = edital.subjects.find(s => s.id === subjectId);
                    sub.topics.push({ id: Date.now(), text: text.trim(), done: false, linkedCategory: null, linkedSubcategory: null, linkedNoteId: null });
                    sub.collapsed = false;
                    saveEditais();
                    renderEditalDetail();
                }
            });
        }

        function toggleTopic(subjectId, topicId) {
            const edital = editais.find(e => e.id === currentEditalId);
            const sub = edital.subjects.find(s => s.id === subjectId);
            const topic = sub.topics.find(t => t.id === topicId);
            topic.done = !topic.done;
            saveEditais();
            renderEditalDetail();
        }

        function toggleSubjectCollapse(subjectId) {
            const edital = editais.find(e => e.id === currentEditalId);
            const sub = edital.subjects.find(s => s.id === subjectId);
            sub.collapsed = !sub.collapsed;
            saveEditais();
            renderEditalDetail();
        }

        function deleteSubject(subjectId) {
            if(confirm("Excluir esta matéria e todos os tópicos?")) {
                const edital = editais.find(e => e.id === currentEditalId);
                edital.subjects = edital.subjects.filter(s => s.id !== subjectId);
                saveEditais();
                renderEditalDetail();
            }
        }

        function deleteTopic(subjectId, topicId) {
             const edital = editais.find(e => e.id === currentEditalId);
             const sub = edital.subjects.find(s => s.id === subjectId);
             sub.topics = sub.topics.filter(t => t.id !== topicId);
             saveEditais();
             renderEditalDetail();
        }

        function deleteCurrentEdital() {
            if(confirm("Tem certeza que deseja apagar este edital inteiro?")) {
                editais = editais.filter(e => e.id !== currentEditalId);
                saveEditais();
                switchTab('syllabus');
            }
        }

        function importFromNotes() {
            openGenericModal('Importar do Caderno', '', true, (content) => {
                if (content && content.trim() !== '') { alert('Funcionalidade de importação será implementada em breve!'); }
            });
        }

        function renderCurrentFolder() {
            const container = document.getElementById('file-explorer');
            const breadcrumbs = document.getElementById('notes-breadcrumbs');
            const search = document.getElementById('search-notes').value.toLowerCase();
            container.innerHTML = ''; breadcrumbs.innerHTML = '';
            let path = []; let tempId = currentFolderId;
            while(tempId) { const f = folders.find(x => x.id === tempId); if(f) { path.unshift(f); tempId = f.parentId; } else break; }
            breadcrumbs.innerHTML += `<div class="breadcrumb-item ${currentFolderId===null?'active':''}" onclick="navigateToFolder(null)"><i class="fas fa-home"></i> Início</div>`;
            path.forEach(f => breadcrumbs.innerHTML += ` / <div class="breadcrumb-item ${currentFolderId===f.id?'active':''}" onclick="navigateToFolder('${f.id}')">${f.name}</div>`);
            let visibleFolders = folders.filter(f => search ? f.name.toLowerCase().includes(search) : String(f.parentId) === String(currentFolderId));
            let visibleNotes = notes.filter(n => search ? n.title.toLowerCase().includes(search) : n.folderId === currentFolderId);
            visibleFolders.forEach(f => {
            container.innerHTML += `
    <div class="file-item" onclick="if(!event.target.closest('.file-btn')) navigateToFolder('${f.id}')">
        <div class="file-actions">
            <!-- Botão Renomear -->
            <div class="file-btn" onclick="renameFolder('${f.id}')" title="Renomear">
                <i class="fas fa-pen"></i>
            </div>
            
            
            <!-- Botão Excluir -->
            <div class="file-btn delete" onclick="deleteFolder('${f.id}')" title="Excluir">
                <i class="fas fa-trash"></i>
            </div>
        </div>
        <div class="file-icon" style="color:#fbbf24;"><i class="fas fa-folder"></i></div>
        <div class="file-name">${f.name}</div>
    </div>`;

            });
            visibleNotes.forEach(n => {
                container.innerHTML += `<div class="file-item" onclick="if(!event.target.closest('.file-btn')) openNoteEditor('${n.id}')"><div class="file-actions"><div class="file-btn delete" onclick="deleteNote('${n.id}')"><i class="fas fa-trash"></i></div></div><div class="file-icon" style="color:var(--text-muted);"><i class="fas fa-file-alt"></i></div><div class="file-name">${n.title}</div></div>`;
            });
            document.getElementById('empty-folder-msg').classList.toggle('hidden', visibleFolders.length > 0 || visibleNotes.length > 0);
        }
        function navigateToFolder(id) { currentFolderId = id; document.getElementById('search-notes').value = ''; renderCurrentFolder(); }
        
        function promptNewFolder() { 
    openGenericModal('Nova Pasta', '', false, (name) => {
        if(name && name.trim() !== '') {
            folders.push({id:'f_'+Date.now(), name: name.trim(), parentId:currentFolderId}); 
            
            // CORREÇÃO: Agora chama a função de salvar pastas
            saveFoldersData(); 
            
            renderCurrentFolder();
            renderReviewBanner();
        }
    });
}

        
        function renameFolder(id) {
    const folder = folders.find(f => f.id === id);
    if (!folder) return;

    // Abre o pop-up (modal) que você já tem no app
    openGenericModal("Renomear Pasta", folder.name, false, (newName) => {
        if (newName && newName.trim() !== "") {
            folder.name = newName.trim();
            
            // Salva as alterações e atualiza a tela
            saveFoldersData(); 
            renderCurrentFolder();
            
            // Opcional: Alerta de sucesso sumindo rápido
            console.log("Pasta renomeada com sucesso!");
        }
    });
}

function moveFolder(id) {
    const folderToMove = folders.find(f => f.id === id);
    if (!folderToMove) return;

    let optionsHtml = `<option value="null">/ Início (Raiz)</option>`;
    folders.forEach(f => {
        // Impede mover a pasta para dentro dela mesma
        if (f.id !== id) {
            optionsHtml += `<option value="${f.id}">${f.name}</option>`;
        }
    });

    showConfirm("Mover Pasta", 
        `Escolha o destino para a pasta "<strong>${folderToMove.name}</strong>":<br><br>
        <select id="move-folder-select" style="width:100%; padding:10px; border-radius:8px; border:1px solid var(--border);">
            ${optionsHtml}
        </select>`, 
        (confirmed) => {
            // ... dentro da função moveFolder, na parte do (confirmed) => {
if (confirmed) {
    const newParentId = document.getElementById('move-folder-select').value;
    
    // A MUDANÇA É AQUI: Tiramos o parseInt
    folderToMove.parentId = (newParentId === "null") ? null : newParentId;

    
    saveFoldersData();
    renderCurrentFolder();
    showAlert("Sucesso", "Pasta movida!");
}

        }
    );
}




function deleteFolder(id) {
    // Pegamos o nome da pasta para personalizar a mensagem
    const folder = folders.find(f => f.id === id);
    const folderName = folder ? folder.name : 'esta pasta';

    // showConfirm(Titulo, Mensagem, FuncaoConfirmacao)
    showConfirm("Excluir Pasta", `Deseja apagar a pasta "${folderName}" e todo o seu conteúdo? Isso não poderá ser desfeito.`, () => {
        
        // --- LÓGICA ORIGINAL MANTIDA AQUI DENTRO ---
        let folderIdsToDelete = [id];
        
        // Coleta todas as subpastas
        const collectSubfolderIds = (parentId) => {
            const subs = folders.filter(f => f.parentId === parentId);
            subs.forEach(sub => {
                folderIdsToDelete.push(sub.id);
                collectSubfolderIds(sub.id);
            });
        };
        collectSubfolderIds(id);
        
        // Remove notas e pastas da memória
        notes = notes.filter(n => !folderIdsToDelete.includes(n.folderId));
        folders = folders.filter(f => !folderIdsToDelete.includes(f.id));
        
        // SALVA TUDO
        if (typeof saveNotesData === 'function') saveNotesData(); 
        saveFoldersData();
        
        renderCurrentFolder();
    });
}



        
        function createNewNote() { editingNoteId = null; openNoteEditor(null); }
                function openNoteEditor(id) { 
            editingNoteId = id; 
            
            // 1. Encontra a nota
            const n = notes.find(x => x.id === id); 
            
            // [NOVO] 2. Salva no Histórico Recente se a nota existir
            if (n) {
                addToQuickHistory(n);
            }

            // 3. Preenche o Editor
            document.getElementById('note-title').value = n ? n.title : ''; 
            quill.clipboard.dangerouslyPasteHTML(n ? n.content : "");
            
            // Populate folder dropdown
            const folderSelect = document.getElementById('note-folder-select');
            folderSelect.innerHTML = '<option value="null">Início</option>';
            
            // Sort folders alphabetically for better UX
            const sortedFolders = [...folders].sort((a,b) => a.name.localeCompare(b.name));
            
            sortedFolders.forEach(f => {
                folderSelect.innerHTML += `<option value="${f.id}" ${n ? (n.folderId === f.id ? 'selected' : '') : (currentFolderId === f.id ? 'selected' : '')}>${f.name}</option>`;
            });
            
            if(n && n.folderId === null) folderSelect.value = "null";
            if(!n && currentFolderId === null) folderSelect.value = "null";

            switchTab('note-editor'); 
        }

        // --- NOVA FUNÇÃO DE SALVAMENTO AUTOMÁTICO ---
function persistCurrentNote() {
    // Verifica se o editor está aberto
    const editorView = document.getElementById('note-editor-view');
    if (!editorView || editorView.classList.contains('hidden')) return;

    const t = document.getElementById('note-title').value;
    // Pega o texto do editor (verifica se o Quill existe)
    if (typeof quill === 'undefined') return;
    const c = quill.root.innerHTML;
    
    // Se não tiver título nem conteúdo, não salva nada
    if (!t && (c === '<p><br></p>' || c === '')) return;

    let fId = document.getElementById('note-folder-select').value;
    if(fId === 'null') fId = null;

    // Garante que a pasta existe
    if (fId && typeof folders !== 'undefined' && !folders.find(f => f.id === fId)) {
        fId = null; 
    }

    if(editingNoteId) { 
        // Atualiza nota existente
        const i = notes.findIndex(x => x.id === editingNoteId); 
        if(i > -1) notes[i] = {...notes[i], title:t, content:c, folderId:fId}; 
    } else { 
        // Cria nova nota e define o ID para continuar editando ela
        const newId = 'n_' + Date.now();
        notes.push({id:newId, title:t||'Nova Nota', content:c, folderId:fId}); 
        editingNoteId = newId;
    } 
    saveNotesData(); 
    console.log('Salvamento automático realizado!');
}

function saveNote() { 
    persistCurrentNote(); 
    // Atualiza para a pasta onde salvamos, para não perder o usuário
    let fId = document.getElementById('note-folder-select').value;
    if(fId === 'null') fId = null;
    currentFolderId = fId;
    switchTab('notes'); 
}

// --- SISTEMA DE REVISÃO ESPAÇADA (SRS) V2 ---

let tempSRSReset = false; // Variável para controlar o reset antes de salvar

function openSRSSettings() {
    // --- CORREÇÃO INICIADA ---
    // Se não tiver ID (nota nova/não salva), tenta salvar automaticamente agora
    if (!editingNoteId) {
        persistCurrentNote(); // Tenta salvar o rascunho
        
        // Se ainda assim não tiver ID (ex: nota vazia sem título nem texto)
        if (!editingNoteId) {
            alert("Por favor, escreva algo na nota antes de configurar a revisão.");
            return;
        }
    }
    // --- CORREÇÃO FINALIZADA ---
    
    const note = notes.find(n => n.id === editingNoteId);
    if (!note) return;

    // Reinicia o estado temporário
    tempSRSReset = false;

    const modal = document.getElementById('srs-modal');
    const check = document.getElementById('srs-active-check');
    const dateInput = document.getElementById('srs-next-date');
    const controls = document.getElementById('srs-controls');
    const badge = document.getElementById('srs-status-badge');

    // Carregar dados
    const srs = note.srs || { active: false, level: 0, nextReview: null };
    
    check.checked = srs.active;
    badge.innerText = `Nível ${srs.level || 0}`;
    
    // Configura data
    if (srs.nextReview) {
        const d = new Date(srs.nextReview);
        dateInput.value = d.toISOString().split('T')[0];
    } else {
        const tomorrow = new Date();
        tomorrow.setDate(tomorrow.getDate() + 1);
        dateInput.value = tomorrow.toISOString().split('T')[0];
    }

    // Controle Visual de Opacidade
    const updateVisuals = () => {
        if(check.checked) {
            controls.style.opacity = "1";
            controls.style.pointerEvents = "auto";
        } else {
            controls.style.opacity = "0.4";
            controls.style.pointerEvents = "none";
        }
    };
    
    check.onchange = updateVisuals;
    updateVisuals(); // Roda ao abrir

    modal.classList.remove('hidden');
}


function resetSRS() {
    // Apenas marca que queremos resetar e atualiza o visual, não salva ainda
    tempSRSReset = true;
    
    document.getElementById('srs-status-badge').innerText = "Nível 0 (Resetado)";
    document.getElementById('srs-status-badge').style.borderColor = "var(--danger)";
    document.getElementById('srs-status-badge').style.color = "var(--danger)";
    
    // Reseta data visualmente para amanhã
    const tomorrow = new Date();
    tomorrow.setDate(tomorrow.getDate() + 1);
    document.getElementById('srs-next-date').value = tomorrow.toISOString().split('T')[0];
}

function saveSRSConfig() {
    if (!editingNoteId) return;
    
    const noteIndex = notes.findIndex(n => n.id === editingNoteId);
    if (noteIndex === -1) return;

    const isActive = document.getElementById('srs-active-check').checked;
    const dateVal = document.getElementById('srs-next-date').value;
    
    // Lógica Corrigida do Nível
    let currentLevel = notes[noteIndex].srs?.level || 0;
    
    // Se o usuário clicou em resetar, força zero
    if (tempSRSReset) {
        currentLevel = 0;
    }
    
    // Se ativou agora e estava no zero, sobe para 1
    if (isActive && currentLevel === 0) {
        currentLevel = 1;
    }

    // Salva no objeto da nota
    notes[noteIndex].srs = {
        active: isActive,
        level: currentLevel,
        nextReview: isActive ? new Date(dateVal + "T12:00:00").getTime() : null // Adiciona hora para evitar fuso bugando o dia
    };

    saveNotesData(); 
    document.getElementById('srs-modal').classList.add('hidden');
    
    // Reseta estilos visuais do modal
    document.getElementById('srs-status-badge').style.borderColor = "var(--border)";
    document.getElementById('srs-status-badge').style.color = "var(--text-main)";
    
    renderReviewBanner(); 
}

function renderReviewBanner() {
    const banner = document.getElementById('srs-review-banner');
    const list = document.getElementById('srs-list');
    const badge = document.getElementById('srs-count-badge');
    
    if (!banner || !list) return;

    const now = new Date();
    now.setHours(23, 59, 59, 999); // Considera o final do dia de hoje
    
    // Filtra notas
    const dueNotes = notes.filter(n => 
        n.srs && 
        n.srs.active && 
        n.srs.nextReview && 
        n.srs.nextReview <= now.getTime()
    );

    if (dueNotes.length === 0) {
        banner.style.display = 'none';
        return;
    }

    banner.style.display = 'block';
    badge.innerText = `${dueNotes.length} pendentes`;
    
    list.innerHTML = dueNotes.map(n => `
        <div class="srs-item-row" onclick="openNoteFromBanner('${n.id}')">
            <div style="display:flex; align-items:center; gap:10px;">
                <div style="background:rgba(255,255,255,0.2); width:30px; height:30px; border-radius:50%; display:flex; align-items:center; justify-content:center;">
                    <i class="fas fa-book-open" style="font-size:0.8rem;"></i>
                </div>
                <div style="display:flex; flex-direction:column;">
                    <span style="font-weight: 600; font-size:0.95rem;">${n.title || 'Sem título'}</span>
                    <span style="font-size: 0.75rem; opacity:0.8;">Nível ${n.srs.level || 1}</span>
                </div>
            </div>
            
            <button id="btn-review-${n.id}" onclick="event.stopPropagation(); completeReview('${n.id}')" 
                style="background: white; color: var(--primary); border: none; border-radius: 20px; padding: 6px 12px; font-weight: bold; cursor: pointer; box-shadow: 0 2px 5px rgba(0,0,0,0.1);">
                <i class="fas fa-check"></i> Feito
            </button>
        </div>
    `).join('');
}

function openNoteFromBanner(id) {
    // 1. Acha a nota
    const note = notes.find(n => n.id === id);
    if(!note) return;

    // 2. Define o ID atual
    editingNoteId = id;

    // 3. Força a troca para a aba de notas
    switchTab('notes');

    // 4. Se a nota estiver dentro de uma pasta, define a pasta atual para o botão "voltar" funcionar
    if(note.folderId) {
        currentFolderId = note.folderId;
    } else {
        currentFolderId = null; 
    }
    
    // 5. Carrega o editor
    loadNoteInEditor(note); // Usa a função auxiliar interna se existir, ou a lógica abaixo
    
    // Caso não tenha loadNoteInEditor separado, fazemos manual:
    const editorView = document.getElementById('note-editor-view');
    const explorer = document.getElementById('file-explorer-container');
    
    if(editorView && explorer) {
        explorer.classList.add('hidden');
        editorView.classList.remove('hidden');
        
        document.getElementById('note-title').value = note.title;
        if (typeof quill !== 'undefined') {
            quill.root.innerHTML = note.content;
        }
        
        // Atualiza breadcrumb/botão voltar visualmente se necessário
        const backBtn = document.getElementById('editor-back-btn');
        if(backBtn) backBtn.style.display = 'flex';
    }
}

// Função de completar (Mantida igual, só garante o save)
function completeReview(noteId) {
    const noteIndex = notes.findIndex(n => n.id === noteId);
    if (noteIndex === -1) return;

    const note = notes[noteIndex];
    if (!note.srs || !note.srs.active) return;

    // Progressão x2
    let nextLevel = (note.srs.level || 0) + 1;
    let daysToAdd = Math.pow(2, nextLevel - 1); 
    
    const nextDate = new Date();
    nextDate.setDate(nextDate.getDate() + daysToAdd);

    note.srs.level = nextLevel;
    note.srs.nextReview = nextDate.getTime();

    saveNotesData();
    
    // Animaçãozinha de sumir
    const row = document.getElementById(`btn-review-${noteId}`).parentElement;
    row.style.transform = "translateX(50px)";
    row.style.opacity = "0";
    
    setTimeout(() => renderReviewBanner(), 300);
}


function openNoteFromBanner(id) {
    loadNote(id);
}

// IMPORTANTE: Adicione esta linha dentro da sua função renderCurrentFolder() existente,
// logo no final dela, para que o banner atualize sempre que você abrir o caderno.
// renderReviewBanner(); 


// --- COLE ISTO LOGO ABAIXO DE saveNote() ---
function deleteNote(id) {
    const note = notes.find(n => n.id === id);
    if (!note) return;

    showConfirm('Excluir Nota', `Tem certeza que deseja apagar a anotação "${note.title}"? Esta ação não pode ser desfeita.`, () => {
        // Filtra a lista removendo a nota selecionada
        notes = notes.filter(n => n.id !== id);
        
        // Salva e atualiza a tela
        saveFoldersData();
        renderCurrentFolder();
        
        // Feedback visual rápido (opcional)
        // alert("Nota excluída com sucesso!"); 
    });
}

// ------------------------------------------------

        // --- NOVA FUNÇÃO PARA SALVAR PASTAS (Isso faltava antes) ---
async function saveFoldersData() {
    try {
        await salvarDados('ted_folders', folders);
        console.log("Pastas salvas com sucesso!");
    } catch (e) {
        console.error("Erro ao salvar pastas:", e);
    }
}

// --- FUNÇÃO DE SALVAR NOTAS CORRIGIDA (Substitui a antiga) ---
async function saveNotesData() {
    // 1. Se estiver com o editor aberto, pega o texto mais recente antes de salvar
    if (editingNoteId && typeof quill !== 'undefined') {
        const noteIndex = notes.findIndex(n => n.id === editingNoteId);
        
        // Só atualiza se encontrar a nota e o editor tiver conteúdo válido
        if (noteIndex !== -1 && quill.root) {
            const conteudoNovo = quill.root.innerHTML;
            notes[noteIndex].content = conteudoNovo;
            notes[noteIndex].updatedAt = new Date().toISOString();
        }
    }

    // 2. Salva TUDO no banco de dados (A correção principal é que isso roda SEMPRE)
    try {
        await salvarDados('ted_notes', notes);
        console.log("Todas as notas foram salvas no banco.");
    } catch (e) {
        console.error("Erro ao salvar notas:", e);
    }
}

        function formatText(cmd, arg=null) { document.getElementById('note-content').focus(); document.execCommand(cmd, false, arg); }
        function closeNoteEditor() { switchTab('notes'); }

        function renderDashboard() {
    const now = Date.now();
    const due = cards.filter(c => c.nextReview <= now).length;
    document.getElementById('dash-due-count').innerText = due;
    
    // --- ALTERAÇÃO: Mostra total de cards em vez de ofensiva ---
    const totalEl = document.getElementById('dash-total-cards');
    if(totalEl) totalEl.innerText = cards.length; 
    // -----------------------------------------------------------

    const nextTaskEl = document.getElementById('dash-next-task');
    if(cards.length > 0) {
        const nextCard = [...cards].sort((a,b) => a.nextReview - b.nextReview)[0];
        const dateStr = new Date(nextCard.nextReview).toLocaleString('pt-BR', {day:'2-digit', month:'2-digit', hour:'2-digit', minute:'2-digit'});
        nextTaskEl.innerHTML = `<div style="font-size:0.9rem">${dateStr}</div><div style="font-size:0.8rem; color:var(--primary); font-weight:600;">${nextCard.category || 'Geral'}</div>`;
    } else { nextTaskEl.innerText = "Nenhuma"; }

    atualizarBannersSubtopicos();
    
    // Gráfico mini
    const chart = document.getElementById('dash-mini-chart'); 
    if(chart) {
        chart.innerHTML = '';
        for(let i=6; i>=0; i--) {
            const d = new Date(); d.setDate(d.getDate() - i);
            const count = performanceData.filter(p => p.date === d.toISOString().split('T')[0]).length;
            const h = Math.min(count * 5, 80);
            chart.innerHTML += `<div class="chart-col"><div class="chart-bar-container"><div class="chart-bar" style="height:${Math.max(4, h)}px;background:${count>0?'var(--primary)':'var(--border)'};"></div></div><div class="chart-label">${d.toLocaleDateString('pt-BR', {weekday:'short'}).slice(0,3)}</div></div>`;
        }
    }

    // Tarefas
    const tasksPreview = document.getElementById('dash-tasks-preview'); 
    if(tasksPreview) {
        tasksPreview.innerHTML = '';
        const pendingTasks = tasks.filter(t => !t.done); const doneTasks = tasks.filter(t => t.done);
        if (pendingTasks.length === 0 && doneTasks.length === 0) tasksPreview.innerHTML = '<div style="font-size:0.85rem; color:var(--text-muted); font-style:italic;">Nenhuma meta definida.</div>';
        else if (pendingTasks.length === 0 && doneTasks.length > 0) tasksPreview.innerHTML = '<div style="font-size:0.85rem; color:var(--success); font-weight:bold;"><i class="fas fa-check-circle"></i> Tudo concluído!</div>';
        else { pendingTasks.slice(0, 3).forEach(t => { tasksPreview.innerHTML += `<div style="display:flex; gap:10px; align-items:center; background:var(--bg-body); padding:8px; border-radius:6px; font-size:0.9rem;"><div class="task-check" onclick="toggleTask(${t.id}); renderDashboard();" style="width:16px; height:16px; min-width:16px;"></div><span style="overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">${t.text}</span></div>`; }); if (pendingTasks.length > 3) tasksPreview.innerHTML += `<div style="font-size:0.8rem; color:var(--text-muted); text-align:center;">+ ${pendingTasks.length - 3} metas</div>`; }
    }
}


        function renderTasks() { const c = document.getElementById('tasks-container'); c.innerHTML = ''; tasks.forEach(t => c.innerHTML += `<div class="task-item ${t.done?'completed':''}"><div class="task-check" onclick="toggleTask(${t.id})">${t.done?'<i class="fas fa-check"></i>':''}</div><span style="flex:1;">${t.text}</span><i class="fas fa-trash" onclick="deleteTask(${t.id})" style="color:var(--text-muted);cursor:pointer;"></i></div>`); }
        function addTask() { const v = document.getElementById('new-task-input').value; if(v) { tasks.push({id:Date.now(), text:v, done:false}); document.getElementById('new-task-input').value=''; saveSchedule(); renderTasks(); renderDashboard(); } }
        function toggleTask(id) { const t=tasks.find(x=>x.id===id); if(t)t.done=!t.done; saveSchedule(); renderTasks(); renderDashboard(); }
        function deleteTask(id) { tasks=tasks.filter(x=>x.id!==id); saveSchedule(); renderTasks(); renderDashboard(); }
        function clearCompletedTasks() { tasks=tasks.filter(t=>!t.done); saveSchedule(); renderTasks(); renderDashboard(); }

        // --- SCHEDULE & POMODORO INTEGRATION FIX ---
        
        // Helper to get week number consistently
        function getWeekNumber(d) {
            // Copy date so don't modify original
            d = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
            // Set to nearest Thursday: current date + 4 - current day number
            // Make Sunday's day number 7
            d.setUTCDate(d.getUTCDate() + 4 - (d.getUTCDay() || 7));
            // Get first day of year
            var yearStart = new Date(Date.UTC(d.getUTCFullYear(),0,1));
            // Calculate full weeks to nearest Thursday
            var weekNo = Math.ceil(( ( (d.valueOf() - yearStart.valueOf()) / 86400000) + 1)/7);
            return weekNo;
        }

        function renderSchedule() {
            const body = document.getElementById('schedule-body'); body.innerHTML = '';
            
            // Calculate the Monday of the current displayed week
            const today = new Date(); 
            today.setDate(today.getDate() + (currentWeekOffset*7));
            const diff = today.getDate() - today.getDay() + (today.getDay()===0?-6:1);
            const monday = new Date(today.setDate(diff));
            
            const realToday = new Date();
            document.getElementById('current-week-label').innerText = `${monday.getDate()} - Semana`;
            
            // Render Headers (Mon-Sun)
            for(let i=0; i<7; i++) { 
                const d=new Date(monday); 
                d.setDate(monday.getDate()+i); 
                const th=document.getElementById(`th-${i}`); 
                th.innerText = ["SEG","TER","QUA","QUI","SEX","SÁB","DOM"][i] + " " + d.getDate(); 
                th.style.color='var(--text-muted)'; 
                if(d.getDate()===realToday.getDate() && d.getMonth()===realToday.getMonth()) th.style.color='var(--primary)'; 
            }
            
            // Consistent Week Calculation for Rendering
            // This ensures keys like '2024-42-0-13' match between saving and rendering
            const currentYear = monday.getFullYear();
            const weekNum = getWeekNumber(monday);
            const weekKey = `${currentYear}-${weekNum}`;
            
            for(let h=0; h<=23; h++) {
                const tr = document.createElement('tr'); 
                tr.innerHTML = `<td class="time-label">${h}:00</td>`;
                for(let d=0; d<7; d++) {
                    const k = `${weekKey}-${d}-${h}`; 
                    const b = scheduleData[k];
                    tr.innerHTML += `<td>${b ? `<div class="event-block" style="background:${b.color}" onclick="editSch('${k}')">${b.title}</div>` : `<div class="empty-cell-btn" onclick="createSch('${k}')"><i class="fas fa-plus"></i></div>`}</td>`;
                } 
                body.appendChild(tr);
            }
        }
        
        function saveSchedule() {
    // Agora salva as duas coisas no banco de dados correto (localForage)
    salvarDados('ted_schedule', scheduleData);
    salvarDados('ted_tasks', tasks); // <--- Corrigido para usar a mesma função de salvamento do resto do app
}

        window.createSch = (k) => { editingScheduleBlock=k; document.getElementById('schedule-block-title').value=''; document.getElementById('btn-delete-block').classList.add('hidden'); document.getElementById('schedule-modal').classList.remove('hidden'); };
        window.editSch = (k) => { editingScheduleBlock=k; document.getElementById('schedule-block-title').value=scheduleData[k].title; selectedColor=scheduleData[k].color; document.getElementById('btn-delete-block').classList.remove('hidden'); document.getElementById('schedule-modal').classList.remove('hidden'); };
        function saveScheduleBlock() { if(!document.getElementById('schedule-block-title').value) return; scheduleData[editingScheduleBlock]={title:document.getElementById('schedule-block-title').value, color:selectedColor}; saveSchedule(); document.getElementById('schedule-modal').classList.add('hidden'); renderSchedule(); }
        function deleteScheduleBlock() { delete scheduleData[editingScheduleBlock]; saveSchedule(); document.getElementById('schedule-modal').classList.add('hidden'); renderSchedule(); }
        function closeScheduleModal() { document.getElementById('schedule-modal').classList.add('hidden'); }
        function selectColor(c, el) { selectedColor=c; document.querySelectorAll('.color-chip').forEach(x=>x.style.border='3px solid transparent'); el.style.border='3px solid white'; }
        function changeWeek(d) { currentWeekOffset+=d; renderSchedule(); }
        
        // --- NEW: TEMPLATE SYSTEM LOGIC ---
        let currentTemplateType = null; // 'task' or 'schedule'

        function openTemplateModal(type, action) {
            currentTemplateType = type;
            const titlePrefix = type === 'task' ? 'Meta' : 'Agenda';
            
            if (action === 'save') {
                openGenericModal(`Salvar Modelo de ${titlePrefix}`, '', false, (name) => {
                    if (name && name.trim() !== '') {
                        saveTemplate(type, name.trim());
                    }
                });
            } else if (action === 'load') {
                document.getElementById('template-modal-title').innerText = `Carregar Modelo de ${titlePrefix}`;
                renderTemplateList(type);
                document.getElementById('template-modal').classList.remove('hidden');
            }
        }

        function saveTemplate(type, name) {
    if (type === 'task') {
        const currentTasks = tasks.map(t => ({ text: t.text, done: false })); // Reset done state on save
        if (currentTasks.length === 0) return alert("Adicione metas antes de salvar um modelo.");
        
        const newTemplate = { id: Date.now(), name: name, data: currentTasks };
        taskTemplates.push(newTemplate);
        
        // MUDANÇA AQUI: localForage
        localforage.setItem('ted_task_templates', taskTemplates).then(function() {
            showAlert("Sucesso", "Modelo de metas salvo!");
        }).catch(console.error);

    } else if (type === 'schedule') {
        // Lógica mantida igual, só muda o salvamento no final
        const today = new Date(); 
        today.setDate(today.getDate() + (currentWeekOffset*7));
        const diff = today.getDate() - today.getDay() + (today.getDay()===0?-6:1);
        const monday = new Date(today.setDate(diff));
        const currentYear = monday.getFullYear();
        const weekNum = getWeekNumber(monday);
        const weekKeyPrefix = `${currentYear}-${weekNum}`;
        
        let weekData = [];
        for(let d=0; d<7; d++) {
            for(let h=0; h<=23; h++) {
                const key = `${weekKeyPrefix}-${d}-${h}`;
                if(scheduleData[key]) {
                    weekData.push({ day: d, hour: h, title: scheduleData[key].title, color: scheduleData[key].color });
                }
            }
        }
        
        if (weekData.length === 0) return alert("A semana atual está vazia. Adicione horários antes de salvar.");
        
        const newTemplate = { id: Date.now(), name: name, data: weekData };
        scheduleTemplates.push(newTemplate);

        // MUDANÇA AQUI: localForage
        localforage.setItem('ted_schedule_templates', scheduleTemplates).then(function() {
            showAlert("Sucesso", "Modelo de agenda salvo!");
        }).catch(console.error);
    }
}


        function renderTemplateList(type) {
            const list = document.getElementById('template-list-container');
            const emptyMsg = document.getElementById('template-empty-msg');
            list.innerHTML = '';
            
            const templates = type === 'task' ? taskTemplates : scheduleTemplates;
            
            if (templates.length === 0) {
                emptyMsg.classList.remove('hidden');
                return;
            }
            emptyMsg.classList.add('hidden');
            
            templates.forEach(t => {
                const item = document.createElement('div');
                item.className = 'template-item';
                item.innerHTML = `
                    <div onclick="applyTemplate('${type}', ${t.id})" style="flex:1; font-weight:600;">${t.name}</div>
                    <div style="display:flex; gap:8px;">
                        <button class="btn-sm btn-outline" onclick="applyTemplate('${type}', ${t.id})" title="Carregar"><i class="fas fa-upload"></i></button>
                        <button class="btn-sm btn-danger" onclick="deleteTemplate('${type}', ${t.id})" title="Excluir"><i class="fas fa-trash"></i></button>
                    </div>
                `;
                list.appendChild(item);
            });
        }

        function deleteTemplate(type, id) {
    showConfirm("Excluir Modelo", "Tem certeza?", () => {
        if (type === 'task') {
            taskTemplates = taskTemplates.filter(t => t.id !== id);
            
            // MUDANÇA: Salvando tasks no localForage
            localforage.setItem('ted_task_templates', taskTemplates).then(function() {
                 renderTemplateList(type);
            }).catch(console.error);
            
        } else {
            scheduleTemplates = scheduleTemplates.filter(t => t.id !== id);
            
            // MUDANÇA: Salvando schedule no localForage
            localforage.setItem('ted_schedule_templates', scheduleTemplates).then(function() {
                 renderTemplateList(type);
            }).catch(console.error);
        }
        
        // Note que o renderTemplateList foi movido para dentro do .then()
        // Isso garante que a lista só atualiza na tela se o salvamento deu certo.
    });
}


        function applyTemplate(type, id) {
            showConfirm("Carregar Modelo", "Isso substituirá/adicionará os itens atuais. Deseja continuar?", () => {
                if (type === 'task') {
                    const template = taskTemplates.find(t => t.id === id);
                    if (template) {
                        // Append or Replace? Let's Replace for "Template" behavior, or user cleans first. 
                        // Let's Append to be safe, user can clear list easily.
                        template.data.forEach(item => {
                            tasks.push({ id: Date.now() + Math.random(), text: item.text, done: false });
                        });
                        saveSchedule();
                        renderTasks();
                        renderDashboard();
                        showAlert("Sucesso", "Metas carregadas!");
                    }
                } else if (type === 'schedule') {
                    const template = scheduleTemplates.find(t => t.id === id);
                    if (template) {
                        // Apply to CURRENT visible week
                        const today = new Date(); 
                        today.setDate(today.getDate() + (currentWeekOffset*7));
                        const diff = today.getDate() - today.getDay() + (today.getDay()===0?-6:1);
                        const monday = new Date(today.setDate(diff));
                        const currentYear = monday.getFullYear();
                        const weekNum = getWeekNumber(monday);
                        const weekKeyPrefix = `${currentYear}-${weekNum}`;
                        
                        // Overwrite slots
                        template.data.forEach(item => {
                            const key = `${weekKeyPrefix}-${item.day}-${item.hour}`;
                            scheduleData[key] = { title: item.title, color: item.color };
                        });
                        saveSchedule();
                        renderSchedule();
                        showAlert("Sucesso", "Agenda carregada na semana atual!");
                    }
                }
                document.getElementById('template-modal').classList.add('hidden');
            });
        }

        function handleSave() {
    const q = document.getElementById('input-question').innerHTML; 
    const a = document.getElementById('input-opt-a').value;
    const comment = document.getElementById('input-comment').innerHTML; 
    const cat = document.getElementById('input-category').value;
    const subcat = document.getElementById('input-subcategory').value; 
    const sourceLink = document.getElementById('input-source') ? document.getElementById('input-source').value : '';
    
    if(!q || !a) return alert('Preencha pergunta e resposta correta!');

    // Coleta as opções
    const opts = [
        a, 
        document.getElementById('input-opt-b').value, 
        document.getElementById('input-opt-c').value, 
        document.getElementById('input-opt-d').value,
        document.getElementById('input-opt-e').value
    ].filter(Boolean); // Remove vazios

    if (editingId) {
        // --- MODO EDIÇÃO ---
        const index = cards.findIndex(c => c.id === editingId);
        
        if (index !== -1) {
            // Copia o card original e sobrescreve apenas os campos de texto
            // Mantém nextReview, interval, ease, reviewsCount, history, etc.
            cards[index] = {
                ...cards[index], // Mantém TUDO que já existia
                question: q,
                correctText: a,
                category: cat,
                subcategory: subcat,
                comment: comment,
                source: sourceLink,
                options: opts
                // id não muda, SRS não muda
            };
        }
        editingId = null;
        
    } else { 
        // --- MODO CRIAÇÃO ---
        const newCard = {
            id: Date.now(),
            question: q, 
            correctText: a,
            category: cat,
            subcategory: subcat,
            comment: comment,
            source: sourceLink, 
            options: opts,
            // Dados iniciais de SRS padrão
            nextReview: Date.now(), 
            interval: 0,
            ease: 2.5,          // Importante para o algoritmo
            reviewsCount: 0     // Importante para estatísticas
        };
        cards.push(newCard); 
    }

    salvarDados('ted_flashcards', cards);

    // ATUALIZA AS CATEGORIAS IMEDIATAMENTE APÓS SALVAR
    updateCategoryDropdowns(); 

    resetForm();
    // Switch to Library view after save
    switchStudyTab('library');
}



        function updateSubcategorySuggestions() {
            const currentCat = document.getElementById('input-category').value;
            const subList = document.getElementById('subcategory-list-suggestions');
            subList.innerHTML = '';
            const relevantCards = cards.filter(c => (c.category || '').toLowerCase() === currentCat.toLowerCase());
            const subs = [...new Set(relevantCards.map(c => c.subcategory).filter(Boolean))];
            subs.forEach(s => { subList.innerHTML += `<option value="${s}">`; });
        }

        function resetForm() {
    document.querySelectorAll('#sub-view-creator input, #sub-view-creator textarea').forEach(i => i.value = '');
    
    document.getElementById('input-question').innerHTML = ''; 
    document.getElementById('input-comment').innerHTML = ''; 

    document.getElementById('save-btn').innerHTML = '<i class="fas fa-save"></i> Salvar Card';
    document.getElementById('cancel-edit-btn').classList.add('hidden');
    editingId = null;
}


        function changeLibraryPage(direction) {
    const list = document.getElementById('cards-list-container');
    // Apenas muda visualmente se tivermos cards suficientes, a lógica real está no renderManageList
    // Mas para simplificar, vamos apenas atualizar a variável e renderizar de novo
    currentLibraryPage += direction;
    if (currentLibraryPage < 1) currentLibraryPage = 1;
    renderManageList();
    // Rola para o topo da lista suavemente
    document.getElementById('sub-view-library').scrollIntoView({ behavior: 'smooth' });
}

/* --- NOVA FUNÇÃO DE RENDERIZAÇÃO DA LISTA (DESIGN PREMIUM) --- */
function renderManageList() {
    const listContainer = document.getElementById('cards-list-container');
    if (!listContainer) return;

    listContainer.innerHTML = '';

    const searchInput = document.getElementById('search-cards');
    const categorySelect = document.getElementById('filter-category');
    const sortSelect = document.getElementById('filter-sort');
    const emptyMsg = document.getElementById('empty-list-msg');
    const totalCountDiv = document.getElementById('total-cards-count');

    // Pega valores
    const s = searchInput ? searchInput.value.toLowerCase() : '';
    const catFilter = categorySelect ? categorySelect.value : 'all';
    const sortFilter = sortSelect ? sortSelect.value : 'newest';

    // 1. Filtragem
    if (!cards) cards = [];
    let filtered = cards.filter(c => {
        const matchesSearch = c.question.toLowerCase().includes(s) ||
                              (c.category && c.category.toLowerCase().includes(s));
        const matchesCat = catFilter === 'all' || c.category === catFilter;
        return matchesSearch && matchesCat;
    });

    // Atualiza contador
    if(totalCountDiv) totalCountDiv.innerText = `${filtered.length} cards encontrados`;

    // 2. Ordenação
    filtered.sort((a, b) => {
        switch (sortFilter) {
            case 'newest': return b.id - a.id;
            case 'oldest': return a.id - b.id;
            case 'reviewDateAsc': return a.nextReview - b.nextReview;
            case 'reviewDateDesc': return b.nextReview - a.nextReview;
            case 'az': return a.question.localeCompare(b.question);
            default: return b.id - a.id;
        }
    });

    // 3. Paginação
    const totalPages = Math.ceil(filtered.length / libraryItemsPerPage) || 1;
    if (currentLibraryPage > totalPages) currentLibraryPage = totalPages;
    if (currentLibraryPage < 1) currentLibraryPage = 1;

    const pageInfo = document.getElementById('page-info');
    if(pageInfo) pageInfo.innerText = `Pág ${currentLibraryPage} de ${totalPages}`;

    const start = (currentLibraryPage - 1) * libraryItemsPerPage;
    const end = start + libraryItemsPerPage;
    const paginatedItems = filtered.slice(start, end);

    if (filtered.length === 0) {
        if(emptyMsg) emptyMsg.classList.remove('hidden');
        return;
    } else {
        if(emptyMsg) emptyMsg.classList.add('hidden');
    }

    // 4. Renderização HTML (DESIGN NOVO)
    paginatedItems.forEach(c => {
        const nextRev = new Date(c.nextReview).toLocaleDateString('pt-BR', {
            day: '2-digit', month: '2-digit', year: '2-digit'
        });

        // Lógica para subcategoria mais bonita
        const categoryLabel = c.category || 'Geral';
        const subLabel = c.subcategory ? `<span style="opacity: 0.6; margin: 0 6px;">/</span> ${c.subcategory}` : '';
        const shortId = c.id.toString().slice(-4);

        const cardHTML = `
        <div class="card-list-item" style="
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 16px;
            transition: transform 0.2s, box-shadow 0.2s;
        " onmouseover="this.style.borderColor='var(--primary)'; this.style.boxShadow='0 4px 12px rgba(0,0,0,0.05)'" 
          onmouseout="this.style.borderColor='var(--border)'; this.style.boxShadow='none'">
            
            <!-- TOPO: Categoria e ID -->
            <div style="display:flex; justify-content:space-between; align-items:flex-start; margin-bottom:12px;">
                <div style="display:flex; flex-direction:column; gap:4px;">
                     <!-- Badge Nova: Fundo sutil, letra maior e legível -->
                     <div style="
                        font-family: inherit;
                        font-weight: 700;
                        font-size: 0.9rem;
                        color: var(--primary);
                        text-transform: uppercase;
                        letter-spacing: 0.5px;
                     ">
                        ${categoryLabel} ${subLabel}
                     </div>
                     <span style="font-size: 0.75rem; color: var(--text-muted); font-family: monospace;">#${shortId}</span>
                </div>
                
                <div style="font-size:0.85rem; color:var(--text-muted); font-weight:500; display:flex; align-items:center; gap:6px; background: var(--bg-main); padding: 4px 8px; border-radius: 6px;">
                    <i class="far fa-clock"></i> ${nextRev}
                </div>
            </div>
            
            <!-- CORPO: Pergunta -->
            <div style="
                font-size: 1.05rem; 
                font-weight: 500; 
                color: var(--text-main); 
                margin-bottom: 20px; 
                line-height: 1.6;
            ">
                ${c.question}
            </div>
            
            <!-- RODAPÉ: Botões de Ação Minimalistas -->
            <div style="
                display:flex; 
                gap: 12px; 
                justify-content: flex-end; 
                border-top: 1px solid var(--border); 
                padding-top: 15px;
            ">
                <button onclick="openCardHistory(${c.id})" title="Histórico" style="background:none; border:none; cursor:pointer; font-size:1.1rem; color:var(--text-muted); transition: color 0.2s;" onmouseover="this.style.color='var(--primary)'" onmouseout="this.style.color='var(--text-muted)'">
                    <i class="fas fa-history"></i>
                </button>

                <button onclick="viewCard(${c.id})" title="Visualizar" style="background:none; border:none; cursor:pointer; font-size:1.1rem; color:var(--text-muted); transition: color 0.2s;" onmouseover="this.style.color='var(--text-main)'" onmouseout="this.style.color='var(--text-muted)'">
                    <i class="fas fa-eye"></i>
                </button>
                
                <button onclick="editCard(${c.id})" title="Editar" style="background:none; border:none; cursor:pointer; font-size:1.1rem; color:var(--text-muted); transition: color 0.2s;" onmouseover="this.style.color='#3b82f6'" onmouseout="this.style.color='var(--text-muted)'">
                    <i class="fas fa-pen"></i>
                </button>
                
                <button onclick="deleteCard(${c.id})" title="Excluir" style="background:none; border:none; cursor:pointer; font-size:1.1rem; color:var(--text-muted); transition: color 0.2s; margin-left: 8px;" onmouseover="this.style.color='#ef4444'" onmouseout="this.style.color='var(--text-muted)'">
                    <i class="fas fa-trash-alt"></i>
                </button>
            </div>
        </div>
        `;
        listContainer.innerHTML += cardHTML;
    });
}




function openCardHistory(id) {
    const card = cards.find(c => c.id === id);
    if (!card) return;

    const list = document.getElementById('history-list');
    const summary = document.getElementById('history-summary');
    const modal = document.getElementById('history-modal');
    
    list.innerHTML = '';
    modal.classList.remove('hidden');

    if (!card.history || card.history.length === 0) {
        summary.innerHTML = `<span style="color:var(--text-muted)">Sem dados registrados.</span>`;
        list.innerHTML = `<tr><td colspan="3" style="text-align:center; padding: 30px; color: var(--text-muted);">Nenhum histórico disponível.</td></tr>`;
        return;
    }

    const total = card.history.length;
    const acertos = card.history.filter(h => h.quality > 1).length; 
    const taxa = Math.round((acertos / total) * 100);

    summary.innerHTML = `
        <span>Total: <strong>${total}</strong></span>
        <span>Acertos: <strong style="color: var(--success)">${acertos}</strong></span>
        <span>Aproveitamento: <strong>${taxa}%</strong></span>
    `;

    // Preenche a tabela
    [...card.history].reverse().forEach(h => {
        const dateObj = new Date(h.date);
        const dateStr = dateObj.toLocaleDateString('pt-BR');
        const timeStr = dateObj.toLocaleTimeString('pt-BR', { hour: '2-digit', minute:'2-digit' });
        
        // Formatação simples e formal
        let resultText = 'Desconhecido';
        let resultColor = 'var(--text-muted)';
        let resultWeight = 'normal';

        if (h.quality === 1) { 
            resultText = 'Erro'; 
            resultColor = '#ef4444'; // Vermelho suave
            resultWeight = '600';
        } else if (h.quality === 4) { 
            resultText = 'Acerto'; 
            resultColor = '#22c55e'; // Verde suave
            resultWeight = '600';
        } else {
             // Caso futuramente tenha outros níveis
            resultText = 'Revisado';
        }

        // Se tiver intervalo salvo, mostra (ex: "3 dias"), senão "-"
        const intervalText = h.interval ? `${h.interval} dias` : '-';

        list.innerHTML += `
            <tr style="border-bottom: 1px solid var(--border);">
                <td style="padding: 12px 24px; color: var(--text-main);">
                    ${dateStr} <span style="color: var(--text-muted); font-size: 0.85em; margin-left: 6px;">${timeStr}</span>
                </td>
                <td style="padding: 12px 24px; color: ${resultColor}; font-weight: ${resultWeight};">
                    ${resultText}
                </td>
                <td style="padding: 12px 24px; text-align: right; color: var(--text-muted);">
                    ${intervalText}
                </td>
            </tr>
        `;
    });
}


// Função para aplicar negrito/itálico no comentário
function formatCommentText(command) {
    document.execCommand(command, false, null);
    document.getElementById('input-comment').focus();
}




        function editCard(id) {
    const c = cards.find(x => x.id === id);
    if (!c) return;

    editingId = id;

    // Preenche campos de texto básicos
    document.getElementById('input-category').value = c.category || '';
    document.getElementById('input-subcategory').value = c.subcategory || ''; 
    document.getElementById('input-question').innerHTML = c.question;
    document.getElementById('input-opt-a').value = c.correctText;
    
    // --- ATUALIZAÇÃO: Comentário Rico (innerHTML) ---
    document.getElementById('input-comment').innerHTML = c.comment || '';

    // Carrega a Fonte
    const sourceInput = document.getElementById('input-source');
    if (sourceInput) sourceInput.value = c.source || '';

    // Limpa campos de alternativas incorretas antes de preencher
    document.getElementById('input-opt-b').value = '';
    document.getElementById('input-opt-c').value = '';
    document.getElementById('input-opt-d').value = '';
    const optE = document.getElementById('input-opt-e');
    if (optE) optE.value = '';

    // Filtra e preenche as incorretas
    const wrongs = c.options.filter(o => o !== c.correctText);
    
    if (wrongs[0]) document.getElementById('input-opt-b').value = wrongs[0];
    if (wrongs[1]) document.getElementById('input-opt-c').value = wrongs[1];
    if (wrongs[2]) document.getElementById('input-opt-d').value = wrongs[2];
    if (wrongs[3] && optE) optE.value = wrongs[3]; // Suporte para 5ª opção

    // Ajusta visual dos botões
    document.getElementById('save-btn').innerHTML = '<i class="fas fa-pen"></i> Atualizar';
    document.getElementById('cancel-edit-btn').classList.remove('hidden');
    
    // Troca para a aba de criação
    switchTab('study');
    switchStudyTab('creator');
}


// Wrappers simples
function editCurrentCard() { if(currentCard) editCard(currentCard.id); }
function deleteCurrentCard() { if(currentCard) deleteCard(currentCard.id); }

function deleteCard(id) { 
    // Uso do modal visual showConfirm em vez de confirm()
    showConfirm('Excluir Card', 'Tem certeza que deseja excluir este card permanentemente?', () => {
        cards = cards.filter(c => c.id !== id); 
        salvarDados('ted_flashcards', cards); 
        renderManageList(); 
        switchTab('study'); 
        switchStudyTab('library'); 
    });
}

function loadStudySession() { 
    studyMode = 'standard';
    
    // Garante que a UI está limpa
    document.getElementById('simulation-result').classList.add('hidden');
    document.getElementById('study-content').classList.remove('hidden');
    
    // Filtra cards vencidos (nextReview <= agora)
    // Dica: Adicionei uma ordenação simples para priorizar os mais atrasados
    sessionQueue = cards
        .filter(c => c.nextReview <= Date.now())
        .sort((a, b) => a.nextReview - b.nextReview); 

    currentSessionTotal = sessionQueue.length;
    currentSessionDone = 0;
    
    // RESET NAV STATE
    currentCardIndex = 0;
    sessionAnswers = {};
    
    const dueCountElement = document.getElementById('due-count');
    if (dueCountElement) dueCountElement.innerText = sessionQueue.length; 
    
    if (sessionQueue.length > 0) {
        showCard(sessionQueue[0]); 
    } else { 
        document.getElementById('study-content').classList.add('hidden'); 
        document.getElementById('no-cards-msg').classList.remove('hidden'); 
    } 
}

        
        function showCard(c) { 
            currentCard = c; 
            currentSelectedOption = null;
            currentSelectedBtn = null;
            
            // Update Progress Display (1-based index)
            document.getElementById('study-progress-display').innerText = `${currentCardIndex + 1} / ${currentSessionTotal}`;
            
            document.getElementById('study-content').classList.remove('hidden'); 
            document.getElementById('no-cards-msg').classList.add('hidden'); 
            document.getElementById('simulation-result').classList.add('hidden');
            document.getElementById('question-display').innerHTML=c.question; 
            document.getElementById('category-display').innerText = c.category || 'GERAL';
            document.getElementById('subcategory-display').innerText = c.subcategory || '';
            document.getElementById('card-id-display').innerText = '#' + c.id.toString().slice(-4);
            document.getElementById('options-display').innerHTML=''; 
            
            // Comment Section Reset
            document.getElementById('comment-display').classList.add('hidden');
            document.getElementById('comment-edit-wrapper').classList.add('hidden');
            document.getElementById('comment-content-wrapper').classList.remove('hidden');
            // LÓGICA PARA EXIBIR A FONTE NO ESTUDO
const sourceWrapper = document.getElementById('source-display-wrapper');
const sourceLink = document.getElementById('source-link');
if (c.source && c.source.trim() !== '') {
    sourceWrapper.classList.remove('hidden');
    sourceWrapper.style.display = 'flex'; // Força o display flex para alinhar icone
    sourceLink.href = c.source;
} else {
    sourceWrapper.classList.add('hidden');
    sourceWrapper.style.display = 'none';
}

            
            // Handle Buttons State based on index
            document.getElementById('nav-prev-btn').disabled = (currentCardIndex === 0);
            
            // If already answered, render state
            const previousAnswer = sessionAnswers[c.id];
            
            if (previousAnswer) {
                 renderAnsweredState(previousAnswer);
            } else {
                 renderUnansweredState();
            }

            const prefixes = ['a.', 'b.', 'c.', 'd.', 'e.'];
            
            c.options.sort(()=>Math.random()-0.5).forEach((o, index)=>{ 
                const b=document.createElement('button'); 
                b.className='option-btn'; 
                b.dataset.val = o;
                b.innerHTML = `<strong>${prefixes[index]||'-'}</strong> ${o}`; 
                
                if (previousAnswer) {
                    b.disabled = true;
                    if (o === c.correctText) b.classList.add('correct');
                    if (previousAnswer.selected === o && o !== c.correctText) b.classList.add('wrong');
                } else {
                    b.onclick=()=>selectAnswer(b, o); 
                }
                
                document.getElementById('options-display').appendChild(b); 
            }); 
        }
        
        function renderUnansweredState() {
    document.getElementById('confirm-action-btn').classList.remove('hidden');
    document.getElementById('view-comment-btn').classList.add('hidden');
    // Allow skipping
    document.getElementById('nav-next-btn').disabled = false;
}

function renderAnsweredState(answerData) {
    document.getElementById('confirm-action-btn').classList.add('hidden');
    document.getElementById('view-comment-btn').classList.remove('hidden');
    document.getElementById('nav-next-btn').disabled = false;
    
    // Load comment content - CORREÇÃO: innerHTML
    if(currentCard.comment && currentCard.comment.trim() !== "") {
        document.getElementById('comment-text').innerHTML = currentCard.comment; 
    } else {
        document.getElementById('comment-text').innerText = "Nenhuma explicação registrada.";
        document.getElementById('comment-text').style.fontStyle = "italic";
        document.getElementById('comment-text').style.color = "var(--text-muted)";
    }
}

// --- NEW COMMENT EDITING FUNCTIONS ---
function toggleCommentSection() {
    const el = document.getElementById('comment-display');
    if (el.classList.contains('hidden')) {
        el.classList.remove('hidden');
        // Ensure correct state when opening - CORREÇÃO: innerHTML
        if(currentCard.comment && currentCard.comment.trim() !== "") {
            document.getElementById('comment-text').innerHTML = currentCard.comment;
            document.getElementById('comment-text').style.fontStyle = "normal";
            document.getElementById('comment-text').style.color = "var(--text-main)";
        } else {
            document.getElementById('comment-text').innerText = "Nenhuma explicação registrada.";
            document.getElementById('comment-text').style.fontStyle = "italic";
            document.getElementById('comment-text').style.color = "var(--text-muted)";
        }
    } else {
        el.classList.add('hidden');
    }
}


function formatCommentEditText(command) {
    document.execCommand(command, false, null);
    document.getElementById('comment-edit-area').focus();
}

function enableCommentEdit() {
    document.getElementById('comment-content-wrapper').classList.add('hidden');
    document.getElementById('comment-edit-wrapper').classList.remove('hidden');
    
    // CORREÇÃO: Usa innerHTML (div editável)
    document.getElementById('comment-edit-area').innerHTML = currentCard.comment || ""; 
    document.getElementById('comment-edit-area').focus();
}

function saveCommentEdit() {
    // CORREÇÃO: Pega o HTML formatado com innerHTML
    const newComment = document.getElementById('comment-edit-area').innerHTML;
    
    // Update current object
    currentCard.comment = newComment;
    
    // Update main array
    const index = cards.findIndex(c => c.id === currentCard.id);
    if(index !== -1) {
        cards[index].comment = newComment;
        salvarDados('ted_flashcards', cards);
    }
    
    // Reset UI
    document.getElementById('comment-edit-wrapper').classList.add('hidden');
    document.getElementById('comment-content-wrapper').classList.remove('hidden');
    
    // Exibir formatado após salvar
    if(newComment && newComment.trim() !== "") {
        document.getElementById('comment-text').innerHTML = newComment;
        document.getElementById('comment-text').style.fontStyle = "normal";
        document.getElementById('comment-text').style.color = "var(--text-main)";
    } else {
        document.getElementById('comment-text').innerText = "Nenhuma explicação registrada.";
        document.getElementById('comment-text').style.fontStyle = "italic";
        document.getElementById('comment-text').style.color = "var(--text-muted)";
    }
}



        function selectAnswer(btn, text) {
            // If already answered, do nothing
            if (sessionAnswers[currentCard.id]) return;
            
            document.querySelectorAll('.option-btn').forEach(b => b.classList.remove('selected'));
            btn.classList.add('selected');
            currentSelectedOption = text;
            currentSelectedBtn = btn;
        }

        function confirmAnswer() {
    if(!currentSelectedOption) return alert("Por favor, selecione uma alternativa.");
    const isCor = currentSelectedOption === currentCard.correctText;
    
    // --- CÓDIGO NOVO: SALVAR HISTÓRICO NO CARD ---
    if (!currentCard.history) currentCard.history = []; 
    const qualityScore = isCor ? 4 : 1;
    currentCard.history.push({
        date: Date.now(),
        quality: qualityScore,
        interval: currentCard.interval || 0
    });
    // ---------------------------------------------
    
    // Save state
    sessionAnswers[currentCard.id] = { selected: currentSelectedOption, correct: isCor };
    
    // Update UI
    currentSelectedBtn.classList.remove('selected');
    currentSelectedBtn.classList.add(isCor ? 'correct' : 'wrong');
    
    if(!isCor) { 
        document.querySelectorAll('.option-btn').forEach(b => { 
            if(b.dataset.val === currentCard.correctText) { b.classList.add('correct'); } 
        }); 
    }
    
    document.querySelectorAll('.option-btn').forEach(b => b.disabled = true);
    
    // Change buttons
    renderAnsweredState();
    
    if(studyMode === 'simulation') {
        if(isCor) simulationResults.correct++;
        else simulationResults.wrong++;
        
        currentSimulationLog.push({
            question: currentCard.question,
            userAnswer: currentSelectedOption,
            correctAnswer: currentCard.correctText,
            isCorrect: isCor,
            category: currentCard.category || 'Geral'
        });
        
    } else {
        updateStreakOnStudy();
        // REMOVIDO: Linha que atualizava 'dash-streak' foi apagada para evitar erro
        
        if(studyMode === 'standard') { 
    const idx = cards.findIndex(x=>x.id===currentCard.id); 
    
    if(isCor) {
        // Apply intensity logic
        let multiplier = 1.8; 
        const level = userData.revisionLevel || 'moderate';
        if (level === 'light') multiplier = 2.2; 
        if (level === 'intense') multiplier = 1.4; 

        const MAX_INTERVAL = 45; 
        let calculatedInterval = cards[idx].interval === 0 ? 1 : Math.ceil(cards[idx].interval * multiplier);
        cards[idx].interval = Math.min(calculatedInterval, MAX_INTERVAL);
        cards[idx].nextReview = Date.now() + (cards[idx].interval * 86400000);
    } else {
        cards[idx].interval = 0;
        cards[idx].nextReview = Date.now();
    }
    
    // CORREÇÃO: Usando .then() para evitar erro se a função pai não for async
    salvarDados('ted_flashcards', cards).then(() => {
        // Salvamento concluído
    }).catch(err => console.error("Erro ao salvar:", err));
}

    }
    
    if(studyMode !== 'simulation') {
            // Adicionamos 'subcategory' aqui
performanceData.push({
    date: new Date().toISOString().split('T')[0], 
    correct: isCor, 
    category: currentCard.category || 'Geral',
    subcategory: currentCard.subcategory || 'Sem Subtópico' 
});

            salvarDados('ted_performance', performanceData);
    }
}


        // --- NEW NAV FUNCTIONS ---
        function prevCard() {
            if (currentCardIndex > 0) {
                currentCardIndex--;
                let queue;
                if(studyMode === 'simulation') queue = simulationQueue;
                else if(studyMode === 'random') queue = randomReviewQueue;
                else queue = sessionQueue;
                showCard(queue[currentCardIndex]);
            }
        }

        function nextCard() {
            let queue;
            if(studyMode === 'simulation') queue = simulationQueue;
            else if(studyMode === 'random') queue = randomReviewQueue;
            else queue = sessionQueue;
            
            if (currentCardIndex < queue.length - 1) {
                currentCardIndex++;
                showCard(queue[currentCardIndex]);
            } else {
                // End of queue
                if(studyMode === 'simulation') finishSimulation(); 
                else {
                    alert("Você chegou ao fim da fila!");
                    document.getElementById('finish-review-btn').classList.remove('hidden');
                }
            }
        }

       function startRandomReview() {
    // Verificação usando o POP-UP INTERNO
    if (!cards || cards.length === 0) {
        showAlert("Sem Cards", "Você precisa criar cards antes de iniciar uma revisão aleatória. Vá em 'Criar' para adicionar sua primeira pergunta.");
        return;
    }

    studyMode = 'random';
    
    randomReviewQueue = [...cards].sort(() => 0.5 - Math.random()).slice(0, 10);
        
    currentSessionTotal = randomReviewQueue.length;
    currentSessionDone = 0;
    currentCardIndex = 0;
    sessionAnswers = {};
    
    // Prepara a tela
    document.getElementById('study-content').classList.remove('hidden');
    document.getElementById('no-cards-msg').classList.add('hidden');
    document.getElementById('simulation-result').classList.add('hidden');
    
    if (randomReviewQueue.length > 0) {
        showCard(randomReviewQueue[0]);
    } else {
        showAlert("Erro", "Não foi possível carregar os cards.");
    }
}



function showAlert(title, msg) {
    document.getElementById('custom-alert-title').innerText = title;
    document.getElementById('custom-alert-msg').innerText = msg;
    document.getElementById('custom-alert-modal').classList.remove('hidden');
}


        
        function finishRandomReview() { loadStudySession(); }

       function openSimulationModal() {
    // Verificação usando o POP-UP INTERNO
    if (!cards || cards.length === 0) {
        showAlert("Sem Cards", "Você precisa criar cards antes de iniciar um simulado. Vá em 'Criar' para adicionar sua primeira pergunta.");
        return;
    }

    const list = document.getElementById('sim-category-list');
    list.innerHTML = '';
    
    // Pega todas as categorias únicas
    const categories = [...new Set(cards.map(c => c.category || 'Geral'))].sort();
    
    categories.forEach(cat => {
        const count = cards.filter(c => (c.category || 'Geral') === cat).length;
        
        const item = document.createElement('div');
        item.className = 'sim-config-item';
        item.innerHTML = `
            <label>${cat} <small>(Disp: ${count})</small></label>
            <input type="number" class="sim-cat-input" data-cat="${cat}" data-max="${count}" min="0" max="${count}" value="0" onchange="updateSimTotal()">
        `;
        list.appendChild(item);
    });
    
    updateSimTotal();
    document.getElementById('simulation-config-modal').classList.remove('hidden');
}



        function updateSimTotal() {
            let total = 0;
            document.querySelectorAll('.sim-cat-input').forEach(input => {
                let val = parseInt(input.value);
                const max = parseInt(input.getAttribute('data-max'));
                if(val < 0) { val = 0; input.value = 0; }
                if(val > max) { val = max; input.value = max; }
                total += val;
            });
            document.getElementById('sim-total-preview').innerText = total;
        }

        function startSimulationFromConfig() {
            simulationQueue = [];
            document.querySelectorAll('.sim-cat-input').forEach(input => {
                const qty = parseInt(input.value);
                if(qty > 0) {
                    const cat = input.getAttribute('data-cat');
                    const available = cards.filter(c => (c.category||'Geral') === cat);
                    const selected = available.sort(() => 0.5 - Math.random()).slice(0, qty);
                    simulationQueue = simulationQueue.concat(selected);
                }
            });
            if(simulationQueue.length === 0) return alert("Selecione pelo menos 1 questão.");
            simulationQueue.sort(() => 0.5 - Math.random());
            simulationResults = { correct: 0, wrong: 0, total: simulationQueue.length };
            currentSimulationLog = [];
            currentSessionTotal = simulationQueue.length;
            
            // RESET NAV
            currentCardIndex = 0;
            sessionAnswers = {};
            
            studyMode = 'simulation';
            document.getElementById('simulation-config-modal').classList.add('hidden');
            document.getElementById('no-cards-msg').classList.add('hidden');
            document.getElementById('study-content').classList.remove('hidden');
            showCard(simulationQueue[0]);
            document.getElementById('finish-review-btn').classList.remove('hidden');
        }

        function finishSimulation() {
            const p = Math.round((simulationResults.correct / simulationResults.total) * 100);
            document.getElementById('study-content').classList.add('hidden');
            document.getElementById('simulation-result').classList.remove('hidden');
            
            // New UI Population
            document.getElementById('sim-score-pct').innerText = `${p}%`;
            document.getElementById('sim-correct-count').innerText = simulationResults.correct;
            document.getElementById('sim-wrong-count').innerText = simulationResults.wrong;
            document.getElementById('sim-total-count').innerText = simulationResults.total;
            
            // Build Detailed Log (Card Style)
            const logContainer = document.getElementById('sim-detailed-log');
            logContainer.innerHTML = '';
            
            currentSimulationLog.forEach((item, idx) => {
                 const div = document.createElement('div');
                 div.className = `sim-log-item ${item.isCorrect ? 'correct' : 'wrong'}`;
                 div.innerHTML = `
                    <div style="font-weight:600; margin-bottom:6px; font-size:0.95rem;">${idx+1}. ${item.question}</div>
                    <div style="display:flex; justify-content:space-between; font-size:0.9rem;">
                        <span style="color:${item.isCorrect ? 'var(--success)' : 'var(--danger)'}; font-weight:600;">
                            ${item.isCorrect ? '<i class="fas fa-check"></i> Correto' : '<i class="fas fa-times"></i> Errou (Sua: ' + item.userAnswer + ')'}
                        </span>
                        <span style="color:var(--text-muted); font-size:0.8rem; text-transform:uppercase;">${item.category}</span>
                    </div>
                 `;
                 logContainer.appendChild(div);
            });
        }
        
        // Save the simulation result
        function saveSimulationResult() {
            const simRecord = {
                id: Date.now(),
                date: new Date().toISOString(),
                score: simulationResults.correct,
                total: simulationResults.total,
                log: currentSimulationLog
            };
            simulationHistory.unshift(simRecord);
            salvarDados('ted_simulation_history', simulationHistory);
            
            alert('Simulado salvo no histórico!');
            // Reload performance view in background
            renderPerformanceView();
            // Go back to menu
            finishRandomReview();
        }

        function updateCategoryDropdowns() { 
    const listSuggestions = document.getElementById('category-list-suggestions'); 
    const filterSelect = document.getElementById('filter-category'); 
    
    // Pega todas as categorias únicas e ordena alfabeticamente
    const uniqueCategories = [...new Set(cards.map(x => x.category || 'Geral'))].sort(); 
    
    // Atualiza a lista de sugestões da tela de criação (datalist)
    if (listSuggestions) {
        listSuggestions.innerHTML = uniqueCategories.map(x => `<option value="${x}">`).join('');
    }
    
    // Atualiza também o filtro da biblioteca (dropdown)
    if (filterSelect) {
        // Mantém o valor que estava selecionado antes de atualizar
        const currentVal = filterSelect.value;
        filterSelect.innerHTML = '<option value="all">Todas as Categorias</option>' + 
                                 uniqueCategories.map(x => `<option value="${x}">${x}</option>`).join('');
        filterSelect.value = currentVal; // Restaura a seleção
    }
}

        function exportAllData() { const d = { cards, performanceData, folders, notes, scheduleData, tasks, userData, editais, pomoSettings, pomoHistory, simulationHistory, taskTemplates, scheduleTemplates }; const a = document.createElement('a'); a.href = URL.createObjectURL(new Blob([JSON.stringify(d)],{type:'application/json'})); a.download = `Teddy_Backup_${new Date().toISOString().split('T')[0]}.json`; a.click(); }
        function importAllData(i) {
    if (i.files.length === 0) return;
    const r = new FileReader();
    r.onload = async (e) => {
        try {
            const d = JSON.parse(e.target.result);
            
            if(!confirm("Isso apagará seus dados atuais. Continuar?")) return;

            // Salvando tudo no banco ilimitado
            await salvarDados('ted_flashcards', d.cards || []);
            await salvarDados('ted_performance', d.performanceData || []);
            await salvarDados('ted_folders', d.folders || []);
            await salvarDados('ted_notes', d.notes || []);
            await salvarDados('ted_schedule', d.scheduleData || {});
            await salvarDados('ted_tasks', d.tasks || []);
            await salvarDados('ted_editais', d.editais || []);
            
            if(d.userData) await salvarDados('ted_userdata', d.userData);
            if(d.pomoSettings) await salvarDados('ted_pomo_settings', d.pomoSettings);
            if(d.pomoHistory) await salvarDados('ted_pomo_history', d.pomoHistory);
            if(d.simulationHistory) await salvarDados('ted_simulation_history', d.simulationHistory);
            if(d.taskTemplates) await salvarDados('ted_task_templates', d.taskTemplates);
            if(d.scheduleTemplates) await salvarDados('ted_schedule_templates', d.scheduleTemplates);

            alert('Backup restaurado com sucesso!');
            location.reload();
        } catch (err) {
            console.error(err);
            alert('Erro ao ler backup.');
        }
    };
    r.readAsText(i.files[0]);
}

        async function clearAllData() { 
    if(confirm("Certeza? Isso apagará TUDO permanentemente.")) { 
        // Limpa o banco de dados GRANDE
        await localforage.clear();
        
        // Limpa o pequeno também, só por garantia
        localStorage.clear(); 
        
        location.reload(); 
    } 
}

        function goBackTo(t) { switchTab(t); }
        function formatQuestionText(c) { document.getElementById('input-question').focus(); document.execCommand(c, false, null); }

        function changePeriod(period) { 
            currentPeriod = period; 
            currentPeriodIndex = 0; 
            document.querySelectorAll('.banner-period-btn').forEach(b => b.classList.remove('active')); 
            document.getElementById('btn-' + period).classList.add('active'); 
            renderPerformanceView(); 
        }
        function prevPeriod() { currentPeriodIndex++; renderPerformanceView(); }
        function nextPeriod() { if (currentPeriodIndex > 0) currentPeriodIndex--; renderPerformanceView(); }
                        // --- NOVA FUNÇÃO: Ocultar pelo ID ---
        function hidePomoSessionById(id) {
            if(!confirm("Deseja ocultar esta sessão da lista? Ela continuará contando no Tempo Total de Estudo.")) return;

            // Usa a variável global direto
const itemIndex = pomoHistory.findIndex(i => i.id === id);

if (itemIndex !== -1) {
    pomoHistory[itemIndex].hidden = true; // Marca como oculto
    
    // Salva usando a nova função
    salvarDados('ted_pomo_history', pomoHistory);
    
    // Atualiza a tela
    renderPomoHistory();
    showAlert("Sucesso", "Item removido da lista.");
}

        }


        function renderStudyTimeBarChart(startDate, endDate) {
  const container = document.getElementById('studytime-chart');
  const subtitle = document.getElementById('studytime-chart-subtitle');
  if (!container) return;

  const ph = Array.isArray(pomoHistory) ? pomoHistory : [];
  const points = [];

  const normalizeLabel = (txt) => (txt || '').replace('.', '').toUpperCase();

  // Define agrupamento conforme o modo
  if (currentPeriod === 'week') {
    if (subtitle) subtitle.innerText = 'Semana (dias)';

    for (let i = 0; i < 7; i++) {
      const d = new Date(startDate);
      d.setDate(startDate.getDate() + i);
      const label = normalizeLabel(d.toLocaleDateString('pt-BR', { weekday: 'short' }));
      points.push({ label, minutes: 0, keyDate: d });
    }

    // Soma minutos por dia dentro do intervalo startDate/endDate
    ph.forEach(s => {
      const dStr = s.date || s.timestamp || s.endTime || s.startTime;
      if (!dStr) return;

      const sDate = new Date(dStr);
      if (isNaN(sDate.getTime())) return;

      // Comparação por intervalo do período atual
      if (sDate < startDate || sDate > endDate) return;

      const dayIndex = Math.floor((new Date(sDate.getFullYear(), sDate.getMonth(), sDate.getDate()) - startDate) / 86400000);
      if (dayIndex < 0 || dayIndex > 6) return;

      points[dayIndex].minutes += parseInt(s.duration || 0);
    });

  } else if (currentPeriod === 'month') {
    // Conforme pedido: no modo "Mês" exibe meses do ano (Jan..Dez)
    const y = startDate.getFullYear();
    if (subtitle) subtitle.innerText = `Ano ${y} (meses)`;

    for (let m = 0; m < 12; m++) {
      const d = new Date(y, m, 1);
      const label = normalizeLabel(d.toLocaleDateString('pt-BR', { month: 'short' }));
      points.push({ label, minutes: 0, monthIndex: m, year: y });
    }

    ph.forEach(s => {
      const dStr = s.date || s.timestamp || s.endTime || s.startTime;
      if (!dStr) return;

      const sDate = new Date(dStr);
      if (isNaN(sDate.getTime())) return;

      if (sDate.getFullYear() !== y) return;
      points[sDate.getMonth()].minutes += parseInt(s.duration || 0);
    });

  } else { 
    // currentPeriod === 'year'
    // Exibe anos (janela dinâmica: últimos até 5 anos, terminando no ano selecionado)
    const selectedYear = startDate.getFullYear();
    const yearsInData = ph
      .map(s => {
        const dStr = s.date || s.timestamp || s.endTime || s.startTime;
        const d = dStr ? new Date(dStr) : null;
        return d && !isNaN(d.getTime()) ? d.getFullYear() : null;
      })
      .filter(y => y !== null);

    const minYear = yearsInData.length ? Math.min(...yearsInData) : selectedYear;
    const startYear = Math.max(minYear, selectedYear - 4);

    if (subtitle) subtitle.innerText = `Anos (${startYear}–${selectedYear})`;

    for (let y = startYear; y <= selectedYear; y++) {
      points.push({ label: String(y), minutes: 0, year: y });
    }

    ph.forEach(s => {
      const dStr = s.date || s.timestamp || s.endTime || s.startTime;
      if (!dStr) return;

      const sDate = new Date(dStr);
      if (isNaN(sDate.getTime())) return;

      const y = sDate.getFullYear();
      if (y < startYear || y > selectedYear) return;

      const idx = y - startYear;
      points[idx].minutes += parseInt(s.duration || 0);
    });
  }

  // Se não tiver nada, mostra vazio elegante
  const totalMinutesAll = points.reduce((acc, p) => acc + (p.minutes || 0), 0);
  if (totalMinutesAll <= 0) {
    container.innerHTML = `<div style="text-align:center; padding:30px; color:var(--text-muted)">Sem tempo registrado neste período.</div>`;
    return;
  }

  const maxMinutes = Math.max(...points.map(p => p.minutes), 1);

  // Render usando as mesmas classes do mini-chart (barras verticais)
  container.innerHTML = points.map(p => {
    const pct = (p.minutes / maxMinutes) * 100;
    const hours = p.minutes / 60;
    const hoursText = hours.toFixed(1) + 'h';

    return `
      <div class="chart-col" title="${hoursText}">
        <div class="chart-bar-container">
          <div class="chart-bar" style="height:${pct}%; background: var(--primary);"></div>
        </div>
        <div class="chart-label">${p.label}</div>
        <div class="chart-label" style="font-size:0.72rem; opacity:0.9">${hoursText}</div>
      </div>
    `;
  }).join('');
}


        /* --- FUNÇÃO PRINCIPAL DE DESEMPENHO (VERSÃO CORRIGIDA E SEGURA) --- */
function renderPerformanceView() {
    const display = document.getElementById('period-display');
    const totalCountEl = document.getElementById('total-reviews-count');
    const accuracyEl = document.getElementById('accuracy-rate');
    const categoryList = document.getElementById('category-stats-list');
    const chart = document.getElementById('performance-chart');
    const categoryProgressGrid = document.getElementById('category-progress-grid');
    const streakEl = document.getElementById('performance-streak');
    const reviewsTodayEl = document.getElementById('reviews-today');

    // 1. LIMPEZA DE TELA
    if(categoryList) categoryList.innerHTML = '';
    if(categoryProgressGrid) categoryProgressGrid.innerHTML = '';
    if(chart) chart.innerHTML = '';
    const studyChart = document.getElementById('studytime-chart');
    if (studyChart) studyChart.innerHTML = '';

    const now = new Date();
    
    // 2. DEFINIÇÃO DE DATAS (MÉTODO UTC SEGURO)
    let startDate, endDate;

    if(currentPeriod === 'week') {
        startDate = new Date();
        startDate.setDate(now.getDate() - (currentPeriodIndex * 7) - 6);
        startDate.setHours(0,0,0,0);
        
        endDate = new Date(startDate);
        endDate.setDate(startDate.getDate() + 6);
        endDate.setHours(23,59,59,999);
        
        display.innerText = `${startDate.toLocaleDateString('pt-BR')} - ${endDate.toLocaleDateString('pt-BR')}`;
    } else if(currentPeriod === 'month') {
        startDate = new Date(now.getFullYear(), now.getMonth() - currentPeriodIndex, 1);
        startDate.setHours(0,0,0,0);
        endDate = new Date(now.getFullYear(), now.getMonth() - currentPeriodIndex + 1, 0);
        endDate.setHours(23,59,59,999);
        display.innerText = startDate.toLocaleDateString('pt-BR', { month: 'long', year: 'numeric' });
    } else {
        startDate = new Date(now.getFullYear() - currentPeriodIndex, 0, 1);
        startDate.setHours(0,0,0,0);
        endDate = new Date(now.getFullYear() - currentPeriodIndex, 11, 31);
        endDate.setHours(23,59,59,999);
        display.innerText = startDate.getFullYear();
    }

    // 3. FILTRAGEM SEGURA (EVITA BUGS DE FUSO)
    // Converte tudo para timestamp numérico
    const startTs = startDate.getTime();
    const endTs = endDate.getTime();

    const periodData = performanceData.filter(p => {
        // Truque: Adiciona meio-dia para evitar que dia 01 vire dia 31 do mês anterior por fuso
        const pDate = new Date(p.date + 'T12:00:00'); 
        const pTs = pDate.getTime();
        return pTs >= startTs && pTs <= endTs;
    });

    // Renderiza Gráficos Novos
    if(typeof renderStudyTimeBarChart === 'function') renderStudyTimeBarChart(startDate, endDate);
    if(typeof renderAccuracyChart === 'function') renderAccuracyChart(startDate, endDate);
    if(typeof renderCreatedCardsChart === 'function') renderCreatedCardsChart(startDate, endDate);



    // 4. ATUALIZA MÉTRICAS DO BANNER
    const totalReviews = periodData.length;
    const totalCorrect = periodData.filter(p => p.correct).length;
    const accuracy = totalReviews ? Math.round((totalCorrect/totalReviews)*100) : 0;

    // A) Total e Taxa
    if(totalCountEl) totalCountEl.innerText = totalReviews;
    if(accuracyEl) accuracyEl.innerText = accuracy + '%';

    // B) Dias Estudados (Substitui Ofensiva Fixa)
    const uniqueDays = [...new Set(periodData.map(p => p.date))].length;
    if(streakEl) streakEl.innerText = uniqueDays;

    // C) Tempo de Estudo (Cálculo do Pomodoro Integrado)
    try {
        const ph = pomoHistory || [];
        // Filtra sessões dentro do período
        const periodPomo = ph.filter(s => {
            const sDate = new Date(s.date || s.timestamp || s.endTime);
            return sDate.getTime() >= startTs && sDate.getTime() <= endTs;
        });
        
        const pTotal = periodPomo.reduce((acc, curr) => acc + (parseInt(curr.duration) || 0), 0);
        
        let pText = "0m";
        if (pTotal > 0) {
            const h = Math.floor(pTotal / 60);
            const m = pTotal % 60;
            pText = h > 0 ? `${h}h ${m}m` : `${m}m`;
        }
        
        if(reviewsTodayEl) {
            reviewsTodayEl.innerText = pText;
            reviewsTodayEl.style.color = "var(--primary)";
        }
    } catch(e) { console.error("Erro Pomo Stats:", e); }


    // 5. GRÁFICO DIÁRIO (APENAS MODO SEMANA)
    if(currentPeriod === 'week' && chart) {
        for(let i=0; i<7; i++) {
            const d = new Date(startDate);
            d.setDate(startDate.getDate()+i);
            const ds = d.toISOString().split('T')[0];
            const recs = periodData.filter(p => p.date === ds);
            const total = recs.length;
            const corr = recs.filter(r => r.correct).length;
            const pct = total ? (corr/total)*100 : 0;
            const dayName = d.toLocaleDateString('pt-BR', {weekday: 'long'});

            chart.innerHTML += `
                <div style="display:flex; align-items:center; gap:16px;">
                    <div style="width:100px; font-size:0.9rem; font-weight:600; color:var(--text-muted); text-transform:capitalize;">${dayName}</div>
                    <div style="flex:1;">
                        <div style="display:flex; justify-content:space-between; margin-bottom:4px;">
                            <span style="font-size:0.85rem; color:var(--text-main);">${corr}/${total} acertos</span>
                            <span style="font-size:0.85rem; font-weight:bold; color:${pct >= 70 ? 'var(--success)' : pct >= 50 ? 'var(--warning)' : 'var(--danger)'}">${pct.toFixed(0)}%</span>
                        </div>
                        <div style="background:var(--bg-body); height:12px; border-radius:6px; overflow:hidden;">
                            <div style="width:${pct}%; background:${pct >= 70 ? 'var(--success)' : pct >= 50 ? 'var(--warning)' : 'var(--danger)'}; height:100%;"></div>
                        </div>
                    </div>
                </div>`;
        }
    } else if (chart) {
        chart.innerHTML = `<div style="text-align:center; padding: 40px; color:var(--text-muted); font-style:italic;">Visualize os gráficos detalhados acima (Acertos vs Erros).</div>`;
    }

    // 6. ESTATÍSTICAS POR MATÉRIA E CATEGORIA
    const cats = [...new Set(cards.map(c => c.category || 'Geral'))];
    
    if (periodData.length === 0) {
        if(categoryList) categoryList.innerHTML = "<div style='text-align:center;color:var(--text-muted);padding:20px;'>Nenhum dado registrado neste período.</div>";
        if(categoryProgressGrid) categoryProgressGrid.innerHTML = "<div style='text-align:center;color:var(--text-muted);padding:20px;'>Nenhum dado registrado neste período.</div>";
        return;
    }

    let hasDataForCats = false;
    cats.forEach(c => {
        const data = periodData.filter(p => p.category === c);
        const total = data.length;
        
        if (total > 0) {
            hasDataForCats = true;
            const correct = data.filter(p => p.correct).length;
            const pct = Math.round((correct/total)*100);
            
            // Render Lista
            if(categoryList) {
                categoryList.innerHTML += `
                    <div class="category-stat-item">
                        <div class="cat-name">${c}</div>
                        <div style="flex:1;margin:0 10px;">
                            <div class="cat-bar-bg">
                                <div class="cat-bar-fill" style="width:${pct}%; background:${pct>=70?'var(--success)':pct>=50?'var(--warning)':'var(--danger)'}"></div>
                            </div>
                        </div>
                        <div class="cat-percent" style="color:${pct>=70?'var(--success)':pct>=50?'var(--warning)':'var(--danger)'}">${pct}%</div>
                    </div>`;
            }

            // Render Grid
            if(categoryProgressGrid) {
                categoryProgressGrid.innerHTML += `
                    <div class="category-progress-item">
                        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px;">
                            <span style="font-weight:600;font-size:1rem;">${c}</span>
                            <span style="font-size:1rem;font-weight:bold;color:${pct>=70?'var(--success)':pct>=50?'var(--warning)':'var(--danger)'}">${pct}%</span>
                        </div>
                        <div style="background:rgba(0,0,0,0.05);height:10px;border-radius:5px;overflow:hidden; margin-bottom:8px;">
                            <div style="width:${pct}%;height:100%;background:${pct>=70?'var(--success)':pct>=50?'var(--warning)':'var(--danger)'}"></div>
                        </div>
                        <div style="font-size:0.85rem;color:var(--text-muted);">${correct} acertos de ${total} tentativas</div>
                    </div>`;
            }
        }
    });

    if (!hasDataForCats) {
        if(categoryList) categoryList.innerHTML = "<div style='text-align:center;color:var(--text-muted);padding:20px;'>Sem atividades nestas matérias para o período.</div>";
        if(categoryProgressGrid) categoryProgressGrid.innerHTML = "<div style='text-align:center;color:var(--text-muted);padding:20px;'>Sem atividades nestas matérias para o período.</div>";
    }
}

        
        function openSimDetail(id) {
            const sim = simulationHistory.find(s => s.id === id);
            if(!sim) return;
            
            const dateStr = new Date(sim.date).toLocaleDateString('pt-BR') + ' ' + new Date(sim.date).toLocaleTimeString('pt-BR');
            document.getElementById('sim-detail-title').innerText = `Simulado: ${dateStr}`;
            
            const content = document.getElementById('sim-detail-content');
            content.innerHTML = `
                <div style="background:var(--bg-body); padding:16px; border-radius:12px; display:flex; justify-content:space-around; margin-bottom:16px;">
                     <div style="text-align:center;">
                        <div style="font-size:0.8rem; text-transform:uppercase; color:var(--text-muted);">Pontos</div>
                        <div style="font-size:1.5rem; font-weight:800; color:var(--primary);">${sim.score}/${sim.total}</div>
                     </div>
                     <div style="text-align:center;">
                        <div style="font-size:0.8rem; text-transform:uppercase; color:var(--text-muted);">Precisão</div>
                        <div style="font-size:1.5rem; font-weight:800; color:var(--text-main);">${Math.round((sim.score/sim.total)*100)}%</div>
                     </div>
                </div>
            `;
            
            // Render Log
            if(sim.log && sim.log.length > 0) {
                 sim.log.forEach((item, idx) => {
                     const div = document.createElement('div');
                     div.className = `sim-log-item ${item.isCorrect ? 'correct' : 'wrong'}`;
                     div.style.marginBottom = '8px';
                     div.innerHTML = `
                        <div style="font-weight:600; margin-bottom:6px; color:var(--text-main);">${idx+1}. ${item.question}</div>
                        <div style="font-size:0.9rem; margin-bottom:4px;">
                            <span style="color:var(--text-muted);">Sua resposta: </span> 
                            <span style="font-weight:600; color:${item.isCorrect ? 'var(--success)' : 'var(--danger)'}">${item.userAnswer}</span>
                        </div>
                         ${!item.isCorrect ? `<div style="font-size:0.9rem; color:var(--success);"><span style="color:var(--text-muted);">Correta: </span> <strong>${item.correctAnswer}</strong></div>` : ''}
                        <div style="font-size:0.8rem; color:var(--text-muted); margin-top:4px; text-transform:uppercase; letter-spacing:0.5px;">${item.category}</div>
                     `;
                     content.appendChild(div);
                });
            } else {
                content.innerHTML += `<div style="text-align:center; padding:20px; color:var(--text-muted);">Detalhes não disponíveis para este registro antigo.</div>`;
            }
            
            document.getElementById('sim-detail-modal').classList.remove('hidden');
        }


        // FORÇAR CARREGAMENTO DA INTENSIDADE
// Coloque isso no final do script
setTimeout(() => {
    localforage.getItem('ted_config_intensity').then(savedLevel => {
        if (savedLevel) {
            console.log("Restaurando intensidade da chave segura:", savedLevel);
            
            // Atualiza o objeto global
            if(typeof userData !== 'undefined') userData.revisionLevel = savedLevel;
            
            // Atualiza o seletor visual
            const select = document.getElementById('revision-level-select');
            if (select) select.value = savedLevel;
        }
    }).catch(err => console.error("Erro ao ler chave segura:", err));
}, 1000); // Espera 1 segundo para garantir que a tela já carregou

     
    </script>

<!-- CUSTOM LOGOUT MODAL -->
<div id="logout-modal" class="hidden" style="position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.6);z-index:10000;display:flex;align-items:center;justify-content:center; padding: 20px; backdrop-filter: blur(5px);">
    <div style="background:var(--bg-card); padding:30px; border-radius:16px; width:100%; max-width:350px; text-align:center; box-shadow:var(--shadow-lg); border:1px solid var(--border); animation: fadeIn 0.3s ease;">
        <div style="font-size:3rem; color:#ef4444; margin-bottom:15px;"><i class="fas fa-exclamation-triangle"></i></div>
        <h3 style="margin-bottom:10px; color:var(--text-primary); font-size: 1.25rem;">Sair da Conta?</h3>
        <p style="color:var(--text-muted); margin-bottom:25px;">Você precisará fazer login novamente para acessar seus dados.</p>
        <div style="display:flex; gap:10px; justify-content:center;">
            <button class="btn-outline" onclick="closeLogoutModal()" style="flex:1;">Cancelar</button>
            <button class="action-btn" onclick="confirmLogout()" style="background:#ef4444; flex:1; border:none;">Sim, Sair</button>
        </div>
    </div>
</div>
<!-- BIBLIOTECA LOCALFORAGE -->
<script src="https://cdn.jsdelivr.net/npm/localforage@1.10.0/dist/localforage.min.js"></script>

<!-- NOSSAS NOVAS FUNÇÕES (COPIE E COLE ISSO EXATAMENTE ASSIM) -->
<script>
    // Configura o banco de dados para aceitar arquivos grandes
    localforage.config({
        name: 'AppEstudosConcurso',
        storeName: 'meus_dados_v1'
    });

    // Função AUXILIAR para salvar (substitui o setItem)
    async function salvarDados(chave, valor) {
        try {
            await localforage.setItem(chave, valor);
            // Mantemos no localStorage APENAS coisas pequenas se precisar,
            // mas para o seu backup grande, o localforage resolve.
        } catch (erro) {
            console.error("Erro ao salvar:", erro);
        }
    }

    // Função AUXILIAR para carregar (substitui o getItem)
    async function carregarDados(chave, valorPadrao) {
        try {
            const valor = await localforage.getItem(chave);
            // Se valor for null (não existe), retorna o valorPadrao
            return valor !== null ? valor : valorPadrao;
        } catch (erro) {
            console.error("Erro ao carregar:", erro);
            return valorPadrao;
        }
    }
</script>
<script src="https://cdn.quilljs.com/1.3.6/quill.min.js"></script>
<!-- BIBLIOTECA QUILL (Copie e cole isso) -->
<link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css" />
<script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
<script src="https://cdn.quilljs.com/1.3.6/quill.min.js"></script>

<script>
    // Inicializa o Editor
    var quill = new Quill('#editor-container', {
      modules: {
        toolbar: [
  [{ 'size': ['small', false, 'large', 'huge'] }], // <--- LINHA NOVA (Tamanho)
  ['bold', 'italic', 'underline'],                 // Mantém negrito, itálico...
  [{ 'list': 'ordered'}, { 'list': 'bullet' }],    // Mantém listas
  [{ 'indent': '-1'}, { 'indent': '+1' }],         // Mantém recuo
  [{ 'color': [] }, { 'background': [] }],         // Mantém cores
  ['formula']                                      // Mantém matemática
]
      },
      placeholder: 'Digite sua anotação aqui...',
      theme: 'snow'
    });

    // TRUQUE: Conecta o Quill com seu sistema antigo de salvar notas
    // Quando você digitar, ele joga o texto pro lugar onde seu app espera encontrar
    quill.on('text-change', function() {
        // Se houver alguma variável global ou input escondido, atualize aqui
        // Exemplo: se seu app lia o innerHTML do 'note-content' antigo
    });

    // --- VERSÃO FINAL: DESIGN CORRIGIDO (TEXTO VISÍVEL) ---
    const { ipcRenderer } = require('electron');

    ipcRenderer.on('app-close-attempt', () => {
        showBackupModal();
    });

    function showBackupModal() {
        const existing = document.getElementById('backup-exit-modal');
        if (existing) existing.remove();

        const modalHtml = `
            <div id="backup-exit-modal" style="
                position: fixed; top: 0; left: 0; 
                width: 100%; height: 100%; 
                background: rgba(0, 0, 0, 0.85); 
                z-index: 99999; 
                display: flex; justify-content: center; align-items: center;
                backdrop-filter: blur(5px);
                font-family: inherit; /* Usa a mesma fonte do app */
            ">
                <div style="
                    background-color: #202020; /* Fundo escuro sólido */
                    color: #ffffff; 
                    padding: 32px; 
                    border-radius: 16px; 
                    width: 360px; 
                    text-align: center; 
                    border: 1px solid #333; 
                    box-shadow: 0 20px 60px rgba(0,0,0,0.6);
                ">
                    <!-- TÍTULO BRANCO PURO -->
                    <h2 style="
                        margin: 0 0 12px 0; 
                        color: #ffffff !important; 
                        font-size: 1.5rem; 
                        font-weight: 700;
                    ">Sair do Teddy?</h2>
                    
                    <p style="
                        margin-bottom: 30px; 
                        color: #cccccc !important; 
                        font-size: 1rem; 
                        line-height: 1.5;
                    ">
                        Não perca seu progresso de hoje.<br>Deseja fazer um backup antes de ir?
                    </p>
                    
                    <div style="display: flex; gap: 12px; flex-direction: column;">
                        <!-- Botão Principal (Usa variável ou Laranja padrão se falhar) -->
                        <button onclick="realizarBackupEFechar()" style="
                            background: var(--primary, #D97706); 
                            color: white; 
                            padding: 14px; 
                            border-radius: 10px; 
                            border: none; 
                            cursor: pointer; 
                            font-weight: 600; 
                            font-size: 1rem;
                            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                        ">
                            Fazer Backup e Sair
                        </button>

                        <!-- Botão Secundário -->
                        <button onclick="fecharDireto()" style="
                            background: transparent; 
                            border: 2px solid #444; 
                            color: #dddddd; 
                            padding: 12px; 
                            border-radius: 10px; 
                            cursor: pointer; 
                            font-weight: 500;
                            font-size: 0.95rem;
                            margin-top: 5px;
                        ">
                            Sair sem salvar
                        </button>
                        
                        <!-- Botão Cancelar -->
                        <button onclick="cancelarSaida()" style="
                            background: transparent; 
                            border: none; 
                            color: #888888; 
                            padding: 8px; 
                            cursor: pointer; 
                            font-size: 0.85rem; 
                            margin-top: 5px;
                            text-decoration: underline;
                        ">
                            Cancelar
                        </button>
                    </div>
                </div>
            </div>
        `;
        document.body.insertAdjacentHTML('beforeend', modalHtml);
    }

    function realizarBackupEFechar() {
        if (typeof exportAllData === 'function') {
            exportAllData(); 
        }

        const modal = document.getElementById('backup-exit-modal');
        if(modal) {
            modal.innerHTML = `
                <div style="
                    background:#202020; color:#fff; padding:32px; 
                    border-radius:16px; width:360px; text-align:center; 
                    border:1px solid #333; box-shadow: 0 20px 60px rgba(0,0,0,0.6);
                    font-family: inherit;
                ">
                    <h2 style="margin:0 0 15px 0; color:var(--primary, #D97706); font-size: 1.4rem;">Salvando...</h2>
                    <p style="color:#cccccc; font-size:1rem; margin-bottom: 30px; line-height: 1.5;">
                        Escolha onde salvar o arquivo.<br>
                        Depois clique abaixo para fechar.
                    </p>
                    
                    <button onclick="fecharDireto()" style="
                        background: #333; 
                        color: #ffffff; 
                        padding: 14px 40px; 
                        border-radius: 10px; 
                        border: 1px solid #555; 
                        cursor: pointer; 
                        font-weight: bold; 
                        font-size: 1rem;
                    ">
                        Fechar Agora
                    </button>
                </div>
            `;
        }
    }

    function fecharDireto() {
        ipcRenderer.send('app-quit-confirmed');
    }

    function cancelarSaida() {
        const modal = document.getElementById('backup-exit-modal');
        if(modal) modal.remove();
    }






</script>


<div id="srs-modal" class="hidden" style="position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.6);z-index:2000;display:flex;align-items:center;justify-content:center; backdrop-filter: blur(3px);">
    <div class="srs-modal-content">
        <!-- Cabeçalho (ícone removido e margem ajustada) -->
        <div style="display:flex; align-items:center; gap:10px; margin-bottom:15px; border-bottom: 1px solid var(--border); padding-bottom: 15px;">
            <h3 style="margin:0; font-size:1.3rem;">Revisão Inteligente</h3>
        </div>

        <!-- Texto Explicativo Adicionado -->
        <p style="color: var(--text-muted); font-size: 0.9rem; line-height: 1.5; margin-bottom: 20px;">
            A revisão inteligente utiliza a curva de esquecimento para agendar automaticamente quando você deve rever esta anotação. Ative para receber lembretes periódicos e fixar o conteúdo.
        </p>
        
        <div style="margin-bottom: 25px; display:flex; justify-content:space-between; align-items:center; background:var(--bg-main); padding:15px; border-radius:12px;">
            <span style="font-weight:600;">Ativar Revisão</span>
            <label class="switch-container">
                <input type="checkbox" id="srs-active-check">
                <span class="slider"></span>
            </label>
        </div>

        <div id="srs-controls" style="transition: opacity 0.3s;">
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:15px; margin-bottom:20px;">
                <div>
                    <label style="font-size: 0.85rem; color: var(--text-muted); display:block; margin-bottom:5px;">Nível Atual</label>
                    <div id="srs-status-badge" style="background:var(--bg-main); padding:10px; border-radius:8px; font-weight:bold; text-align:center; border:2px solid var(--border);">Nível 0</div>
                </div>
                <div>
                    <label style="font-size: 0.85rem; color: var(--text-muted); display:block; margin-bottom:5px;">Próxima Data</label>
                    <input type="date" id="srs-next-date" class="modern-input" style="padding: 8px;">
                </div>
            </div>

            <button class="action-btn" onclick="resetSRS()" style="width:100%; background:transparent; border:1px solid var(--danger); color:var(--danger); margin-bottom:20px; display:flex; align-items:center; justify-content:center; gap:8px;">
                <i class="fas fa-undo"></i> Resetar Progresso
            </button>
        </div>

        <div style="display:flex; gap:10px;">
            <button class="action-btn" onclick="saveSRSConfig()" style="flex:1;">Salvar</button>
            <button class="btn-outline" onclick="document.getElementById('srs-modal').classList.add('hidden')" style="flex:1;">Cancelar</button>
        </div>
    </div>
</div>


<!-- ======================================================= -->
<!-- SISTEMA ANTI-DISTRAÇÃO (FINAL: CLEAN & RETORNANDO)      -->
<!-- Sem ícones, sem neon, texto ajustado.                   -->
<!-- ======================================================= -->

<style>
    /* Aviso Limpo e Sólido */
    .ad-toast {
        position: fixed; top: 30px; right: 30px;
        background: #10b981; /* Verde Sólido */
        color: white; 
        padding: 15px 30px;
        border-radius: 8px; /* Bordas normais */
        font-weight: 600;
        font-size: 1.1rem;
        z-index: 10000;
        /* Sombra suave apenas para separar do fundo (sem neon) */
        box-shadow: 0 4px 12px rgba(0,0,0,0.15); 
        display: none; animation: slideIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        border: none;
        font-family: 'Segoe UI', sans-serif;
    }
    
    .ad-overlay {
        position: fixed; top: 0; left: 0; right: 0; bottom: 0;
        background: rgba(0, 0, 0, 0.75); 
        z-index: 9999;
        display: flex; align-items: center; justify-content: center;
        backdrop-filter: blur(5px);
    }
    
    .ad-box {
        background: var(--bg-card, #ffffff); 
        color: var(--text-primary, #333);
        padding: 35px; border-radius: 16px;
        text-align: center; max-width: 400px; width: 90%;
        box-shadow: 0 20px 50px rgba(0,0,0,0.3);
        border: 1px solid var(--border, #eee);
    }
    
    .ad-btn {
        background: var(--primary, #f59e0b);
        color: white; border: none;
        padding: 14px 28px; border-radius: 8px; 
        font-weight: 600; cursor: pointer; margin-top: 25px; 
        transition: transform 0.2s; width: 100%; font-size: 1rem;
    }
    .ad-btn:hover { transform: scale(1.02); filter: brightness(1.1); }
    
    @keyframes slideIn { from { transform: translateX(50px) scale(0.9); opacity:0; } to { transform: translateX(0) scale(1); opacity:1; } }
</style>

<div id="ad-toast-container" class="ad-toast"></div>

<script>
(function() {
    let Config = { enabled: false, mouseOut: 30, inactivity: 5, resume: 10 };
    
    let state = { 
        pausedBySystem: false, 
        lastActivity: Date.now(), 
        mouseTimer: null, 
        resumeTimer: null 
    };

        function loadConfig() {
    // Inicia carregamento assíncrono do localForage
    localforage.getItem('ad_settings').then(function(saved) {
        
        // Se encontrou dados salvos, atualiza o objeto Config
        if (saved) {
            // localForage já retorna o objeto, não precisa JSON.parse
            Config = { ...Config, ...saved };
        }

        // --- ATUALIZAÇÃO DA TELA (Agora acontece APÓS os dados chegarem) ---
        
        const iMouse = document.getElementById('mouseOutTime');
        const iInact = document.getElementById('inactivityTime');
        const iResume = document.getElementById('resumeCountdown');
        const iEnabled = document.getElementById('antiDistractionToggle'); 
        const optionsDiv = document.getElementById('antiDistractionOptions'); 
        
        if (iMouse) iMouse.value = Config.mouseOut;
        if (iInact) iInact.value = Config.inactivity;
        if (iResume) iResume.value = Config.resume;
        
        // Lógica do botão de Ativar/Desativar
        if (iEnabled) {
            iEnabled.checked = Config.enabled; // Marca se estiver true
            
            // Mostra/Esconde as opções baseado na configuração salva
            if (optionsDiv) {
                optionsDiv.style.display = Config.enabled ? 'block' : 'none';
            }

            // Remove listeners antigos para evitar duplicação (boa prática em SPAs)
            // Mas se seu app recarrega a página, apenas adicionar o novo está ok.
            // Para garantir, vamos usar onchange direto ou assumir que loadConfig roda 1x.
            iEnabled.onchange = (e) => {
                if (optionsDiv) {
                    optionsDiv.style.display = e.target.checked ? 'block' : 'none';
                }
                // Dica: Lembre-se de salvar a config quando o usuário mudar o toggle!
                saveConfig(); 
            };
        }

    }).catch(function(err) {
        console.error('Erro ao carregar configurações (ad_settings):', err);
    });
}



       window.saveAntiDistractionConfig = function() {
    const newConfig = {
        enabled: document.getElementById('antiDistractionToggle').checked,
        mouseOut: parseInt(document.getElementById('mouseOutTime').value) || 30,
        inactivity: parseInt(document.getElementById('inactivityTime').value) || 5,
        resume: parseInt(document.getElementById('resumeCountdown').value) || 10
    };
    
    Config = newConfig;

    // MUDANÇA: Salvando com localForage
    localforage.setItem('ad_settings', Config).then(function() {
        // O código de feedback visual agora fica dentro do .then()
        // Isso garante que o usuário só veja "Salvo!" quando realmente salvou.
        const status = document.getElementById('configStatus');
        if(status) {
            status.innerHTML = '<i class="fas fa-check"></i> Salvo!';
            status.style.color = "var(--success, #10b981)";
            setTimeout(() => status.innerHTML = "", 3000);
        }
        state.lastActivity = Date.now();
        
    }).catch(function(err) {
        console.error("Erro ao salvar configurações:", err);
        // Opcional: Mostrar erro pro usuário
        const status = document.getElementById('configStatus');
        if(status) {
             status.innerHTML = '<i class="fas fa-times"></i> Erro!';
             status.style.color = "red";
        }
    });
};



    function isTimerRunning() {
        const btn = document.getElementById('btn-toggle-timer');
        return btn && btn.innerHTML.includes('fa-pause'); 
    }

    function forcePause(reason) {
        if (isTimerRunning()) {
            console.log(`[AntiDistraction] Pausando: ${reason}`);
            document.getElementById('btn-toggle-timer').click();
            state.pausedBySystem = true;
        }
    }

    function forceResume() {
        if (!isTimerRunning() && state.pausedBySystem) {
            console.log("[AntiDistraction] Retomando...");
            document.getElementById('btn-toggle-timer').click();
            state.pausedBySystem = false;
        }
    }

    // Monitoramento
    document.addEventListener('mouseleave', () => {
        if (!Config.enabled) return;
        if (isTimerRunning()) {
            state.mouseTimer = setTimeout(() => {
                forcePause('Mouse saiu');
            }, Config.mouseOut * 1000);
        }
    });

    document.addEventListener('mouseenter', () => {
        if (state.mouseTimer) clearTimeout(state.mouseTimer);
        if (state.pausedBySystem) startResumeSequence();
    });

    setInterval(() => {
        if (!Config.enabled) return;
        const diff = (Date.now() - state.lastActivity) / 1000 / 60;
        if (diff >= Config.inactivity && isTimerRunning()) {
            forcePause('Inatividade');
            showPopup();
        }
    }, 5000);

    ['mousemove', 'keydown', 'click'].forEach(e => {
        document.addEventListener(e, () => {
            state.lastActivity = Date.now();
            if(state.pausedBySystem && !document.querySelector('.ad-overlay')) {
                startResumeSequence();
            }
        });
    });

    const btn = document.getElementById('btn-toggle-timer');
    if(btn) btn.addEventListener('click', (e) => {
        if(e.isTrusted) {
            state.pausedBySystem = false;
            stopResumeSequence();
        }
    });

    // === LÓGICA DO AVISO (MODIFICADA) ===
    function startResumeSequence() {
        if (state.resumeTimer || document.querySelector('.ad-overlay')) return;
        
        let time = Config.resume;
        const toast = document.getElementById('ad-toast-container');
        
        toast.style.display = 'block';
        // SEM ÍCONE, TEXTO "RETORNANDO"
        toast.innerHTML = `Retornando ao Foco em ${time}s...`;

        state.resumeTimer = setInterval(() => {
            time--;
            toast.innerHTML = `Retornando ao Foco em ${time}s...`;
            
            if(!state.pausedBySystem) stopResumeSequence(); 

            if (time <= 0) {
                stopResumeSequence();
                forceResume();
            }
        }, 1000);
    }

    function stopResumeSequence() {
        if (state.resumeTimer) clearInterval(state.resumeTimer);
        state.resumeTimer = null;
        document.getElementById('ad-toast-container').style.display = 'none';
    }

    function showPopup() {
        const div = document.createElement('div');
        div.className = 'ad-overlay';
        div.innerHTML = `
            <div class="ad-box">
                <h2 style="margin-top:0">Ainda focado?</h2>
                <p style="opacity:0.8; margin-bottom:20px; font-size:1.1rem">
                    Sem atividade há ${Config.inactivity} minutos.
                </p>
                <button class="ad-btn" id="ad-confirm">Sim, estou aqui!</button>
            </div>
        `;
        document.body.appendChild(div);
        
        document.getElementById('ad-confirm').onclick = () => {
            div.remove();
            state.lastActivity = Date.now();
            startResumeSequence();
        };
    }

    loadConfig();
    console.log("[AntiDistraction] Versão Final Clean.");
})();



/* --- GRÁFICO ACERTOS vs ERROS (Versão Final c/ Scroll e Largura Dinâmica) --- */
function renderAccuracyChart(start, end) {
    const container = document.getElementById('accuracy-vs-error-chart');
    if (!container) return;
    container.innerHTML = '';

    let maxTotal = 0;
    const dataPoints = [];

    // LÓGICA DE AGRUPAMENTO
    if (currentPeriod === 'year') {
        // --- MODO ANO: Agrupa por Mês (12 colunas) ---
        let loopDate = new Date(start);
        loopDate.setDate(1); // Garante início do mês

        while (loopDate <= end) {
            const currentMonth = loopDate.getMonth();
            const currentYear = loopDate.getFullYear();
            
            // Filtra dados do mês inteiro
            const monthData = performanceData.filter(p => {
                const pDate = new Date(p.date + 'T00:00:00');
                return pDate.getMonth() === currentMonth && pDate.getFullYear() === currentYear;
            });

            const correct = monthData.filter(p => p.correct).length;
            const wrong = monthData.filter(p => !p.correct).length;
            if ((correct + wrong) > maxTotal) maxTotal = correct + wrong;

            const label = loopDate.toLocaleDateString('pt-BR', { month: 'short' }).replace('.', '');
            dataPoints.push({ label, correct, wrong });

            loopDate.setMonth(loopDate.getMonth() + 1);
        }
    } else {
        // --- MODO SEMANA/MÊS: Dia a Dia ---
        let loopDate = new Date(start);
        while (loopDate <= end) {
            const dateStr = loopDate.toISOString().split('T')[0];
            const dayData = performanceData.filter(p => p.date === dateStr);
            
            const correct = dayData.filter(p => p.correct).length;
            const wrong = dayData.filter(p => !p.correct).length;
            if ((correct + wrong) > maxTotal) maxTotal = correct + wrong;

            let label = loopDate.getDate();
            if (currentPeriod === 'week') {
                 label = loopDate.toLocaleDateString('pt-BR', {weekday:'short'}).slice(0,3);
            }

            dataPoints.push({ label, correct, wrong });
            loopDate.setDate(loopDate.getDate() + 1);
        }
    }

    // RENDERIZAÇÃO (ACERTOS vs ERROS - COM NÚMEROS)
    dataPoints.forEach(d => {
        // Reduzi altura máx para 130px (sobra espaço para números)
        const hC = maxTotal > 0 ? (d.correct / maxTotal) * 130 : 0;
        const hW = maxTotal > 0 ? (d.wrong / maxTotal) * 130 : 0;

        let styleWrapper = "";
        if (dataPoints.length > 15) {
             styleWrapper = "min-width: 40px; flex-shrink: 0;";
        } else {
             styleWrapper = "flex: 1; min-width: 20px;";
        }

                container.innerHTML += `
        <div style="
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            ${styleWrapper}
        ">
            <div style="display:flex; align-items:flex-end; gap:6px; height:160px; border-bottom:1px solid var(--border); width:100%; justify-content:center; padding-bottom:1px;">
                
                <!-- Coluna Verde (Mais Grossa: 20px) -->
                <div style="position: relative; width:30px; height:${Math.max(2, hC)}px; background:#10b981; border-radius:3px 3px 0 0;" title="Acertos: ${d.correct}">
                    ${d.correct > 0 ? `<div style='position:absolute; top:-25px; left:50%; transform:translateX(-50%); font-size:0.9rem; font-weight:bold; color:#10b981;'>${d.correct}</div>` : ''}
                </div>

                <!-- Coluna Vermelha (Mais Grossa: 25px) -->
                <div style="position: relative; width:30px; height:${Math.max(2, hW)}px; background:#ef4444; border-radius:3px 3px 0 0;" title="Erros: ${d.wrong}">
                    ${d.wrong > 0 ? `<div style='position:absolute; top:-25px; left:50%; transform:translateX(-50%); font-size:0.9rem; font-weight:bold; color:#ef4444;'>${d.wrong}</div>` : ''}
                </div>

            </div>
            <div style="margin-top:6px; font-size:0.9rem; color:var(--text-muted); text-transform:capitalize;">${d.label}</div>
        </div>`;

    });
}


/* --- GRÁFICO DE CARDS CRIADOS (Versão Blindada) --- */
function renderCreatedCardsChart(start, end) {
    const container = document.getElementById('cards-created-chart');
    if (!container) return;
    container.innerHTML = '';

    let maxTotal = 0;
    const dataPoints = [];

    // LÓGICA DE AGRUPAMENTO
    if (currentPeriod === 'year') {
        // --- MODO ANO: 12 meses fixos ---
        // Em vez de while loop complicado, vamos iterar fixo 0 a 11
        for (let m = 0; m < 12; m++) {
            // Cria data para o mês M do ano selecionado
            const loopDate = new Date(start.getFullYear(), m, 1);
            
            const currentMonth = loopDate.getMonth();
            const currentYear = loopDate.getFullYear();
            
            // Filtra cards
            const count = cards.filter(c => {
                const cDate = new Date(c.createdAt || c.id); 
                return cDate.getMonth() === currentMonth && cDate.getFullYear() === currentYear;
            }).length;

            if (count > maxTotal) maxTotal = count;

            const label = loopDate.toLocaleDateString('pt-BR', { month: 'short' }).replace('.', '');
            dataPoints.push({ label, count });
        }
    } else {
        // --- MODO SEMANA/MÊS: Dia a Dia ---
        // Cria uma cópia segura da data de início para não alterar a original
        let loopDate = new Date(start); 
        
        // Loop de segurança (máximo 35 dias para evitar travar se a lógica falhar)
        let safety = 0;
        
        while (loopDate <= end && safety < 40) {
            const dateStr = loopDate.toISOString().split('T')[0];
            
            const count = cards.filter(c => {
                // Tenta usar createdAt, se não existir, usa ID (timestamp)
                let cDate;
                if(c.createdAt) {
                    cDate = new Date(c.createdAt);
                } else {
                    cDate = new Date(parseInt(c.id));
                }
                return cDate.toISOString().split('T')[0] === dateStr;
            }).length;
            
            if (count > maxTotal) maxTotal = count;

            let label = loopDate.getDate();
            if (currentPeriod === 'week') {
                 label = loopDate.toLocaleDateString('pt-BR', {weekday:'short'}).slice(0,3);
            }

            dataPoints.push({ label, count });
            
            // Avança 1 dia
            loopDate.setDate(loopDate.getDate() + 1);
            safety++;
        }
    }

     // RENDERIZAÇÃO
    dataPoints.forEach(d => {
        // Reduzimos um pouco a altura máxima da barra (de 150 para 130) para sobrar espaço pro número
        const height = maxTotal > 0 ? (d.count / maxTotal) * 130 : 0;
        
        let styleWrapper = "";
        if (dataPoints.length > 15) {
             styleWrapper = "min-width: 40px; flex-shrink: 0;";
        } else {
             styleWrapper = "flex: 1; min-width: 20px;";
        }

        container.innerHTML += `
        <div style="display: flex; flex-direction: column; align-items: center; ${styleWrapper}">
            <!-- Aumentei height para 160px e dei padding-top -->
            <div style="display:flex; align-items:flex-end; justify-content:center; height:160px; border-bottom:1px solid var(--border); width:100%; padding-bottom:1px; position: relative;">
                
                <!-- Coluna Azul -->
                <div style="width: 40%; max-width: 30px; min-width: 8px; height:${Math.max(2, height)}px; background: var(--primary); border-radius: 4px 4px 0 0; transition: height 0.3s; position: relative;" 
                     title="${d.count} cards criados">
                     
                     <!-- Número Flutuante (Agora posicionado acima da barra com absolute) -->
                     ${d.count > 0 ? `<div style='
                        position: absolute; 
                        top: -25px; 
                        left: 50%; 
                        transform: translateX(-50%); 
                        font-size: 1.10rem; 
                        font-weight: bold; 
                        color: var(--text-main);
                        white-space: nowrap;
                     '>${d.count}</div>` : ''}
                </div>
            </div>
            <div style="margin-top:6px; font-size:0.75rem; color:var(--text-muted); text-transform:capitalize;">${d.label}</div>
        </div>`;
    });
}


// --- FECHAR AO CLICAR FORA ---
document.addEventListener('click', function(event) {
    const panel = document.getElementById('quick-notes-panel');
    const btn = document.getElementById('btn-quick-notes');

    // Se o painel não existir ou estiver fechado, não faz nada
    if (!panel || panel.style.display !== 'flex') return;

    // Verifica se o clique foi FORA do painel E FORA do botão
    // (O .contains verifica se o elemento clicado está dentro deles)
    if (!panel.contains(event.target) && !btn.contains(event.target)) {
        panel.style.display = 'none';
    }
});


try {
    // 1. Limpa o sistema ANTIGO (Garante que não volta a usar o limitado)
    localStorage.removeItem('ted_quick_history'); 
    sessionStorage.removeItem('ted_quick_history'); 
    
    // 2. Limpa o sistema NOVO (Zera o banco de dados ilimitado)
    localforage.removeItem('ted_quick_history').then(function() {
        console.log("Histórico limpo com sucesso (ambos os sistemas)!");
        alert("Histórico resetado! Tudo pronto.");
        
        // Opcional: Recarregar a tela para sumir os dados visuais
        // renderHistoryTable([]); 
    }).catch(function(err) {
        console.error("Erro ao limpar localForage:", err);
    });

} catch(e) { console.error("Erro ao limpar localStorage:", e); }


function atualizarBannersSubtopicos() {
    // 1. Definir data de corte (últimos 7 dias)
    const hoje = new Date();
    const seteDiasAtras = new Date();
    seteDiasAtras.setDate(hoje.getDate() - 7);
    const dataCorte = seteDiasAtras.toISOString().split('T')[0];

    // 2. Mapear Subtópicos -> Categorias
    // Criamos um dicionário para saber a qual categoria cada subtópico pertence
    const subToCat = {};
    const todosSubtopicos = new Set();

    cards.forEach(card => {
        if(card.subcategory && card.subcategory.trim() !== "") {
            todosSubtopicos.add(card.subcategory);
            // Salva a categoria deste subtópico (se já existir, mantém)
            if (!subToCat[card.subcategory]) {
                subToCat[card.subcategory] = card.category || 'Geral';
            }
        }
    });

    // 3. Contar revisões
    const contagem = {};
    todosSubtopicos.forEach(sub => contagem[sub] = 0);

    performanceData.forEach(log => {
        if (log.date >= dataCorte && log.subcategory) {
            contagem[log.subcategory] = (contagem[log.subcategory] || 0) + 1;
        }
    });

    // 4. Ordenar
    const arrayStats = Object.keys(contagem).map(sub => ({
        nome: sub,
        qtd: contagem[sub],
        categoria: subToCat[sub] || 'Geral' // Pega a categoria mapeada
    }));

    const maisRevisados = [...arrayStats].sort((a, b) => b.qtd - a.qtd).slice(0, 5);
    const menosRevisados = [...arrayStats].sort((a, b) => a.qtd - b.qtd).slice(0, 5);

    // 5. Renderizar com Categoria
    function renderList(elementId, data) {
        const ul = document.getElementById(elementId);
        if(!ul) return;
        
        ul.innerHTML = '';
        if (data.length === 0) {
            ul.innerHTML = '<li style="color:var(--text-muted)">Sem dados suficientes</li>';
            return;
        }

        data.forEach((item, index) => {
            const li = document.createElement('li');
            
            // Layout: 
            // Esquerda: Número + Nome + Categoria (embaixo)
            // Direita: Contagem
            li.innerHTML = `
                <div style="display:flex; flex-direction:column; gap:2px; overflow:hidden;">
                    <span class="sub-name" style="white-space:nowrap; overflow:hidden; text-overflow:ellipsis; max-width: 200px;" title="${item.nome}">
                        <b>${index + 1}.</b> ${item.nome}
                    </span>
                    <span style="font-size: 0.75rem; color: #94a3b8; margin-left: 14px;">
                        ${item.categoria}
                    </span>
                </div>
                <span class="sub-count" style="align-self: center;">${item.qtd}</span>
            `;
            ul.appendChild(li);
        });
    }

    renderList('list-top-reviewed', maisRevisados);
    renderList('list-least-reviewed', menosRevisados);
}



// Chame esta função sempre que carregar o dashboard ou salvar uma revisão
// Exemplo: adicione 'atualizarBannersSubtopicos();' dentro da função 'renderDashboard()'

function goToStudyPractice() {
    // Pega o número atual do contador
    const dueCount = parseInt(document.getElementById('dash-due-count').innerText);
    
    // Só redireciona se o número for maior que 0
    if (dueCount > 0) {
        switchTab('study');     // Muda para a aba Estudar
        switchStudyTab('practice'); // Muda para a sub-aba Praticar
    }
}



</script>

<!-- MODAL DE HISTÓRICO (Versão Tabela Elegante) -->
<div id="history-modal" class="hidden" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.4); z-index: 2000; display: flex; align-items: center; justify-content: center; backdrop-filter: blur(2px);">
    <div style="background: var(--bg-card); width: 90%; max-width: 600px; max-height: 80vh; border-radius: 8px; display: flex; flex-direction: column; box-shadow: 0 4px 15px rgba(0,0,0,0.1); border: 1px solid var(--border);">
        
        <!-- Cabeçalho Limpo -->
        <div style="padding: 20px 24px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center;">
            <h3 style="margin: 0; font-weight: 600; font-size: 1.1rem; color: var(--text-main);">Histórico de Revisões</h3>
            <button onclick="document.getElementById('history-modal').classList.add('hidden')" style="background: none; border: none; font-size: 1.2rem; cursor: pointer; color: var(--text-muted); padding: 4px;">
                <i class="fas fa-times"></i>
            </button>
        </div>

        <!-- Resumo em Faixa -->
        <div id="history-summary" style="padding: 16px 24px; background: var(--bg-body); font-size: 0.9rem; border-bottom: 1px solid var(--border); display: flex; gap: 30px; font-weight: 500; color: var(--text-main);">
            <!-- Será preenchido via JS -->
        </div>

        <!-- Área da Tabela -->
        <div style="overflow-y: auto; flex: 1; padding: 0;">
            <table style="width: 100%; border-collapse: collapse; font-size: 0.9rem;">
                <thead style="background: var(--bg-body); position: sticky; top: 0;">
                    <tr>
                        <th style="text-align: left; padding: 12px 24px; border-bottom: 1px solid var(--border); color: var(--text-muted); font-weight: 600; width: 40%;">Data</th>
                        <th style="text-align: left; padding: 12px 24px; border-bottom: 1px solid var(--border); color: var(--text-muted); font-weight: 600;">Resultado</th>
                        <th style="text-align: right; padding: 12px 24px; border-bottom: 1px solid var(--border); color: var(--text-muted); font-weight: 600;">Intervalo</th>
                    </tr>
                </thead>
                <tbody id="history-list">
                    <!-- Linhas da tabela virão aqui -->
                </tbody>
            </table>
        </div>
    </div>
</div>



</body>
</html>