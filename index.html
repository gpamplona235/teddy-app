<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>TeddyApp - BETA</title>
    
    <meta name="theme-color" content="#ed8432">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    
    <style>
        :root {
            /* CORES ORIGINAIS */
            --primary: #ed8432;
            --primary-hover: #d9772b;
            --primary-light: #fff7ed;
            --primary-dim: #ffedd5;
            --primary-dark: #c2410c;
            --secondary: #fb923c;
            
            --success: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --info: #3b82f6;
            
            --bg-body: #f1f5f9;
            --bg-card: #ffffff;
            --bg-nav: #ffffff;
            --text-main: #1e293b;
            --text-muted: #64748b;
            --border: #e2e8f0;
            --input-bg: #ffffff;
            
            --radius-lg: 20px;
            --radius-md: 12px;
            --radius-sm: 8px;
            
            --shadow-sm: 0 1px 2px rgba(0,0,0,0.05);
            --shadow-md: 0 4px 6px -1px rgba(0,0,0,0.1);
            --shadow-lg: 0 10px 15px -3px rgba(0,0,0,0.1);
            --nav-height: 65px;
            --sidebar-width: 80px; /* Fixed width for collapsed state */
        }

        /* DARK MODE */
        body.dark-mode {
            --bg-body: #0f172a;
            --bg-card: #1e293b;
            --bg-nav: #1e293b;
            --text-main: #f1f5f9;
            --text-muted: #94a3b8;
            --border: #334155;
            --primary-light: #331f14; 
            --primary-dim: #431407;
            --input-bg: #0f172a;
            --shadow-sm: 0 1px 2px rgba(0,0,0,0.3);
            --shadow-md: 0 4px 6px -1px rgba(0,0,0,0.3);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-body);
            color: var(--text-main);
            height: 100vh;
            display: flex;
            overflow: hidden;
            font-size: 16px; 
            transition: background 0.3s, color 0.3s;
        }

        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        .dark-mode ::-webkit-scrollbar-thumb { background: #475569; }

        /* SIDEBAR APRIMORADA - ALWAYS COLLAPSED */
        .sidebar {
            width: var(--sidebar-width);
            background: var(--bg-nav);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            padding: 24px 12px; 
            z-index: 100;
            padding-top: 40px;
            transition: background 0.3s;
            position: relative;
        }

        .nav-links { display: flex; flex-direction: column; gap: 8px; flex: 1; margin-top: 20px; overflow: hidden; }

        .nav-item {
            display: flex; align-items: center; justify-content: center; /* Centered for icons */
            gap: 12px; padding: 14px 0;
            border-radius: var(--radius-sm); color: var(--text-muted);
            font-weight: 600; cursor: pointer; transition: all 0.2s;
            border: none; background: none; width: 100%; 
            font-size: 0.95rem; white-space: nowrap; 
            position: relative;
        }

        .nav-item:hover { background: var(--primary-light); color: var(--primary); }
        .nav-item.active { background: var(--primary); color: white; box-shadow: var(--shadow-sm); }
        
        .nav-item i { 
            min-width: 24px; 
            text-align: center; 
            font-size: 1.1rem; 
            margin: 0;
        }
        
        /* Tooltip style for Sidebar Legend */
        .nav-item span { 
            position: absolute;
            left: 70px;
            background: var(--text-main);
            color: var(--bg-card);
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 0.85rem;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s ease-in-out;
            box-shadow: var(--shadow-md);
            z-index: 200;
            white-space: nowrap;
        }

        .nav-item:hover span { opacity: 1; }

        /* BOTTOM NAV */
        .bottom-nav {
            display: none; position: fixed; bottom: 0; left: 0; width: 100%;
            background: var(--bg-nav); height: var(--nav-height); border-top: 1px solid var(--border);
            z-index: 1000; justify-content: space-around; align-items: center;
            padding-bottom: env(safe-area-inset-bottom);
            transition: background 0.3s;
        }

        .bottom-nav-item {
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            color: var(--text-muted); font-size: 0.75rem; font-weight: 600; gap: 4px;
            background: none; border: none; width: 100%; height: 100%;
        }
        .bottom-nav-item.active { color: var(--primary); }
        .bottom-nav-item i { font-size: 1.4rem; margin-bottom: 2px; }

        /* MAIN AREA */
        .main-content {
            flex: 1; height: 100%; overflow-y: auto; overflow-x: hidden;
            padding: 24px 32px; position: relative;
        }

        .page-header { margin-bottom: 24px; display: flex; align-items: center; justify-content: space-between; }
        #page-title-display { font-weight: 800; font-size: 1.5rem; color: var(--text-main); letter-spacing: -0.5px; }

        .header-actions { display: flex; gap: 12px; align-items: center; }

        .header-btn-icon {
            width: 40px; height: 40px; border-radius: 50%; border: 1px solid var(--border);
            background: var(--bg-card); color: var(--text-main); display: flex; align-items: center;
            justify-content: center; cursor: pointer; font-size: 1.1rem;
            transition: all 0.2s;
        }
        .header-btn-icon:hover {
            border-color: var(--primary);
            color: var(--primary);
            background: var(--primary-light);
        }

        .view-section { max-width: 1000px; margin: 0 auto; padding-bottom: 100px; animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .hidden { display: none !important; }

        .card-box {
            background: var(--bg-card); border-radius: var(--radius-lg);
            padding: 24px; box-shadow: var(--shadow-sm); border: 1px solid var(--border);
            margin-bottom: 20px; transition: background 0.3s, border 0.3s;
        }

        /* Fix spacing inside grids */
        .dashboard-grid .card-box { margin-bottom: 0; height: 100%; }

        h3 { font-size: 1.15rem; font-weight: 700; color: var(--text-main); margin-bottom: 16px; }

        /* BUTTONS & INPUTS */
        .action-btn {
            background: var(--primary); color: white; border: none; padding: 14px 24px;
            border-radius: var(--radius-md); font-weight: 600; font-size: 1rem;
            cursor: pointer; display: inline-flex; align-items: center; justify-content: center;
            gap: 8px; width: 100%; transition: background 0.2s;
        }
        .action-btn:hover { background: var(--primary-hover); }
        .action-btn:active { transform: scale(0.98); }
        .action-btn:disabled { opacity: 0.6; cursor: not-allowed; transform: none; }
        
        .btn-outline { background: var(--bg-card); border: 1px solid var(--border); color: var(--text-main); cursor: pointer; border-radius: var(--radius-md); padding: 12px 20px; font-weight: 600; font-size: 0.95rem; }
        .btn-outline:hover { background: var(--bg-body); border-color: var(--text-muted); }
        .btn-danger { background: var(--danger); color: white; border: none;}
        .btn-sm { padding: 8px 16px; font-size: 0.85rem; width: auto; border-radius: 8px; }
        .btn-icon { width: 38px; height: 38px; border-radius: 50%; padding: 0; display: flex; align-items: center; justify-content: center; border: 1px solid var(--border); background: var(--bg-card); cursor: pointer; color: var(--text-muted); font-size: 1.1rem; }
        .btn-icon:hover { color: var(--primary); border-color: var(--primary); background: var(--primary-light); }
        .btn-back { border: none; padding: 10px 0; margin-bottom: 16px; color: var(--text-muted); font-size: 1.1rem; display: flex; align-items: center; gap: 8px; background: transparent; cursor: pointer; }
        .btn-back:hover { color: var(--primary); }

        input, select, textarea {
            width: 100%; padding: 14px; border-radius: var(--radius-md);
            border: 1px solid var(--border); background: var(--input-bg);
            font-family: inherit; font-size: 1.05rem; margin-bottom: 16px; color: var(--text-main);
        }
        
        /* Remove default focus outline and add custom style */
        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px var(--primary-light);
        }

        .editor-toolbar { display: flex; gap: 8px; margin-bottom: 12px; padding: 4px; background: var(--bg-body); border-radius: 8px; border: 1px solid var(--border); width: fit-content; }
        
        /* --- SEARCH DROPDOWN STYLES --- */
        .search-container { position: relative; width: 100%; margin-bottom: 12px; }
        .search-results-list {
            position: absolute;
            top: 100%;
            left: 0;
            width: 100%;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
            max-height: 200px;
            overflow-y: auto;
            z-index: 2500;
            box-shadow: var(--shadow-lg);
            display: none;
        }
        .search-result-item {
            padding: 10px 14px;
            border-bottom: 1px solid var(--bg-body);
            cursor: pointer;
            transition: background 0.2s;
            font-size: 0.9rem;
            color: var(--text-main);
        }
        .search-result-item:last-child { border-bottom: none; }
        .search-result-item:hover { background: var(--bg-body); color: var(--primary); }
        .search-result-item strong { display: block; font-size: 0.95rem; }
        .search-result-item span { font-size: 0.8rem; color: var(--text-muted); }

        /* --- HERO HEADER STYLES --- */
        .hero-header-card {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            border: none;
            overflow: hidden;
            position: relative;
            margin-bottom: 24px;
            padding: 24px;
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-md);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .hero-bg-icon {
            position: absolute; right: -20px; bottom: -30px; font-size: 10rem; opacity: 0.1; pointer-events: none;
        }
        .hero-content {
            position: relative; z-index: 2; width: 100%; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 16px;
        }
        .hero-title {
            color: white; margin: 0; font-size: 1.3rem; font-weight: 800;
        }
        .hero-subtitle {
            opacity: 0.9; margin-top: 4px; font-size: 0.9rem; font-weight: 500;
        }
        .hero-actions {
            display: flex;
            background: rgba(255,255,255,0.2);
            padding: 4px;
            border-radius: 12px;
            gap: 4px;
        }
        .banner-period-btn {
            background: transparent;
            border: none;
            color: rgba(255,255,255,0.8);
            padding: 8px 16px;
            border-radius: 8px;
            font-weight: 600;
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.2s;
        }
        .banner-period-btn:hover {
            background: rgba(255,255,255,0.1);
            color: white;
        }
        .banner-period-btn.active {
            background: white;
            color: var(--primary);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        /* --- STYLES FOR UNIFIED STUDY VIEW --- */
        .study-nav-container {
            display: flex;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: var(--radius-lg);
            padding: 6px;
            margin-bottom: 24px;
            gap: 6px;
        }

        .study-nav-btn {
            flex: 1;
            padding: 12px;
            border: none;
            background: transparent;
            color: var(--text-muted);
            border-radius: var(--radius-md);
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .study-nav-btn:hover {
            background: var(--bg-body);
            color: var(--text-main);
        }

        .study-nav-btn.active {
            background: var(--primary);
            color: white;
            box-shadow: var(--shadow-sm);
        }

        /* --- POMODORO STYLES --- */
        .pomodoro-layout { display: grid; grid-template-columns: 1fr 1fr; gap: 24px; }
        .timer-card { text-align: center; display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 400px; }
        .pomo-tabs { display: flex; background: var(--bg-body); padding: 4px; border-radius: 30px; margin-bottom: 30px; width: fit-content; border: 1px solid var(--border); }
        .pomo-tab { padding: 8px 20px; border-radius: 25px; cursor: pointer; border: none; background: transparent; color: var(--text-muted); font-weight: 600; transition: all 0.3s; }
        .pomo-tab.active { background: var(--bg-card); color: var(--primary); box-shadow: var(--shadow-sm); }
        
        .timer-display { font-size: 5rem; font-weight: 800; font-feature-settings: "tnum"; font-variant-numeric: tabular-nums; color: var(--text-main); margin: 20px 0; line-height: 1; }
        
        .timer-controls { display: flex; gap: 16px; align-items: center; margin-bottom: 30px; }
        .btn-pomo-main { width: 70px; height: 70px; border-radius: 50%; font-size: 1.5rem; display: flex; align-items: center; justify-content: center; background: var(--primary); color: white; border: none; cursor: pointer; transition: transform 0.2s, background 0.2s; box-shadow: var(--shadow-md); }
        .btn-pomo-main:hover { transform: scale(1.1); background: var(--primary-hover); }
        .btn-pomo-sec { width: 50px; height: 50px; border-radius: 50%; background: var(--bg-body); color: var(--text-muted); border: 1px solid var(--border); display: flex; align-items: center; justify-content: center; font-size: 1rem; cursor: pointer; transition: all 0.2s; }
        .btn-pomo-sec:hover { background: var(--bg-card); color: var(--primary); border-color: var(--primary); }

        .pomo-history-list { display: flex; flex-direction: column; gap: 10px; max-height: 400px; overflow-y: auto; }
        .pomo-item { display: flex; align-items: center; justify-content: space-between; padding: 14px 16px; background: var(--bg-card); border: 1px solid var(--border); border-radius: var(--radius-md); transition: all 0.2s; }
        .pomo-item:hover { border-color: var(--primary); transform: translateX(2px); }
        .pomo-info h4 { margin: 0; font-size: 0.95rem; color: var(--text-main); }
        .pomo-info span { font-size: 0.8rem; color: var(--text-muted); display: block; margin-top: 2px; }
        .pomo-actions { display: flex; gap: 8px; }
        .tag-pomo { background: var(--primary-light); color: var(--primary); }
        .tag-short { background: #dbeafe; color: var(--info); }
        .tag-long { background: #d1fae5; color: var(--success); }

        /* FLOATING TIMER WIDGET - Updated Position and Layout */
        .floating-timer {
            position: fixed;
            bottom: 77px; /* Align vertical center with FAB (bottom ~70px + ~1/2 height) */
            right: 105px; /* Position to the left of FAB */
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: 10px 20px;
            border-radius: 30px;
            box-shadow: var(--shadow-lg);
            display: flex;
            flex-direction: row; 
            align-items: center;
            justify-content: center;
            border: 1px solid var(--border);
            z-index: 1900;
            transform: translateX(200%);
            transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            pointer-events: none; /* Read only */
        }
        .dark-mode .floating-timer { background: rgba(30, 41, 59, 0.95); }
        .floating-timer.visible { transform: translateX(0); }
        
        .float-time { font-weight: 800; font-variant-numeric: tabular-nums; color: var(--primary); font-size: 1.5rem; line-height: 1; }

        /* --- NEW CREATE CARD STYLES REFINED --- */
        .create-container {
            display: flex;
            flex-direction: column;
            gap: 24px;
        }

        .create-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .create-label {
            font-size: 0.75rem;
            font-weight: 700;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
            display: block;
        }

        .rich-editor {
            min-height: 120px;
            padding: 20px;
            background: var(--input-bg);
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
            font-size: 1.1rem;
            line-height: 1.5;
            transition: all 0.2s;
            color: var(--text-main);
        }

        .rich-editor:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px var(--primary-light);
        }

        .answer-group {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .answer-block {
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
            padding: 12px 16px;
            background: var(--bg-card);
            position: relative;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .answer-block:focus-within {
            border-color: var(--primary);
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
            transform: translateY(-1px);
        }

        .answer-block input {
            border: none;
            background: transparent;
            padding: 8px 0;
            margin: 0;
            font-size: 1rem;
            width: 100%;
            color: var(--text-main);
            box-shadow: none !important; /* Force remove default focus shadow on inner input */
        }
        
        .answer-block input:focus {
             outline: none;
             box-shadow: none;
             border: none;
        }

        .answer-block.correct-answer {
            background: linear-gradient(to right, rgba(16, 185, 129, 0.05), transparent);
            border-left: 4px solid var(--success);
        }
        
        .answer-block.correct-answer:focus-within {
            border-color: var(--success);
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.1);
        }

        .answer-block.wrong-answer {
            border-left: 4px solid var(--border);
        }
        
        .answer-block.wrong-answer:focus-within {
            border-left-color: var(--danger);
            border-color: var(--text-muted);
        }

        .answer-icon {
            font-size: 1.1rem;
            color: var(--text-muted);
            opacity: 0.5;
            flex-shrink: 0;
        }
        
        .correct-answer .answer-icon { color: var(--success); opacity: 1; }

        /* --- FLASHCARDS & STUDY --- */
        .flashcard-display {
            background: var(--bg-card); border-radius: var(--radius-lg); padding: 40px 24px;
            text-align: left; box-shadow: var(--shadow-lg); border: 1px solid var(--border);
            position: relative; overflow: hidden;
        }
        .question-text {
            font-size: 1.25rem; font-weight: 600; color: var(--text-main);
            margin: 16px 0 24px; line-height: 1.6; text-align: left;
        }
        .option-btn {
            background: var(--bg-card); border: 2px solid var(--border); padding: 18px;
            border-radius: var(--radius-md); font-size: 1.05rem; color: var(--text-main);
            font-weight: 500; text-align: left; cursor: pointer; transition: all 0.2s;
            margin-bottom: 12px; width: 100%;
            display: flex; gap: 8px; align-items: flex-start;
        }
        .option-btn:hover { border-color: var(--primary); transform: translateX(4px); }
        .option-btn:disabled { cursor: default; transform: none !important; }
        .option-btn strong { color: var(--primary); margin-right: 4px; }
        
        .option-btn.selected { 
            background: var(--bg-body); 
            border-color: var(--info); 
            box-shadow: 0 0 0 1px var(--info);
        }

        .option-btn.correct { background: rgba(16, 185, 129, 0.1); border-color: var(--success); color: var(--success); }
        .option-btn.wrong { background: rgba(239, 68, 68, 0.1); border-color: var(--danger); color: var(--danger); }
        
        /* List Styles */
        .card-list-item {
            background: var(--bg-card); border-radius: var(--radius-md); padding: 20px;
            border: 1px solid var(--border); box-shadow: var(--shadow-sm);
            margin-bottom: 16px; transition: transform 0.2s, box-shadow 0.2s;
            display: flex; flex-direction: column; gap: 12px;
        }
        .card-list-item:hover { transform: translateY(-2px); box-shadow: var(--shadow-md); border-color: var(--primary); }
        .card-meta { display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 8px; }
        .card-badge {
            font-size: 0.8rem; font-weight: 800; color: var(--primary);
            background: var(--primary-light); padding: 4px 10px; border-radius: 12px; text-transform: uppercase;
        }
        .next-review-badge { font-size: 0.8rem; font-weight: 600; color: var(--text-muted); display: flex; align-items: center; gap: 4px; }

        /* ID Badge Style */
        .id-badge {
            font-family: monospace; font-size: 0.75rem; background: var(--bg-body); 
            padding: 2px 6px; border-radius: 4px; color: var(--text-muted); border: 1px solid var(--border);
        }

        /* --- SYLLABUS, PERFORMANCE, NOTES, SCHEDULE (Kept same) --- */
        .syllabus-item { background: var(--bg-card); border: 1px solid var(--border); border-radius: var(--radius-md); padding: 20px; margin-bottom: 16px; cursor: pointer; transition: all 0.2s; display: flex; justify-content: space-between; align-items: center; }
        .syllabus-item:hover { transform: translateY(-2px); box-shadow: var(--shadow-md); border-color: var(--primary); }
        
        /* Refined Subject/Topic Styling */
        .subject-container { 
            background: var(--bg-card); 
            border: 1px solid var(--border);
            border-left: 4px solid var(--primary);
            border-radius: var(--radius-md); 
            margin-bottom: 20px; 
            overflow: hidden; 
            box-shadow: var(--shadow-sm);
            transition: box-shadow 0.2s;
        }
        .subject-container:hover {
            box-shadow: var(--shadow-md);
        }
        .subject-header { 
            padding: 18px 24px; 
            background: var(--bg-card); 
            border-bottom: 1px solid var(--bg-body); 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            cursor: pointer; 
            user-select: none; 
            transition: background 0.2s;
        }
        .subject-header:hover { background: var(--bg-body); }
        .subject-title { font-weight: 700; color: var(--text-main); font-size: 1rem; display: flex; align-items: center; gap: 10px; }
        
        .subject-progress { width: 100px; height: 8px; background: #e2e8f0; border-radius: 4px; overflow: hidden; margin-left: auto; margin-right: 16px; }
        .subject-progress-bar { height: 100%; background: var(--success); width: 0%; transition: width 0.5s ease; }
        
        .topic-list { padding: 0; background: var(--bg-card); }
        .topic-row { 
            display: flex; 
            align-items: center; 
            padding: 16px 24px; 
            border-bottom: 1px solid var(--bg-body); 
            transition: background 0.2s; 
        }
        .topic-row:last-child { border-bottom: none; }
        .topic-row:hover { background: var(--bg-body); }
        
        .topic-check { 
            width: 24px; height: 24px; 
            border: 2px solid var(--text-muted); 
            border-radius: 50%; /* Rounded checkbox */
            margin-right: 16px; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            cursor: pointer; 
            flex-shrink: 0; 
            color: white; 
            transition: all 0.2s; 
            font-size: 0.8rem;
        }
        .topic-row.done .topic-check { background: var(--success); border-color: var(--success); }
        .topic-row.done span { text-decoration: line-through; color: var(--text-muted); }
        
        .category-stat-item { display: flex; align-items: center; justify-content: space-between; padding: 16px 20px; border-bottom: 1px solid var(--bg-body); background: var(--bg-card); transition:background 0.2s; }
        .category-stat-item:last-child { border-bottom: none; }
        .category-stat-item:hover { background: var(--bg-body); }
        
        .cat-name { font-weight: 600; font-size: 1rem; color: var(--text-main); margin-bottom: 4px; }
        .cat-bar-bg { width: 100%; height: 8px; background: var(--bg-body); border-radius: 4px; overflow: hidden; }
        .cat-bar-fill { height: 100%; border-radius: 4px; transition: width 0.5s ease; }
        .cat-percent { font-weight: 700; font-size: 0.9rem; color: var(--text-main); min-width: 45px; text-align: right; margin-left: 10px; }
        .stats-summary-box { display: flex; justify-content: space-around; align-items: center; text-align: center; padding: 32px 16px; }
        .stat-big-item { flex: 1; }
        .stat-big-item .label { font-size: 0.9rem; opacity:0.8; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 8px; color:white; }
        .stat-big-item .value { font-size: 2.8rem; font-weight: 800; color: white; line-height: 1; }
        .stat-divider { width: 1px; height: 50px; background: rgba(255,255,255,0.3); margin: 0 10px; }
        
        .schedule-layout { display: flex; flex-direction: column; gap: 24px; }
        .task-section, .calendar-wrapper { background: var(--bg-card); border-radius: var(--radius-lg); padding: 24px; box-shadow: var(--shadow-sm); border: 1px solid var(--border); }
        
        /* UPDATED TASK LIST STYLES */
        .task-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 20px; }
        .task-list { display: flex; flex-direction: column; gap: 10px; min-height: 20px; /* Reduced min-height to fix whitespace */ }
        .task-item { 
            background: var(--bg-card); 
            border: 1px solid var(--border); 
            color: var(--text-main); 
            padding: 16px 20px; 
            border-radius: var(--radius-md); 
            display: flex; 
            align-items: center; 
            gap: 16px; 
            transition: all 0.2s;
            box-shadow: var(--shadow-sm);
        }
        .task-item:hover { border-color: var(--primary); transform: translateY(-2px); box-shadow: var(--shadow-md); }
        .task-check { 
            width: 24px; height: 24px; 
            border: 2px solid var(--text-muted); 
            border-radius: 50%; 
            display: flex; align-items: center; justify-content: center; 
            cursor: pointer; color: white; flex-shrink: 0;
            transition: all 0.2s;
        }
        .task-item.completed .task-check { background: var(--success); border-color: var(--success); }
        .task-item.completed span { text-decoration: line-through; color: var(--text-muted); }
        
        .schedule-grid-container { overflow-x: auto; position: relative; max-height: 600px; padding-bottom: 20px; }
        .modern-table { width: 100%; border-collapse: separate; border-spacing: 0; min-width: 900px; table-layout: fixed; border-radius: var(--radius-md); overflow: hidden; border: 1px solid var(--border); }
        .modern-table th { background: var(--bg-body); color: var(--text-muted); border-bottom: 1px solid var(--border); padding: 16px; position: sticky; top: 0; z-index: 20; font-weight: 700; text-transform: uppercase; font-size: 0.8rem; }
        .modern-table td { border-right: 1px solid var(--border); border-bottom: 1px solid var(--border); height: 70px; vertical-align: middle; padding: 4px; position: relative; background: var(--bg-card); transition: background 0.2s; }
        .modern-table td:hover { background: var(--bg-body); }
        .modern-table td.time-label { background: var(--bg-body); color: var(--text-muted); border-right: 1px solid var(--border); width: 80px; text-align: center; position: sticky; left: 0; z-index: 10; font-size: 0.8rem; font-weight: bold; }
        
        .event-block { height: 100%; width: 100%; border-radius: 6px; padding: 4px 8px; font-size: 0.75rem; font-weight: 600; color: white; box-shadow: 0 2px 4px rgba(0,0,0,0.05); cursor: pointer; display: flex; align-items: center; gap: 6px; overflow: hidden; white-space: nowrap; text-overflow: ellipsis; transition: transform 0.2s; }
        .event-block:hover { transform: scale(1.02); }
        .empty-cell-btn { position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; opacity: 0; color: var(--primary); font-size: 1.4rem; cursor: pointer; transition: opacity 0.2s; }
        td:hover .empty-cell-btn { opacity: 0.6; background: rgba(0,0,0,0.02); }
        
        .notes-breadcrumb { display: flex; align-items: center; gap: 8px; padding: 16px 20px; background: var(--bg-card); border: 1px solid var(--border); border-radius: var(--radius-md); margin-bottom: 24px; overflow-x: auto; white-space: nowrap; box-shadow: var(--shadow-sm); }
        .breadcrumb-item { color: var(--text-muted); font-size: 0.95rem; cursor: pointer; display: flex; align-items: center; gap: 8px; font-weight: 500; transition: color 0.2s; }
        .breadcrumb-item:hover { color: var(--primary); }
        .breadcrumb-item.active { color: var(--text-main); font-weight: 700; pointer-events: none; }
        
        .file-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: 20px; }
        .file-item { 
            background: var(--bg-card); 
            border: none; 
            border-radius: var(--radius-lg); 
            padding: 24px 16px; 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            text-align: center; 
            cursor: pointer; 
            position: relative; 
            transition: all 0.2s; 
            box-shadow: var(--shadow-sm); 
            aspect-ratio: 1/1; 
            justify-content: center; 
            border: 1px solid var(--border);
        }
        .file-item:hover { transform: translateY(-4px); box-shadow: var(--shadow-lg); border-color: var(--primary); }
        .file-icon { font-size: 3.5rem; margin-bottom: 16px; transition: transform 0.2s; }
        .file-item:hover .file-icon { transform: scale(1.1); }
        .file-name { font-size: 1rem; font-weight: 600; line-height: 1.3; overflow: hidden; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; color: var(--text-main); }
        .file-actions { position: absolute; top: 12px; right: 12px; display: flex; gap: 6px; opacity: 0; transition: opacity 0.2s; }
        .file-item:hover .file-actions { opacity: 1; }
        
        /* NEW: Study Control Bar (Buttons) */
        .study-controls-container {
            display: flex;
            flex-direction: column;
            gap: 16px;
            margin-top: 24px;
            padding-top: 20px;
            border-top: 1px solid var(--border);
        }
        
        .nav-buttons-row {
            display: flex;
            gap: 12px;
            justify-content: center;
        }

        .btn-study-rect {
            background: var(--bg-card);
            border: 1px solid var(--border);
            color: var(--text-muted);
            border-radius: 12px;
            padding: 12px 24px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.2s;
            flex: 1;
            justify-content: center;
            box-shadow: var(--shadow-sm);
        }
        
        .btn-study-rect:hover {
            border-color: var(--primary);
            color: var(--primary);
            background: var(--bg-body);
        }
        
        .btn-study-rect:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none !important;
        }

        .btn-study-confirm {
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 12px;
            padding: 16px 32px;
            font-size: 1.1rem;
            font-weight: 700;
            width: 100%;
            cursor: pointer;
            box-shadow: var(--shadow-md);
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        
        .btn-study-confirm:hover {
            background: var(--primary-hover);
            transform: translateY(-2px);
        }

        .sim-result-card {
            background: var(--bg-card);
            border-radius: var(--radius-lg);
            border: 1px solid var(--border);
            overflow: hidden;
            box-shadow: var(--shadow-md);
            margin-bottom: 24px;
        }

        .sim-result-header {
            padding: 30px;
            text-align: center;
            background: linear-gradient(135deg, var(--bg-body), var(--bg-card));
            border-bottom: 1px solid var(--border);
        }

        .sim-score-big {
            font-size: 4rem;
            font-weight: 800;
            color: var(--text-main);
            line-height: 1;
            margin-bottom: 4px;
        }

        .sim-score-label {
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--text-muted);
            font-weight: 600;
        }

        .sim-stats-row {
            display: flex;
            border-bottom: 1px solid var(--border);
        }

        .sim-stat-box {
            flex: 1;
            padding: 20px;
            text-align: center;
            border-right: 1px solid var(--border);
        }
        .sim-stat-box:last-child { border-right: none; }

        .sim-stat-val {
            font-size: 1.4rem;
            font-weight: 800;
            margin-bottom: 4px;
        }

        .sim-log-container {
            padding: 20px;
            background: var(--bg-body);
            max-height: 400px;
            overflow-y: auto;
        }

        .sim-log-item {
            background: var(--bg-card);
            padding: 16px;
            border-radius: var(--radius-md);
            margin-bottom: 12px;
            border: 1px solid var(--border);
            border-left: 4px solid var(--border);
            box-shadow: var(--shadow-sm);
        }

        .sim-log-item.correct { border-left-color: var(--success); }
        .sim-log-item.wrong { border-left-color: var(--danger); }
        
        /* NEW: Sim History Card List Style */
        .sim-history-card {
            display: flex;
            align-items: center;
            background: var(--bg-card);
            padding: 16px 20px;
            border-radius: var(--radius-md);
            border: 1px solid var(--border);
            margin-bottom: 12px;
            transition: all 0.2s;
            cursor: pointer;
        }
        .sim-history-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
            border-color: var(--primary);
        }
        
        .sim-hist-date {
            display: flex;
            flex-direction: column;
            margin-right: 20px;
        }
        .sim-hist-day { font-weight: 700; font-size: 1.1rem; color: var(--text-main); }
        .sim-hist-time { font-size: 0.8rem; color: var(--text-muted); }
        
        .sim-hist-score {
            font-size: 1.5rem;
            font-weight: 800;
            margin-left: auto;
            color: var(--text-main);
        }
        
        .sim-hist-pct {
            font-size: 0.85rem;
            font-weight: 700;
            padding: 4px 8px;
            border-radius: 6px;
            margin-left: 16px;
        }
        .bg-success-light { background: #dcfce7; color: var(--success); }
        .bg-warning-light { background: #fef3c7; color: var(--warning); }
        .bg-danger-light { background: #fee2e2; color: var(--danger); }

        .sim-config-item { display: flex; justify-content: space-between; align-items: center; padding: 12px; border: 1px solid var(--border); border-radius: var(--radius-md); margin-bottom: 10px; background: var(--bg-body); }
        .sim-config-item label { margin: 0; font-weight: 600; flex: 1; color: var(--text-main); font-size: 0.95rem; }
        .sim-config-item input[type="number"] { width: 70px; margin-bottom: 0; padding: 8px; font-size: 0.9rem; text-align: center; }
        .subject-controls { display: flex; gap: 6px; align-items: center; }
        .subject-controls .btn-icon { width: 30px; height: 30px; font-size: 0.8rem; border: none; background: transparent; color: var(--text-muted); }
        .subject-controls .btn-icon:hover { background: var(--bg-body); }
        .topic-controls { display: flex; gap: 4px; align-items: center; }
        .topic-controls .btn-icon { width: 26px; height: 26px; font-size: 0.7rem; border: none; background: transparent; color: var(--text-muted); }
        .topic-controls .btn-icon:hover { background: var(--bg-body); }
        .draggable-item { cursor: move; padding: 12px; background: var(--bg-card); border: 1px solid var(--border); border-radius: var(--radius-sm); margin-bottom: 8px; display: flex; align-items: center; gap: 12px; transition: all 0.2s; }
        .draggable-item:hover { background: var(--bg-body); border-color: var(--primary); }
        .draggable-item.dragging { opacity: 0.5; background: var(--primary-light); }
        .drag-handle { color: var(--text-muted); cursor: move; padding: 4px; }
        .drag-handle:hover { color: var(--primary); }
        .topic-card-count { margin-right: 8px; font-size: 0.75rem; background: var(--primary); color: white; border: none; border-radius: 4px; padding: 2px 8px; cursor: pointer; transition: all 0.2s; }
        .topic-card-count:hover { background: var(--primary-hover); transform: scale(1.05); }
        #link-topic-unlink-btn { background: var(--danger); color: white; border: none; }
        #link-topic-unlink-btn:hover { background: #dc2626; }
        .dashboard-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; margin-bottom: 12px; }
        .welcome-card { background: linear-gradient(135deg, var(--primary), var(--secondary)); color: white; border: none; grid-column: 1 / -1; display: flex; flex-direction: column; justify-content: center; min-height: 160px; }
        .welcome-card h2 { font-size: 1.8rem; margin-bottom: 8px; }
        .stat-widget { display: flex; align-items: center; gap: 16px; }
        .stat-icon { width: 50px; height: 50px; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; flex-shrink: 0; }
        .stat-info strong { font-size: 1.5rem; color: var(--text-main); font-weight: 800; }
        #dash-mini-chart { display: flex; justify-content: space-between; align-items: flex-end; height: 160px; padding-top: 20px; width: 100%; }
        .chart-col { display: flex; flex-direction: column; align-items: center; gap: 8px; flex: 1; }
        .chart-bar-container { flex: 1; display: flex; align-items: flex-end; justify-content: center; width: 100%; }
        .chart-bar { width: 12px; border-radius: 6px; transition: height 0.5s ease; min-height: 4px; }
        .chart-label { font-size: 0.75rem; color: var(--text-muted); font-weight: 600; }

        /* Specific Grid for Main Dashboard Row */
        #dash-main-row {
            grid-template-columns: 1.5fr 0.8fr 1fr;
        }

        /* PERFORMANCE VIEW UPDATED STYLES (Horizontal & Larger) */
        .performance-layout {
            display: flex;
            flex-direction: column;
            gap: 20px;
            margin-bottom: 20px;
        }

        .performance-card {
            background: var(--bg-card);
            border-radius: var(--radius-lg);
            padding: 24px;
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--border);
            transition: all 0.3s ease;
            width: 100%; /* Force full width */
        }

        .performance-card:hover {
            box-shadow: var(--shadow-md);
            transform: translateY(-2px);
        }

        /* Metrics Horizontal Row */
        .performance-metrics {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); /* Larger minimum width */
            gap: 16px;
            margin-bottom: 24px;
        }

        .metric-box {
            background: var(--bg-body);
            border-radius: var(--radius-md);
            padding: 20px;
            text-align: center;
            border: 1px solid var(--border);
            transition: all 0.2s ease;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        .metric-box:hover {
            border-color: var(--primary);
            transform: translateY(-2px);
        }

        .metric-value {
            font-size: 2.2rem; /* Larger font */
            font-weight: 800;
            color: var(--primary);
            line-height: 1.1;
            margin-bottom: 8px;
        }

        .metric-label {
            font-size: 0.9rem;
            color: var(--text-muted);
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .category-progress-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); /* Bigger Cards */
            gap: 16px;
            margin-top: 16px;
        }

        .category-progress-item {
            background: var(--bg-body);
            border-radius: var(--radius-md);
            padding: 16px;
            border-left: 5px solid var(--primary);
        }

        /* FAB STYLES - MODIFIED TO EXPAND UPWARDS */
        .fab-container {
            position: fixed;
            bottom: 70px; /* Aumentado do original 50px */
            right: 30px;  /* Movido mais para a direita */
            z-index: 2000;
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 12px;
        }
        
        .fab-button {
            width: 60px;
            height: 60px;
            background: var(--primary);
            color: white;
            border-radius: 50%;
            border: none;
            box-shadow: var(--shadow-lg);
            font-size: 1.5rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: transform 0.3s, background 0.3s;
        }
        
        .fab-button:hover { transform: scale(1.1); background: var(--primary-hover); }
        .fab-button.active { transform: rotate(45deg); background: var(--danger); }
        
        .fab-menu {
            display: flex;
            flex-direction: column;
            gap: 12px;
            align-items: flex-end;
            margin-bottom: 12px;
            opacity: 0;
            pointer-events: none;
            transform: translateY(20px);
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        
        .fab-container.open .fab-menu {
            opacity: 1;
            pointer-events: all;
            transform: translateY(0);
        }
        
        .fab-item {
            display: flex;
            align-items: center;
            gap: 12px;
            background: transparent;
            border: none;
            cursor: pointer;
        }
        
        .fab-icon {
            width: 48px;
            height: 48px;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-muted);
            box-shadow: var(--shadow-md);
            transition: all 0.2s;
            font-size: 1.2rem;
        }
        
        .fab-item:hover .fab-icon {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }
        
        .fab-label {
            background: var(--text-main);
            color: var(--bg-card);
            padding: 4px 10px;
            border-radius: 4px;
            font-size: 0.8rem;
            font-weight: 600;
            opacity: 0;
            transition: opacity 0.2s;
            pointer-events: none;
            box-shadow: var(--shadow-sm);
        }
        
        .fab-container.open .fab-label { opacity: 1; }

        /* Sim History Table Styles */
        .sim-table-row {
            display: grid;
            grid-template-columns: 1.5fr 1fr 1fr 0.5fr;
            padding: 14px 10px;
            border-bottom: 1px solid var(--border);
            align-items: center;
            cursor: pointer;
            transition: background 0.2s;
        }
        .sim-table-row:hover { background: var(--bg-body); }
        .sim-table-header { font-weight: 700; color: var(--text-muted); font-size: 0.85rem; text-transform: uppercase; background: var(--bg-body); border-radius: 8px 8px 0 0; }
        
        /* Progress Indicator in Card */
        .card-progress-counter {
            position: absolute;
            top: 20px;
            right: 20px;
            background: var(--bg-body);
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 700;
            color: var(--text-muted);
            border: 1px solid var(--border);
        }

        /* --- NEW STYLES FOR TEMPLATES --- */
        .template-actions { display: flex; gap: 8px; margin-top: 8px; }
        .btn-template { 
            font-size: 0.8rem; padding: 6px 12px; border-radius: 6px; border: none; 
            cursor: pointer; display: flex; align-items: center; gap: 6px; 
            transition: transform 0.2s; color: white; font-weight: 600;
        }
        .btn-save-tmpl { background: var(--info); }
        .btn-load-tmpl { background: var(--success); }
        .btn-template:hover { transform: translateY(-2px); opacity: 0.9; }
        
        .template-item { 
            display: flex; justify-content: space-between; align-items: center; 
            padding: 12px; border: 1px solid var(--border); border-radius: 8px; 
            margin-bottom: 8px; background: var(--bg-card); cursor: pointer;
            transition: background 0.2s;
        }
        .template-item:hover { border-color: var(--primary); background: var(--bg-body); }
        .template-list { max-height: 300px; overflow-y: auto; margin-top: 10px; }

        @media (max-width: 900px) {
            #dash-main-row { grid-template-columns: 1fr 1fr; }
            .performance-metrics { grid-template-columns: 1fr 1fr; }
            .pomodoro-layout { grid-template-columns: 1fr; }
        }

        @media (max-width: 768px) {
            .sidebar { display: none; }
            .bottom-nav { display: flex; }
            .main-content { padding: 20px 16px; margin-bottom: 80px; }
            .card-box { padding: 24px; }
            .file-actions { opacity: 1; }
            .topic-card-count { font-size: 0.7rem; padding: 1px 6px; }
            .create-grid { grid-template-columns: 1fr; }
            #dash-main-row { grid-template-columns: 1fr; }
            .performance-metrics { grid-template-columns: 1fr; }
            .category-progress-grid { grid-template-columns: 1fr; }
            /* FAB Mobile Adjustment */
            .fab-container { bottom: 85px; right: 20px; }
            .hero-header-card { flex-direction: column; align-items: flex-start; }
            .hero-actions { width: 100%; justify-content: space-between; margin-top: 12px; }
            .banner-period-btn { flex: 1; text-align: center; }
            .pomodoro-layout { grid-template-columns: 1fr; }
            .floating-timer { bottom: 92px; right: 90px; }
            .sim-table-row { grid-template-columns: 1fr 1fr 0.5fr; } /* Hide score details on small mobile maybe */
        }
    
#auth-wrapper {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: var(--bg-body);
            z-index: 9999;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            overflow-y: auto;
        }
        
        .auth-card {
            background: var(--bg-card);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-lg);
            padding: 40px;
            width: 100%;
            max-width: 400px;
            border: 1px solid var(--border);
            text-align: center;
            animation: fadeIn 0.4s ease-out;
        }

        .auth-logo {
            font-size: 3rem;
            color: var(--primary);
            margin-bottom: 10px;
        }

        .auth-title {
            font-size: 1.8rem;
            font-weight: 800;
            color: var(--text-main);
            margin-bottom: 8px;
        }

        .auth-subtitle {
            color: var(--text-muted);
            margin-bottom: 30px;
            font-size: 0.95rem;
        }

        .auth-form {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .auth-footer {
            margin-top: 24px;
            font-size: 0.9rem;
            color: var(--text-muted);
        }

        .auth-link {
            color: var(--primary);
            font-weight: 700;
            cursor: pointer;
            text-decoration: none;
        }
        .auth-link:hover { text-decoration: underline; }

        .error-message {
            background: #fee2e2;
            color: #b91c1c;
            padding: 10px;
            border-radius: var(--radius-sm);
            font-size: 0.85rem;
            margin-bottom: 16px;
            display: none;
            text-align: left;
            border: 1px solid #fecaca;
        }

        /* --- APP CONTENT WRAPPER --- */
        #app-content {
            display: flex;
            width: 100%;
            height: 100%;
            overflow: hidden;
        }
        
        #app-content.hidden {
            display: none !important;
        }

        /* SCROLLBAR & REST OF STYLES */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        .dark-mode ::-webkit-scrollbar-thumb { background: #475569; }

        /* SIDEBAR APRIMORADA - ALWAYS COLLAPSED */
        .sidebar {
            width: var(--sidebar-width);
            background: var(--bg-nav);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            padding: 24px 12px; 
            z-index: 100;
            padding-top: 40px;
            transition: background 0.3s;
            position: relative;
        }

        .nav-links { display: flex; flex-direction: column; gap: 8px; flex: 1; margin-top: 20px; overflow: hidden; }

        .nav-item {
            display: flex; align-items: center; justify-content: center; /* Centered for icons */
            gap: 12px; padding: 14px 0;
            border-radius: var(--radius-sm); color: var(--text-muted);
            font-weight: 600; cursor: pointer; transition: all 0.2s;
            border: none; background: none; width: 100%; 
            font-size: 0.95rem; white-space: nowrap; 
            position: relative;
        }

        .nav-item:hover { background: var(--primary-light); color: var(--primary); }
        .nav-item.active { background: var(--primary); color: white; box-shadow: var(--shadow-sm); }
        
        .nav-item i { 
            min-width: 24px; 
            text-align: center; 
            font-size: 1.1rem; 
            margin: 0;
        }
        
        /* Tooltip style for Sidebar Legend */
        .nav-item span { 
            position: absolute;
            left: 70px;
            background: var(--text-main);
            color: var(--bg-card);
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 0.85rem;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s ease-in-out;
            box-shadow: var(--shadow-md);
            z-index: 200;
            white-space: nowrap;
        }

        .nav-item:hover span { opacity: 1; }

        /* BOTTOM NAV */
        .bottom-nav {
            display: none; position: fixed; bottom: 0; left: 0; width: 100%;
            background: var(--bg-nav); height: var(--nav-height); border-top: 1px solid var(--border);
            z-index: 1000; justify-content: space-around; align-items: center;
            padding-bottom: env(safe-area-inset-bottom);
            transition: background 0.3s;
        }

        .bottom-nav-item {
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            color: var(--text-muted); font-size: 0.75rem; font-weight: 600; gap: 4px;
            background: none; border: none; width: 100%; height: 100%;
        }
        .bottom-nav-item.active { color: var(--primary); }
        .bottom-nav-item i { font-size: 1.4rem; margin-bottom: 2px; }

        /* MAIN AREA */
        .main-content {
            flex: 1; height: 100%; overflow-y: auto; overflow-x: hidden;
            padding: 24px 32px; position: relative;
        }

        .page-header { margin-bottom: 24px; display: flex; align-items: center; justify-content: space-between; }
        #page-title-display { font-weight: 800; font-size: 1.5rem; color: var(--text-main); letter-spacing: -0.5px; }

        .header-actions { display: flex; gap: 12px; align-items: center; }

        .header-btn-icon {
            width: 40px; height: 40px; border-radius: 50%; border: 1px solid var(--border);
            background: var(--bg-card); color: var(--text-main); display: flex; align-items: center;
            justify-content: center; cursor: pointer; font-size: 1.1rem;
            transition: all 0.2s;
        }
        .header-btn-icon:hover {
            border-color: var(--primary);
            color: var(--primary);
            background: var(--primary-light);
        }

        .view-section { max-width: 1000px; margin: 0 auto; padding-bottom: 100px; animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .hidden { display: none !important; }

        .card-box {
            background: var(--bg-card); border-radius: var(--radius-lg);
            padding: 24px; box-shadow: var(--shadow-sm); border: 1px solid var(--border);
            margin-bottom: 20px; transition: background 0.3s, border 0.3s;
        }

        /* Fix spacing inside grids */
        .dashboard-grid .card-box { margin-bottom: 0; height: 100%; }

        h3 { font-size: 1.15rem; font-weight: 700; color: var(--text-main); margin-bottom: 16px; }

        /* BUTTONS & INPUTS */
        .action-btn {
            background: var(--primary); color: white; border: none; padding: 14px 24px;
            border-radius: var(--radius-md); font-weight: 600; font-size: 1rem;
            cursor: pointer; display: inline-flex; align-items: center; justify-content: center;
            gap: 8px; width: 100%; transition: background 0.2s;
        }
        .action-btn:hover { background: var(--primary-hover); }
        .action-btn:active { transform: scale(0.98); }
        .action-btn:disabled { opacity: 0.6; cursor: not-allowed; transform: none; }
        
        .btn-outline { background: var(--bg-card); border: 1px solid var(--border); color: var(--text-main); cursor: pointer; border-radius: var(--radius-md); padding: 12px 20px; font-weight: 600; font-size: 0.95rem; }
        .btn-outline:hover { background: var(--bg-body); border-color: var(--text-muted); }
        .btn-danger { background: var(--danger); color: white; border: none;}
        .btn-sm { padding: 8px 16px; font-size: 0.85rem; width: auto; border-radius: 8px; }
        .btn-icon { width: 38px; height: 38px; border-radius: 50%; padding: 0; display: flex; align-items: center; justify-content: center; border: 1px solid var(--border); background: var(--bg-card); cursor: pointer; color: var(--text-muted); font-size: 1.1rem; }
        .btn-icon:hover { color: var(--primary); border-color: var(--primary); background: var(--primary-light); }
        .btn-back { border: none; padding: 10px 0; margin-bottom: 16px; color: var(--text-muted); font-size: 1.1rem; display: flex; align-items: center; gap: 8px; background: transparent; cursor: pointer; }
        .btn-back:hover { color: var(--primary); }

        input, select, textarea {
            width: 100%; padding: 14px; border-radius: var(--radius-md);
            border: 1px solid var(--border); background: var(--input-bg);
            font-family: inherit; font-size: 1.05rem; margin-bottom: 16px; color: var(--text-main);
        }
        
        /* Remove default focus outline and add custom style */
        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px var(--primary-light);
        }

        .editor-toolbar { display: flex; gap: 8px; margin-bottom: 12px; padding: 4px; background: var(--bg-body); border-radius: 8px; border: 1px solid var(--border); width: fit-content; }
        
        /* --- SEARCH DROPDOWN STYLES --- */
        .search-container { position: relative; width: 100%; margin-bottom: 12px; }
        .search-results-list {
            position: absolute;
            top: 100%;
            left: 0;
            width: 100%;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
            max-height: 200px;
            overflow-y: auto;
            z-index: 2500;
            box-shadow: var(--shadow-lg);
            display: none;
        }
        .search-result-item {
            padding: 10px 14px;
            border-bottom: 1px solid var(--bg-body);
            cursor: pointer;
            transition: background 0.2s;
            font-size: 0.9rem;
            color: var(--text-main);
        }
        .search-result-item:last-child { border-bottom: none; }
        .search-result-item:hover { background: var(--bg-body); color: var(--primary); }
        .search-result-item strong { display: block; font-size: 0.95rem; }
        .search-result-item span { font-size: 0.8rem; color: var(--text-muted); }

        /* --- HERO HEADER STYLES --- */
        .hero-header-card {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            border: none;
            overflow: hidden;
            position: relative;
            margin-bottom: 24px;
            padding: 24px;
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-md);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .hero-bg-icon {
            position: absolute; right: -20px; bottom: -30px; font-size: 10rem; opacity: 0.1; pointer-events: none;
        }
        .hero-content {
            position: relative; z-index: 2; width: 100%; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 16px;
        }
        .hero-title {
            color: white; margin: 0; font-size: 1.3rem; font-weight: 800;
        }
        .hero-subtitle {
            opacity: 0.9; margin-top: 4px; font-size: 0.9rem; font-weight: 500;
        }
        .hero-actions {
            display: flex;
            background: rgba(255,255,255,0.2);
            padding: 4px;
            border-radius: 12px;
            gap: 4px;
        }
        .banner-period-btn {
            background: transparent;
            border: none;
            color: rgba(255,255,255,0.8);
            padding: 8px 16px;
            border-radius: 8px;
            font-weight: 600;
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.2s;
        }
        .banner-period-btn:hover {
            background: rgba(255,255,255,0.1);
            color: white;
        }
        .banner-period-btn.active {
            background: white;
            color: var(--primary);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        /* --- STYLES FOR UNIFIED STUDY VIEW --- */
        .study-nav-container {
            display: flex;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: var(--radius-lg);
            padding: 6px;
            margin-bottom: 24px;
            gap: 6px;
        }

        .study-nav-btn {
            flex: 1;
            padding: 12px;
            border: none;
            background: transparent;
            color: var(--text-muted);
            border-radius: var(--radius-md);
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .study-nav-btn:hover {
            background: var(--bg-body);
            color: var(--text-main);
        }

        .study-nav-btn.active {
            background: var(--primary);
            color: white;
            box-shadow: var(--shadow-sm);
        }

        /* --- POMODORO STYLES --- */
        .pomodoro-layout { display: grid; grid-template-columns: 1fr 1fr; gap: 24px; }
        .timer-card { text-align: center; display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 400px; }
        .pomo-tabs { display: flex; background: var(--bg-body); padding: 4px; border-radius: 30px; margin-bottom: 30px; width: fit-content; border: 1px solid var(--border); }
        .pomo-tab { padding: 8px 20px; border-radius: 25px; cursor: pointer; border: none; background: transparent; color: var(--text-muted); font-weight: 600; transition: all 0.3s; }
        .pomo-tab.active { background: var(--bg-card); color: var(--primary); box-shadow: var(--shadow-sm); }
        
        .timer-display { font-size: 5rem; font-weight: 800; font-feature-settings: "tnum"; font-variant-numeric: tabular-nums; color: var(--text-main); margin: 20px 0; line-height: 1; }
        
        .timer-controls { display: flex; gap: 16px; align-items: center; margin-bottom: 30px; }
        .btn-pomo-main { width: 70px; height: 70px; border-radius: 50%; font-size: 1.5rem; display: flex; align-items: center; justify-content: center; background: var(--primary); color: white; border: none; cursor: pointer; transition: transform 0.2s, background 0.2s; box-shadow: var(--shadow-md); }
        .btn-pomo-main:hover { transform: scale(1.1); background: var(--primary-hover); }
        .btn-pomo-sec { width: 50px; height: 50px; border-radius: 50%; background: var(--bg-body); color: var(--text-muted); border: 1px solid var(--border); display: flex; align-items: center; justify-content: center; font-size: 1rem; cursor: pointer; transition: all 0.2s; }
        .btn-pomo-sec:hover { background: var(--bg-card); color: var(--primary); border-color: var(--primary); }

        .pomo-history-list { display: flex; flex-direction: column; gap: 10px; max-height: 400px; overflow-y: auto; }
        .pomo-item { display: flex; align-items: center; justify-content: space-between; padding: 14px 16px; background: var(--bg-card); border: 1px solid var(--border); border-radius: var(--radius-md); transition: all 0.2s; }
        .pomo-item:hover { border-color: var(--primary); transform: translateX(2px); }
        .pomo-info h4 { margin: 0; font-size: 0.95rem; color: var(--text-main); }
        .pomo-info span { font-size: 0.8rem; color: var(--text-muted); display: block; margin-top: 2px; }
        .pomo-actions { display: flex; gap: 8px; }
        .tag-pomo { background: var(--primary-light); color: var(--primary); }
        .tag-short { background: #dbeafe; color: var(--info); }
        .tag-long { background: #d1fae5; color: var(--success); }

        /* FLOATING TIMER WIDGET - Updated Position and Layout */
        .floating-timer {
            position: fixed;
            bottom: 77px; /* Align vertical center with FAB (bottom ~70px + ~1/2 height) */
            right: 105px; /* Position to the left of FAB */
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: 10px 20px;
            border-radius: 30px;
            box-shadow: var(--shadow-lg);
            display: flex;
            flex-direction: row; 
            align-items: center;
            justify-content: center;
            border: 1px solid var(--border);
            z-index: 1900;
            transform: translateX(200%);
            transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            pointer-events: none; /* Read only */
        }
        .dark-mode .floating-timer { background: rgba(30, 41, 59, 0.95); }
        .floating-timer.visible { transform: translateX(0); }
        
        .float-time { font-weight: 800; font-variant-numeric: tabular-nums; color: var(--primary); font-size: 1.5rem; line-height: 1; }

        /* --- NEW CREATE CARD STYLES REFINED --- */
        .create-container {
            display: flex;
            flex-direction: column;
            gap: 24px;
        }

        .create-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .create-label {
            font-size: 0.75rem;
            font-weight: 700;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
            display: block;
        }

        .rich-editor {
            min-height: 120px;
            padding: 20px;
            background: var(--input-bg);
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
            font-size: 1.1rem;
            line-height: 1.5;
            transition: all 0.2s;
            color: var(--text-main);
        }

        .rich-editor:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px var(--primary-light);
        }

        .answer-group {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .answer-block {
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
            padding: 12px 16px;
            background: var(--bg-card);
            position: relative;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .answer-block:focus-within {
            border-color: var(--primary);
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
            transform: translateY(-1px);
        }

        .answer-block input {
            border: none;
            background: transparent;
            padding: 8px 0;
            margin: 0;
            font-size: 1rem;
            width: 100%;
            color: var(--text-main);
            box-shadow: none !important; /* Force remove default focus shadow on inner input */
        }
        
        .answer-block input:focus {
             outline: none;
             box-shadow: none;
             border: none;
        }

        .answer-block.correct-answer {
            background: linear-gradient(to right, rgba(16, 185, 129, 0.05), transparent);
            border-left: 4px solid var(--success);
        }
        
        .answer-block.correct-answer:focus-within {
            border-color: var(--success);
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.1);
        }

        .answer-block.wrong-answer {
            border-left: 4px solid var(--border);
        }
        
        .answer-block.wrong-answer:focus-within {
            border-left-color: var(--danger);
            border-color: var(--text-muted);
        }

        .answer-icon {
            font-size: 1.1rem;
            color: var(--text-muted);
            opacity: 0.5;
            flex-shrink: 0;
        }
        
        .correct-answer .answer-icon { color: var(--success); opacity: 1; }

        /* --- FLASHCARDS & STUDY --- */
        .flashcard-display {
            background: var(--bg-card); border-radius: var(--radius-lg); padding: 40px 24px;
            text-align: left; box-shadow: var(--shadow-lg); border: 1px solid var(--border);
            position: relative; overflow: hidden;
        }
        .question-text {
            font-size: 1.25rem; font-weight: 600; color: var(--text-main);
            margin: 16px 0 24px; line-height: 1.6; text-align: left;
        }
        .option-btn {
            background: var(--bg-card); border: 2px solid var(--border); padding: 18px;
            border-radius: var(--radius-md); font-size: 1.05rem; color: var(--text-main);
            font-weight: 500; text-align: left; cursor: pointer; transition: all 0.2s;
            margin-bottom: 12px; width: 100%;
            display: flex; gap: 8px; align-items: flex-start;
        }
        .option-btn:hover { border-color: var(--primary); transform: translateX(4px); }
        .option-btn:disabled { cursor: default; transform: none !important; }
        .option-btn strong { color: var(--primary); margin-right: 4px; }
        
        .option-btn.selected { 
            background: var(--bg-body); 
            border-color: var(--info); 
            box-shadow: 0 0 0 1px var(--info);
        }

        .option-btn.correct { background: rgba(16, 185, 129, 0.1); border-color: var(--success); color: var(--success); }
        .option-btn.wrong { background: rgba(239, 68, 68, 0.1); border-color: var(--danger); color: var(--danger); }
        
        /* List Styles */
        .card-list-item {
            background: var(--bg-card); border-radius: var(--radius-md); padding: 20px;
            border: 1px solid var(--border); box-shadow: var(--shadow-sm);
            margin-bottom: 16px; transition: transform 0.2s, box-shadow 0.2s;
            display: flex; flex-direction: column; gap: 12px;
        }
        .card-list-item:hover { transform: translateY(-2px); box-shadow: var(--shadow-md); border-color: var(--primary); }
        .card-meta { display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 8px; }
        .card-badge {
            font-size: 0.8rem; font-weight: 800; color: var(--primary);
            background: var(--primary-light); padding: 4px 10px; border-radius: 12px; text-transform: uppercase;
        }
        .next-review-badge { font-size: 0.8rem; font-weight: 600; color: var(--text-muted); display: flex; align-items: center; gap: 4px; }

        /* ID Badge Style */
        .id-badge {
            font-family: monospace; font-size: 0.75rem; background: var(--bg-body); 
            padding: 2px 6px; border-radius: 4px; color: var(--text-muted); border: 1px solid var(--border);
        }

        /* --- SYLLABUS, PERFORMANCE, NOTES, SCHEDULE (Kept same) --- */
        .syllabus-item { background: var(--bg-card); border: 1px solid var(--border); border-radius: var(--radius-md); padding: 20px; margin-bottom: 16px; cursor: pointer; transition: all 0.2s; display: flex; justify-content: space-between; align-items: center; }
        .syllabus-item:hover { transform: translateY(-2px); box-shadow: var(--shadow-md); border-color: var(--primary); }
        
        /* Refined Subject/Topic Styling */
        .subject-container { 
            background: var(--bg-card); 
            border: 1px solid var(--border);
            border-left: 4px solid var(--primary);
            border-radius: var(--radius-md); 
            margin-bottom: 20px; 
            overflow: hidden; 
            box-shadow: var(--shadow-sm);
            transition: box-shadow 0.2s;
        }
        .subject-container:hover {
            box-shadow: var(--shadow-md);
        }
        .subject-header { 
            padding: 18px 24px; 
            background: var(--bg-card); 
            border-bottom: 1px solid var(--bg-body); 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            cursor: pointer; 
            user-select: none; 
            transition: background 0.2s;
        }
        .subject-header:hover { background: var(--bg-body); }
        .subject-title { font-weight: 700; color: var(--text-main); font-size: 1rem; display: flex; align-items: center; gap: 10px; }
        
        .subject-progress { width: 100px; height: 8px; background: #e2e8f0; border-radius: 4px; overflow: hidden; margin-left: auto; margin-right: 16px; }
        .subject-progress-bar { height: 100%; background: var(--success); width: 0%; transition: width 0.5s ease; }
        
        .topic-list { padding: 0; background: var(--bg-card); }
        .topic-row { 
            display: flex; 
            align-items: center; 
            padding: 16px 24px; 
            border-bottom: 1px solid var(--bg-body); 
            transition: background 0.2s; 
        }
        .topic-row:last-child { border-bottom: none; }
        .topic-row:hover { background: var(--bg-body); }
        
        .topic-check { 
            width: 24px; height: 24px; 
            border: 2px solid var(--text-muted); 
            border-radius: 50%; /* Rounded checkbox */
            margin-right: 16px; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            cursor: pointer; 
            flex-shrink: 0; 
            color: white; 
            transition: all 0.2s; 
            font-size: 0.8rem;
        }
        .topic-row.done .topic-check { background: var(--success); border-color: var(--success); }
        .topic-row.done span { text-decoration: line-through; color: var(--text-muted); }
        
        .category-stat-item { display: flex; align-items: center; justify-content: space-between; padding: 16px 20px; border-bottom: 1px solid var(--bg-body); background: var(--bg-card); transition:background 0.2s; }
        .category-stat-item:last-child { border-bottom: none; }
        .category-stat-item:hover { background: var(--bg-body); }
        
        .cat-name { font-weight: 600; font-size: 1rem; color: var(--text-main); margin-bottom: 4px; }
        .cat-bar-bg { width: 100%; height: 8px; background: var(--bg-body); border-radius: 4px; overflow: hidden; }
        .cat-bar-fill { height: 100%; border-radius: 4px; transition: width 0.5s ease; }
        .cat-percent { font-weight: 700; font-size: 0.9rem; color: var(--text-main); min-width: 45px; text-align: right; margin-left: 10px; }
        .stats-summary-box { display: flex; justify-content: space-around; align-items: center; text-align: center; padding: 32px 16px; }
        .stat-big-item { flex: 1; }
        .stat-big-item .label { font-size: 0.9rem; opacity:0.8; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 8px; color:white; }
        .stat-big-item .value { font-size: 2.8rem; font-weight: 800; color: white; line-height: 1; }
        .stat-divider { width: 1px; height: 50px; background: rgba(255,255,255,0.3); margin: 0 10px; }
        
        .schedule-layout { display: flex; flex-direction: column; gap: 24px; }
        .task-section, .calendar-wrapper { background: var(--bg-card); border-radius: var(--radius-lg); padding: 24px; box-shadow: var(--shadow-sm); border: 1px solid var(--border); }
        
        /* UPDATED TASK LIST STYLES */
        .task-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 20px; }
        .task-list { display: flex; flex-direction: column; gap: 10px; min-height: 20px; /* Reduced min-height to fix whitespace */ }
        .task-item { 
            background: var(--bg-card); 
            border: 1px solid var(--border); 
            color: var(--text-main); 
            padding: 16px 20px; 
            border-radius: var(--radius-md); 
            display: flex; 
            align-items: center; 
            gap: 16px; 
            transition: all 0.2s;
            box-shadow: var(--shadow-sm);
        }
        .task-item:hover { border-color: var(--primary); transform: translateY(-2px); box-shadow: var(--shadow-md); }
        .task-check { 
            width: 24px; height: 24px; 
            border: 2px solid var(--text-muted); 
            border-radius: 50%; 
            display: flex; align-items: center; justify-content: center; 
            cursor: pointer; color: white; flex-shrink: 0;
            transition: all 0.2s;
        }
        .task-item.completed .task-check { background: var(--success); border-color: var(--success); }
        .task-item.completed span { text-decoration: line-through; color: var(--text-muted); }
        
        .schedule-grid-container { overflow-x: auto; position: relative; max-height: 600px; padding-bottom: 20px; }
        .modern-table { width: 100%; border-collapse: separate; border-spacing: 0; min-width: 900px; table-layout: fixed; border-radius: var(--radius-md); overflow: hidden; border: 1px solid var(--border); }
        .modern-table th { background: var(--bg-body); color: var(--text-muted); border-bottom: 1px solid var(--border); padding: 16px; position: sticky; top: 0; z-index: 20; font-weight: 700; text-transform: uppercase; font-size: 0.8rem; }
        .modern-table td { border-right: 1px solid var(--border); border-bottom: 1px solid var(--border); height: 70px; vertical-align: middle; padding: 4px; position: relative; background: var(--bg-card); transition: background 0.2s; }
        .modern-table td:hover { background: var(--bg-body); }
        .modern-table td.time-label { background: var(--bg-body); color: var(--text-muted); border-right: 1px solid var(--border); width: 80px; text-align: center; position: sticky; left: 0; z-index: 10; font-size: 0.8rem; font-weight: bold; }
        
        .event-block { height: 100%; width: 100%; border-radius: 6px; padding: 4px 8px; font-size: 0.75rem; font-weight: 600; color: white; box-shadow: 0 2px 4px rgba(0,0,0,0.05); cursor: pointer; display: flex; align-items: center; gap: 6px; overflow: hidden; white-space: nowrap; text-overflow: ellipsis; transition: transform 0.2s; }
        .event-block:hover { transform: scale(1.02); }
        .empty-cell-btn { position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; opacity: 0; color: var(--primary); font-size: 1.4rem; cursor: pointer; transition: opacity 0.2s; }
        td:hover .empty-cell-btn { opacity: 0.6; background: rgba(0,0,0,0.02); }
        
        .notes-breadcrumb { display: flex; align-items: center; gap: 8px; padding: 16px 20px; background: var(--bg-card); border: 1px solid var(--border); border-radius: var(--radius-md); margin-bottom: 24px; overflow-x: auto; white-space: nowrap; box-shadow: var(--shadow-sm); }
        .breadcrumb-item { color: var(--text-muted); font-size: 0.95rem; cursor: pointer; display: flex; align-items: center; gap: 8px; font-weight: 500; transition: color 0.2s; }
        .breadcrumb-item:hover { color: var(--primary); }
        .breadcrumb-item.active { color: var(--text-main); font-weight: 700; pointer-events: none; }
        
        .file-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: 20px; }
        .file-item { 
            background: var(--bg-card); 
            border: none; 
            border-radius: var(--radius-lg); 
            padding: 24px 16px; 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            text-align: center; 
            cursor: pointer; 
            position: relative; 
            transition: all 0.2s; 
            box-shadow: var(--shadow-sm); 
            aspect-ratio: 1/1; 
            justify-content: center; 
            border: 1px solid var(--border);
        }
        .file-item:hover { transform: translateY(-4px); box-shadow: var(--shadow-lg); border-color: var(--primary); }
        .file-icon { font-size: 3.5rem; margin-bottom: 16px; transition: transform 0.2s; }
        .file-item:hover .file-icon { transform: scale(1.1); }
        .file-name { font-size: 1rem; font-weight: 600; line-height: 1.3; overflow: hidden; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; color: var(--text-main); }
        .file-actions { position: absolute; top: 12px; right: 12px; display: flex; gap: 6px; opacity: 0; transition: opacity 0.2s; }
        .file-item:hover .file-actions { opacity: 1; }
        
        /* NEW: Study Control Bar (Buttons) */
        .study-controls-container {
            display: flex;
            flex-direction: column;
            gap: 16px;
            margin-top: 24px;
            padding-top: 20px;
            border-top: 1px solid var(--border);
        }
        
        .nav-buttons-row {
            display: flex;
            gap: 12px;
            justify-content: center;
        }

        .btn-study-rect {
            background: var(--bg-card);
            border: 1px solid var(--border);
            color: var(--text-muted);
            border-radius: 12px;
            padding: 12px 24px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.2s;
            flex: 1;
            justify-content: center;
            box-shadow: var(--shadow-sm);
        }
        
        .btn-study-rect:hover {
            border-color: var(--primary);
            color: var(--primary);
            background: var(--bg-body);
        }
        
        .btn-study-rect:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none !important;
        }

        .btn-study-confirm {
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 12px;
            padding: 16px 32px;
            font-size: 1.1rem;
            font-weight: 700;
            width: 100%;
            cursor: pointer;
            box-shadow: var(--shadow-md);
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        
        .btn-study-confirm:hover {
            background: var(--primary-hover);
            transform: translateY(-2px);
        }

        .sim-result-card {
            background: var(--bg-card);
            border-radius: var(--radius-lg);
            border: 1px solid var(--border);
            overflow: hidden;
            box-shadow: var(--shadow-md);
            margin-bottom: 24px;
        }

        .sim-result-header {
            padding: 30px;
            text-align: center;
            background: linear-gradient(135deg, var(--bg-body), var(--bg-card));
            border-bottom: 1px solid var(--border);
        }

        .sim-score-big {
            font-size: 4rem;
            font-weight: 800;
            color: var(--text-main);
            line-height: 1;
            margin-bottom: 4px;
        }

        .sim-score-label {
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--text-muted);
            font-weight: 600;
        }

        .sim-stats-row {
            display: flex;
            border-bottom: 1px solid var(--border);
        }

        .sim-stat-box {
            flex: 1;
            padding: 20px;
            text-align: center;
            border-right: 1px solid var(--border);
        }
        .sim-stat-box:last-child { border-right: none; }

        .sim-stat-val {
            font-size: 1.4rem;
            font-weight: 800;
            margin-bottom: 4px;
        }

        .sim-log-container {
            padding: 20px;
            background: var(--bg-body);
            max-height: 400px;
            overflow-y: auto;
        }

        .sim-log-item {
            background: var(--bg-card);
            padding: 16px;
            border-radius: var(--radius-md);
            margin-bottom: 12px;
            border: 1px solid var(--border);
            border-left: 4px solid var(--border);
            box-shadow: var(--shadow-sm);
        }

        .sim-log-item.correct { border-left-color: var(--success); }
        .sim-log-item.wrong { border-left-color: var(--danger); }
        
        /* NEW: Sim History Card List Style */
        .sim-history-card {
            display: flex;
            align-items: center;
            background: var(--bg-card);
            padding: 16px 20px;
            border-radius: var(--radius-md);
            border: 1px solid var(--border);
            margin-bottom: 12px;
            transition: all 0.2s;
            cursor: pointer;
        }
        .sim-history-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
            border-color: var(--primary);
        }
        
        .sim-hist-date {
            display: flex;
            flex-direction: column;
            margin-right: 20px;
        }
        .sim-hist-day { font-weight: 700; font-size: 1.1rem; color: var(--text-main); }
        .sim-hist-time { font-size: 0.8rem; color: var(--text-muted); }
        
        .sim-hist-score {
            font-size: 1.5rem;
            font-weight: 800;
            margin-left: auto;
            color: var(--text-main);
        }
        
        .sim-hist-pct {
            font-size: 0.85rem;
            font-weight: 700;
            padding: 4px 8px;
            border-radius: 6px;
            margin-left: 16px;
        }
        .bg-success-light { background: #dcfce7; color: var(--success); }
        .bg-warning-light { background: #fef3c7; color: var(--warning); }
        .bg-danger-light { background: #fee2e2; color: var(--danger); }

        .sim-config-item { display: flex; justify-content: space-between; align-items: center; padding: 12px; border: 1px solid var(--border); border-radius: var(--radius-md); margin-bottom: 10px; background: var(--bg-body); }
        .sim-config-item label { margin: 0; font-weight: 600; flex: 1; color: var(--text-main); font-size: 0.95rem; }
        .sim-config-item input[type="number"] { width: 70px; margin-bottom: 0; padding: 8px; font-size: 0.9rem; text-align: center; }
        .subject-controls { display: flex; gap: 6px; align-items: center; }
        .subject-controls .btn-icon { width: 30px; height: 30px; font-size: 0.8rem; border: none; background: transparent; color: var(--text-muted); }
        .subject-controls .btn-icon:hover { background: var(--bg-body); }
        .topic-controls { display: flex; gap: 4px; align-items: center; }
        .topic-controls .btn-icon { width: 26px; height: 26px; font-size: 0.7rem; border: none; background: transparent; color: var(--text-muted); }
        .topic-controls .btn-icon:hover { background: var(--bg-body); }
        .draggable-item { cursor: move; padding: 12px; background: var(--bg-card); border: 1px solid var(--border); border-radius: var(--radius-sm); margin-bottom: 8px; display: flex; align-items: center; gap: 12px; transition: all 0.2s; }
        .draggable-item:hover { background: var(--bg-body); border-color: var(--primary); }
        .draggable-item.dragging { opacity: 0.5; background: var(--primary-light); }
        .drag-handle { color: var(--text-muted); cursor: move; padding: 4px; }
        .drag-handle:hover { color: var(--primary); }
        .topic-card-count { margin-right: 8px; font-size: 0.75rem; background: var(--primary); color: white; border: none; border-radius: 4px; padding: 2px 8px; cursor: pointer; transition: all 0.2s; }
        .topic-card-count:hover { background: var(--primary-hover); transform: scale(1.05); }
        #link-topic-unlink-btn { background: var(--danger); color: white; border: none; }
        #link-topic-unlink-btn:hover { background: #dc2626; }
        .dashboard-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; margin-bottom: 12px; }
        .welcome-card { background: linear-gradient(135deg, var(--primary), var(--secondary)); color: white; border: none; grid-column: 1 / -1; display: flex; flex-direction: column; justify-content: center; min-height: 160px; }
        .welcome-card h2 { font-size: 1.8rem; margin-bottom: 8px; }
        .stat-widget { display: flex; align-items: center; gap: 16px; }
        .stat-icon { width: 50px; height: 50px; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; flex-shrink: 0; }
        .stat-info strong { font-size: 1.5rem; color: var(--text-main); font-weight: 800; }
        #dash-mini-chart { display: flex; justify-content: space-between; align-items: flex-end; height: 160px; padding-top: 20px; width: 100%; }
        .chart-col { display: flex; flex-direction: column; align-items: center; gap: 8px; flex: 1; }
        .chart-bar-container { flex: 1; display: flex; align-items: flex-end; justify-content: center; width: 100%; }
        .chart-bar { width: 12px; border-radius: 6px; transition: height 0.5s ease; min-height: 4px; }
        .chart-label { font-size: 0.75rem; color: var(--text-muted); font-weight: 600; }

        /* Specific Grid for Main Dashboard Row */
        #dash-main-row {
            grid-template-columns: 1.5fr 0.8fr 1fr;
        }

        /* PERFORMANCE VIEW UPDATED STYLES (Horizontal & Larger) */
        .performance-layout {
            display: flex;
            flex-direction: column;
            gap: 20px;
            margin-bottom: 20px;
        }

        .performance-card {
            background: var(--bg-card);
            border-radius: var(--radius-lg);
            padding: 24px;
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--border);
            transition: all 0.3s ease;
            width: 100%; /* Force full width */
        }

        .performance-card:hover {
            box-shadow: var(--shadow-md);
            transform: translateY(-2px);
        }

        /* Metrics Horizontal Row */
        .performance-metrics {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); /* Larger minimum width */
            gap: 16px;
            margin-bottom: 24px;
        }

        .metric-box {
            background: var(--bg-body);
            border-radius: var(--radius-md);
            padding: 20px;
            text-align: center;
            border: 1px solid var(--border);
            transition: all 0.2s ease;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        .metric-box:hover {
            border-color: var(--primary);
            transform: translateY(-2px);
        }

        .metric-value {
            font-size: 2.2rem; /* Larger font */
            font-weight: 800;
            color: var(--primary);
            line-height: 1.1;
            margin-bottom: 8px;
        }

        .metric-label {
            font-size: 0.9rem;
            color: var(--text-muted);
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .category-progress-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); /* Bigger Cards */
            gap: 16px;
            margin-top: 16px;
        }

        .category-progress-item {
            background: var(--bg-body);
            border-radius: var(--radius-md);
            padding: 16px;
            border-left: 5px solid var(--primary);
        }

        /* FAB STYLES - MODIFIED TO EXPAND UPWARDS */
        .fab-container {
            position: fixed;
            bottom: 70px; /* Aumentado do original 50px */
            right: 30px;  /* Movido mais para a direita */
            z-index: 2000;
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 12px;
        }
        
        .fab-button {
            width: 60px;
            height: 60px;
            background: var(--primary);
            color: white;
            border-radius: 50%;
            border: none;
            box-shadow: var(--shadow-lg);
            font-size: 1.5rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: transform 0.3s, background 0.3s;
        }
        
        .fab-button:hover { transform: scale(1.1); background: var(--primary-hover); }
        .fab-button.active { transform: rotate(45deg); background: var(--danger); }
        
        .fab-menu {
            display: flex;
            flex-direction: column;
            gap: 12px;
            align-items: flex-end;
            margin-bottom: 12px;
            opacity: 0;
            pointer-events: none;
            transform: translateY(20px);
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        
        .fab-container.open .fab-menu {
            opacity: 1;
            pointer-events: all;
            transform: translateY(0);
        }
        
        .fab-item {
            display: flex;
            align-items: center;
            gap: 12px;
            background: transparent;
            border: none;
            cursor: pointer;
        }
        
        .fab-icon {
            width: 48px;
            height: 48px;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-muted);
            box-shadow: var(--shadow-md);
            transition: all 0.2s;
            font-size: 1.2rem;
        }
        
        .fab-item:hover .fab-icon {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }
        
        .fab-label {
            background: var(--text-main);
            color: var(--bg-card);
            padding: 4px 10px;
            border-radius: 4px;
            font-size: 0.8rem;
            font-weight: 600;
            opacity: 0;
            transition: opacity 0.2s;
            pointer-events: none;
            box-shadow: var(--shadow-sm);
        }
        
        .fab-container.open .fab-label { opacity: 1; }

        /* Sim History Table Styles */
        .sim-table-row {
            display: grid;
            grid-template-columns: 1.5fr 1fr 1fr 0.5fr;
            padding: 14px 10px;
            border-bottom: 1px solid var(--border);
            align-items: center;
            cursor: pointer;
            transition: background 0.2s;
        }
        .sim-table-row:hover { background: var(--bg-body); }
        .sim-table-header { font-weight: 700; color: var(--text-muted); font-size: 0.85rem; text-transform: uppercase; background: var(--bg-body); border-radius: 8px 8px 0 0; }
        
        /* Progress Indicator in Card */
        .card-progress-counter {
            position: absolute;
            top: 20px;
            right: 20px;
            background: var(--bg-body);
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 700;
            color: var(--text-muted);
            border: 1px solid var(--border);
        }

        /* --- NEW STYLES FOR TEMPLATES --- */
        .template-actions { display: flex; gap: 8px; margin-top: 8px; }
        .btn-template { 
            font-size: 0.8rem; padding: 6px 12px; border-radius: 6px; border: none; 
            cursor: pointer; display: flex; align-items: center; gap: 6px; 
            transition: transform 0.2s; color: white; font-weight: 600;
        }
        .btn-save-tmpl { background: var(--info); }
        .btn-load-tmpl { background: var(--success); }
        .btn-template:hover { transform: translateY(-2px); opacity: 0.9; }
        
        .template-item { 
            display: flex; justify-content: space-between; align-items: center; 
            padding: 12px; border: 1px solid var(--border); border-radius: 8px; 
            margin-bottom: 8px; background: var(--bg-card); cursor: pointer;
            transition: background 0.2s;
        }
        .template-item:hover { border-color: var(--primary); background: var(--bg-body); }
        .template-list { max-height: 300px; overflow-y: auto; margin-top: 10px; }

        @media (max-width: 900px) {
            #dash-main-row { grid-template-columns: 1fr 1fr; }
            .performance-metrics { grid-template-columns: 1fr 1fr; }
            .pomodoro-layout { grid-template-columns: 1fr; }
        }

        @media (max-width: 768px) {
            .sidebar { display: none; }
            .bottom-nav { display: flex; }
            .main-content { padding: 20px 16px; margin-bottom: 80px; }
            .card-box { padding: 24px; }
            .file-actions { opacity: 1; }
            .topic-card-count { font-size: 0.7rem; padding: 1px 6px; }
            .create-grid { grid-template-columns: 1fr; }
            #dash-main-row { grid-template-columns: 1fr; }
            .performance-metrics { grid-template-columns: 1fr; }
            .category-progress-grid { grid-template-columns: 1fr; }
            /* FAB Mobile Adjustment */
            .fab-container { bottom: 85px; right: 20px; }
            .hero-header-card { flex-direction: column; align-items: flex-start; }
            .hero-actions { width: 100%; justify-content: space-between; margin-top: 12px; }
            .banner-period-btn { flex: 1; text-align: center; }
            .pomodoro-layout { grid-template-columns: 1fr; }
            .floating-timer { bottom: 92px; right: 90px; }
            .sim-table-row { grid-template-columns: 1fr 1fr 0.5fr; } /* Hide score details on small mobile maybe */
        }
    
</style>
</head>
<body>
<!-- LOGIN/AUTH SCREENS -->
    <div id="auth-wrapper">
        <div class="auth-card">
            <div class="auth-logo"><i class="fas fa-paw"></i></div>
            <h2 class="auth-title">TeddyApp</h2>
            <p class="auth-subtitle">Organize, estude e evolua.</p>

            <div id="auth-error-msg" class="error-message"></div>

            <!-- LOGIN FORM -->
            <form id="login-form" class="auth-form">
                <input type="email" id="login-email" placeholder="Seu e-mail" required>
                <input type="password" id="login-password" placeholder="Sua senha" required>
                <button type="submit" class="action-btn">Entrar <i class="fas fa-sign-in-alt"></i></button>
            </form>

            <!-- REGISTER FORM -->
            <form id="register-form" class="auth-form hidden">
                <input type="email" id="reg-email" placeholder="E-mail" required>
                <input type="password" id="reg-password" placeholder="Senha" required>
                <input type="password" id="reg-confirm" placeholder="Confirmar senha" required>
                <button type="submit" class="action-btn">Criar Conta</button>
            </form>

            <!-- FORGOT PASSWORD FORM -->
            <form id="forgot-form" class="auth-form hidden">
                <p style="font-size:0.9rem; color:var(--text-muted); margin-bottom:10px;">
                    Digite seu e-mail para receber um link de redefinio de senha.
                </p>
                <input type="email" id="forgot-email" placeholder="Seu e-mail cadastrado" required>
                <button type="submit" class="action-btn">Enviar Link</button>
            </form>

            <div class="auth-footer">
                <div id="login-footer">
                    No tem uma conta? <span class="auth-link" onclick="toggleAuthMode('register')">Cadastre-se</span><br>
                    <span class="auth-link" onclick="toggleAuthMode('forgot')" style="font-size:0.85rem; display:block; margin-top:8px;">Esqueci minha senha</span>
                </div>
                <div id="register-footer" class="hidden">
                    J tem uma conta? <span class="auth-link" onclick="toggleAuthMode('login')">Fazer Login</span>
                </div>
                <div id="forgot-footer" class="hidden">
                    <span class="auth-link" onclick="toggleAuthMode('login')">Voltar para o Login</span>
                </div>
            </div>
        </div>
    </div>

    
<div id="app-content" class="hidden">


    <nav class="sidebar collapsed" id="sidebar">
        <!-- Sidebar Toggle Removed -->

        <div class="nav-links">
            <button class="nav-item active" onclick="switchTab('dashboard')" title="Incio"><i class="fas fa-home"></i> <span>Incio</span></button>
            <button class="nav-item" onclick="switchTab('study')" title="Estudar"><i class="fas fa-book-open"></i> <span>Estudar</span></button>
            <button class="nav-item" onclick="switchTab('syllabus')" title="Editais"><i class="fas fa-clipboard-list"></i> <span>Editais</span></button>
            <button class="nav-item" onclick="switchTab('pomodoro')" title="Pomodoro"><i class="fas fa-stopwatch"></i> <span>Pomodoro</span></button>
            <button class="nav-item" onclick="switchTab('notes')" title="Caderno"><i class="fas fa-sticky-note"></i> <span>Caderno</span></button>
            <button class="nav-item" onclick="switchTab('schedule')" title="Cronograma"><i class="fas fa-calendar-alt"></i> <span>Cronograma</span></button>
            <button class="nav-item" onclick="switchTab('performance')" title="Dados"><i class="fas fa-chart-pie"></i> <span>Dados</span></button>
            <button class="nav-item" onclick="switchTab('settings')" title="Configuraes"><i class="fas fa-cog"></i> <span>Configuraes</span></button>
        </div>
                <!-- TAG DE VERSO BETA (Retangular - Alinhado  Esquerda) -->
        <div class="version-tag" style="
            position: absolute;
            bottom: 20px;
            left: 0;
            width: 100%;
            background: var(--primary);
            color: white;
            padding: 8px 0 8px 12px; /* Topo, Direita, Base, Esquerda (12px) */
            text-align: left;
            font-size: 0.75rem;
            cursor: default;
            z-index: 10;
            line-height: 1.2;
            box-sizing: border-box;
        ">
            <div style="font-weight: 900; letter-spacing: 1px; font-size: 0.85rem;">BETA</div>
            <div style="font-weight: 400; font-size: 0.7rem; opacity: 0.9;">v0.52</div>
        </div>

    </nav>

    <main class="main-content">
        <div class="page-header">
            <div id="page-title-display">INCIO</div>
            <div class="header-actions">
    <!-- Boto Configuraes -->
    <button class="header-btn-icon" onclick="switchTab('settings')" title="Configuraes">
        <i class="fas fa-cog"></i>
    </button>

    <!-- NOVO: Boto Telegram (Adicionado AQUI) -->
    <button class="header-btn-icon" 
            onclick="window.open('https://t.me/teddyaplicativo', '_blank')" 
            title="Canal Telegram">
        <i class="fab fa-telegram-plane"></i>
    </button>

    <!-- Boto Tema -->
    <button class="header-btn-icon theme-toggle" onclick="toggleTheme()" title="Mudar Tema">
        <i class="fas fa-moon" id="theme-icon"></i>
    </button>

    <!-- Boto Sair -->
    <button onclick="logout()" class="header-btn-icon" title="Sair / Logout" style="color: #ef4444;">
        <i class="fas fa-sign-out-alt"></i>
    </button>
</div>

        </div>

        <section id="dashboard-view" class="view-section">
            <div class="card-box welcome-card">
                <h2>Ol! </h2>
                <p id="quote-display">"O sucesso  a soma de pequenos esforos repetidos dia aps dia."</p>
                <div style="margin-top: 20px;">
                    <button class="action-btn" onclick="switchTab('study')" style="background: rgba(255,255,255,0.2); width: auto; backdrop-filter: blur(5px);">
                        Comear Agora <i class="fas fa-arrow-right"></i>
                    </button>
                </div>
            </div>
            
            <div class="dashboard-grid">
                <div class="card-box stat-widget">
                    <div class="stat-icon" style="background: var(--primary-light); color: var(--primary);"><i class="fas fa-layer-group"></i></div>
                    <div class="stat-info"><h4>Cards para Hoje</h4><strong id="dash-due-count">0</strong></div>
                </div>
                <div class="card-box stat-widget">
                    <div class="stat-icon" style="background: #fef3c7; color: var(--warning);"><i class="fas fa-fire"></i></div>
                    <div class="stat-info"><h4>Ofensiva</h4><strong id="dash-streak">0 dias</strong></div>
                </div>
                <div class="card-box stat-widget">
                    <div class="stat-icon" style="background: #e0f2fe; color: var(--info);"><i class="fas fa-clock"></i></div>
                    <div class="stat-info"><h4>Prxima Atividade</h4><div id="dash-next-task" style="font-weight:700">Nenhuma</div></div>
                </div>
            </div>

            <div id="dash-main-row" class="dashboard-grid">
                <div class="card-box">
                    <h3>Resumo Semanal</h3>
                    <div id="dash-mini-chart"></div>
                </div>

                <!-- MODIFIED: Novo Card box with solid color -->
                <div class="card-box" style="background: var(--primary); color: white; display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center; gap: 12px; border:none;">
                    <div style="background: rgba(255,255,255,0.2); width: 50px; height: 50px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; backdrop-filter: blur(5px);">
                        <i class="fas fa-plus"></i>
                    </div>
                    <h4 style="margin: 0; font-size: 1rem; color:white;">Novo Card</h4>
                    <button class="btn-sm" onclick="switchTab('study'); switchStudyTab('creator')" style="background: white; color: var(--primary); border: none; font-weight: 700; width: 80%; border-radius: 8px; cursor: pointer; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
                        Criar
                    </button>
                </div>
                
                <div class="card-box" style="display:flex; flex-direction:column;">
                    <h3 style="margin-bottom:12px;">Metas do Dia</h3>
                    <div id="dash-tasks-preview" style="flex:1; display:flex; flex-direction:column; gap:8px;">
                        <div style="text-align:center; color:var(--text-muted); font-size:0.9rem; margin-top:10px;">Carregando...</div>
                    </div>
                    <button class="btn-sm btn-outline" onclick="switchTab('schedule')" style="margin-top:12px; width:100%;">Ver Cronograma</button>
                </div>
            </div>
                        <!-- BANNER DE DOAES (TELA INICIAL) -->
            <div class="card-box" style="
                margin-top: 20px;
                background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
                color: white;
                border: none;
                display: flex;
                flex-wrap: wrap;
                gap: 24px;
                align-items: center;
                justify-content: space-between;
                position: relative;
                overflow: hidden;
            ">
                <!-- Efeito de brilho sutil no fundo -->
                <div style="position: absolute; top: -50%; left: -10%; width: 200px; height: 200px; background: rgba(255,255,255,0.1); border-radius: 50%;"></div>
                
                <div style="flex: 1; min-width: 250px; z-index: 1;">
                    <h3 style="margin-bottom: 12px; color: white; display: flex; align-items: center; gap: 10px; font-size: 1.3rem;">
                        <i class="fas fa-hand-holding-heart"></i> Apoie o Projeto
                    </h3>
                    <p style="color: rgba(255,255,255,0.95); font-size: 0.95rem; line-height: 1.6; margin-bottom: 0;">
                        Gosta do app? Ajude a manter o desenvolvimento ativo e 100% grtis! <br>
                        Sua doao traz novas atualizaes e melhorias.
                    </p>
                </div>

                <div style="text-align: center; margin: 0 auto; z-index: 1;">
                    <div style="
                        background: white; 
                        padding: 8px; 
                        border-radius: var(--radius-md); 
                        box-shadow: 0 4px 15px rgba(0,0,0,0.2);
                        display: inline-block;
                    ">
                        <!-- Imagem do QR Code -->
                        <img src="assets/qrcode.png" alt="Pix QR Code" style="width: 120px; height: 120px; display: block; border-radius: 4px;">
                    </div>
                    <div style="margin-top: 8px; font-size: 0.8rem; font-weight: 600; opacity: 0.9;">
                        <i class="fas fa-qrcode"></i> Escaneie o Pix
                    </div>
                </div>
            </div>

        </section>

        <!-- POMODORO VIEW -->
        <section id="pomodoro-view" class="view-section hidden">
            <div class="hero-header-card">
                <i class="fas fa-stopwatch hero-bg-icon"></i>
                <div class="hero-content">
                    <div>
                        <h2 class="hero-title">Pomodoro</h2>
                        <p class="hero-subtitle">Foque no que importa, com pausas estratgicas.</p>
                    </div>
                </div>
            </div>

            <div class="pomodoro-layout">
                <div class="card-box timer-card">
                    <div class="pomo-tabs">
                        <button class="pomo-tab active" id="pomo-mode-focus" onclick="setPomoMode('focus')">Pomodoro</button>
                        <button class="pomo-tab" id="pomo-mode-short" onclick="setPomoMode('short')">Descanso</button>
                        <button class="pomo-tab" id="pomo-mode-long" onclick="setPomoMode('long')">Longo</button>
                    </div>

                    <div class="timer-display" id="timer-display">25:00</div>
                    
                    <div class="timer-controls">
                         <button class="btn-pomo-sec" onclick="resetTimer()" title="Reiniciar"><i class="fas fa-undo"></i></button>
                         <button class="btn-pomo-main" id="btn-toggle-timer" onclick="toggleTimer()"><i class="fas fa-play" style="margin-left:4px;"></i></button>
                         <button class="btn-pomo-sec" onclick="openPomoSettings()" title="Configurar"><i class="fas fa-cog"></i></button>
                    </div>
                    
                    <button class="btn-sm btn-outline" onclick="finishPomoSession()" style="margin-bottom:20px; color: var(--danger); border-color: var(--danger);">Finalizar Agora</button>

                    <div style="width: 100%; max-width: 300px; height: 6px; background: var(--bg-body); border-radius: 3px; overflow: hidden;">
                        <div id="pomo-progress-bar" style="height: 100%; background: var(--primary); width: 0%; transition: width 1s linear;"></div>
                    </div>
                </div>

                <div class="card-box" style="display:flex; flex-direction:column;">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:16px;">
                        <h3>Histrico de Sesses</h3>
                        <button class="btn-sm btn-outline" onclick="clearPomoHistory()" style="font-size:0.75rem;">Limpar</button>
                    </div>
                    
                    <div id="pomo-history-list" class="pomo-history-list">
                        <!-- History Items go here -->
                    </div>
                    <div id="pomo-empty-msg" style="text-align:center; padding:40px; color:var(--text-muted); font-style:italic;">Nenhuma sesso finalizada.</div>
                </div>
            </div>
        </section>

        <!-- UNIFIED STUDY SECTION -->
        <section id="study-view" class="view-section hidden">
            <!-- Internal Navigation -->
            <div class="study-nav-container">
                <button class="study-nav-btn active" id="sub-nav-practice" onclick="switchStudyTab('practice')">
                    <i class="fas fa-book-reader"></i> Praticar
                </button>
                <button class="study-nav-btn" id="sub-nav-library" onclick="switchStudyTab('library')">
                    <i class="fas fa-list"></i> Biblioteca
                </button>
                <button class="study-nav-btn" id="sub-nav-creator" onclick="switchStudyTab('creator')">
                    <i class="fas fa-plus-circle"></i> Criar
                </button>
            </div>

            <!-- SUB VIEW: PRACTICE (Original Study) -->
            <div id="sub-view-practice">
                <div class="card-box" style="background: linear-gradient(135deg, var(--primary), var(--secondary)); color: white; border: none; overflow: hidden; position: relative; margin-bottom: 24px;">
                    <i class="fas fa-shapes" style="position: absolute; right: -20px; bottom: -20px; font-size: 8rem; opacity: 0.1;"></i>
                    <div style="display: flex; justify-content: space-between; align-items: center; position: relative; z-index: 2; flex-wrap: wrap; gap:16px;">
                        <div>
                            <h3 style="color: white; margin: 0; font-size: 1.2rem;">Sesso de Estudo</h3>
                            <p style="opacity: 0.9; margin-top: 4px; font-size: 0.9rem;">Cards para revisar: <strong id="due-count">0</strong></p>
                        </div>
                        <div style="display: flex; gap: 8px;">
                            <button class="action-btn" onclick="openSimulationModal()" style="background: var(--primary-dark); width: auto; font-size: 0.9rem; border: 1px solid rgba(255,255,255,0.2);">
                                <i class="fas fa-clipboard-list"></i> Novo Simulado
                            </button>
                            <button class="action-btn" onclick="startRandomReview()" style="background: rgba(255,255,255,0.25); width: auto; font-size: 0.9rem; border: 1px solid rgba(255,255,255,0.4);">
                                <i class="fas fa-dice"></i> Aleatrio
                            </button>
                        </div>
                    </div>
                </div>

                <div id="study-content">
                    <div class="flashcard-display">
                        <div style="position: absolute; top: 0; left: 0; width: 100%; height: 6px; background: linear-gradient(90deg, var(--primary), var(--secondary));"></div>
                        
                        <!-- Progress Counter -->
                        <div id="study-progress-display" class="card-progress-counter">0 / 0</div>

                        <div style="display:flex; flex-direction:column; align-items:center; margin-bottom:10px;">
                            <span id="category-display" style="background: var(--primary-light); color: var(--primary); padding: 6px 16px; border-radius: 20px; font-size: 0.8rem; font-weight: 700; text-transform: uppercase;">GERAL</span>
                            <span id="subcategory-display" style="color: var(--text-muted); font-size: 0.75rem; font-weight: 600; margin-top: 4px; text-transform: uppercase;"></span>
                            <span id="card-id-display" class="id-badge" style="margin-top: 6px;">#0000</span>
                        </div>

                        <div id="question-display" class="question-text">Carregando pergunta...</div>
                        <div id="options-display" class="options-grid"></div>
                        
                        <div id="comment-display" class="hidden" style="margin-top: 24px; background: var(--bg-body); padding: 20px; border-radius: 12px; border: 1px solid var(--border); text-align: left;">
                             <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
                                <h4 style="color: var(--primary-dark); font-size: 0.9rem; margin:0; text-transform: uppercase;">Explicao</h4>
                                <button class="btn-sm btn-outline" onclick="enableCommentEdit()"><i class="fas fa-pen"></i> Editar</button>
                            </div>
                            <div id="comment-content-wrapper">
                                <p id="comment-text" style="font-size: 0.95rem; color: var(--text-main); line-height: 1.5;"></p>
                            </div>
                            <div id="comment-edit-wrapper" class="hidden">
                                <textarea id="comment-edit-area" rows="4" style="width:100%; margin-bottom:10px;"></textarea>
                                <button class="btn-sm action-btn" onclick="saveCommentEdit()">Salvar</button>
                            </div>
                        </div>
                        
                        <!-- NEW NAVIGATION AREA -->
                        <div class="study-controls-container">
                            <div class="nav-buttons-row">
                                <button id="nav-prev-btn" class="btn-study-rect" onclick="prevCard()">
                                    <i class="fas fa-arrow-left"></i> Anterior
                                </button>
                                <button id="nav-next-btn" class="btn-study-rect" onclick="nextCard()">
                                    Prximo <i class="fas fa-arrow-right"></i>
                                </button>
                            </div>
                            
                            <button id="confirm-action-btn" class="btn-study-confirm" onclick="confirmAnswer()">
                                Confirmar Resposta
                            </button>
                            
                            <button id="view-comment-btn" class="btn-study-confirm hidden" style="background-color: var(--secondary);" onclick="toggleCommentSection()">
                                <i class="fas fa-comment-alt"></i> Ver Comentrio
                            </button>
                        </div>
                        
                        <!-- Finish Button (shown only at end) -->
                        <div style="text-align:center; margin-top:16px;">
                            <button id="finish-review-btn" class="action-btn btn-danger hidden" onclick="finishRandomReview()" style="width:auto; margin:0 auto;">
                                Encerrar Sesso
                            </button>
                        </div>
                    </div>
                </div>

                <div id="simulation-result" class="hidden" style="animation: fadeIn 0.4s ease-out;">
                    <div class="sim-result-card">
                         <div class="sim-result-header">
                            <h3 style="margin-bottom:20px;">Relatrio de Desempenho</h3>
                            <div class="sim-score-big" id="sim-score-pct">0%</div>
                            <div class="sim-score-label">Aproveitamento</div>
                         </div>
                         <div class="sim-stats-row">
                             <div class="sim-stat-box">
                                 <div class="sim-stat-val" style="color:var(--success)" id="sim-correct-count">0</div>
                                 <div style="font-size:0.8rem; color:var(--text-muted);">Acertos</div>
                             </div>
                             <div class="sim-stat-box">
                                 <div class="sim-stat-val" style="color:var(--danger)" id="sim-wrong-count">0</div>
                                 <div style="font-size:0.8rem; color:var(--text-muted);">Erros</div>
                             </div>
                             <div class="sim-stat-box">
                                 <div class="sim-stat-val" style="color:var(--text-main)" id="sim-total-count">0</div>
                                 <div style="font-size:0.8rem; color:var(--text-muted);">Total</div>
                             </div>
                         </div>
                    </div>

                    <h4 style="margin-left:8px; margin-bottom:12px; color:var(--text-muted); text-transform:uppercase; font-size:0.85rem;">Gabarito Detalhado</h4>
                    <div id="sim-detailed-log" class="sim-log-container"></div>

                    <div style="display:flex; gap:12px; justify-content: center; margin-top:24px;">
                        <button class="action-btn" onclick="saveSimulationResult()"><i class="fas fa-save"></i> Salvar e Sair</button>
                        <button class="btn-outline action-btn" onclick="finishRandomReview()" style="width: auto;">Sair sem Salvar</button>
                    </div>
                </div>

                <div id="no-cards-msg" class="hidden" style="text-align: center; padding: 60px 20px;">
                    <div style="background: var(--primary-light); width: 80px; height: 80px; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 20px;">
                        <i class="fas fa-check-double" style="font-size: 2.5rem; color: var(--primary);"></i>
                    </div>
                    <h3 style="margin-bottom: 8px;">Tudo em dia!</h3>
                    <p style="color: var(--text-muted); margin-bottom: 24px;">Voc zerou sua fila de revises por hoje.</p>
                    <button class="action-btn btn-prominent" onclick="switchStudyTab('creator')" style="width: auto;">Criar Novo Card <i class="fas fa-plus" style="margin-left:8px"></i></button>
                </div>
            </div>

            <!-- SUB VIEW: LIBRARY (Original Manage) -->
            <div id="sub-view-library" class="hidden">
                 <div id="total-cards-count" style="margin-bottom: 10px; color: var(--text-muted); font-weight: 600; font-size: 0.9rem;"></div>
            
                <div style="margin-bottom: 24px; display: flex; gap: 12px; flex-wrap: wrap;">
                    <input type="text" id="search-cards" placeholder="Buscar cards..." onkeyup="renderManageList()" style="flex: 1; margin-bottom: 0;">
                    <select id="filter-category" onchange="renderManageList()" style="width: auto; margin-bottom: 0; min-width: 140px;">
                        <option value="all">Todas as Categorias</option>
                    </select>
                </div>
                <div id="cards-list-container"></div>
                <div id="empty-list-msg" class="hidden" style="text-align: center; padding: 40px; color: var(--text-muted); font-style: italic;">Nenhum card encontrado.</div>
            </div>

            <!-- SUB VIEW: CREATOR (Redesigned) -->
            <div id="sub-view-creator" class="hidden">
                <div class="card-box create-container">
                    
                    <div class="create-grid">
                        <div>
                            <label class="create-label">Matria / Categoria</label>
                            <input type="text" id="input-category" list="category-list-suggestions" placeholder="Ex: Histria, Ingls..." oninput="updateSubcategorySuggestions()" style="margin-bottom:0;">
                            <datalist id="category-list-suggestions"></datalist>
                        </div>
                        <div>
                            <label class="create-label">Tpico / Subcategoria</label>
                            <input type="text" id="input-subcategory" list="subcategory-list-suggestions" placeholder="Ex: Verbos, Revoluo..." style="margin-bottom:0;">
                            <datalist id="subcategory-list-suggestions"></datalist>
                        </div>
                    </div>

                    <div>
                        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
                            <label class="create-label" style="margin-bottom:0;">Pergunta</label>
                            <div class="editor-toolbar" style="margin-bottom:0;">
                                <button class="btn-outline btn-sm" onclick="formatQuestionText('bold')"><i class="fas fa-bold"></i></button>
                                <button class="btn-outline btn-sm" onclick="formatQuestionText('italic')"><i class="fas fa-italic"></i></button>
                                <button class="btn-outline btn-sm" onclick="formatQuestionText('underline')"><i class="fas fa-underline"></i></button>
                            </div>
                        </div>
                        <div id="input-question" class="rich-editor" contenteditable="true" placeholder="Digite sua pergunta aqui..."></div>
                    </div>

                    <div class="answer-group">
                        <label class="create-label">Alternativas</label>
                        
                        <div class="answer-block correct-answer">
                            <i class="fas fa-check-circle answer-icon"></i>
                            <input type="text" id="input-opt-a" placeholder="Digite a resposta correta aqui">
                        </div>
                        
                        <div class="answer-block wrong-answer">
                            <i class="far fa-circle answer-icon"></i>
                            <input type="text" id="input-opt-b" placeholder="Alternativa incorreta 1">
                        </div>
                        
                        <div class="answer-block wrong-answer">
                            <i class="far fa-circle answer-icon"></i>
                            <input type="text" id="input-opt-c" placeholder="Alternativa incorreta 2">
                        </div>
                        
                        <div class="answer-block wrong-answer">
                            <i class="far fa-circle answer-icon"></i>
                            <input type="text" id="input-opt-d" placeholder="Alternativa incorreta 3">
                        </div>
                    </div>

                    <div>
                        <label class="create-label">Explicao / Comentrio (Opcional)</label>
                        <textarea id="input-comment" rows="2" placeholder="Explicao que aparece aps responder..." style="margin-bottom:0;"></textarea>
                    </div>

                    <div style="display: flex; gap: 12px; padding-top:16px; border-top:1px solid var(--border);">
                        <button id="save-btn" class="action-btn" onclick="handleSave()" style="flex:1;">
                            <i class="fas fa-save"></i> Salvar Card
                        </button>
                        <button id="cancel-edit-btn" class="action-btn btn-outline hidden" onclick="resetForm()">Cancelar</button>
                    </div>
                </div>
            </div>
        </section>

        <!-- OLD Create & Manage views REMOVED (Merged above) -->

        <section id="syllabus-view" class="view-section hidden">
            <div class="card-box" style="background: linear-gradient(135deg, var(--primary), var(--secondary)); color: white; border: none; overflow: hidden; position: relative; margin-bottom: 24px;">
                <i class="fas fa-clipboard-list" style="position: absolute; right: -20px; bottom: -20px; font-size: 8rem; opacity: 0.1;"></i>
                <div style="display: flex; justify-content: space-between; align-items: center; position: relative; z-index: 2; flex-wrap: wrap; gap:16px;">
                    <div>
                        <h3 style="color: white; margin: 0; font-size: 1.2rem;">Meus Editais</h3>
                        <p style="opacity: 0.9; margin-top: 4px; font-size: 0.9rem;">Crie seus editais e acompanhe seu desenvolvimento...</p>
                    </div>
                    <div>
                        <button class="action-btn" onclick="createNewEdital()" style="background: rgba(255,255,255,0.25); width: auto; font-size: 0.9rem; border: 1px solid rgba(255,255,255,0.4);">
                            <i class="fas fa-plus"></i> Novo Edital
                        </button>
                    </div>
                </div>
            </div>
            <div id="syllabus-list-container"></div>
        </section>

        <section id="syllabus-detail-view" class="view-section hidden">
            <div style="display:flex; align-items:center; gap:10px; margin-bottom: 16px;">
                <button class="btn-icon" onclick="switchTab('syllabus')" style="background:transparent; border:none; color:var(--text-muted); font-size:1.2rem; width:auto; height:auto; padding:0;">
                    <i class="fas fa-arrow-left"></i>
                </button>
                <h3 style="margin:0; font-size:1.1rem; color:var(--text-muted);">Voltar para Editais</h3>
                <div style="margin-left:auto; display:flex; gap:8px;">
                     <button class="btn-icon" onclick="reorderSubjects()" title="Reorganizar">
                        <i class="fas fa-sort"></i>
                    </button>
                    <button class="btn-icon" onclick="deleteCurrentEdital()" style="color:var(--danger); border-color:rgba(239,68,68,0.3); background: rgba(239,68,68,0.1);">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </div>

            <!-- Hero Card -->
            <div class="card-box" style="background: linear-gradient(135deg, var(--primary), var(--secondary)); color: white; border: none; padding: 24px; position:relative; overflow:hidden;">
                <i class="fas fa-chart-bar" style="position: absolute; right: -20px; bottom: -30px; font-size: 10rem; opacity: 0.1;"></i>
                <div style="display:flex; justify-content:space-between; align-items:flex-start; margin-bottom: 20px; position:relative; z-index:2;">
                    <div>
                         <div style="display:flex; align-items:center; gap:10px; margin-bottom: 8px;">
                            <h2 id="current-edital-title" style="margin:0; font-size:1.8rem; font-weight:800; color:white; line-height:1.2;">Ttulo</h2>
                            <button onclick="editEditalTitle()" style="background:rgba(255,255,255,0.2); border:none; color:white; width:30px; height:30px; border-radius:50%; cursor:pointer; display:flex; align-items:center; justify-content:center;"><i class="fas fa-pen" style="font-size:0.8rem"></i></button>
                         </div>
                         <div style="font-size:0.9rem; opacity:0.9; color:white;">Progresso Geral</div>
                    </div>
                    <div id="current-edital-percent" style="font-size:2.2rem; font-weight:800; color:white;">0%</div>
                </div>
                
                <div style="height:8px; background:rgba(255,255,255,0.3); border-radius:4px; overflow:hidden; position:relative; z-index:2;">
                    <div id="current-edital-progress" style="height:100%; background:white; width:0%; transition:width 0.5s;"></div>
                </div>
            </div>

            <!-- Controls -->
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:16px; margin-bottom:24px;">
                <button class="card-box" onclick="addSubjectToEdital()" style="margin:0; padding:16px; display:flex; align-items:center; justify-content:center; gap:10px; cursor:pointer; border:1px dashed var(--primary); color:var(--primary); font-weight:600; transition:all 0.2s;">
                    <div style="background:var(--primary-light); width:32px; height:32px; border-radius:50%; display:flex; align-items:center; justify-content:center;"><i class="fas fa-plus"></i></div>
                    Nova Matria
                </button>
                <button class="card-box" onclick="importFromNotes()" style="margin:0; padding:16px; display:flex; align-items:center; justify-content:center; gap:10px; cursor:pointer; border:1px dashed var(--text-muted); color:var(--text-muted); font-weight:600;">
                    <div style="background:var(--bg-body); width:32px; height:32px; border-radius:50%; display:flex; align-items:center; justify-content:center;"><i class="fas fa-book"></i></div>
                    Importar
                </button>
            </div>

            <div id="subjects-container"></div>
        </section>

        <section id="schedule-view" class="view-section hidden">
            <div class="hero-header-card">
                <i class="fas fa-calendar-alt hero-bg-icon"></i>
                <div class="hero-content">
                    <div>
                        <h2 class="hero-title">Minha Agenda</h2>
                        <p class="hero-subtitle">Organize seu tempo e cumpra suas metas.</p>
                    </div>
                </div>
            </div>

            <div class="schedule-layout">
                <div class="task-section">
                    <div class="task-header">
                        <div>
                            <h3 style="margin-bottom: 4px; font-size: 1.3rem;">Metas do Dia</h3>
                            <div style="font-size: 0.9rem; color: var(--text-muted);">Foco total hoje!</div>
                            <!-- New Template Buttons for Tasks -->
                            <div class="template-actions">
                                <button class="btn-template btn-save-tmpl" onclick="openTemplateModal('task', 'save')"><i class="fas fa-save"></i> Salvar Modelo</button>
                                <button class="btn-template btn-load-tmpl" onclick="openTemplateModal('task', 'load')"><i class="fas fa-folder-open"></i> Carregar</button>
                            </div>
                        </div>
                        <button class="btn-sm btn-outline" onclick="clearCompletedTasks()" style="color: var(--text-muted);">Limpar Concludas</button>
                    </div>
                    
                    <div class="task-progress-bar" style="height:8px; background:var(--bg-body); border-radius:4px; overflow:hidden; margin-bottom:24px;">
                        <div id="task-progress-fill" style="height:100%; background:var(--success); width:0%; transition: width 0.3s ease;"></div>
                    </div>
                    
                    <div class="task-input-group" style="display:flex; gap:12px; margin-bottom:20px;">
                        <input type="text" id="new-task-input" placeholder="Adicionar nova meta..." style="margin-bottom: 0; padding: 14px;">
                        <button class="action-btn" onclick="addTask()" style="width: auto; padding: 0 20px;"><i class="fas fa-plus"></i></button>
                    </div>
                    <div id="tasks-container" class="task-list"></div>
                </div>

                <div class="calendar-wrapper">
                    <div class="calendar-header" style="display:flex; justify-content:space-between; align-items:flex-start; margin-bottom: 16px;">
                        <div style="display: flex; gap: 8px;">
                            <button class="btn-icon" onclick="changeWeek(-1)"><i class="fas fa-chevron-left"></i></button>
                            <button class="btn-icon" onclick="changeWeek(1)"><i class="fas fa-chevron-right"></i></button>
                        </div>
                        <div style="text-align: right; display: flex; flex-direction: column; align-items: flex-end;">
                            <span id="current-week-label" style="display: block; font-weight: 800; font-size: 1.1rem; color: var(--primary);">Semana Atual</span>
                            <span id="current-month-label" style="font-size: 0.8rem; color: var(--text-muted); font-weight: 600; margin-bottom: 8px;">...</span>
                             <!-- New Template Buttons for Schedule -->
                            <div class="template-actions">
                                <button class="btn-template btn-save-tmpl" onclick="openTemplateModal('schedule', 'save')"><i class="fas fa-save"></i> Salvar</button>
                                <button class="btn-template btn-load-tmpl" onclick="openTemplateModal('schedule', 'load')"><i class="fas fa-folder-open"></i> Carregar</button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="schedule-grid-container">
                        <table class="modern-table">
                            <thead>
                                <tr>
                                    <th style="width: 80px;">Hora</th>
                                    <th id="th-0">SEG</th><th id="th-1">TER</th><th id="th-2">QUA</th><th id="th-3">QUI</th><th id="th-4">SEX</th><th id="th-5">SB</th><th id="th-6">DOM</th>
                                </tr>
                            </thead>
                            <tbody id="schedule-body"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </section>

        <section id="notes-view" class="view-section hidden">
            <div class="hero-header-card">
                <i class="fas fa-book hero-bg-icon"></i>
                <div class="hero-content">
                    <div>
                        <h2 class="hero-title">Caderno Digital</h2>
                        <p class="hero-subtitle">Seus resumos e anotaes em um s lugar.</p>
                    </div>
                    <div style="display:flex; gap:10px;">
                        <button class="action-btn" onclick="promptNewFolder()" style="background: rgba(255,255,255,0.2); width:auto; border: 1px solid rgba(255,255,255,0.3); font-size:0.9rem;"><i class="fas fa-folder-plus"></i> Pasta</button>
                        <button class="action-btn" onclick="createNewNote()" style="background: white; color: var(--primary); width:auto; font-size:0.9rem;"><i class="fas fa-file-alt"></i> Nota</button>
                    </div>
                </div>
            </div>

            <div id="notes-breadcrumbs" class="notes-breadcrumb"></div>
            
            <div style="margin-bottom: 24px; position: relative;">
                <i class="fas fa-search" style="position: absolute; left: 16px; top: 50%; transform: translateY(-50%); color: var(--text-muted);"></i>
                <input type="text" id="search-notes" placeholder="Buscar pastas ou anotaes..." onkeyup="renderCurrentFolder()" style="margin-bottom:0; padding-left: 44px;">
            </div>

            <div id="file-explorer" class="file-grid"></div>
            <div id="empty-folder-msg" class="hidden" style="text-align:center; padding:60px 20px; color:var(--text-muted); grid-column:1/-1; display: flex; flex-direction: column; align-items: center; gap: 10px;">
                <i class="far fa-folder-open" style="font-size: 3rem; opacity: 0.3;"></i>
                <span>Pasta vazia.</span>
            </div>
        </section>

        <section id="note-editor-view" class="view-section hidden">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <button class="btn-back" onclick="closeNoteEditor()" style="margin-bottom: 0;">
                    <i class="fas fa-arrow-left"></i> Voltar
                </button>
                <div style="display:flex; gap:12px; align-items:center;">
                    <select id="note-folder-select" style="margin-bottom:0; width:auto; padding:10px;">
                        <option value="null">Incio</option>
                    </select>
                    <button class="action-btn" onclick="saveNote()" style="width: auto;">Salvar</button>
                </div>
            </div>
            
            <input type="text" id="note-title" placeholder="Ttulo da Anotao" style="font-size: 1.8rem; font-weight: 800; border: none; background: transparent; padding: 0; margin-bottom: 20px; color: var(--text-main);">
            
            <div class="editor-toolbar">
                <button class="btn-outline btn-sm" onclick="formatText('bold')"><i class="fas fa-bold"></i></button>
                <button class="btn-outline btn-sm" onclick="formatText('italic')"><i class="fas fa-italic"></i></button>
                <button class="btn-outline btn-sm" onclick="formatText('insertUnorderedList')"><i class="fas fa-list-ul"></i></button>
                <button class="btn-outline btn-sm" onclick="formatText('formatBlock', '<h3>')"><i class="fas fa-heading"></i></button>
            </div>
            
            <div id="note-content" contenteditable="true" style="min-height: 500px; outline: none; line-height: 1.8; font-size: 1.15rem; color: var(--text-main); padding:20px; background: var(--bg-card); border-radius: var(--radius-md); box-shadow: var(--shadow-sm); border: 1px solid var(--border);" placeholder="Comece a escrever..."></div>
        </section>

        <section id="card-detail-view" class="view-section hidden">
            <button class="btn-back" onclick="switchTab('study'); switchStudyTab('library');">
                <i class="fas fa-arrow-left"></i> Voltar
            </button>
            <div class="card-box">
                <span id="detail-category" style="background: var(--primary); color: white; padding: 4px 12px; border-radius: 12px; font-size: 0.8rem; font-weight: 700;">GERAL</span>
                <div id="detail-question" class="question-text" style="margin-top: 20px;"></div>
                <div id="detail-options-list" style="display: flex; flex-direction: column; gap: 10px; margin-bottom: 24px;"></div>
                <div id="detail-comment-container" style="background: var(--bg-body); padding: 20px; border-radius: 12px; border-left: 4px solid var(--primary);">
                    <strong style="color: var(--primary); display: block; margin-bottom: 4px;">Explicao:</strong> 
                    <span id="detail-comment-text" style="color: var(--text-main);"></span>
                </div>
                <div style="display: flex; gap: 12px; margin-top: 32px; border-top: 1px solid var(--border); padding-top: 20px;">
                    <button class="action-btn btn-outline" onclick="editCurrentCard()">Editar</button>
                    <button class="action-btn btn-danger" onclick="deleteCurrentCard()">Excluir</button>
                </div>
            </div>
        </section>

        <!-- MODIFIED: Performance View Reformulated (Horizontal & Banner Buttons) -->
        <section id="performance-view" class="view-section hidden">
            <div class="hero-header-card">
                <i class="fas fa-chart-line hero-bg-icon"></i>
                <div class="hero-content">
                    <div>
                        <h2 class="hero-title">Meu Desempenho</h2>
                        <p class="hero-subtitle">Acompanhe sua evoluo e mtricas de estudo.</p>
                    </div>
                    <div class="hero-actions">
                        <button id="btn-week" class="banner-period-btn active" onclick="changePeriod('week')">Semana</button>
                        <button id="btn-month" class="banner-period-btn" onclick="changePeriod('month')">Ms</button>
                        <button id="btn-year" class="banner-period-btn" onclick="changePeriod('year')">Ano</button>
                    </div>
                </div>
            </div>

            <!-- Date Display -->
            <div style="text-align: center; margin-bottom: 24px; color: var(--text-main);">
                <div style="display: flex; align-items: center; justify-content: center; gap: 20px;">
                    <button class="btn-outline btn-sm" style="width: 32px; padding: 0;" onclick="prevPeriod()"><i class="fas fa-chevron-left"></i></button>
                    <span id="period-display" style="font-weight: 800; font-size: 1.1rem; min-width: 150px;">...</span>
                    <button class="btn-outline btn-sm" style="width: 32px; padding: 0;" onclick="nextPeriod()"><i class="fas fa-chevron-right"></i></button>
                </div>
            </div>

            <div class="performance-layout">
                <!-- Row 1: Top Metrics (Full Width Stack) -->
                <div class="performance-card">
                    <h3 style="margin-bottom:20px;">Mtricas Principais</h3>
                    <div class="performance-metrics">
                        <div class="metric-box">
                            <div class="metric-value" id="total-reviews-count">0</div>
                            <div class="metric-label">Revises Feitas</div>
                        </div>
                        <div class="metric-box">
                            <div class="metric-value" id="accuracy-rate">0%</div>
                            <div class="metric-label">Taxa de Acertos</div>
                        </div>
                        <div class="metric-box">
                            <div class="metric-value" id="performance-streak">0</div>
                            <div class="metric-label">Dias de Ofensiva</div>
                        </div>
                                                <div class="metric-box">
                            <!-- O ID PRECISA SER reviews-today PARA O APP NO QUEBRAR -->
                            <div class="metric-value" id="reviews-today">0</div>
                            <div class="metric-label">Tempo de Estudo</div>
                        </div>


                    </div>
                </div>

                <!-- NEW: Simulation History Table -->
                <div class="performance-card">
                    <h3 style="margin-bottom:20px;">Histrico de Simulados</h3>
                    <div id="simulation-history-list">
                        <!-- History cards go here -->
                    </div>
                    <div id="sim-history-empty" class="hidden" style="text-align:center; padding: 20px; color:var(--text-muted);">Nenhum simulado salvo ainda.</div>
                </div>

                <!-- Row 2: Evolution Chart (Full Width) -->
                <div class="performance-card">
                    <h3 style="margin-bottom:20px;">Evoluo Diria</h3>
                    <div id="performance-chart" style="display: flex; flex-direction: column; gap: 12px; min-height: 200px;"></div>
                </div>

                <!-- Row 3: Breakdown by Subject & Category (Full Width) -->
                <div class="performance-card">
                    <h3 style="margin-bottom:20px;">Desempenho por Matria</h3>
                    <div id="category-stats-list" style="display: flex; flex-direction: column; gap: 10px;"></div>
                </div>

                <div class="performance-card">
                    <h3 style="margin-bottom:20px;">Progresso por Categoria</h3>
                    <div class="category-progress-grid" id="category-progress-grid"></div>
                </div>
            </div>
        </section>

        <section id="settings-view" class="view-section hidden">
                                    <!-- BANNER DE DOAES (DESIGN MODERNO ORANGE) -->
            <div class="card-box" style="
                background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
                color: white;
                border: none;
                display: flex;
                flex-wrap: wrap;
                gap: 24px;
                align-items: center;
                justify-content: space-between;
                position: relative;
                overflow: hidden;
            ">
                <!-- Efeito de brilho sutil no fundo para modernidade -->
                <div style="position: absolute; top: -50%; left: -10%; width: 200px; height: 200px; background: rgba(255,255,255,0.1); border-radius: 50%;"></div>
                
                <div style="flex: 1; min-width: 250px; z-index: 1;">
                    <h3 style="margin-bottom: 12px; color: white; display: flex; align-items: center; gap: 10px; font-size: 1.3rem;">
                        <i class="fas fa-hand-holding-heart"></i> Apoie o Projeto
                    </h3>
                    <p style="color: rgba(255,255,255,0.95); font-size: 0.95rem; line-height: 1.6; margin-bottom: 0;">
                        Gosta do app? Ajude a manter o desenvolvimento ativo e 100% grtis! <br>
                        Sua doao traz novas atualizaes e melhorias.
                    </p>
                </div>

                <div style="text-align: center; margin: 0 auto; z-index: 1;">
                    <div style="
                        background: white; 
                        padding: 8px; 
                        border-radius: var(--radius-md); 
                        box-shadow: 0 4px 15px rgba(0,0,0,0.2);
                        display: inline-block;
                    ">
                        <!-- Imagem do QR Code -->
                        <img src="assets/qrcode.png" alt="Pix QR Code" style="width: 120px; height: 120px; display: block; border-radius: 4px;">
                    </div>
                    <div style="margin-top: 8px; font-size: 0.8rem; font-weight: 600; opacity: 0.9;">
                        <i class="fas fa-qrcode"></i> Escaneie o Pix
                    </div>
                </div>
            </div>
            <!-- FIM DO BANNER -->


            <!-- NEW: Revision Intensity Settings -->
            <div class="card-box">
                <h3>Intensidade da Reviso</h3>
                <p style="color:var(--text-muted); margin-bottom:12px; font-size:0.95rem;">
                    Defina a frequncia com que os cards reaparecero para reviso.
                </p>
                <div style="margin-bottom: 12px;">
                    <select id="revision-level-select" onchange="changeRevisionLevel(this.value)">
                        <option value="light">Leve (Intervalos Longos)</option>
                        <option value="moderate">Moderada (Padro)</option>
                        <option value="intense">Intensa (Intervalos Curtos)</option>
                    </select>
                </div>
                <div style="background: var(--bg-body); padding: 12px; border-radius: 8px; border: 1px solid var(--border); font-size: 0.85rem; color: var(--text-muted);">
                    <i class="fas fa-info-circle"></i> <strong>Ateno:</strong> Alterar esta opo reiniciar o agendamento de todos os cards para hoje, adaptando-se  nova intensidade.
                </div>
            </div>

            <div class="card-box">
                <h3>Backup e Restaurao</h3>
                <p style="color:var(--text-muted); margin-bottom:20px; font-size:0.95rem;">
                    Salve todo o seu progresso (cards, notas, cronograma e metas) em um arquivo ou restaure um backup anterior.
                </p>
                <button class="action-btn" onclick="exportAllData()"><i class="fas fa-download"></i> Baixar Backup Completo</button>
                <button class="btn-outline action-btn" onclick="document.getElementById('import-file').click()" style="margin-top: 10px;"><i class="fas fa-upload"></i> Restaurar Backup</button>
                <input type="file" id="import-file" style="display: none;" onchange="importAllData(this)" accept=".json">
            </div>

            <div class="card-box" style="margin-top:20px;">
                <h3 style="color:var(--danger);">Zona de Perigo</h3>
                <p style="color:var(--text-muted); margin-bottom:20px; font-size:0.95rem;">
                    Esta ao apagar todos os seus dados do navegador. Certifique-se de ter um backup.
                </p>
                <button class="btn-outline action-btn" onclick="clearAllData()" style="color: var(--danger); border-color: var(--danger);"><i class="fas fa-trash"></i> Apagar Tudo</button>
            </div>
        </section>

    </main>

    <nav class="bottom-nav">
        <button class="bottom-nav-item active" onclick="switchTab('dashboard')"><i class="fas fa-home"></i>Incio</button>
        <button class="bottom-nav-item" onclick="switchTab('study')"><i class="fas fa-book-open"></i>Estudar</button>
        <button class="bottom-nav-item" onclick="switchTab('pomodoro')"><i class="fas fa-stopwatch"></i>Pomodoro</button> 
        <button class="bottom-nav-item" onclick="switchTab('schedule')"><i class="fas fa-calendar-alt"></i>Agenda</button>
    </nav>

    <!-- MODIFIED: FAB Container with upward expansion -->
    <div class="fab-container" id="fab-container">
        <div class="fab-menu" id="fab-menu">
            <button class="fab-item" onclick="quickCreate('card')" title="Novo Card">
                <span class="fab-label">Novo Card</span>
                <div class="fab-icon"><i class="fas fa-layer-group"></i></div>
            </button>
            <button class="fab-item" onclick="quickCreate('note')" title="Nova Nota">
                <span class="fab-label">Nova Nota</span>
                <div class="fab-icon"><i class="fas fa-sticky-note"></i></div>
            </button>
            <button class="fab-item" onclick="quickCreate('goal')" title="Nova Meta">
                <span class="fab-label">Nova Meta</span>
                <div class="fab-icon"><i class="fas fa-check-circle"></i></div>
            </button>
        </div>
        <button class="fab-button" id="fab-button" onclick="toggleFabMenu()">
            <i class="fas fa-plus"></i>
        </button>
    </div>

    <!-- NEW: Floating Timer Widget - Updated Position & Controls -->
    <div id="floating-timer-widget" class="floating-timer">
        <div class="float-time" id="float-time-display">25:00</div>
    </div>

    <!-- NEW: Custom Alert Modal -->
    <div id="custom-alert-modal" class="hidden" style="position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);z-index:3000;display:flex;align-items:center;justify-content:center; padding: 20px;">
        <div class="card-box" style="width:100%;max-width:350px;margin:0; text-align: center; border-radius: 20px;">
            <div style="width: 60px; height: 60px; background: var(--primary-light); color: var(--primary); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.8rem; margin: 0 auto 16px;">
                <i class="fas fa-bell"></i>
            </div>
            <h3 id="custom-alert-title" style="margin-bottom: 8px;">Ateno</h3>
            <p id="custom-alert-msg" style="color:var(--text-muted); margin-bottom: 24px; font-size:0.95rem;">Mensagem</p>
            <button class="action-btn" onclick="document.getElementById('custom-alert-modal').classList.add('hidden')">Entendido</button>
        </div>
    </div>

    <!-- NEW: Custom Confirmation Modal -->
    <div id="custom-confirm-modal" class="hidden" style="position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);z-index:3000;display:flex;align-items:center;justify-content:center; padding: 20px;">
        <div class="card-box" style="width:100%;max-width:350px;margin:0; text-align: center; border-radius: 20px;">
            <div style="width: 60px; height: 60px; background: #fee2e2; color: var(--danger); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.8rem; margin: 0 auto 16px;">
                <i class="fas fa-exclamation-triangle"></i>
            </div>
            <h3 id="confirm-modal-title" style="margin-bottom: 8px;">Confirmar</h3>
            <p id="confirm-modal-msg" style="color:var(--text-muted); margin-bottom: 24px; font-size:0.95rem;">Tem certeza?</p>
            <div style="display:flex; gap:10px;">
                <button class="action-btn btn-outline" onclick="handleConfirm(false)">Cancelar</button>
                <button class="action-btn btn-danger" onclick="handleConfirm(true)">Sim, confirmar</button>
            </div>
        </div>
    </div>

    <div id="schedule-modal" class="hidden" style="position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);z-index:2000;display:flex;align-items:flex-end;justify-content:center;">
        <div class="card-box" style="width:100%;max-width:500px;margin:0;border-bottom-left-radius:0;border-bottom-right-radius:0;">
            <h3>Agendar</h3>
            <input type="text" id="schedule-block-title" placeholder="Ttulo">
            <div style="display:flex;gap:12px;margin-bottom:20px;">
                <div class="color-chip" onclick="selectColor('var(--primary)',this)" style="background:var(--primary);width:30px;height:30px;border-radius:50%;border:2px solid transparent;"></div>
                <div class="color-chip" onclick="selectColor('var(--success)',this)" style="background:var(--success);width:30px;height:30px;border-radius:50%;border:2px solid transparent;"></div>
                <div class="color-chip" onclick="selectColor('var(--info)',this)" style="background:var(--info);width:30px;height:30px;border-radius:50%;border:2px solid transparent;"></div>
            </div>
            <div style="display:flex;gap:10px;">
                <button class="action-btn" onclick="saveScheduleBlock()">Salvar</button>
                <button class="action-btn btn-danger hidden" id="btn-delete-block" onclick="deleteScheduleBlock()">Excluir</button>
                <button class="btn-outline" onclick="closeScheduleModal()">Cancelar</button>
            </div>
        </div>
    </div>
    
    <div id="simulation-config-modal" class="hidden" style="position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.6);z-index:3000;display:flex;align-items:center;justify-content:center; padding: 20px;">
        <div class="card-box" style="width:100%;max-width:450px;margin:0; text-align: left; max-height: 90vh; display:flex; flex-direction:column;">
            <h3 style="color: var(--primary); margin-bottom: 8px;">Configurar Simulado</h3>
            <p style="color:var(--text-muted); font-size:0.9rem; margin-bottom:16px;">Defina a quantidade de questes por matria:</p>
            
            <div id="sim-category-list" style="overflow-y: auto; margin-bottom: 20px; padding-right:5px;">
                </div>
            
            <div style="border-top: 1px solid var(--border); padding-top: 12px; margin-bottom: 16px; display:flex; justify-content:space-between; font-weight:700;">
                <span>Total de Questes:</span>
                <span id="sim-total-preview" style="color:var(--primary);">0</span>
            </div>

            <div style="display:flex;gap:10px;">
                <button class="action-btn" onclick="startSimulationFromConfig()">Comear</button>
                <button class="btn-outline" onclick="document.getElementById('simulation-config-modal').classList.add('hidden')">Cancelar</button>
            </div>
        </div>
    </div>

    <!-- Modal genrico para edio -->
    <div id="generic-modal" class="hidden" style="position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);z-index:2000;display:flex;align-items:center;justify-content:center; padding: 20px;">
        <div class="card-box" style="width:100%;max-width:500px;margin:0; text-align: left; max-height: 90vh; display:flex; flex-direction:column;">
            <h3 id="generic-modal-title"></h3>
            <input type="text" id="generic-modal-input" placeholder="Digite aqui..." style="margin-bottom:20px;">
            <div id="generic-modal-textarea-container" style="display:none;">
                <textarea id="generic-modal-textarea" rows="4" placeholder="Digite aqui..." style="margin-bottom:20px;"></textarea>
            </div>
            <div style="display:flex;gap:10px;">
                <button class="action-btn" id="generic-modal-confirm">Salvar</button>
                <button class="btn-outline" onclick="closeGenericModal()">Cancelar</button>
            </div>
        </div>
    </div>

    <!-- Modal para configuraes do Pomodoro -->
    <div id="pomo-settings-modal" class="hidden" style="position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);z-index:2000;display:flex;align-items:center;justify-content:center; padding: 20px;">
        <div class="card-box" style="width:100%;max-width:400px;margin:0; text-align: left;">
            <h3>Configurar Pomodoro</h3>
            <div style="margin-bottom: 16px;">
                <label style="font-size:0.9rem; font-weight:600; color:var(--text-muted); display:block; margin-bottom:6px;">Pomodoro (minutos)</label>
                <input type="number" id="pomo-input-focus" value="25" min="1" max="60">
            </div>
            <div style="margin-bottom: 16px;">
                <label style="font-size:0.9rem; font-weight:600; color:var(--text-muted); display:block; margin-bottom:6px;">Descanso Curto (minutos)</label>
                <input type="number" id="pomo-input-short" value="5" min="1" max="60">
            </div>
            <div style="margin-bottom: 20px;">
                <label style="font-size:0.9rem; font-weight:600; color:var(--text-muted); display:block; margin-bottom:6px;">Descanso Longo (minutos)</label>
                <input type="number" id="pomo-input-long" value="15" min="1" max="60">
            </div>
            <div style="display:flex; gap:10px;">
                <button class="action-btn" onclick="savePomoSettings()">Salvar</button>
                <button class="btn-outline" onclick="document.getElementById('pomo-settings-modal').classList.add('hidden')">Cancelar</button>
            </div>
        </div>
    </div>

    <!-- Modal para reordenar itens -->
    <div id="reorder-modal" class="hidden" style="position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);z-index:2000;display:flex;align-items:center;justify-content:center; padding: 20px;">
        <div class="card-box" style="width:100%;max-width:500px;margin:0; text-align: left; max-height: 90vh; display:flex; flex-direction:column;">
            <h3 id="reorder-modal-title">Reorganizar</h3>
            <p style="color:var(--text-muted); margin-bottom:16px;">Arraste os itens para reordenar:</p>
            <div id="reorder-list-container" style="overflow-y: auto; margin-bottom: 20px; border: 1px solid var(--border); border-radius: var(--radius-md); padding: 10px;"></div>
            <div style="display:flex;gap:10px;">
                <button class="action-btn" onclick="saveReordering()">Salvar Ordem</button>
                <button class="btn-outline" onclick="document.getElementById('reorder-modal').classList.add('hidden')">Cancelar</button>
            </div>
        </div>
    </div>
    
    <!-- Modal Details for Saved Simulation -->
    <div id="sim-detail-modal" class="hidden" style="position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);z-index:2500;display:flex;align-items:center;justify-content:center; padding: 20px;">
        <div class="card-box" style="width:100%;max-width:500px;margin:0; text-align: left; max-height: 90vh; display:flex; flex-direction:column;">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px;">
                <h3 id="sim-detail-title" style="margin:0;">Detalhes do Simulado</h3>
                <button class="btn-icon" onclick="document.getElementById('sim-detail-modal').classList.add('hidden')"><i class="fas fa-times"></i></button>
            </div>
            <div id="sim-detail-content" style="overflow-y: auto; margin-bottom: 20px; flex:1;"></div>
            <button class="action-btn" onclick="document.getElementById('sim-detail-modal').classList.add('hidden')">Fechar</button>
        </div>
    </div>

    <!-- Modal para vincular tpico a categoria de cards E anotaes -->
    <div id="link-topic-modal" class="hidden" style="position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);z-index:2000;display:flex;align-items:center;justify-content:center; padding: 20px;">
        <div class="card-box" style="width:100%;max-width:500px;margin:0; text-align: left; max-height: 90vh; display:flex; flex-direction:column;">
            <h3>Vincular Contedo</h3>
            <p style="color:var(--text-muted); margin-bottom:16px;">Associe este tpico a cards de estudo e/ou uma anotao do caderno.</p>
            
            <div style="margin-bottom:20px; border-bottom:1px solid var(--border); padding-bottom:16px;">
                <label style="font-weight:700; margin-bottom:8px; display:block; color:var(--primary);">1. Vincular Flashcards</label>
                <label style="font-weight:600; margin-bottom:4px; display:block; font-size:0.9rem;">Categoria Principal</label>
                
                <!-- NEW SEARCHABLE DROPDOWN FOR CATEGORIES -->
                <div class="search-container">
                    <input type="text" id="link-category-search" placeholder="Buscar categoria..." onkeyup="filterLinkCategories()" onfocus="filterLinkCategories()" autocomplete="off">
                    <div id="link-category-results" class="search-results-list"></div>
                </div>
                
                <label style="font-weight:600; margin-bottom:4px; display:block; font-size:0.9rem;">Subcategoria (Opcional)</label>
                <select id="link-subcategory-select" style="margin-bottom:12px;">
                    <option value="">Todas as subcategorias</option>
                </select>
                
                <div id="link-preview" style="background:var(--bg-body); padding:10px; border-radius:8px; font-size:0.9rem; display:none;">
                    Cards disponveis: <span id="link-card-count" style="font-weight:bold; color:var(--primary);">0</span>
                </div>
            </div>

            <div style="margin-bottom:20px;">
                <label style="font-weight:700; margin-bottom:8px; display:block; color:var(--primary);">2. Vincular Anotao</label>
                <!-- NEW SEARCHABLE DROPDOWN FOR NOTES -->
                <div class="search-container">
                    <input type="text" id="link-note-search" placeholder="Buscar anotao..." onkeyup="filterLinkNotes()" onfocus="filterLinkNotes()" autocomplete="off">
                    <div id="link-note-results" class="search-results-list"></div>
                </div>
            </div>
            
            <div style="display:flex;gap:10px;">
                <button class="action-btn" id="link-topic-confirm-btn">Salvar Vnculos</button>
                <button class="btn-outline" onclick="document.getElementById('link-topic-modal').classList.add('hidden')">Cancelar</button>
            </div>
        </div>
    </div>

    <!-- NEW: Template Management Modal -->
    <div id="template-modal" class="hidden" style="position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);z-index:2000;display:flex;align-items:center;justify-content:center; padding: 20px;">
        <div class="card-box" style="width:100%;max-width:450px;margin:0; text-align: left; display:flex; flex-direction:column;">
            <h3 id="template-modal-title">Modelos</h3>
            <p id="template-modal-desc" style="color:var(--text-muted); margin-bottom:16px;">Gerenciar modelos salvos.</p>
            
            <div id="template-list-container" class="template-list">
                <!-- Template items injected here -->
            </div>
            
            <div id="template-empty-msg" class="hidden" style="text-align:center; padding:20px; color:var(--text-muted);">Nenhum modelo salvo.</div>

            <div style="display:flex;gap:10px; margin-top:20px;">
                <button class="btn-outline" style="width:100%" onclick="document.getElementById('template-modal').classList.add('hidden')">Fechar</button>
            </div>
        </div>
    </div>

    
</div><!-- END APP CONTENT -->

<script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, sendPasswordResetEmail, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyClmCSBNN63iHY9F_bFXRP2x7YYNr_2Qm4",
            authDomain: "teddy-c5c03.firebaseapp.com",
            projectId: "teddy-c5c03",
            storageBucket: "teddy-c5c03.firebasestorage.app",
            messagingSenderId: "850197478556",
            appId: "1:850197478556:web:e0ae46c5b158c21a64c159",
            measurementId: "G-HSVGWCDCEF"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);

        // UI References
        const authWrapper = document.getElementById('auth-wrapper');
        const appContent = document.getElementById('app-content');
        const errorMsg = document.getElementById('auth-error-msg');
        
        const loginForm = document.getElementById('login-form');
        const registerForm = document.getElementById('register-form');
        const forgotForm = document.getElementById('forgot-form');

        const loginFooter = document.getElementById('login-footer');
        const registerFooter = document.getElementById('register-footer');
        const forgotFooter = document.getElementById('forgot-footer');

        // Expose toggleAuthMode to global scope for HTML onclick
        window.toggleAuthMode = (mode) => {
            errorMsg.style.display = 'none';
            loginForm.classList.add('hidden');
            registerForm.classList.add('hidden');
            forgotForm.classList.add('hidden');
            
            loginFooter.classList.add('hidden');
            registerFooter.classList.add('hidden');
            forgotFooter.classList.add('hidden');

            if (mode === 'login') {
                loginForm.classList.remove('hidden');
                loginFooter.classList.remove('hidden');
            } else if (mode === 'register') {
                registerForm.classList.remove('hidden');
                registerFooter.classList.remove('hidden');
            } else if (mode === 'forgot') {
                forgotForm.classList.remove('hidden');
                forgotFooter.classList.remove('hidden');
            }
        };

        // Helper: Show Error
        const showError = (message) => {
            errorMsg.innerText = message;
            errorMsg.style.display = 'block';
        };

        // Firebase Error Translation
        const getErrorMessage = (error) => {
            switch (error.code) {
                case 'auth/email-already-in-use': return 'Este e-mail j est em uso.';
                case 'auth/invalid-email': return 'E-mail invlido.';
                case 'auth/weak-password': return 'A senha deve ter pelo menos 6 caracteres.';
                case 'auth/user-not-found': return 'Usurio no encontrado.';
                case 'auth/wrong-password': return 'Senha incorreta.';
                case 'auth/too-many-requests': return 'Muitas tentativas. Tente novamente mais tarde.';
                case 'auth/missing-password': return 'Digite a senha.';
                case 'auth/invalid-credential': return 'Credenciais invlidas.';
                default: return 'Erro: ' + error.message;
            }
        };

        // Login Handler
        loginForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            
            signInWithEmailAndPassword(auth, email, password)
                .catch((error) => showError(getErrorMessage(error)));
        });

        // Register Handler
        registerForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const email = document.getElementById('reg-email').value;
            const password = document.getElementById('reg-password').value;
            const confirm = document.getElementById('reg-confirm').value;

            if (password !== confirm) return showError('As senhas no coincidem.');

            createUserWithEmailAndPassword(auth, email, password)
                .catch((error) => showError(getErrorMessage(error)));
        });

        // Forgot Password Handler
        forgotForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const email = document.getElementById('forgot-email').value;

            sendPasswordResetEmail(auth, email)
                .then(() => {
                    alert('E-mail de redefinio enviado!');
                    window.toggleAuthMode('login');
                })
                .catch((error) => showError(getErrorMessage(error)));
        });

        // Auth State Listener
        onAuthStateChanged(auth, (user) => {
            if (user) {
                // Logged In
                authWrapper.style.display = 'none';
                appContent.classList.remove('hidden');
                // Trigger dashboard render if needed
                if(window.renderDashboard) window.renderDashboard();
            } else {
                // Logged Out
                authWrapper.style.display = 'flex';
                appContent.classList.add('hidden');
            }
        });

        // LOGOUT COM MODAL CUSTOMIZADO
    window.logout = () => {
        const logoutModal = document.getElementById('logout-modal');
        if (logoutModal) logoutModal.classList.remove('hidden');
    };

    window.closeLogoutModal = () => {
        const logoutModal = document.getElementById('logout-modal');
        if (logoutModal) logoutModal.classList.add('hidden');
    };

    window.confirmLogout = () => {
        const logoutModal = document.getElementById('logout-modal');
        if (logoutModal) logoutModal.classList.add('hidden'); // Close immediately

        signOut(auth).then(() => {
            location.reload(); // Reload to return to login screen
        }).catch(e => {
            alert("Erro ao sair: " + e.message);
            // Reopen modal if error
            if (logoutModal) logoutModal.classList.remove('hidden');
        });
    };
    </script>
<script>
        // --- BLOQUEADOR DE ALERTAS E POP-UPS NATIVOS (PARA ELECTRON) ---
    window.alert = function(message) {
        console.log("Alerta Bloqueado: " + message); 
        return true; // Retorna true para simular que o alerta foi "visto"
    };
    window.confirm = function(message) {
        console.log("Confirmao Bloqueada: " + message);
        return true; // Retorna true para aes de excluso que esperam a confirmao
    };
    window.prompt = function(message) {
        console.log("Prompt Bloqueado: " + message);
        return null; // Retorna nulo para simular que o prompt foi cancelado
    };
    // -----------------------------------------------------------------
        // --- ESTADO GLOBAL ---
        let cards = JSON.parse(localStorage.getItem('ted_flashcards')) || [];
        let folders = JSON.parse(localStorage.getItem('ted_folders')) || [];
        let notes = JSON.parse(localStorage.getItem('ted_notes')) || [];
        let scheduleData = JSON.parse(localStorage.getItem('ted_schedule')) || {};
        let tasks = JSON.parse(localStorage.getItem('ted_tasks')) || [];
        let performanceData = JSON.parse(localStorage.getItem('ted_performance')) || [];
        let editais = JSON.parse(localStorage.getItem('ted_editais')) || []; 
        let simulationHistory = JSON.parse(localStorage.getItem('ted_simulation_history')) || [];
        
        // Templates State
        let taskTemplates = JSON.parse(localStorage.getItem('ted_task_templates')) || [];
        let scheduleTemplates = JSON.parse(localStorage.getItem('ted_schedule_templates')) || [];

        // Updated userData with revisionLevel
        let userData = JSON.parse(localStorage.getItem('ted_userdata')) || { streak: 0, lastStudyDate: null, theme: 'light', revisionLevel: 'moderate' };
        
        // --- POMODORO STATE ---
        let pomoSettings = JSON.parse(localStorage.getItem('ted_pomo_settings')) || { focus: 25, short: 5, long: 15 };
        let pomoHistory = JSON.parse(localStorage.getItem('ted_pomo_history')) || [];
        let pomoTimer = null;
        let pomoTimeLeft = pomoSettings.focus * 60;
        let pomoCurrentMode = 'focus'; // focus, short, long
        let pomoIsRunning = false;

        let currentFolderId = null;
        let editingNoteId = null;
        let sessionQueue = [];
        let randomReviewQueue = [];
        let currentCard = null;
        let editingId = null; 
        
        // NEW NAVIGATION STATE
        let currentCardIndex = 0;
        let sessionAnswers = {}; // { cardId: { selected: string, correct: boolean } }

        let currentEditalId = null;
        
        let currentSelectedOption = null;
        let currentSelectedBtn = null;
        
        let studyMode = 'standard'; 
        let simulationQueue = [];
        let simulationResults = { correct: 0, wrong: 0, total: 0 };
        let currentSimulationLog = []; // Stores detailed answers for the current sim
        
        // Study Progress State
        let currentSessionTotal = 0;
        let cardsDoneCount = 0;

        let currentWeekOffset = 0;
        let editingScheduleBlock = null;
        let selectedColor = 'var(--primary)';
        let currentPeriod = 'week';
        let currentPeriodIndex = 0;

        let genericModalCallback = null;
        let genericModalIsTextarea = false;
        let reorderingData = null;
        let reorderingType = null; 
        
        let linkingTopicData = null; 
        
        // Linking state variables
        let selectedLinkCategory = null;
        let selectedLinkNoteId = null;

        let confirmCallback = null;

        window.onload = function() {
            if (userData.theme === 'dark') document.body.classList.add('dark-mode');
            
            // Set Revision Level dropdown
            if(document.getElementById('revision-level-select')) {
                document.getElementById('revision-level-select').value = userData.revisionLevel || 'moderate';
            }

            checkStreakIntegrity(); 
            checkDataIntegrity(); // Fix ghost folders
            updateCategoryDropdowns();
            renderDashboard();
            
            document.getElementById('generic-modal-confirm').onclick = function() {
                if (genericModalCallback) {
                    const value = genericModalIsTextarea ? 
                        document.getElementById('generic-modal-textarea').value : 
                        document.getElementById('generic-modal-input').value;
                    genericModalCallback(value);
                }
                closeGenericModal();
            };
            
            document.getElementById('link-topic-confirm-btn').onclick = saveTopicLink;
            document.getElementById('link-subcategory-select').addEventListener('change', updateLinkPreview);
            
            document.getElementById('generic-modal').addEventListener('transitionend', function() {
                if (!this.classList.contains('hidden')) {
                    if (genericModalIsTextarea) {
                        document.getElementById('generic-modal-textarea').focus();
                    } else {
                        document.getElementById('generic-modal-input').focus();
                    }
                }
            });

            // Initialize Pomodoro
            setPomoMode('focus');

            // Close FAB when clicking outside
            document.addEventListener('click', (e) => {
                const fab = document.getElementById('fab-container');
                if(fab && fab.classList.contains('open') && !fab.contains(e.target)) {
                    toggleFabMenu();
                }
                
                // Close search dropdowns when clicking outside
                if(!e.target.closest('.search-container')) {
                    document.getElementById('link-category-results').style.display = 'none';
                    document.getElementById('link-note-results').style.display = 'none';
                }
            });
        }
        
        function checkDataIntegrity() {
            // Fix notes pointing to non-existent folders
            let fixedCount = 0;
            notes.forEach(note => {
                if (note.folderId && !folders.find(f => f.id === note.folderId)) {
                    note.folderId = null; // Move to root
                    fixedCount++;
                }
            });
            if (fixedCount > 0) {
                console.log(`Fixed ${fixedCount} ghost notes.`);
                saveNotesData();
            }
        }

        function showAlert(title, msg) {
            document.getElementById('custom-alert-title').innerText = title;
            document.getElementById('custom-alert-msg').innerText = msg;
            document.getElementById('custom-alert-modal').classList.remove('hidden');
        }

        function showConfirm(title, msg, callback) {
            document.getElementById('confirm-modal-title').innerText = title;
            document.getElementById('confirm-modal-msg').innerText = msg;
            confirmCallback = callback;
            document.getElementById('custom-confirm-modal').classList.remove('hidden');
        }

        function handleConfirm(result) {
            document.getElementById('custom-confirm-modal').classList.add('hidden');
            if(result && confirmCallback) confirmCallback();
            
            // Revert dropdown if canceled during revision level change
            if(!result && document.getElementById('revision-level-select')) {
                 document.getElementById('revision-level-select').value = userData.revisionLevel || 'moderate';
            }
            
            confirmCallback = null;
        }

        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                if (!document.getElementById('generic-modal').classList.contains('hidden')) closeGenericModal();
                if (!document.getElementById('reorder-modal').classList.contains('hidden')) document.getElementById('reorder-modal').classList.add('hidden');
                if (!document.getElementById('link-topic-modal').classList.contains('hidden')) document.getElementById('link-topic-modal').classList.add('hidden');
                if (!document.getElementById('simulation-config-modal').classList.contains('hidden')) document.getElementById('simulation-config-modal').classList.add('hidden');
                if (!document.getElementById('schedule-modal').classList.contains('hidden')) document.getElementById('schedule-modal').classList.add('hidden');
                if (!document.getElementById('pomo-settings-modal').classList.contains('hidden')) document.getElementById('pomo-settings-modal').classList.add('hidden');
                if (!document.getElementById('custom-alert-modal').classList.contains('hidden')) document.getElementById('custom-alert-modal').classList.add('hidden');
                if (!document.getElementById('custom-confirm-modal').classList.contains('hidden')) handleConfirm(false);
                if (!document.getElementById('sim-detail-modal').classList.contains('hidden')) document.getElementById('sim-detail-modal').classList.add('hidden');
                if (!document.getElementById('template-modal').classList.contains('hidden')) document.getElementById('template-modal').classList.add('hidden');
                
                document.getElementById('link-category-results').style.display = 'none';
                document.getElementById('link-note-results').style.display = 'none';
            }
            if (e.key === 'Enter' && !document.getElementById('generic-modal').classList.contains('hidden')) {
                if (document.activeElement.id === 'generic-modal-input' || document.activeElement.id === 'generic-modal-textarea') {
                    document.getElementById('generic-modal-confirm').click();
                }
            }
        });

        // Toggle Sidebar function removed/simplified as it is always collapsed
        function toggleTheme() {
            document.body.classList.toggle('dark-mode');
            userData.theme = document.body.classList.contains('dark-mode') ? 'dark' : 'light';
            localStorage.setItem('ted_userdata', JSON.stringify(userData));
        }

        function checkStreakIntegrity() {
            if (!userData.lastStudyDate) return;
            const today = new Date();
            const lastStudy = new Date(userData.lastStudyDate);
            today.setHours(0,0,0,0);
            lastStudy.setHours(0,0,0,0);
            const diffTime = Math.abs(today - lastStudy);
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            if (diffDays > 1) {
                userData.streak = 0;
                localStorage.setItem('ted_userdata', JSON.stringify(userData));
            }
        }

        function updateStreakOnStudy() {
            const today = new Date();
            const todayStr = today.toISOString().split('T')[0];
            if (userData.lastStudyDate === todayStr) return;
            const lastStudy = userData.lastStudyDate ? new Date(userData.lastStudyDate) : null;
            if (lastStudy) {
                lastStudy.setHours(0,0,0,0);
                const currentToday = new Date();
                currentToday.setHours(0,0,0,0);
                const diffTime = Math.abs(currentToday - lastStudy);
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                if (diffDays === 1) userData.streak++;
                else userData.streak = 1;
            } else { userData.streak = 1; }
            userData.lastStudyDate = todayStr;
            localStorage.setItem('ted_userdata', JSON.stringify(userData));
        }
        
        // --- NEW: Change Revision Level Logic ---
        function changeRevisionLevel(newLevel) {
            showConfirm("Alterar Intensidade?", "Mudar o nvel de reviso resetar o agendamento de TODOS os cards para hoje, para aplicar o novo ritmo. Deseja continuar?", () => {
                userData.revisionLevel = newLevel;
                
                // Reset interval and nextReview for all cards
                cards.forEach(c => {
                    c.interval = 0;
                    c.nextReview = Date.now();
                });
                
                localStorage.setItem('ted_userdata', JSON.stringify(userData));
                localStorage.setItem('ted_flashcards', JSON.stringify(cards));
                
                showAlert("Sucesso", "Nvel de reviso atualizado e cards resetados.");
                
                // Refresh dashboard if active to show new due count
                if (!document.getElementById('dashboard-view').classList.contains('hidden')) renderDashboard();
            });
        }

        // --- NAVEGAO ---
        function switchTab(tab) {
            document.querySelectorAll('.view-section').forEach(el => el.classList.add('hidden'));
            const target = document.getElementById(tab + '-view');
            if(target) target.classList.remove('hidden');
            
            const titles = {
                'dashboard': 'INCIO', 'study':'ESTUDAR', 
                'notes':'CADERNO', 'schedule':'CRONOGRAMA', 'performance':'DADOS',
                'card-detail': 'DETALHES', 'note-editor': 'EDITOR', 'settings': 'CONFIGURAES',
                'syllabus': 'EDITAIS', 'syllabus-detail': 'EDITAL',
                'pomodoro': 'POMODORO'
            };
            document.getElementById('page-title-display').innerText = titles[tab] || '';
            
            document.querySelectorAll('.nav-item, .bottom-nav-item').forEach(btn => btn.classList.remove('active'));
            
            let activeTab = tab;
            if(tab === 'syllabus-detail') activeTab = 'syllabus';
            if(tab === 'card-detail') activeTab = 'study';
            if(tab === 'note-editor') activeTab = 'notes';

            document.querySelectorAll(`button[onclick="switchTab('${activeTab}')"]`).forEach(btn => btn.classList.add('active'));

            if (tab === 'notes') renderCurrentFolder();
            if (tab === 'schedule') { renderSchedule(); renderTasks(); }
            if (tab === 'dashboard') renderDashboard();
            if (tab === 'pomodoro') renderPomoHistory();
            if (tab === 'study') {
                 // Default to practice if not set, or maintain state if switching back
                 if(document.querySelector('.study-nav-btn.active').id === 'sub-nav-practice') loadStudyView();
                 if(document.querySelector('.study-nav-btn.active').id === 'sub-nav-library') renderManageList();
            }
            if (tab === 'performance') renderPerformanceView();
            if (tab === 'syllabus') renderSyllabusList();

            // Floating Widget Logic
            const floatWidget = document.getElementById('floating-timer-widget');
            if(tab === 'pomodoro') {
                floatWidget.classList.remove('visible');
            } else {
                // Show if running OR if active but paused (timeLeft < fullTime)
                const fullTime = pomoSettings[pomoCurrentMode] * 60;
                if(pomoIsRunning || pomoTimeLeft < fullTime) {
                    floatWidget.classList.add('visible');
                } else {
                    floatWidget.classList.remove('visible');
                }
            }
        }

        // --- UNIFIED STUDY NAVIGATION ---
        function switchStudyTab(subTab) {
            // Hide all sub-views
            document.getElementById('sub-view-practice').classList.add('hidden');
            document.getElementById('sub-view-library').classList.add('hidden');
            document.getElementById('sub-view-creator').classList.add('hidden');
            
            // Deactivate nav buttons
            document.querySelectorAll('.study-nav-btn').forEach(btn => btn.classList.remove('active'));
            
            // Activate target
            document.getElementById(`sub-nav-${subTab}`).classList.add('active');
            document.getElementById(`sub-view-${subTab}`).classList.remove('hidden');
            
            // Load specific logic
            if (subTab === 'practice') loadStudyView();
            if (subTab === 'library') renderManageList();
            if (subTab === 'creator') {
                // If we are not editing, ensure form is clean
                if (!editingId) resetForm();
            }
        }

        // --- MODIFIED: FAB LOGIC with upward expansion ---
        function toggleFabMenu() {
            document.getElementById('fab-container').classList.toggle('open');
            document.getElementById('fab-button').classList.toggle('active');
        }
        
        function quickCreate(type) {
            toggleFabMenu(); // close menu
            if (type === 'card') {
                switchTab('study');
                switchStudyTab('creator');
            } else if (type === 'note') {
                createNewNote();
            } else if (type === 'goal') {
                // Global Quick Task creation
                openGenericModal('Nova Meta', '', false, (text) => {
                    if(text && text.trim() !== '') {
                        tasks.push({id:Date.now(), text:text.trim(), done:false});
                        saveSchedule();
                        // If we are on dashboard or schedule, update view
                        if(!document.getElementById('dashboard-view').classList.contains('hidden')) renderDashboard();
                        if(!document.getElementById('schedule-view').classList.contains('hidden')) renderTasks();
                        alert('Meta adicionada!');
                    }
                });
            }
        }

        function saveEditais() { localStorage.setItem('ted_editais', JSON.stringify(editais)); }

        function openGenericModal(title, initialValue, isTextarea = false, callback) {
            document.getElementById('generic-modal-title').innerText = title;
            if (isTextarea) {
                document.getElementById('generic-modal-input').style.display = 'none';
                document.getElementById('generic-modal-textarea-container').style.display = 'block';
                document.getElementById('generic-modal-textarea').value = initialValue || '';
            } else {
                document.getElementById('generic-modal-input').style.display = 'block';
                document.getElementById('generic-modal-textarea-container').style.display = 'none';
                document.getElementById('generic-modal-input').value = initialValue || '';
            }
            genericModalIsTextarea = isTextarea;
            genericModalCallback = callback;
            document.getElementById('generic-modal').classList.remove('hidden');
        }

        function closeGenericModal() {
            document.getElementById('generic-modal').classList.add('hidden');
            genericModalCallback = null;
        }

        // --- POMODORO LOGIC START ---
        function setPomoMode(mode) {
            // If timer is running, stop it
            if(pomoIsRunning) toggleTimer();
            
            pomoCurrentMode = mode;
            pomoTimeLeft = pomoSettings[mode] * 60;
            updateTimerDisplay();
            updatePomoTabs();
            // Reset bar
            document.getElementById('pomo-progress-bar').style.width = '0%';
        }

        function updatePomoTabs() {
            document.querySelectorAll('.pomo-tab').forEach(t => t.classList.remove('active'));
            document.getElementById(`pomo-mode-${pomoCurrentMode}`).classList.add('active');
        }

        function updateTimerDisplay() {
            const m = Math.floor(pomoTimeLeft / 60);
            const s = pomoTimeLeft % 60;
            const timeStr = `${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;
            document.getElementById('timer-display').innerText = timeStr;
            document.title = `TeddyApp (BETA)`;
            
            // Update Floating Widget
            document.getElementById('float-time-display').innerText = timeStr;
        }

        function toggleTimer() {
            const btn = document.getElementById('btn-toggle-timer');
            // Removed float button icon logic
            
            if (pomoIsRunning) {
                clearInterval(pomoTimer);
                pomoIsRunning = false;
                btn.innerHTML = '<i class="fas fa-play" style="margin-left:4px;"></i>';
                btn.style.background = 'var(--primary)';
            } else {
                pomoTimer = setInterval(() => {
                    if (pomoTimeLeft > 0) {
                        pomoTimeLeft--;
                        updateTimerDisplay();
                        
                        // Update Progress Bar
                        const totalTime = pomoSettings[pomoCurrentMode] * 60;
                        const percent = ((totalTime - pomoTimeLeft) / totalTime) * 100;
                        document.getElementById('pomo-progress-bar').style.width = percent + '%';
                    } else {
                        finishPomoSession();
                    }
                }, 1000);
                pomoIsRunning = true;
                btn.innerHTML = '<i class="fas fa-pause"></i>';
                btn.style.background = 'var(--warning)';
                
                // If not on pomodoro tab, show widget
                if(document.getElementById('pomodoro-view').classList.contains('hidden')) {
                     document.getElementById('floating-timer-widget').classList.add('visible');
                }
            }
        }

        function resetTimer() {
            if(pomoIsRunning) toggleTimer();
            pomoTimeLeft = pomoSettings[pomoCurrentMode] * 60;
            updateTimerDisplay();
            document.getElementById('pomo-progress-bar').style.width = '0%';
            document.getElementById('floating-timer-widget').classList.remove('visible');
        }

        // Helper to get week number consistently
        function getWeekNumber(d) {
            // Copy date so don't modify original
            d = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
            // Set to nearest Thursday: current date + 4 - current day number
            // Make Sunday's day number 7
            d.setUTCDate(d.getUTCDate() + 4 - (d.getUTCDay() || 7));
            // Get first day of year
            var yearStart = new Date(Date.UTC(d.getUTCFullYear(),0,1));
            // Calculate full weeks to nearest Thursday
            var weekNo = Math.ceil(( ( (d.valueOf() - yearStart.valueOf()) / 86400000) + 1)/7);
            return weekNo;
        }

        function finishPomoSession() {
            if(pomoIsRunning) toggleTimer(); // Stop timer
            const audio = new Audio('https://actions.google.com/sounds/v1/alarms/beep_short.ogg');
            audio.play().catch(e=>console.log(e));
            
            showAlert("Tempo Esgotado!", "Sesso finalizada com sucesso! Seus dados foram salvos.");

            // Save to history automatically as "Pomodoro" if focus
            if (pomoCurrentMode === 'focus') {
                const sessionName = "Pomodoro";
                const now = new Date();
                
                const newItem = {
                    id: Date.now(),
                    name: sessionName,
                    duration: pomoSettings.focus, // Note: This logs the planned duration, or could log elapsed if modified
                    type: 'focus',
                    date: now.toISOString()
                };
                pomoHistory.unshift(newItem);
                savePomoHistory();
                renderPomoHistory();

                // Save to Schedule Grid (Current time slot)
                const currentYear = now.getFullYear();
                const weekNum = getWeekNumber(now); // Use consistent week helper
                const dayIndex = now.getDay() === 0 ? 6 : now.getDay() - 1; // Mon=0 ... Sun=6
                const hour = now.getHours();

                if(hour >= 0 && hour <= 23) {
                    const key = `${currentYear}-${weekNum}-${dayIndex}-${hour}`;
                    // Force save regardless of duration
                    scheduleData[key] = { title: "Pomodoro", color: "var(--primary)" }; 
                    saveSchedule();
                    
                    // If schedule view is open, refresh
                    if(!document.getElementById('schedule-view').classList.contains('hidden')) renderSchedule();
                }
            }
            
            resetTimer();
        }

        function openPomoSettings() {
            document.getElementById('pomo-input-focus').value = pomoSettings.focus;
            document.getElementById('pomo-input-short').value = pomoSettings.short;
            document.getElementById('pomo-input-long').value = pomoSettings.long;
            document.getElementById('pomo-settings-modal').classList.remove('hidden');
        }

        function savePomoSettings() {
            const f = parseInt(document.getElementById('pomo-input-focus').value);
            const s = parseInt(document.getElementById('pomo-input-short').value);
            const l = parseInt(document.getElementById('pomo-input-long').value);
            
            if(f > 0 && s > 0 && l > 0) {
                pomoSettings = { focus: f, short: s, long: l };
                localStorage.setItem('ted_pomo_settings', JSON.stringify(pomoSettings));
                document.getElementById('pomo-settings-modal').classList.add('hidden');
                // Reset current timer to reflect changes
                resetTimer();
            } else {
                alert("Valores invlidos.");
            }
        }

        function savePomoHistory() {
            localStorage.setItem('ted_pomo_history', JSON.stringify(pomoHistory));
        }

                function renderPomoHistory() {
            const list = document.getElementById('pomo-history-list');
            list.innerHTML = '';
            
            // Pega o histrico atualizado
            // IMPORTANTE: Garantir que usamos a varivel pomoHistory se ela for global, ou ler do localStorage
            let currentHistory = JSON.parse(localStorage.getItem('ted_pomo_history') || '[]');
            
            // Verifica se tem itens visveis (no ocultos)
            const visibleItems = currentHistory.filter(item => !item.hidden);

            if (visibleItems.length === 0) {
                // Se tiver o elemento de mensagem vazia, usa ele, seno cria um div
                const emptyMsg = document.getElementById('pomo-empty-msg');
                if (emptyMsg) emptyMsg.classList.remove('hidden');
                else list.innerHTML = '<div style="text-align:center; color:var(--text-muted); padding:20px;">Nenhuma sesso visvel.</div>';
                return;
            }
            
            // Esconde msg de vazio se existir
            const emptyMsg = document.getElementById('pomo-empty-msg');
            if(emptyMsg) emptyMsg.classList.add('hidden');

            // Percorre o histrico INVERTIDO para mostrar os mais novos primeiro
            // Mas mantendo a referncia correta para edio
            currentHistory.slice().reverse().forEach(item => {
                // Se estiver oculto, pula
                if (item.hidden) return;

                const date = new Date(item.date || item.timestamp || item.endTime);
                const dateStr = date.toLocaleDateString('pt-BR') + ' ' + date.toLocaleTimeString('pt-BR', {hour:'2-digit', minute:'2-digit'});
                
                // Layout Original que voc tinha
                list.innerHTML += `
                    <div class="pomo-item">
                        <div class="pomo-info">
                            <h4>${item.name || 'Sesso de Estudo'} <span class="card-badge tag-pomo" style="display:inline; padding:2px 6px; font-size:0.7rem;">${item.duration} min</span></h4>
                            <span>${dateStr}</span>
                        </div>
                        <div class="pomo-actions">
                            <!-- Boto Salvar na Agenda (Mantido) -->
                            <button class="btn-sm btn-outline" title="Salvar no Cronograma" onclick="addPomoToSchedule(${item.id})"><i class="fas fa-calendar-plus"></i></button>
        
                            <!-- Boto Editar (Mantido) -->
                            <button class="btn-sm btn-outline" title="Editar" onclick="editPomoItem(${item.id})"><i class="fas fa-pen"></i></button>
                            
                            <!-- Boto Excluir MODIFICADO para usar a funo hidePomoSession -->
                            <!-- Note que passamos o ID do item, no o index -->
                            <button class="btn-sm btn-danger" title="Excluir da lista (mantm nos dados)" onclick="hidePomoSessionById(${item.id})"><i class="fas fa-trash"></i></button>
                        </div>
                    </div>
                `;
            });
        }


        function editPomoItem(id) {
            const item = pomoHistory.find(i => i.id === id);
            openGenericModal('Editar Sesso', item.name, false, (newName) => {
                if (newName && newName.trim() !== '') {
                    item.name = newName.trim();
                    savePomoHistory();
                    renderPomoHistory();
                }
            });
        }

        function deletePomoItem(id) {
            showConfirm("Excluir Sesso", "Deseja realmente apagar este registro do histrico?", () => {
                pomoHistory = pomoHistory.filter(i => i.id !== id);
                savePomoHistory();
                renderPomoHistory();
            });
        }
        
        function clearPomoHistory() {
            if(pomoHistory.length === 0) return;
            showConfirm("Limpar Histrico", "Deseja apagar todas as sesses registradas?", () => {
                pomoHistory = [];
                savePomoHistory();
                renderPomoHistory();
            });
        }

        function addPomoToSchedule(id) {
            const item = pomoHistory.find(i => i.id === id);
            if(item) {
                // Manually add to current slot based on item date
                const date = new Date(item.date); // Use the date stored in history
                const currentYear = date.getFullYear();
                const weekNum = getWeekNumber(date); // Use helper
                const dayIndex = date.getDay() === 0 ? 6 : date.getDay() - 1; 
                const hour = date.getHours();

                if(hour >= 0 && hour <= 23) {
                    const key = `${currentYear}-${weekNum}-${dayIndex}-${hour}`;
                    scheduleData[key] = { title: `Pomo: ${item.name}`, color: "var(--primary)" }; 
                    saveSchedule();
                    showAlert("Sucesso", "Adicionado  grade de horrios com sucesso!");
                    if(!document.getElementById('schedule-view').classList.contains('hidden')) renderSchedule();
                } else {
                    showAlert("Erro", "Horrio invlido.");
                }
            }
        }
        // --- POMODORO LOGIC END ---

        function openLinkTopicModal(subjectId, topicId) {
            linkingTopicData = { subjectId, topicId };
            const edital = editais.find(e => e.id === currentEditalId);
            const subject = edital.subjects.find(s => s.id === subjectId);
            const topic = subject.topics.find(t => t.id === topicId);
            
            // Setup Categories
            selectedLinkCategory = topic.linkedCategory || null;
            document.getElementById('link-category-search').value = selectedLinkCategory || '';
            updateLinkSubcategories(topic.linkedSubcategory);
            updateLinkPreview();

            // Setup Notes
            selectedLinkNoteId = topic.linkedNoteId || null;
            if (selectedLinkNoteId) {
                const note = notes.find(n => n.id === selectedLinkNoteId);
                document.getElementById('link-note-search').value = note ? note.title : '';
            } else {
                document.getElementById('link-note-search').value = '';
            }

            document.getElementById('link-topic-modal').classList.remove('hidden');
        }

        function filterLinkCategories() {
            const input = document.getElementById('link-category-search');
            const filter = input.value.toLowerCase();
            const results = document.getElementById('link-category-results');
            
            const categories = [...new Set(cards.map(c => c.category || 'Geral'))].sort();
            const filtered = categories.filter(c => c.toLowerCase().includes(filter));
            
            results.innerHTML = '';
            if (filtered.length > 0) {
                filtered.forEach(cat => {
                    results.innerHTML += `<div class="search-result-item" onclick="selectLinkCategory('${cat}')">${cat}</div>`;
                });
                results.style.display = 'block';
            } else {
                results.style.display = 'none';
            }
        }
        
        function selectLinkCategory(cat) {
            selectedLinkCategory = cat;
            document.getElementById('link-category-search').value = cat;
            document.getElementById('link-category-results').style.display = 'none';
            updateLinkSubcategories();
            updateLinkPreview();
        }

        function filterLinkNotes() {
            const input = document.getElementById('link-note-search');
            const filter = input.value.toLowerCase();
            const results = document.getElementById('link-note-results');
            
            const filtered = notes.filter(n => n.title.toLowerCase().includes(filter));
            
            results.innerHTML = '';
            // Add option to clear
            results.innerHTML += `<div class="search-result-item" onclick="selectLinkNote(null, '')" style="color:var(--danger);"><i class="fas fa-times"></i> Nenhuma anotao</div>`;
            
            if (filtered.length > 0) {
                filtered.forEach(n => {
                    const folderName = n.folderId ? (folders.find(f => f.id === n.folderId)?.name || 'Pasta desconhecida') : 'Incio';
                    results.innerHTML += `<div class="search-result-item" onclick="selectLinkNote('${n.id}', '${n.title}')"><strong>${n.title}</strong><span>${folderName}</span></div>`;
                });
                results.style.display = 'block';
            } else if (filter === '') {
                // Show recent/all if empty
                 notes.slice(0, 10).forEach(n => {
                    const folderName = n.folderId ? (folders.find(f => f.id === n.folderId)?.name || 'Pasta desconhecida') : 'Incio';
                    results.innerHTML += `<div class="search-result-item" onclick="selectLinkNote('${n.id}', '${n.title}')"><strong>${n.title}</strong><span>${folderName}</span></div>`;
                });
                results.style.display = 'block';
            } else {
                results.style.display = 'none';
            }
        }
        
        function selectLinkNote(id, title) {
            selectedLinkNoteId = id;
            document.getElementById('link-note-search').value = title;
            document.getElementById('link-note-results').style.display = 'none';
        }

        function updateLinkSubcategories(selectedSubcategory = '') {
            const subcategorySelect = document.getElementById('link-subcategory-select');
            const category = selectedLinkCategory;
            subcategorySelect.innerHTML = '<option value="">Todas as subcategorias</option>';
            if (category) {
                const subcategories = [...new Set(cards.filter(c => (c.category || 'Geral') === category && c.subcategory).map(c => c.subcategory))].sort();
                subcategories.forEach(sub => {
                    subcategorySelect.innerHTML += `<option value="${sub}" ${selectedSubcategory === sub ? 'selected' : ''}>${sub}</option>`;
                });
            }
            updateLinkPreview();
        }

        function updateLinkPreview() {
            const category = selectedLinkCategory;
            const subcategory = document.getElementById('link-subcategory-select').value;
            const previewDiv = document.getElementById('link-preview');
            const countSpan = document.getElementById('link-card-count');
            
            if (!category) { 
                previewDiv.style.display = 'none'; 
                return; 
            }
            
            let filteredCards = cards.filter(c => (c.category || 'Geral') === category);
            if (subcategory) filteredCards = filteredCards.filter(c => c.subcategory === subcategory);
            
            countSpan.textContent = filteredCards.length;
            previewDiv.style.display = 'block';
        }

        function saveTopicLink() {
            if (!linkingTopicData) return;
            const { subjectId, topicId } = linkingTopicData;
            
            const category = selectedLinkCategory;
            const subcategory = document.getElementById('link-subcategory-select').value || '';
            const noteId = selectedLinkNoteId;

            const edital = editais.find(e => e.id === currentEditalId);
            const subject = edital.subjects.find(s => s.id === subjectId);
            const topic = subject.topics.find(t => t.id === topicId);
            
            // Update Card Links
            topic.linkedCategory = category || null;
            topic.linkedSubcategory = subcategory || null;
            
            // Update Note Link
            topic.linkedNoteId = noteId;

            saveEditais();
            document.getElementById('link-topic-modal').classList.add('hidden');
            renderEditalDetail();
        }

        function openLinkedNote(noteId) {
            openNoteEditor(noteId);
        }

        function startSimulationForTopic(subjectId, topicId) {
            const edital = editais.find(e => e.id === currentEditalId);
            const subject = edital.subjects.find(s => s.id === subjectId);
            const topic = subject.topics.find(t => t.id === topicId);
            if (!topic.linkedCategory) return alert('Este tpico no est vinculado a nenhuma categoria de cards.');
            let filteredCards = cards.filter(c => (c.category || 'Geral') === topic.linkedCategory);
            if (topic.linkedSubcategory) filteredCards = filteredCards.filter(c => c.subcategory === topic.linkedSubcategory);
            if (filteredCards.length === 0) return alert('Nenhum card encontrado para esta associao.');
            simulationQueue = [...filteredCards].sort(() => 0.5 - Math.random());
            simulationResults = { correct: 0, wrong: 0, total: simulationQueue.length };
            currentSimulationLog = [];
            currentSessionTotal = simulationQueue.length;
            currentSessionDone = 0;
            studyMode = 'simulation';
            
            // NEW NAV INIT
            currentCardIndex = 0;
            sessionAnswers = {};
            
            document.getElementById('study-content').classList.remove('hidden');
            document.getElementById('simulation-result').classList.add('hidden');
            document.getElementById('no-cards-msg').classList.add('hidden');
            showCard(simulationQueue[0]);
            switchTab('study');
            switchStudyTab('practice');
            document.getElementById('due-count').innerText = simulationQueue.length;
            document.getElementById('finish-review-btn').classList.remove('hidden'); // Show finish early
        }

        function loadStudyView() {
            if (studyMode === 'simulation' && simulationQueue.length > 0) {
                document.getElementById('simulation-result').classList.add('hidden');
                document.getElementById('study-content').classList.remove('hidden');
                document.getElementById('no-cards-msg').classList.add('hidden');
                showCard(simulationQueue[currentCardIndex]);
            } else if (studyMode === 'standard') {
                loadStudySession();
            }
        }

        function countCardsForTopic(topic) {
            if (!topic.linkedCategory) return 0;
            let filteredCards = cards.filter(c => (c.category || 'Geral') === topic.linkedCategory);
            if (topic.linkedSubcategory) filteredCards = filteredCards.filter(c => c.subcategory === topic.linkedSubcategory);
            return filteredCards.length;
        }

        function editEditalTitle() {
            const edital = editais.find(e => e.id === currentEditalId);
            openGenericModal('Editar Nome do Edital', edital.title, false, (newTitle) => {
                if (newTitle && newTitle.trim() !== '') {
                    edital.title = newTitle.trim();
                    saveEditais();
                    renderEditalDetail();
                }
            });
        }

        function editSubject(subjectId) {
            const edital = editais.find(e => e.id === currentEditalId);
            const subject = edital.subjects.find(s => s.id === subjectId);
            openGenericModal('Editar Matria', subject.title, false, (newTitle) => {
                if (newTitle && newTitle.trim() !== '') {
                    subject.title = newTitle.trim();
                    saveEditais();
                    renderEditalDetail();
                }
            });
        }

        function editTopic(subjectId, topicId) {
            const edital = editais.find(e => e.id === currentEditalId);
            const subject = edital.subjects.find(s => s.id === subjectId);
            const topic = subject.topics.find(t => t.id === topicId);
            openGenericModal('Editar Tpico', topic.text, false, (newText) => {
                if (newText && newText.trim() !== '') {
                    topic.text = newText.trim();
                    saveEditais();
                    renderEditalDetail();
                }
            });
        }

        function reorderSubjects() {
            const edital = editais.find(e => e.id === currentEditalId);
            reorderingData = edital.subjects;
            reorderingType = 'subjects';
            openReorderModal('Matrias');
        }

        function reorderTopics(subjectId) {
            const edital = editais.find(e => e.id === currentEditalId);
            const subject = edital.subjects.find(s => s.id === subjectId);
            reorderingData = subject.topics;
            reorderingType = 'topics';
            openReorderModal('Tpicos');
        }

        function openReorderModal(title) {
            document.getElementById('reorder-modal-title').innerText = `Reorganizar ${title}`;
            const container = document.getElementById('reorder-list-container');
            container.innerHTML = '';
            reorderingData.forEach((item, index) => {
                const itemDiv = document.createElement('div');
                itemDiv.className = 'draggable-item';
                itemDiv.draggable = true;
                itemDiv.dataset.index = index;
                itemDiv.innerHTML = `<div class="drag-handle"><i class="fas fa-grip-vertical"></i></div><div style="flex:1;">${item.title || item.text}</div><div style="font-size:0.8rem; color:var(--text-muted);">${index + 1}</div>`;
                itemDiv.addEventListener('dragstart', (e) => { e.dataTransfer.setData('text/plain', index); itemDiv.classList.add('dragging'); });
                itemDiv.addEventListener('dragend', () => { document.querySelectorAll('.draggable-item').forEach(el => { el.classList.remove('dragging'); }); });
                container.appendChild(itemDiv);
            });
            container.addEventListener('dragover', (e) => {
                e.preventDefault();
                const dragging = document.querySelector('.dragging');
                const siblings = [...container.querySelectorAll('.draggable-item:not(.dragging)')];
                const nextSibling = siblings.find(sibling => {
                    const box = sibling.getBoundingClientRect();
                    const offset = e.clientY - box.top - box.height / 2;
                    return offset < 0;
                });
                container.insertBefore(dragging, nextSibling);
            });
            document.getElementById('reorder-modal').classList.remove('hidden');
        }

        function saveReordering() {
            const container = document.getElementById('reorder-list-container');
            const newOrder = [...container.querySelectorAll('.draggable-item')].map(item => {
                const index = parseInt(item.dataset.index);
                return reorderingData[index];
            });
            if (reorderingType === 'subjects') {
                const edital = editais.find(e => e.id === currentEditalId);
                edital.subjects = newOrder;
            } else if (reorderingType === 'topics') {
                const edital = editais.find(e => e.id === currentEditalId);
                for (let subject of edital.subjects) {
                    if (subject.topics === reorderingData) { subject.topics = newOrder; break; }
                }
            }
            saveEditais();
            renderEditalDetail();
            document.getElementById('reorder-modal').classList.add('hidden');
        }

        function createNewEdital() {
            openGenericModal('Novo Edital', '', false, (name) => {
                if (name && name.trim() !== '') {
                    editais.push({ id: Date.now(), title: name.trim(), subjects: [] });
                    saveEditais();
                    renderSyllabusList();
                }
            });
        }

        function renderSyllabusList() {
            const container = document.getElementById('syllabus-list-container');
            container.innerHTML = '';
            if(editais.length === 0) { container.innerHTML = `<div style="text-align:center; color:var(--text-muted); margin-top:20px;">Voc ainda no criou nenhum edital.</div>`; return; }
            editais.forEach(edital => {
                let totalTopics = 0; let doneTopics = 0; let linkedTopics = 0;
                edital.subjects.forEach(sub => { totalTopics += sub.topics.length; doneTopics += sub.topics.filter(t => t.done).length; linkedTopics += sub.topics.filter(t => t.linkedCategory || t.linkedNoteId).length; });
                const percent = totalTopics === 0 ? 0 : Math.round((doneTopics / totalTopics) * 100);
                container.innerHTML += `<div class="syllabus-item" onclick="openEdital(${edital.id})"><div style="flex:1;"><h4 style="margin-bottom:8px; font-size:1.1rem; color:var(--text-main);">${edital.title}</h4><div style="font-size:0.85rem; color:var(--text-muted);">${edital.subjects.length} Matrias  ${totalTopics} Tpicos  ${linkedTopics} Vinculados</div></div><div style="display:flex; align-items:center; gap:12px;"><strong style="color:var(--primary); font-size:1.1rem;">${percent}%</strong><i class="fas fa-chevron-right" style="color:var(--text-muted);"></i></div></div>`;
            });
        }

        function openEdital(id) { currentEditalId = id; renderEditalDetail(); switchTab('syllabus-detail'); }

        function renderEditalDetail() {
            const edital = editais.find(e => e.id === currentEditalId);
            if(!edital) return switchTab('syllabus');
            document.getElementById('current-edital-title').innerText = edital.title;
            let totalTopics = 0; let doneTopics = 0;
            edital.subjects.forEach(sub => { totalTopics += sub.topics.length; doneTopics += sub.topics.filter(t => t.done).length; });
            const percent = totalTopics === 0 ? 0 : Math.round((doneTopics / totalTopics) * 100);
            document.getElementById('current-edital-percent').innerText = `${percent}%`;
            document.getElementById('current-edital-progress').style.width = `${percent}%`;
            const container = document.getElementById('subjects-container');
            container.innerHTML = '';
            if(edital.subjects.length === 0) { container.innerHTML = `<div style="text-align:center; color:var(--text-muted); padding:40px;">Nenhuma matria adicionada.</div>`; }
            edital.subjects.forEach((sub, subIndex) => {
                const subTotal = sub.topics.length; const subDone = sub.topics.filter(t => t.done).length; const subPercent = subTotal === 0 ? 0 : Math.round((subDone / subTotal) * 100);
                let topicsHtml = '';
                sub.topics.forEach((topic, topicIndex) => {
                    const topicCount = countCardsForTopic(topic);
                    
                    // Buttons logic
                    let linkButtons = '';
                    if (topic.linkedCategory) {
                         linkButtons += `<button class="topic-card-count" onclick="startSimulationForTopic(${sub.id}, ${topic.id})" title="Simulado: ${topic.linkedCategory}${topic.linkedSubcategory ? '  ' + topic.linkedSubcategory : ''}"><i class="fas fa-play-circle" style="margin-right: 4px;"></i> ${topicCount} questes</button>`;
                    }
                    if (topic.linkedNoteId) {
                         linkButtons += `<button class="topic-card-count" style="background:var(--info);" onclick="openLinkedNote('${topic.linkedNoteId}')" title="Abrir anotao vinculada"><i class="fas fa-sticky-note" style="margin-right: 4px;"></i> Anotao</button>`;
                    }

                    topicsHtml += `<div class="topic-row ${topic.done ? 'done' : ''}"><div class="topic-check" onclick="toggleTopic(${sub.id}, ${topic.id})">${topic.done ? '<i class="fas fa-check" style="font-size:0.8rem"></i>' : ''}</div><span style="flex:1; font-size:0.95rem;">${topic.text}</span>${linkButtons}<div class="topic-controls"><button class="btn-icon" onclick="openLinkTopicModal(${sub.id}, ${topic.id})" title="Vincular contedo"><i class="fas fa-link"></i></button><button class="btn-icon" onclick="editTopic(${sub.id}, ${topic.id})" title="Editar"><i class="fas fa-pen"></i></button><button class="btn-icon" onclick="deleteTopic(${sub.id}, ${topic.id})" title="Excluir" style="color:var(--danger);"><i class="fas fa-trash"></i></button></div></div>`;
                });
                container.innerHTML += `<div class="subject-container ${sub.collapsed ? 'collapsed' : ''}"><div class="subject-header" onclick="toggleSubjectCollapse(${sub.id})"><div class="subject-title"><i class="fas fa-chevron-down chevron-icon"></i>${sub.title}</div><div style="display:flex; align-items:center; gap:16px;"><div class="subject-progress"><div class="subject-progress-bar" style="width:${subPercent}%"></div></div><span style="font-size:0.85rem; font-weight:700; color:var(--text-muted);">${subPercent}%</span><div class="subject-controls"><button class="btn-icon" onclick="reorderTopics(${sub.id})" title="Reorganizar tpicos"><i class="fas fa-sort"></i></button><button class="btn-icon" onclick="editSubject(${sub.id})" title="Editar"><i class="fas fa-pen"></i></button><button class="btn-icon" onclick="deleteSubject(${sub.id})" title="Excluir" style="color:var(--danger);"><i class="fas fa-trash"></i></button></div></div></div><div class="topic-list ${sub.collapsed ? 'hidden' : ''}">${topicsHtml}<div style="padding:10px 16px;"><button class="btn-sm btn-outline" onclick="addTopicToSubject(${sub.id})" style="width:100%; border-style:dashed; font-size:0.85rem;"><i class="fas fa-plus"></i> Adicionar Tpico</button></div></div></div>`;
            });
        }

        function addSubjectToEdital() {
            openGenericModal('Nova Matria', '', false, (title) => {
                if (title && title.trim() !== '') {
                    const edital = editais.find(e => e.id === currentEditalId);
                    edital.subjects.push({ id: Date.now(), title: title.trim(), collapsed: false, topics: [] });
                    saveEditais();
                    renderEditalDetail();
                }
            });
        }

        function addTopicToSubject(subjectId) {
            openGenericModal('Novo Tpico', '', false, (text) => {
                if (text && text.trim() !== '') {
                    const edital = editais.find(e => e.id === currentEditalId);
                    const sub = edital.subjects.find(s => s.id === subjectId);
                    sub.topics.push({ id: Date.now(), text: text.trim(), done: false, linkedCategory: null, linkedSubcategory: null, linkedNoteId: null });
                    sub.collapsed = false;
                    saveEditais();
                    renderEditalDetail();
                }
            });
        }

        function toggleTopic(subjectId, topicId) {
            const edital = editais.find(e => e.id === currentEditalId);
            const sub = edital.subjects.find(s => s.id === subjectId);
            const topic = sub.topics.find(t => t.id === topicId);
            topic.done = !topic.done;
            saveEditais();
            renderEditalDetail();
        }

        function toggleSubjectCollapse(subjectId) {
            const edital = editais.find(e => e.id === currentEditalId);
            const sub = edital.subjects.find(s => s.id === subjectId);
            sub.collapsed = !sub.collapsed;
            saveEditais();
            renderEditalDetail();
        }

        function deleteSubject(subjectId) {
            if(confirm("Excluir esta matria e todos os tpicos?")) {
                const edital = editais.find(e => e.id === currentEditalId);
                edital.subjects = edital.subjects.filter(s => s.id !== subjectId);
                saveEditais();
                renderEditalDetail();
            }
        }

        function deleteTopic(subjectId, topicId) {
             const edital = editais.find(e => e.id === currentEditalId);
             const sub = edital.subjects.find(s => s.id === subjectId);
             sub.topics = sub.topics.filter(t => t.id !== topicId);
             saveEditais();
             renderEditalDetail();
        }

        function deleteCurrentEdital() {
            if(confirm("Tem certeza que deseja apagar este edital inteiro?")) {
                editais = editais.filter(e => e.id !== currentEditalId);
                saveEditais();
                switchTab('syllabus');
            }
        }

        function importFromNotes() {
            openGenericModal('Importar do Caderno', '', true, (content) => {
                if (content && content.trim() !== '') { alert('Funcionalidade de importao ser implementada em breve!'); }
            });
        }

        function renderCurrentFolder() {
            const container = document.getElementById('file-explorer');
            const breadcrumbs = document.getElementById('notes-breadcrumbs');
            const search = document.getElementById('search-notes').value.toLowerCase();
            container.innerHTML = ''; breadcrumbs.innerHTML = '';
            let path = []; let tempId = currentFolderId;
            while(tempId) { const f = folders.find(x => x.id === tempId); if(f) { path.unshift(f); tempId = f.parentId; } else break; }
            breadcrumbs.innerHTML += `<div class="breadcrumb-item ${currentFolderId===null?'active':''}" onclick="navigateToFolder(null)"><i class="fas fa-home"></i> Incio</div>`;
            path.forEach(f => breadcrumbs.innerHTML += ` / <div class="breadcrumb-item ${currentFolderId===f.id?'active':''}" onclick="navigateToFolder('${f.id}')">${f.name}</div>`);
            let visibleFolders = folders.filter(f => search ? f.name.toLowerCase().includes(search) : f.parentId === currentFolderId);
            let visibleNotes = notes.filter(n => search ? n.title.toLowerCase().includes(search) : n.folderId === currentFolderId);
            visibleFolders.forEach(f => {
                container.innerHTML += `<div class="file-item" onclick="if(!event.target.closest('.file-btn')) navigateToFolder('${f.id}')"><div class="file-actions"><div class="file-btn" onclick="renameFolder('${f.id}')"><i class="fas fa-pen"></i></div><div class="file-btn delete" onclick="deleteFolder('${f.id}')"><i class="fas fa-trash"></i></div></div><div class="file-icon" style="color:#fbbf24;"><i class="fas fa-folder"></i></div><div class="file-name">${f.name}</div></div>`;
            });
            visibleNotes.forEach(n => {
                container.innerHTML += `<div class="file-item" onclick="if(!event.target.closest('.file-btn')) openNoteEditor('${n.id}')"><div class="file-actions"><div class="file-btn delete" onclick="deleteNote('${n.id}')"><i class="fas fa-trash"></i></div></div><div class="file-icon" style="color:var(--text-muted);"><i class="fas fa-file-alt"></i></div><div class="file-name">${n.title}</div></div>`;
            });
            document.getElementById('empty-folder-msg').classList.toggle('hidden', visibleFolders.length > 0 || visibleNotes.length > 0);
        }
        function navigateToFolder(id) { currentFolderId = id; document.getElementById('search-notes').value = ''; renderCurrentFolder(); }
        
        function promptNewFolder() { 
            openGenericModal('Nova Pasta', '', false, (name) => {
                if(name && name.trim() !== '') {
                    folders.push({id:'f_'+Date.now(), name: name.trim(), parentId:currentFolderId}); 
                    saveNotesData(); 
                    renderCurrentFolder();
                }
            });
        }
        
        function renameFolder(id) { const f = folders.find(x => x.id === id); if(!f) return; const newName = prompt("Novo nome:", f.name); if(newName) { f.name = newName; saveNotesData(); renderCurrentFolder(); } }
        
        function deleteFolder(id) {
            if(confirm("Apagar pasta e todo o seu contedo?")) {
                // Collect IDs to delete
                let folderIdsToDelete = [id];
                
                const collectSubfolderIds = (parentId) => {
                    const subs = folders.filter(f => f.parentId === parentId);
                    subs.forEach(sub => {
                        folderIdsToDelete.push(sub.id);
                        collectSubfolderIds(sub.id);
                    });
                };
                collectSubfolderIds(id);
                
                // Delete notes in these folders
                notes = notes.filter(n => !folderIdsToDelete.includes(n.folderId));
                
                // Delete the folders
                folders = folders.filter(f => !folderIdsToDelete.includes(f.id));
                
                saveNotesData(); 
                renderCurrentFolder();
            }
        }
        
        function createNewNote() { editingNoteId = null; openNoteEditor(null); }
        function openNoteEditor(id) { 
            editingNoteId = id; 
            const n = notes.find(x=>x.id===id); 
            document.getElementById('note-title').value = n?n.title:''; 
            document.getElementById('note-content').innerHTML = n?n.content:''; 
            
            // Populate folder dropdown
            const folderSelect = document.getElementById('note-folder-select');
            folderSelect.innerHTML = '<option value="null">Incio</option>';
            
            // Sort folders alphabetically for better UX
            const sortedFolders = [...folders].sort((a,b) => a.name.localeCompare(b.name));
            
            sortedFolders.forEach(f => {
                folderSelect.innerHTML += `<option value="${f.id}" ${n ? (n.folderId === f.id ? 'selected' : '') : (currentFolderId === f.id ? 'selected' : '')}>${f.name}</option>`;
            });
            if(n && n.folderId === null) folderSelect.value = "null";
            if(!n && currentFolderId === null) folderSelect.value = "null";

            switchTab('note-editor'); 
        }
        function saveNote() { 
            const t = document.getElementById('note-title').value; 
            const c = document.getElementById('note-content').innerHTML; 
            let fId = document.getElementById('note-folder-select').value;
            if(fId === 'null') fId = null;
            
            // BUG FIX: Prevent ghost notes by checking if folder actually exists
            if (fId && !folders.find(f => f.id === fId)) {
                alert("A pasta selecionada no existe mais. A nota ser salva no Incio.");
                fId = null;
            }

            if(editingNoteId) { 
                const i = notes.findIndex(x=>x.id===editingNoteId); 
                notes[i] = {...notes[i], title:t, content:c, folderId:fId}; 
            } else { 
                notes.push({id:'n_'+Date.now(), title:t||'Nova Nota', content:c, folderId:fId}); 
            } 
            saveNotesData(); 
            // Update currentFolderId to where we saved it to prevent confusion on return
            currentFolderId = fId;
            switchTab('notes'); 
        }
        function deleteNote(id) { if(confirm("Apagar nota?")) { notes=notes.filter(n=>n.id!==id); saveNotesData(); renderCurrentFolder(); } }
        function saveNotesData() { localStorage.setItem('ted_folders', JSON.stringify(folders)); localStorage.setItem('ted_notes', JSON.stringify(notes)); }
        function formatText(cmd, arg=null) { document.getElementById('note-content').focus(); document.execCommand(cmd, false, arg); }
        function closeNoteEditor() { switchTab('notes'); }

        function renderDashboard() {
            const now = Date.now();
            const due = cards.filter(c => c.nextReview <= now).length;
            document.getElementById('dash-due-count').innerText = due;
            document.getElementById('dash-streak').innerText = `${userData.streak} dias`;
            const nextTaskEl = document.getElementById('dash-next-task');
            if(cards.length > 0) {
                const nextCard = [...cards].sort((a,b) => a.nextReview - b.nextReview)[0];
                const dateStr = new Date(nextCard.nextReview).toLocaleString('pt-BR', {day:'2-digit', month:'2-digit', hour:'2-digit', minute:'2-digit'});
                nextTaskEl.innerHTML = `<div style="font-size:0.9rem">${dateStr}</div><div style="font-size:0.8rem; color:var(--primary); font-weight:600;">${nextCard.category || 'Geral'}</div>`;
            } else { nextTaskEl.innerText = "Nenhuma"; }
            const chart = document.getElementById('dash-mini-chart'); chart.innerHTML = '';
            for(let i=6; i>=0; i--) {
                const d = new Date(); d.setDate(d.getDate() - i);
                const count = performanceData.filter(p => p.date === d.toISOString().split('T')[0]).length;
                const h = Math.min(count * 5, 80);
                chart.innerHTML += `<div class="chart-col"><div class="chart-bar-container"><div class="chart-bar" style="height:${Math.max(4, h)}px;background:${count>0?'var(--primary)':'var(--border)'};"></div></div><div class="chart-label">${d.toLocaleDateString('pt-BR', {weekday:'short'}).slice(0,3)}</div></div>`;
            }
            const tasksPreview = document.getElementById('dash-tasks-preview'); tasksPreview.innerHTML = '';
            const pendingTasks = tasks.filter(t => !t.done); const doneTasks = tasks.filter(t => t.done);
            if (pendingTasks.length === 0 && doneTasks.length === 0) tasksPreview.innerHTML = '<div style="font-size:0.85rem; color:var(--text-muted); font-style:italic;">Nenhuma meta definida.</div>';
            else if (pendingTasks.length === 0 && doneTasks.length > 0) tasksPreview.innerHTML = '<div style="font-size:0.85rem; color:var(--success); font-weight:bold;"><i class="fas fa-check-circle"></i> Tudo concludo!</div>';
            else { pendingTasks.slice(0, 3).forEach(t => { tasksPreview.innerHTML += `<div style="display:flex; gap:10px; align-items:center; background:var(--bg-body); padding:8px; border-radius:6px; font-size:0.9rem;"><div class="task-check" onclick="toggleTask(${t.id}); renderDashboard();" style="width:16px; height:16px; min-width:16px;"></div><span style="overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">${t.text}</span></div>`; }); if (pendingTasks.length > 3) tasksPreview.innerHTML += `<div style="font-size:0.8rem; color:var(--text-muted); text-align:center;">+ ${pendingTasks.length - 3} metas</div>`; }
        }

        function renderTasks() { const c = document.getElementById('tasks-container'); c.innerHTML = ''; tasks.forEach(t => c.innerHTML += `<div class="task-item ${t.done?'completed':''}"><div class="task-check" onclick="toggleTask(${t.id})">${t.done?'<i class="fas fa-check"></i>':''}</div><span style="flex:1;">${t.text}</span><i class="fas fa-trash" onclick="deleteTask(${t.id})" style="color:var(--text-muted);cursor:pointer;"></i></div>`); }
        function addTask() { const v = document.getElementById('new-task-input').value; if(v) { tasks.push({id:Date.now(), text:v, done:false}); document.getElementById('new-task-input').value=''; saveSchedule(); renderTasks(); renderDashboard(); } }
        function toggleTask(id) { const t=tasks.find(x=>x.id===id); if(t)t.done=!t.done; saveSchedule(); renderTasks(); renderDashboard(); }
        function deleteTask(id) { tasks=tasks.filter(x=>x.id!==id); saveSchedule(); renderTasks(); renderDashboard(); }
        function clearCompletedTasks() { tasks=tasks.filter(t=>!t.done); saveSchedule(); renderTasks(); renderDashboard(); }

        // --- SCHEDULE & POMODORO INTEGRATION FIX ---
        
        // Helper to get week number consistently
        function getWeekNumber(d) {
            // Copy date so don't modify original
            d = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
            // Set to nearest Thursday: current date + 4 - current day number
            // Make Sunday's day number 7
            d.setUTCDate(d.getUTCDate() + 4 - (d.getUTCDay() || 7));
            // Get first day of year
            var yearStart = new Date(Date.UTC(d.getUTCFullYear(),0,1));
            // Calculate full weeks to nearest Thursday
            var weekNo = Math.ceil(( ( (d.valueOf() - yearStart.valueOf()) / 86400000) + 1)/7);
            return weekNo;
        }

        function renderSchedule() {
            const body = document.getElementById('schedule-body'); body.innerHTML = '';
            
            // Calculate the Monday of the current displayed week
            const today = new Date(); 
            today.setDate(today.getDate() + (currentWeekOffset*7));
            const diff = today.getDate() - today.getDay() + (today.getDay()===0?-6:1);
            const monday = new Date(today.setDate(diff));
            
            const realToday = new Date();
            document.getElementById('current-week-label').innerText = `${monday.getDate()} - Semana`;
            
            // Render Headers (Mon-Sun)
            for(let i=0; i<7; i++) { 
                const d=new Date(monday); 
                d.setDate(monday.getDate()+i); 
                const th=document.getElementById(`th-${i}`); 
                th.innerText = ["SEG","TER","QUA","QUI","SEX","SB","DOM"][i] + " " + d.getDate(); 
                th.style.color='var(--text-muted)'; 
                if(d.getDate()===realToday.getDate() && d.getMonth()===realToday.getMonth()) th.style.color='var(--primary)'; 
            }
            
            // Consistent Week Calculation for Rendering
            // This ensures keys like '2024-42-0-13' match between saving and rendering
            const currentYear = monday.getFullYear();
            const weekNum = getWeekNumber(monday);
            const weekKey = `${currentYear}-${weekNum}`;
            
            for(let h=0; h<=23; h++) {
                const tr = document.createElement('tr'); 
                tr.innerHTML = `<td class="time-label">${h}:00</td>`;
                for(let d=0; d<7; d++) {
                    const k = `${weekKey}-${d}-${h}`; 
                    const b = scheduleData[k];
                    tr.innerHTML += `<td>${b ? `<div class="event-block" style="background:${b.color}" onclick="editSch('${k}')">${b.title}</div>` : `<div class="empty-cell-btn" onclick="createSch('${k}')"><i class="fas fa-plus"></i></div>`}</td>`;
                } 
                body.appendChild(tr);
            }
        }
        
        function saveSchedule() { localStorage.setItem('ted_schedule', JSON.stringify(scheduleData)); localStorage.setItem('ted_tasks', JSON.stringify(tasks)); }
        window.createSch = (k) => { editingScheduleBlock=k; document.getElementById('schedule-block-title').value=''; document.getElementById('btn-delete-block').classList.add('hidden'); document.getElementById('schedule-modal').classList.remove('hidden'); };
        window.editSch = (k) => { editingScheduleBlock=k; document.getElementById('schedule-block-title').value=scheduleData[k].title; selectedColor=scheduleData[k].color; document.getElementById('btn-delete-block').classList.remove('hidden'); document.getElementById('schedule-modal').classList.remove('hidden'); };
        function saveScheduleBlock() { if(!document.getElementById('schedule-block-title').value) return; scheduleData[editingScheduleBlock]={title:document.getElementById('schedule-block-title').value, color:selectedColor}; saveSchedule(); document.getElementById('schedule-modal').classList.add('hidden'); renderSchedule(); }
        function deleteScheduleBlock() { delete scheduleData[editingScheduleBlock]; saveSchedule(); document.getElementById('schedule-modal').classList.add('hidden'); renderSchedule(); }
        function closeScheduleModal() { document.getElementById('schedule-modal').classList.add('hidden'); }
        function selectColor(c, el) { selectedColor=c; document.querySelectorAll('.color-chip').forEach(x=>x.style.border='3px solid transparent'); el.style.border='3px solid white'; }
        function changeWeek(d) { currentWeekOffset+=d; renderSchedule(); }
        
        // --- NEW: TEMPLATE SYSTEM LOGIC ---
        let currentTemplateType = null; // 'task' or 'schedule'

        function openTemplateModal(type, action) {
            currentTemplateType = type;
            const titlePrefix = type === 'task' ? 'Meta' : 'Agenda';
            
            if (action === 'save') {
                openGenericModal(`Salvar Modelo de ${titlePrefix}`, '', false, (name) => {
                    if (name && name.trim() !== '') {
                        saveTemplate(type, name.trim());
                    }
                });
            } else if (action === 'load') {
                document.getElementById('template-modal-title').innerText = `Carregar Modelo de ${titlePrefix}`;
                renderTemplateList(type);
                document.getElementById('template-modal').classList.remove('hidden');
            }
        }

        function saveTemplate(type, name) {
            if (type === 'task') {
                const currentTasks = tasks.map(t => ({ text: t.text, done: false })); // Reset done state on save
                if (currentTasks.length === 0) return alert("Adicione metas antes de salvar um modelo.");
                
                const newTemplate = { id: Date.now(), name: name, data: currentTasks };
                taskTemplates.push(newTemplate);
                localStorage.setItem('ted_task_templates', JSON.stringify(taskTemplates));
                showAlert("Sucesso", "Modelo de metas salvo!");
            } else if (type === 'schedule') {
                // For schedule, we need to abstract the week/dates and only save dayIndex-hour mapping
                // We iterate scheduleData and filter for current view's week or just extract structure
                // BETTER STRATEGY: Save the RELATIVE structure of what is visible or just abstract all current data?
                // Simplified: Save ALL currently defined schedule blocks, but we need to normalize dates for templates.
                // However, user likely wants to save "This Week's Structure".
                
                // Let's capture the structure of the CURRENTLY VISIBLE WEEK
                const today = new Date(); 
                today.setDate(today.getDate() + (currentWeekOffset*7));
                const diff = today.getDate() - today.getDay() + (today.getDay()===0?-6:1);
                const monday = new Date(today.setDate(diff));
                const currentYear = monday.getFullYear();
                const weekNum = getWeekNumber(monday);
                const weekKeyPrefix = `${currentYear}-${weekNum}`;
                
                let weekData = [];
                for(let d=0; d<7; d++) {
                    for(let h=0; h<=23; h++) {
                        const key = `${weekKeyPrefix}-${d}-${h}`;
                        if(scheduleData[key]) {
                            weekData.push({ day: d, hour: h, title: scheduleData[key].title, color: scheduleData[key].color });
                        }
                    }
                }
                
                if (weekData.length === 0) return alert("A semana atual est vazia. Adicione horrios antes de salvar.");
                
                const newTemplate = { id: Date.now(), name: name, data: weekData };
                scheduleTemplates.push(newTemplate);
                localStorage.setItem('ted_schedule_templates', JSON.stringify(scheduleTemplates));
                showAlert("Sucesso", "Modelo de agenda salvo!");
            }
        }

        function renderTemplateList(type) {
            const list = document.getElementById('template-list-container');
            const emptyMsg = document.getElementById('template-empty-msg');
            list.innerHTML = '';
            
            const templates = type === 'task' ? taskTemplates : scheduleTemplates;
            
            if (templates.length === 0) {
                emptyMsg.classList.remove('hidden');
                return;
            }
            emptyMsg.classList.add('hidden');
            
            templates.forEach(t => {
                const item = document.createElement('div');
                item.className = 'template-item';
                item.innerHTML = `
                    <div onclick="applyTemplate('${type}', ${t.id})" style="flex:1; font-weight:600;">${t.name}</div>
                    <div style="display:flex; gap:8px;">
                        <button class="btn-sm btn-outline" onclick="applyTemplate('${type}', ${t.id})" title="Carregar"><i class="fas fa-upload"></i></button>
                        <button class="btn-sm btn-danger" onclick="deleteTemplate('${type}', ${t.id})" title="Excluir"><i class="fas fa-trash"></i></button>
                    </div>
                `;
                list.appendChild(item);
            });
        }

        function deleteTemplate(type, id) {
            showConfirm("Excluir Modelo", "Tem certeza?", () => {
                if (type === 'task') {
                    taskTemplates = taskTemplates.filter(t => t.id !== id);
                    localStorage.setItem('ted_task_templates', JSON.stringify(taskTemplates));
                } else {
                    scheduleTemplates = scheduleTemplates.filter(t => t.id !== id);
                    localStorage.setItem('ted_schedule_templates', JSON.stringify(scheduleTemplates));
                }
                renderTemplateList(type);
            });
        }

        function applyTemplate(type, id) {
            showConfirm("Carregar Modelo", "Isso substituir/adicionar os itens atuais. Deseja continuar?", () => {
                if (type === 'task') {
                    const template = taskTemplates.find(t => t.id === id);
                    if (template) {
                        // Append or Replace? Let's Replace for "Template" behavior, or user cleans first. 
                        // Let's Append to be safe, user can clear list easily.
                        template.data.forEach(item => {
                            tasks.push({ id: Date.now() + Math.random(), text: item.text, done: false });
                        });
                        saveSchedule();
                        renderTasks();
                        renderDashboard();
                        showAlert("Sucesso", "Metas carregadas!");
                    }
                } else if (type === 'schedule') {
                    const template = scheduleTemplates.find(t => t.id === id);
                    if (template) {
                        // Apply to CURRENT visible week
                        const today = new Date(); 
                        today.setDate(today.getDate() + (currentWeekOffset*7));
                        const diff = today.getDate() - today.getDay() + (today.getDay()===0?-6:1);
                        const monday = new Date(today.setDate(diff));
                        const currentYear = monday.getFullYear();
                        const weekNum = getWeekNumber(monday);
                        const weekKeyPrefix = `${currentYear}-${weekNum}`;
                        
                        // Overwrite slots
                        template.data.forEach(item => {
                            const key = `${weekKeyPrefix}-${item.day}-${item.hour}`;
                            scheduleData[key] = { title: item.title, color: item.color };
                        });
                        saveSchedule();
                        renderSchedule();
                        showAlert("Sucesso", "Agenda carregada na semana atual!");
                    }
                }
                document.getElementById('template-modal').classList.add('hidden');
            });
        }

        // --- FLASHCARDS LOGIC ---
        function handleSave() {
            const q = document.getElementById('input-question').innerHTML; 
            const a = document.getElementById('input-opt-a').value;
            const comment = document.getElementById('input-comment').value; 
            const cat = document.getElementById('input-category').value;
            const subcat = document.getElementById('input-subcategory').value; 
            
            if(!q || !a) return alert('Preencha pergunta e resposta correta!');

            const newCard = {
                id: editingId ? editingId : Date.now(),
                question: q, 
                correctText: a,
                category: cat,
                subcategory: subcat,
                comment: comment,
                options:[a, document.getElementById('input-opt-b').value, document.getElementById('input-opt-c').value, document.getElementById('input-opt-d').value].filter(Boolean),
                nextReview: editingId ? (cards.find(c=>c.id===editingId).nextReview) : Date.now(), 
                interval: editingId ? (cards.find(c=>c.id===editingId).interval) : 0
            };

            if(editingId) {
                const index = cards.findIndex(c => c.id === editingId);
                cards[index] = newCard;
                editingId = null;
            } else { cards.push(newCard); }

            localStorage.setItem('ted_flashcards', JSON.stringify(cards));
            resetForm();
            // Switch to Library view after save
            switchStudyTab('library');
        }

        function updateSubcategorySuggestions() {
            const currentCat = document.getElementById('input-category').value;
            const subList = document.getElementById('subcategory-list-suggestions');
            subList.innerHTML = '';
            const relevantCards = cards.filter(c => (c.category || '').toLowerCase() === currentCat.toLowerCase());
            const subs = [...new Set(relevantCards.map(c => c.subcategory).filter(Boolean))];
            subs.forEach(s => { subList.innerHTML += `<option value="${s}">`; });
        }

        function resetForm() {
            document.querySelectorAll('#sub-view-creator input, #sub-view-creator textarea').forEach(i=>i.value=''); 
            document.getElementById('input-question').innerHTML=''; 
            document.getElementById('save-btn').innerHTML = '<i class="fas fa-save"></i> Salvar Card';
            document.getElementById('cancel-edit-btn').classList.add('hidden');
            editingId = null;
        }

        function renderManageList() {
            const l = document.getElementById('cards-list-container'); l.innerHTML=''; 
            const s = document.getElementById('search-cards').value.toLowerCase();
            const catFilter = document.getElementById('filter-category').value;
            document.getElementById('total-cards-count').innerText = `Total de Cards: ${cards.length}`;
            const filtered = cards.filter(c => {
                const matchesSearch = c.question.toLowerCase().includes(s);
                const matchesCat = catFilter === 'all' || c.category === catFilter;
                return matchesSearch && matchesCat;
            });
            if(filtered.length === 0) {
                 document.getElementById('empty-list-msg').classList.remove('hidden');
            } else {
                 document.getElementById('empty-list-msg').classList.add('hidden');
                 filtered.forEach(c=>{ 
                    const nextRev = new Date(c.nextReview).toLocaleString('pt-BR', {day:'2-digit', month:'2-digit', hour:'2-digit', minute:'2-digit'});
                    const subDisplay = c.subcategory ? ` <span style="opacity:0.6"> ${c.subcategory}</span>` : '';
                    const shortId = '#' + c.id.toString().slice(-4); 
                    l.innerHTML += `<div class="card-list-item"><div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;"><div style="display:flex; align-items:center; gap:8px;"><span class="id-badge">${shortId}</span><div class="card-badge">${c.category||'Geral'}${subDisplay}</div></div><div style="font-size:0.8rem; color:var(--text-muted); font-weight:600;"><i class="far fa-clock"></i> ${nextRev}</div></div><div class="card-body" style="font-weight:600;">${c.question}</div><div style="display:flex; gap:10px; justify-content:flex-end; margin-top:10px;"><button class="btn-sm btn-outline" onclick="viewCard(${c.id})"><i class="fas fa-eye"></i></button><button class="btn-sm btn-outline" onclick="editCard(${c.id})"><i class="fas fa-pen"></i></button><button class="btn-sm btn-danger" onclick="deleteCard(${c.id})"><i class="fas fa-trash"></i></button></div></div>`; 
                });
            }
        }

        function viewCard(id) {
            const c = cards.find(x => x.id === id);
            currentCard = c; 
            document.getElementById('detail-category').innerText = c.category || 'Geral';
            document.getElementById('detail-question').innerHTML = c.question;
            document.getElementById('detail-comment-text').innerText = c.comment || 'Sem explicao registrada.';
            const list = document.getElementById('detail-options-list');
            list.innerHTML = '';
            list.innerHTML += `<div class="option-btn correct" style="cursor:default;">${c.correctText} <i class="fas fa-check"></i></div>`;
            c.options.forEach(o => { if(o !== c.correctText) list.innerHTML += `<div class="option-btn" style="cursor:default; opacity:0.7;">${o}</div>`; });
            switchTab('card-detail');
        }

        function editCard(id) {
            const c = cards.find(x => x.id === id);
            editingId = id;
            document.getElementById('input-category').value = c.category || '';
            document.getElementById('input-subcategory').value = c.subcategory || ''; 
            document.getElementById('input-question').innerHTML = c.question;
            document.getElementById('input-opt-a').value = c.correctText;
            document.getElementById('input-comment').value = c.comment || '';
            const wrongs = c.options.filter(o => o !== c.correctText);
            if(wrongs[0]) document.getElementById('input-opt-b').value = wrongs[0];
            if(wrongs[1]) document.getElementById('input-opt-c').value = wrongs[1];
            if(wrongs[2]) document.getElementById('input-opt-d').value = wrongs[2];
            document.getElementById('save-btn').innerHTML = '<i class="fas fa-pen"></i> Atualizar';
            document.getElementById('cancel-edit-btn').classList.remove('hidden');
            
            // Switch to Create view inside Study tab
            switchTab('study');
            switchStudyTab('creator');
        }

        function editCurrentCard() { if(currentCard) editCard(currentCard.id); }
        function deleteCurrentCard() { if(currentCard) deleteCard(currentCard.id); }
        function deleteCard(id) { if(confirm('Excluir?')) { cards=cards.filter(c=>c.id!==id); localStorage.setItem('ted_flashcards', JSON.stringify(cards)); renderManageList(); switchTab('study'); switchStudyTab('library'); } }

        function loadStudySession() { 
            studyMode = 'standard';
            document.getElementById('simulation-result').classList.add('hidden');
            document.getElementById('study-content').classList.remove('hidden');
            sessionQueue = cards.filter(c=>c.nextReview <= Date.now()); 
            currentSessionTotal = sessionQueue.length;
            currentSessionDone = 0;
            
            // RESET NAV STATE
            currentCardIndex = 0;
            sessionAnswers = {};
            
            document.getElementById('due-count').innerText=sessionQueue.length; 
            if(sessionQueue.length) showCard(sessionQueue[0]); 
            else { 
                document.getElementById('study-content').classList.add('hidden'); 
                document.getElementById('no-cards-msg').classList.remove('hidden'); 
            } 
        }
        
        function showCard(c) { 
            currentCard = c; 
            currentSelectedOption = null;
            currentSelectedBtn = null;
            
            // Update Progress Display (1-based index)
            document.getElementById('study-progress-display').innerText = `${currentCardIndex + 1} / ${currentSessionTotal}`;
            
            document.getElementById('study-content').classList.remove('hidden'); 
            document.getElementById('no-cards-msg').classList.add('hidden'); 
            document.getElementById('simulation-result').classList.add('hidden');
            document.getElementById('question-display').innerHTML=c.question; 
            document.getElementById('category-display').innerText = c.category || 'GERAL';
            document.getElementById('subcategory-display').innerText = c.subcategory || '';
            document.getElementById('card-id-display').innerText = '#' + c.id.toString().slice(-4);
            document.getElementById('options-display').innerHTML=''; 
            
            // Comment Section Reset
            document.getElementById('comment-display').classList.add('hidden');
            document.getElementById('comment-edit-wrapper').classList.add('hidden');
            document.getElementById('comment-content-wrapper').classList.remove('hidden');
            
            // Handle Buttons State based on index
            document.getElementById('nav-prev-btn').disabled = (currentCardIndex === 0);
            
            // If already answered, render state
            const previousAnswer = sessionAnswers[c.id];
            
            if (previousAnswer) {
                 renderAnsweredState(previousAnswer);
            } else {
                 renderUnansweredState();
            }

            const prefixes = ['a.', 'b.', 'c.', 'd.', 'e.'];
            
            c.options.sort(()=>Math.random()-0.5).forEach((o, index)=>{ 
                const b=document.createElement('button'); 
                b.className='option-btn'; 
                b.dataset.val = o;
                b.innerHTML = `<strong>${prefixes[index]||'-'}</strong> ${o}`; 
                
                if (previousAnswer) {
                    b.disabled = true;
                    if (o === c.correctText) b.classList.add('correct');
                    if (previousAnswer.selected === o && o !== c.correctText) b.classList.add('wrong');
                } else {
                    b.onclick=()=>selectAnswer(b, o); 
                }
                
                document.getElementById('options-display').appendChild(b); 
            }); 
        }
        
        function renderUnansweredState() {
            document.getElementById('confirm-action-btn').classList.remove('hidden');
            document.getElementById('view-comment-btn').classList.add('hidden');
            // Allow skipping
            document.getElementById('nav-next-btn').disabled = false;
        }
        
        function renderAnsweredState(answerData) {
            document.getElementById('confirm-action-btn').classList.add('hidden');
            document.getElementById('view-comment-btn').classList.remove('hidden');
            document.getElementById('nav-next-btn').disabled = false;
            
            // Load comment content
            if(currentCard.comment && currentCard.comment.trim() !== "") {
                document.getElementById('comment-text').innerText = currentCard.comment;
            } else {
                document.getElementById('comment-text').innerText = "Nenhuma explicao registrada.";
                document.getElementById('comment-text').style.fontStyle = "italic";
                document.getElementById('comment-text').style.color = "var(--text-muted)";
            }
        }
        
        // --- NEW COMMENT EDITING FUNCTIONS ---
        function toggleCommentSection() {
            const el = document.getElementById('comment-display');
            if (el.classList.contains('hidden')) {
                el.classList.remove('hidden');
                // Ensure correct state when opening
                if(currentCard.comment && currentCard.comment.trim() !== "") {
                    document.getElementById('comment-text').innerText = currentCard.comment;
                    document.getElementById('comment-text').style.fontStyle = "normal";
                    document.getElementById('comment-text').style.color = "var(--text-main)";
                } else {
                    document.getElementById('comment-text').innerText = "Nenhuma explicao registrada.";
                    document.getElementById('comment-text').style.fontStyle = "italic";
                    document.getElementById('comment-text').style.color = "var(--text-muted)";
                }
            } else {
                el.classList.add('hidden');
            }
        }
        
        function enableCommentEdit() {
            document.getElementById('comment-content-wrapper').classList.add('hidden');
            document.getElementById('comment-edit-wrapper').classList.remove('hidden');
            document.getElementById('comment-edit-area').value = currentCard.comment || "";
            document.getElementById('comment-edit-area').focus();
        }
        
        function saveCommentEdit() {
            const newComment = document.getElementById('comment-edit-area').value;
            
            // Update current object
            currentCard.comment = newComment;
            
            // Update main array
            const index = cards.findIndex(c => c.id === currentCard.id);
            if(index !== -1) {
                cards[index].comment = newComment;
                localStorage.setItem('ted_flashcards', JSON.stringify(cards));
            }
            
            // Reset UI
            document.getElementById('comment-edit-wrapper').classList.add('hidden');
            document.getElementById('comment-content-wrapper').classList.remove('hidden');
            
            if(newComment && newComment.trim() !== "") {
                document.getElementById('comment-text').innerText = newComment;
                document.getElementById('comment-text').style.fontStyle = "normal";
                document.getElementById('comment-text').style.color = "var(--text-main)";
            } else {
                document.getElementById('comment-text').innerText = "Nenhuma explicao registrada.";
                document.getElementById('comment-text').style.fontStyle = "italic";
                document.getElementById('comment-text').style.color = "var(--text-muted)";
            }
        }

        function selectAnswer(btn, text) {
            // If already answered, do nothing
            if (sessionAnswers[currentCard.id]) return;
            
            document.querySelectorAll('.option-btn').forEach(b => b.classList.remove('selected'));
            btn.classList.add('selected');
            currentSelectedOption = text;
            currentSelectedBtn = btn;
        }

        function confirmAnswer() {
            if(!currentSelectedOption) return alert("Por favor, selecione uma alternativa.");
            const isCor = currentSelectedOption === currentCard.correctText;
            
            // Save state
            sessionAnswers[currentCard.id] = {
                selected: currentSelectedOption,
                correct: isCor
            };
            
            // Update UI
            currentSelectedBtn.classList.remove('selected');
            currentSelectedBtn.classList.add(isCor ? 'correct' : 'wrong');
            
            if(!isCor) { 
                document.querySelectorAll('.option-btn').forEach(b => { 
                    if(b.dataset.val === currentCard.correctText) { b.classList.add('correct'); } 
                }); 
            }
            
            document.querySelectorAll('.option-btn').forEach(b => b.disabled = true);
            
            // Change buttons
            renderAnsweredState();
            
            if(studyMode === 'simulation') {
                if(isCor) simulationResults.correct++;
                else simulationResults.wrong++;
                
                // Add to detailed log
                currentSimulationLog.push({
                    question: currentCard.question,
                    userAnswer: currentSelectedOption,
                    correctAnswer: currentCard.correctText,
                    isCorrect: isCor,
                    category: currentCard.category || 'Geral'
                });
                
            } else {
                updateStreakOnStudy();
                document.getElementById('dash-streak').innerText = `${userData.streak} dias`;
                
                if(studyMode === 'standard') { 
                    const idx = cards.findIndex(x=>x.id===currentCard.id); 
                    
                    if(isCor) {
                        // Apply intensity logic
                        let multiplier = 2; // Moderate (Standard)
                        const level = userData.revisionLevel || 'moderate';
                        
                        if (level === 'light') multiplier = 3; // Increases interval faster (less frequent)
                        if (level === 'intense') multiplier = 1.5; // Increases interval slower (more frequent)
                        
                        cards[idx].interval = cards[idx].interval === 0 ? 1 : Math.ceil(cards[idx].interval * multiplier);
                        cards[idx].nextReview = Date.now() + (cards[idx].interval * 86400000); 
                    } else { 
                        cards[idx].interval = 0; 
                        cards[idx].nextReview = Date.now(); 
                    } 
                    
                    localStorage.setItem('ted_flashcards', JSON.stringify(cards)); 
                }
            }
            
            if(studyMode !== 'simulation') {
                 performanceData.push({date:new Date().toISOString().split('T')[0], correct:isCor, category:currentCard.category||'Geral'}); localStorage.setItem('ted_performance', JSON.stringify(performanceData));
            }
        }

        // --- NEW NAV FUNCTIONS ---
        function prevCard() {
            if (currentCardIndex > 0) {
                currentCardIndex--;
                let queue;
                if(studyMode === 'simulation') queue = simulationQueue;
                else if(studyMode === 'random') queue = randomReviewQueue;
                else queue = sessionQueue;
                showCard(queue[currentCardIndex]);
            }
        }

        function nextCard() {
            let queue;
            if(studyMode === 'simulation') queue = simulationQueue;
            else if(studyMode === 'random') queue = randomReviewQueue;
            else queue = sessionQueue;
            
            if (currentCardIndex < queue.length - 1) {
                currentCardIndex++;
                showCard(queue[currentCardIndex]);
            } else {
                // End of queue
                if(studyMode === 'simulation') finishSimulation(); 
                else {
                    alert("Voc chegou ao fim da fila!");
                    document.getElementById('finish-review-btn').classList.remove('hidden');
                }
            }
        }

        function startRandomReview() { 
            studyMode = 'random';
            randomReviewQueue=[...cards].sort(()=>0.5-Math.random()).slice(0,10); 
            currentSessionTotal = randomReviewQueue.length;
            currentSessionDone = 0;
            currentCardIndex = 0;
            sessionAnswers = {};
            
            if(randomReviewQueue.length) showCard(randomReviewQueue[0]); 
            else alert('Sem cards'); 
            
            document.getElementById('finish-review-btn').classList.remove('hidden');
        }
        
        function finishRandomReview() { loadStudySession(); }

        function openSimulationModal() {
            if(cards.length === 0) return alert("Voc precisa criar cards primeiro!");
            const list = document.getElementById('sim-category-list');
            list.innerHTML = '';
            const categories = [...new Set(cards.map(c => c.category || 'Geral'))].sort();
            categories.forEach(cat => {
                const count = cards.filter(c => (c.category||'Geral') === cat).length;
                const item = document.createElement('div');
                item.className = 'sim-config-item';
                item.innerHTML = `<label>${cat} (Disp: ${count})</label><input type="number" class="sim-cat-input" data-cat="${cat}" data-max="${count}" min="0" max="${count}" value="0" onchange="updateSimTotal()">`;
                list.appendChild(item);
            });
            updateSimTotal();
            document.getElementById('simulation-config-modal').classList.remove('hidden');
        }

        function updateSimTotal() {
            let total = 0;
            document.querySelectorAll('.sim-cat-input').forEach(input => {
                let val = parseInt(input.value);
                const max = parseInt(input.getAttribute('data-max'));
                if(val < 0) { val = 0; input.value = 0; }
                if(val > max) { val = max; input.value = max; }
                total += val;
            });
            document.getElementById('sim-total-preview').innerText = total;
        }

        function startSimulationFromConfig() {
            simulationQueue = [];
            document.querySelectorAll('.sim-cat-input').forEach(input => {
                const qty = parseInt(input.value);
                if(qty > 0) {
                    const cat = input.getAttribute('data-cat');
                    const available = cards.filter(c => (c.category||'Geral') === cat);
                    const selected = available.sort(() => 0.5 - Math.random()).slice(0, qty);
                    simulationQueue = simulationQueue.concat(selected);
                }
            });
            if(simulationQueue.length === 0) return alert("Selecione pelo menos 1 questo.");
            simulationQueue.sort(() => 0.5 - Math.random());
            simulationResults = { correct: 0, wrong: 0, total: simulationQueue.length };
            currentSimulationLog = [];
            currentSessionTotal = simulationQueue.length;
            
            // RESET NAV
            currentCardIndex = 0;
            sessionAnswers = {};
            
            studyMode = 'simulation';
            document.getElementById('simulation-config-modal').classList.add('hidden');
            document.getElementById('no-cards-msg').classList.add('hidden');
            document.getElementById('study-content').classList.remove('hidden');
            showCard(simulationQueue[0]);
            document.getElementById('finish-review-btn').classList.remove('hidden');
        }

        function finishSimulation() {
            const p = Math.round((simulationResults.correct / simulationResults.total) * 100);
            document.getElementById('study-content').classList.add('hidden');
            document.getElementById('simulation-result').classList.remove('hidden');
            
            // New UI Population
            document.getElementById('sim-score-pct').innerText = `${p}%`;
            document.getElementById('sim-correct-count').innerText = simulationResults.correct;
            document.getElementById('sim-wrong-count').innerText = simulationResults.wrong;
            document.getElementById('sim-total-count').innerText = simulationResults.total;
            
            // Build Detailed Log (Card Style)
            const logContainer = document.getElementById('sim-detailed-log');
            logContainer.innerHTML = '';
            
            currentSimulationLog.forEach((item, idx) => {
                 const div = document.createElement('div');
                 div.className = `sim-log-item ${item.isCorrect ? 'correct' : 'wrong'}`;
                 div.innerHTML = `
                    <div style="font-weight:600; margin-bottom:6px; font-size:0.95rem;">${idx+1}. ${item.question}</div>
                    <div style="display:flex; justify-content:space-between; font-size:0.9rem;">
                        <span style="color:${item.isCorrect ? 'var(--success)' : 'var(--danger)'}; font-weight:600;">
                            ${item.isCorrect ? '<i class="fas fa-check"></i> Correto' : '<i class="fas fa-times"></i> Errou (Sua: ' + item.userAnswer + ')'}
                        </span>
                        <span style="color:var(--text-muted); font-size:0.8rem; text-transform:uppercase;">${item.category}</span>
                    </div>
                 `;
                 logContainer.appendChild(div);
            });
        }
        
        // Save the simulation result
        function saveSimulationResult() {
            const simRecord = {
                id: Date.now(),
                date: new Date().toISOString(),
                score: simulationResults.correct,
                total: simulationResults.total,
                log: currentSimulationLog
            };
            simulationHistory.unshift(simRecord);
            localStorage.setItem('ted_simulation_history', JSON.stringify(simulationHistory));
            
            alert('Simulado salvo no histrico!');
            // Reload performance view in background
            renderPerformanceView();
            // Go back to menu
            finishRandomReview();
        }

        function updateCategoryDropdowns() { const l = document.getElementById('category-list-suggestions'); const s = document.getElementById('filter-category'); const c = [...new Set(cards.map(x=>x.category||'Geral'))]; if(l)l.innerHTML=c.map(x=>`<option value="${x}">`).join(''); if(s)s.innerHTML='<option value="all">Todas</option>'+c.map(x=>`<option value="${x}">${x}</option>`).join(''); }
        function exportAllData() { const d = { cards, performanceData, folders, notes, scheduleData, tasks, userData, editais, pomoSettings, pomoHistory, simulationHistory, taskTemplates, scheduleTemplates }; const a = document.createElement('a'); a.href = URL.createObjectURL(new Blob([JSON.stringify(d)],{type:'application/json'})); a.download = `Teddy_Backup_${new Date().toISOString().split('T')[0]}.json`; a.click(); }
        function importAllData(i) { const r = new FileReader(); r.onload = e => { try { const d = JSON.parse(e.target.result); cards = d.cards || []; performanceData = d.performanceData || []; folders = d.folders || []; notes = d.notes || []; scheduleData = d.scheduleData || {}; tasks = d.tasks || []; editais = d.editais || []; if(d.userData) userData = d.userData; if(d.pomoSettings) pomoSettings = d.pomoSettings; if(d.pomoHistory) pomoHistory = d.pomoHistory; if(d.simulationHistory) simulationHistory = d.simulationHistory; if(d.taskTemplates) taskTemplates = d.taskTemplates; if(d.scheduleTemplates) scheduleTemplates = d.scheduleTemplates; localStorage.setItem('ted_flashcards', JSON.stringify(cards)); localStorage.setItem('ted_performance', JSON.stringify(performanceData)); localStorage.setItem('ted_editais', JSON.stringify(editais)); localStorage.setItem('ted_pomo_settings', JSON.stringify(pomoSettings)); localStorage.setItem('ted_pomo_history', JSON.stringify(pomoHistory)); localStorage.setItem('ted_simulation_history', JSON.stringify(simulationHistory)); localStorage.setItem('ted_task_templates', JSON.stringify(taskTemplates)); localStorage.setItem('ted_schedule_templates', JSON.stringify(scheduleTemplates)); saveNotesData(); saveSchedule(); localStorage.setItem('ted_userdata', JSON.stringify(userData)); alert('Backup restaurado com sucesso!'); location.reload(); } catch (err) { alert('Erro ao ler o arquivo. Verifique se  um backup vlido.'); } }; r.readAsText(i.files[0]); }
        function clearAllData() { if(confirm("Certeza? Isso apagar TUDO permanentemente.")) { localStorage.clear(); location.reload(); } }
        function goBackTo(t) { switchTab(t); }
        function formatQuestionText(c) { document.getElementById('input-question').focus(); document.execCommand(c, false, null); }

        function changePeriod(period) { 
            currentPeriod = period; 
            currentPeriodIndex = 0; 
            document.querySelectorAll('.banner-period-btn').forEach(b => b.classList.remove('active')); 
            document.getElementById('btn-' + period).classList.add('active'); 
            renderPerformanceView(); 
        }
        function prevPeriod() { currentPeriodIndex++; renderPerformanceView(); }
        function nextPeriod() { if (currentPeriodIndex > 0) currentPeriodIndex--; renderPerformanceView(); }
                        // --- NOVA FUNO: Ocultar pelo ID ---
        function hidePomoSessionById(id) {
            if(!confirm("Deseja ocultar esta sesso da lista? Ela continuar contando no Tempo Total de Estudo.")) return;

            let history = JSON.parse(localStorage.getItem('ted_pomo_history') || '[]');
            
            // Encontra o item pelo ID
            const itemIndex = history.findIndex(i => i.id === id);
            
            if (itemIndex !== -1) {
                history[itemIndex].hidden = true; // Marca como oculto
                localStorage.setItem('ted_pomo_history', JSON.stringify(history));
                
                // Se a varivel global pomoHistory existir, atualize-a tambm para evitar bugs visuais imediatos
                if (typeof pomoHistory !== 'undefined') {
                    pomoHistory = history;
                }

                renderPomoHistory(); // Atualiza a tela
            }
        }

        // MODIFIED: Performance View Reformulated (Horizontal & Banner Buttons)
        function renderPerformanceView() {
            const display = document.getElementById('period-display');
            const totalCountEl = document.getElementById('total-reviews-count');
            const accuracyEl = document.getElementById('accuracy-rate');
            const categoryList = document.getElementById('category-stats-list');
            const chart = document.getElementById('performance-chart');
            const categoryProgressGrid = document.getElementById('category-progress-grid');
            const streakEl = document.getElementById('performance-streak');
            const reviewsTodayEl = document.getElementById('reviews-today');
            
            // New Sim History Elements
            const simHistoryList = document.getElementById('simulation-history-list');
            const simEmptyMsg = document.getElementById('sim-history-empty');

            chart.innerHTML = '';
            categoryList.innerHTML = '';
            categoryProgressGrid.innerHTML = '';

            const now = new Date();
            const today = new Date().toISOString().split('T')[0];
            const reviewsToday = performanceData.filter(p => p.date === today).length;
            reviewsTodayEl.innerText = reviewsToday;
            streakEl.innerText = userData.streak;
            
            // --- RENDER SIMULATION HISTORY (NEW DESIGN) ---
            simHistoryList.innerHTML = '';
            if(!simulationHistory || simulationHistory.length === 0) {
                simEmptyMsg.classList.remove('hidden');
            } else {
                simEmptyMsg.classList.add('hidden');
                simulationHistory.forEach(sim => {
                    const date = new Date(sim.date);
                    const dayStr = date.toLocaleDateString('pt-BR');
                    const timeStr = date.toLocaleTimeString('pt-BR', {hour:'2-digit', minute:'2-digit'});
                    const pct = Math.round((sim.score / sim.total) * 100);
                    
                    let bgClass = 'bg-danger-light';
                    if(pct >= 70) bgClass = 'bg-success-light';
                    else if(pct >= 50) bgClass = 'bg-warning-light';
                    
                    const card = document.createElement('div');
                    card.className = 'sim-history-card';
                    card.innerHTML = `
                        <div class="sim-hist-date">
                            <span class="sim-hist-day">${dayStr}</span>
                            <span class="sim-hist-time">${timeStr}</span>
                        </div>
                        <div style="flex:1;">
                            <div style="font-size:0.85rem; color:var(--text-muted); margin-bottom:4px;">Pontuao</div>
                            <div style="background:var(--bg-body); height:8px; border-radius:4px; overflow:hidden; width:100%; max-width:250px;">
                                <div style="width:${pct}%; height:100%; background:var(--primary);"></div>
                            </div>
                        </div>
                        <div class="sim-hist-score">${sim.score}<span style="font-size:1rem; color:var(--text-muted); font-weight:600;">/${sim.total}</span></div>
                        <div class="sim-hist-pct ${bgClass}">${pct}%</div>
                    `;
                    card.onclick = () => openSimDetail(sim.id);
                    simHistoryList.appendChild(card);
                });
            }

            let startDate, endDate;
            let periodData = [];

            // 1. Calculate Date Range
            if(currentPeriod === 'week') {
                startDate = new Date();
                startDate.setDate(now.getDate() - (currentPeriodIndex * 7) - 6);
                startDate.setHours(0,0,0,0);
                
                endDate = new Date(startDate);
                endDate.setDate(startDate.getDate() + 6);
                endDate.setHours(23,59,59,999);
                
                display.innerText = `${startDate.toLocaleDateString('pt-BR')} - ${endDate.toLocaleDateString('pt-BR')}`;
            } else if(currentPeriod === 'month') {
                startDate = new Date(now.getFullYear(), now.getMonth() - currentPeriodIndex, 1);
                endDate = new Date(now.getFullYear(), now.getMonth() - currentPeriodIndex + 1, 0);
                display.innerText = startDate.toLocaleDateString('pt-BR', { month: 'long', year: 'numeric' });
            } else {
                startDate = new Date(now.getFullYear() - currentPeriodIndex, 0, 1);
                endDate = new Date(now.getFullYear() - currentPeriodIndex, 11, 31);
                display.innerText = startDate.getFullYear();
            }

            // 2. Filter Data by Date Range
            periodData = performanceData.filter(p => {
                const pDate = new Date(p.date);
                return pDate >= startDate && pDate <= endDate;
            });

            const totalReviews = periodData.length;
            const totalCorrect = periodData.filter(p => p.correct).length;
            const accuracy = totalReviews ? Math.round((totalCorrect/totalReviews)*100) : 0;

            totalCountEl.innerText = totalReviews;
            accuracyEl.innerText = accuracy + '%';

            // 3. Render Chart (Daily Evolution)
            if(currentPeriod === 'week') {
                // Show daily breakdown
                for(let i=0; i<7; i++) {
                    const d = new Date(startDate);
                    d.setDate(startDate.getDate()+i);
                    const ds = d.toISOString().split('T')[0];
                    const recs = periodData.filter(p => p.date === ds);
                    const total = recs.length;
                    const corr = recs.filter(r => r.correct).length;
                    const pct = total ? (corr/total)*100 : 0;
                    const dayName = d.toLocaleDateString('pt-BR', {weekday: 'long'});

                    chart.innerHTML += `
                        <div style="display:flex; align-items:center; gap:16px;">
                            <div style="width:100px; font-size:0.9rem; font-weight:600; color:var(--text-muted); text-transform:capitalize;">${dayName}</div>
                            <div style="flex:1;">
                                <div style="display:flex; justify-content:space-between; margin-bottom:4px;">
                                    <span style="font-size:0.85rem; color:var(--text-main);">${corr}/${total} acertos</span>
                                    <span style="font-size:0.85rem; font-weight:bold; color:${pct >= 70 ? 'var(--success)' : pct >= 50 ? 'var(--warning)' : 'var(--danger)'}">${pct.toFixed(0)}%</span>
                                </div>
                                <div style="background:var(--bg-body); height:12px; border-radius:6px; overflow:hidden;">
                                    <div style="width:${pct}%; background:${pct >= 70 ? 'var(--success)' : pct >= 50 ? 'var(--warning)' : 'var(--danger)'}; height:100%;"></div>
                                </div>
                            </div>
                        </div>
                    `;
                }
            } else {
                // Simplified view for Month/Year (just total bar)
                chart.innerHTML = `<div style="text-align:center; padding: 40px; color:var(--text-muted);">Visualizao detalhada disponvel apenas no modo Semana.</div>`;
            }

            // 4. Render Subject Stats (Based on Filtered Data)
            const cats = [...new Set(cards.map(c => c.category || 'Geral'))];
            
            // Check if we have data for this period
            if (periodData.length === 0) {
                 categoryList.innerHTML = "<div style='text-align:center;color:var(--text-muted);padding:20px;'>Nenhum dado registrado neste perodo.</div>";
                 categoryProgressGrid.innerHTML = "<div style='text-align:center;color:var(--text-muted);padding:20px;'>Nenhum dado registrado neste perodo.</div>";
                 return;
            }

            if(cats.length === 0) {
                categoryList.innerHTML = "<div style='text-align:center;color:var(--text-muted);padding:20px;'>Nenhuma matria registrada.</div>";
                categoryProgressGrid.innerHTML = "<div style='text-align:center;color:var(--text-muted);padding:20px;'>Nenhuma categoria com dados.</div>";
            } else {
                let hasDataForCats = false;

                cats.forEach(c => {
                    // Filter periodData for this category
                    const data = periodData.filter(p => p.category === c);
                    const total = data.length;
                    
                    if (total > 0) {
                        hasDataForCats = true;
                        const correct = data.filter(p => p.correct).length;
                        const pct = Math.round((correct/total)*100);
                        
                        // List Style
                        categoryList.innerHTML += `
                            <div class="category-stat-item">
                                <div class="cat-name">${c}</div>
                                <div style="flex:1;margin:0 10px;">
                                    <div class="cat-bar-bg">
                                        <div class="cat-bar-fill" style="width:${pct}%; background:${pct>=70?'var(--success)':pct>=50?'var(--warning)':'var(--danger)'}"></div>
                                    </div>
                                </div>
                                <div class="cat-percent" style="color:${pct>=70?'var(--success)':pct>=50?'var(--warning)':'var(--danger)'}">${pct}%</div>
                            </div>
                        `;
                        
                        // Card Grid Style
                        categoryProgressGrid.innerHTML += `
                            <div class="category-progress-item">
                                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px;">
                                    <span style="font-weight:600;font-size:1rem;">${c}</span>
                                    <span style="font-size:1rem;font-weight:bold;color:${pct>=70?'var(--success)':pct>=50?'var(--warning)':'var(--danger)'}">${pct}%</span>
                                </div>
                                <div style="background:rgba(0,0,0,0.05);height:10px;border-radius:5px;overflow:hidden; margin-bottom:8px;">
                                    <div style="width:${pct}%;height:100%;background:${pct>=70?'var(--success)':pct>=50?'var(--warning)':'var(--danger)'}"></div>
                                </div>
                                <div style="font-size:0.85rem;color:var(--text-muted);">${correct} acertos de ${total} tentativas</div>
                            </div>
                        `;
                    }
                });

                if (!hasDataForCats) {
                     categoryList.innerHTML = "<div style='text-align:center;color:var(--text-muted);padding:20px;'>Sem atividades nestas matrias para o perodo selecionado.</div>";
                     categoryProgressGrid.innerHTML = "<div style='text-align:center;color:var(--text-muted);padding:20px;'>Sem atividades nestas matrias para o perodo selecionado.</div>";
                }
            }
                        // --- CLCULO DE TEMPO DE ESTUDO (INTEGRADO  DATA) ---
            try {
                // 1. Pega o histrico do Pomodoro
                const ph = JSON.parse(localStorage.getItem('ted_pomo_history') || '[]');
                let pTotal = 0;

                // 2. Percorre o histrico e soma se estiver DENTRO DO INTERVALO ATUAL
                // A funo renderPerformanceView j define 'startDate' e 'endDate' no incio dela.
                // Vamos usar essas mesmas datas para filtrar o pomodoro.
                
                ph.forEach(s => {
                    // Pega a data da sesso (tenta vrios formatos)
                    let dStr = s.date || s.timestamp || s.endTime;
                    if (!dStr) return;
                    
                    // Converte para objeto Date para comparar
                    // Assume que dStr  ISO (YYYY-MM-DD...) ou aceitvel pelo Date()
                    let sDate = new Date(dStr);
                    
                    // Zera as horas para comparar apenas o dia
                    sDate.setHours(0,0,0,0);
                    
                    // Precisamos garantir que startDate e endDate sejam objetos Date
                    // Se no seu cdigo eles forem strings, converta:
                    let start = new Date(startDate); start.setHours(0,0,0,0);
                    let end = new Date(endDate); end.setHours(23,59,59,999);

                    if (sDate >= start && sDate <= end) {
                        pTotal += parseInt(s.duration || 0);
                    }
                });

                // 3. Formata
                let pText = "0m";
                if (pTotal > 0) {
                    const h = Math.floor(pTotal / 60);
                    const m = pTotal % 60;
                    pText = h > 0 ? `${h}h ${m}m` : `${m}m`;
                }

                // 4. Atualiza o elemento na tela
                if (reviewsTodayEl) {
                    reviewsTodayEl.innerText = pText;
                    reviewsTodayEl.style.color = "var(--primary)"; // Destaque
                    
                    // Opcional: Atualiza o label para refletir que  "Tempo"
                    let label = reviewsTodayEl.nextElementSibling || reviewsTodayEl.parentElement.querySelector('.metric-label');
                    if(label) label.innerText = "Tempo de Estudo";
                }

            } catch (e) { console.error("Erro Pomo Stats:", e); }

        }
        
        function openSimDetail(id) {
            const sim = simulationHistory.find(s => s.id === id);
            if(!sim) return;
            
            const dateStr = new Date(sim.date).toLocaleDateString('pt-BR') + ' ' + new Date(sim.date).toLocaleTimeString('pt-BR');
            document.getElementById('sim-detail-title').innerText = `Simulado: ${dateStr}`;
            
            const content = document.getElementById('sim-detail-content');
            content.innerHTML = `
                <div style="background:var(--bg-body); padding:16px; border-radius:12px; display:flex; justify-content:space-around; margin-bottom:16px;">
                     <div style="text-align:center;">
                        <div style="font-size:0.8rem; text-transform:uppercase; color:var(--text-muted);">Pontos</div>
                        <div style="font-size:1.5rem; font-weight:800; color:var(--primary);">${sim.score}/${sim.total}</div>
                     </div>
                     <div style="text-align:center;">
                        <div style="font-size:0.8rem; text-transform:uppercase; color:var(--text-muted);">Preciso</div>
                        <div style="font-size:1.5rem; font-weight:800; color:var(--text-main);">${Math.round((sim.score/sim.total)*100)}%</div>
                     </div>
                </div>
            `;
            
            // Render Log
            if(sim.log && sim.log.length > 0) {
                 sim.log.forEach((item, idx) => {
                     const div = document.createElement('div');
                     div.className = `sim-log-item ${item.isCorrect ? 'correct' : 'wrong'}`;
                     div.style.marginBottom = '8px';
                     div.innerHTML = `
                        <div style="font-weight:600; margin-bottom:6px; color:var(--text-main);">${idx+1}. ${item.question}</div>
                        <div style="font-size:0.9rem; margin-bottom:4px;">
                            <span style="color:var(--text-muted);">Sua resposta: </span> 
                            <span style="font-weight:600; color:${item.isCorrect ? 'var(--success)' : 'var(--danger)'}">${item.userAnswer}</span>
                        </div>
                         ${!item.isCorrect ? `<div style="font-size:0.9rem; color:var(--success);"><span style="color:var(--text-muted);">Correta: </span> <strong>${item.correctAnswer}</strong></div>` : ''}
                        <div style="font-size:0.8rem; color:var(--text-muted); margin-top:4px; text-transform:uppercase; letter-spacing:0.5px;">${item.category}</div>
                     `;
                     content.appendChild(div);
                });
            } else {
                content.innerHTML += `<div style="text-align:center; padding:20px; color:var(--text-muted);">Detalhes no disponveis para este registro antigo.</div>`;
            }
            
            document.getElementById('sim-detail-modal').classList.remove('hidden');
        }
     
    </script>

<!-- CUSTOM LOGOUT MODAL -->
<div id="logout-modal" class="hidden" style="position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.6);z-index:10000;display:flex;align-items:center;justify-content:center; padding: 20px; backdrop-filter: blur(5px);">
    <div style="background:var(--bg-card); padding:30px; border-radius:16px; width:100%; max-width:350px; text-align:center; box-shadow:var(--shadow-lg); border:1px solid var(--border); animation: fadeIn 0.3s ease;">
        <div style="font-size:3rem; color:#ef4444; margin-bottom:15px;"><i class="fas fa-exclamation-triangle"></i></div>
        <h3 style="margin-bottom:10px; color:var(--text-primary); font-size: 1.25rem;">Sair da Conta?</h3>
        <p style="color:var(--text-muted); margin-bottom:25px;">Voc precisar fazer login novamente para acessar seus dados.</p>
        <div style="display:flex; gap:10px; justify-content:center;">
            <button class="btn-outline" onclick="closeLogoutModal()" style="flex:1;">Cancelar</button>
            <button class="action-btn" onclick="confirmLogout()" style="background:#ef4444; flex:1; border:none;">Sim, Sair</button>
        </div>
    </div>
</div>
</body>
</html>